var Iu=Object.defineProperty;var ku=(n,e,t)=>e in n?Iu(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var Ye=(n,e,t)=>(ku(n,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const a of i.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function r(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();var ie=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function _i(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}function Cu(n){if(n.__esModule)return n;var e=n.default;if(typeof e=="function"){var t=function r(){return this instanceof r?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(n).forEach(function(r){var s=Object.getOwnPropertyDescriptor(n,r);Object.defineProperty(t,r,s.get?s:{enumerable:!0,get:function(){return n[r]}})}),t}var Ne={};const Ht={};Ne.DOTENV_CONFIG_ENCODING!=null&&(Ht.encoding=Ne.DOTENV_CONFIG_ENCODING);Ne.DOTENV_CONFIG_PATH!=null&&(Ht.path=Ne.DOTENV_CONFIG_PATH);Ne.DOTENV_CONFIG_DEBUG!=null&&(Ht.debug=Ne.DOTENV_CONFIG_DEBUG);Ne.DOTENV_CONFIG_OVERRIDE!=null&&(Ht.override=Ne.DOTENV_CONFIG_OVERRIDE);Ne.DOTENV_CONFIG_DOTENV_KEY!=null&&(Ht.DOTENV_KEY=Ne.DOTENV_CONFIG_DOTENV_KEY);var Su=Ht;const xu=/^dotenv_config_(encoding|path|debug|override|DOTENV_KEY)=(.+)$/;var Ru=function(e){return e.reduce(function(t,r){const s=r.match(xu);return s&&(t[s[1]]=s[2]),t},{})},Je={exports:{}};const ju={},$u=Object.freeze(Object.defineProperty({__proto__:null,default:ju},Symbol.toStringTag,{value:"Module"})),Gn=Cu($u),Nu="dotenv",Du="16.3.1",Lu="Loads environment variables from .env file",Uu="lib/main.js",Zu="lib/main.d.ts",Mu={".":{types:"./lib/main.d.ts",require:"./lib/main.js",default:"./lib/main.js"},"./config":"./config.js","./config.js":"./config.js","./lib/env-options":"./lib/env-options.js","./lib/env-options.js":"./lib/env-options.js","./lib/cli-options":"./lib/cli-options.js","./lib/cli-options.js":"./lib/cli-options.js","./package.json":"./package.json"},Fu={"dts-check":"tsc --project tests/types/tsconfig.json",lint:"standard","lint-readme":"standard-markdown",pretest:"npm run lint && npm run dts-check",test:"tap tests/*.js --100 -Rspec",prerelease:"npm test",release:"standard-version"},Bu={type:"git",url:"git://github.com/motdotla/dotenv.git"},Vu="https://github.com/motdotla/dotenv?sponsor=1",zu=["dotenv","env",".env","environment","variables","config","settings"],qu="README.md",Ku="BSD-2-Clause",Hu={"@definitelytyped/dtslint":"^0.0.133","@types/node":"^18.11.3",decache:"^4.6.1",sinon:"^14.0.1",standard:"^17.0.0","standard-markdown":"^7.1.0","standard-version":"^9.5.0",tap:"^16.3.0",tar:"^6.1.11",typescript:"^4.8.4"},Ju={node:">=12"},Gu={fs:!1},Wu={name:Nu,version:Du,description:Lu,main:Uu,types:Zu,exports:Mu,scripts:Fu,repository:Bu,funding:Vu,keywords:zu,readmeFilename:qu,license:Ku,devDependencies:Hu,engines:Ju,browser:Gu};var Sr={};const Oo=Gn,bi=Gn,Yu=Gn,Xu=Gn,Qu=Wu,vi=Qu.version,el=/(?:^|^)\s*(?:export\s+)?([\w.-]+)(?:\s*=\s*?|:\s+?)(\s*'(?:\\'|[^'])*'|\s*"(?:\\"|[^"])*"|\s*`(?:\\`|[^`])*`|[^#\r\n]+)?\s*(?:#.*)?(?:$|$)/mg;function tl(n){const e={};let t=n.toString();t=t.replace(/\r\n?/mg,`
`);let r;for(;(r=el.exec(t))!=null;){const s=r[1];let i=r[2]||"";i=i.trim();const a=i[0];i=i.replace(/^(['"`])([\s\S]*)\1$/mg,"$2"),a==='"'&&(i=i.replace(/\\n/g,`
`),i=i.replace(/\\r/g,"\r")),e[s]=i}return e}function rl(n){const e=Ao(n),t=Y.configDotenv({path:e});if(!t.parsed)throw new Error(`MISSING_DATA: Cannot parse ${e} for an unknown reason`);const r=Po(n).split(","),s=r.length;let i;for(let a=0;a<s;a++)try{const o=r[a].trim(),c=il(t,o);i=Y.decrypt(c.ciphertext,c.key);break}catch(o){if(a+1>=s)throw o}return Y.parse(i)}function nl(n){console.log(`[dotenv@${vi}][INFO] ${n}`)}function sl(n){console.log(`[dotenv@${vi}][WARN] ${n}`)}function Gs(n){console.log(`[dotenv@${vi}][DEBUG] ${n}`)}function Po(n){return n&&n.DOTENV_KEY&&n.DOTENV_KEY.length>0?n.DOTENV_KEY:Sr.DOTENV_KEY&&Sr.DOTENV_KEY.length>0?Sr.DOTENV_KEY:""}function il(n,e){let t;try{t=new URL(e)}catch(o){throw o.code==="ERR_INVALID_URL"?new Error("INVALID_DOTENV_KEY: Wrong format. Must be in valid uri format like dotenv://:key_1234@dotenv.org/vault/.env.vault?environment=development"):o}const r=t.password;if(!r)throw new Error("INVALID_DOTENV_KEY: Missing key part");const s=t.searchParams.get("environment");if(!s)throw new Error("INVALID_DOTENV_KEY: Missing environment part");const i=`DOTENV_VAULT_${s.toUpperCase()}`,a=n.parsed[i];if(!a)throw new Error(`NOT_FOUND_DOTENV_ENVIRONMENT: Cannot locate environment ${i} in your .env.vault file.`);return{ciphertext:a,key:r}}function Ao(n){let e=bi.resolve(process.cwd(),".env");return n&&n.path&&n.path.length>0&&(e=n.path),e.endsWith(".vault")?e:`${e}.vault`}function al(n){return n[0]==="~"?bi.join(Yu.homedir(),n.slice(1)):n}function ol(n){nl("Loading env from encrypted .env.vault");const e=Y._parseVault(n);let t=Sr;return n&&n.processEnv!=null&&(t=n.processEnv),Y.populate(t,e,n),{parsed:e}}function cl(n){let e=bi.resolve(process.cwd(),".env"),t="utf8";const r=!!(n&&n.debug);n&&(n.path!=null&&(e=al(n.path)),n.encoding!=null&&(t=n.encoding));try{const s=Y.parse(Oo.readFileSync(e,{encoding:t}));let i=Sr;return n&&n.processEnv!=null&&(i=n.processEnv),Y.populate(i,s,n),{parsed:s}}catch(s){return r&&Gs(`Failed to load ${e} ${s.message}`),{error:s}}}function ul(n){const e=Ao(n);return Po(n).length===0?Y.configDotenv(n):Oo.existsSync(e)?Y._configVault(n):(sl(`You set DOTENV_KEY but you are missing a .env.vault file at ${e}. Did you forget to build it?`),Y.configDotenv(n))}function ll(n,e){const t=Buffer.from(e.slice(-64),"hex");let r=Buffer.from(n,"base64");const s=r.slice(0,12),i=r.slice(-16);r=r.slice(12,-16);try{const a=Xu.createDecipheriv("aes-256-gcm",t,s);return a.setAuthTag(i),`${a.update(r)}${a.final()}`}catch(a){const o=a instanceof RangeError,c=a.message==="Invalid key length",l=a.message==="Unsupported state or unable to authenticate data";if(o||c){const d="INVALID_DOTENV_KEY: It must be 64 characters long (or more)";throw new Error(d)}else if(l){const d="DECRYPTION_FAILED: Please check your DOTENV_KEY";throw new Error(d)}else throw console.error("Error: ",a.code),console.error("Error: ",a.message),a}}function dl(n,e,t={}){const r=!!(t&&t.debug),s=!!(t&&t.override);if(typeof e!="object")throw new Error("OBJECT_REQUIRED: Please check the processEnv argument being passed to populate");for(const i of Object.keys(e))Object.prototype.hasOwnProperty.call(n,i)?(s===!0&&(n[i]=e[i]),r&&Gs(s===!0?`"${i}" is already defined and WAS overwritten`:`"${i}" is already defined and was NOT overwritten`)):n[i]=e[i]}const Y={configDotenv:cl,_configVault:ol,_parseVault:rl,config:ul,decrypt:ll,parse:tl,populate:dl};Je.exports.configDotenv=Y.configDotenv;Je.exports._configVault=Y._configVault;Je.exports._parseVault=Y._parseVault;Je.exports.config=Y.config;Je.exports.decrypt=Y.decrypt;Je.exports.parse=Y.parse;Je.exports.populate=Y.populate;Je.exports=Y;var hl=Je.exports;(function(){hl.config(Object.assign({},Su,Ru(process.argv)))})();const $t="4.24.1";let da=!1,xr,Io,ko,Ws,Co,So,xo,Ro,jo;function fl(n,e={auto:!1}){if(da)throw new Error(`you must \`import 'openai/shims/${n.kind}'\` before importing anything else from openai`);if(xr)throw new Error(`can't \`import 'openai/shims/${n.kind}'\` after \`import 'openai/shims/${xr}'\``);da=e.auto,xr=n.kind,Io=n.fetch,n.Request,n.Response,n.Headers,ko=n.FormData,n.Blob,Ws=n.File,Co=n.ReadableStream,So=n.getMultipartRequestOptions,xo=n.getDefaultAgent,Ro=n.fileFromPath,jo=n.isFsReadStream}class pl{constructor(e){this.body=e}get[Symbol.toStringTag](){return"MultipartBody"}}function ml({manuallyImported:n}={}){const e=n?"You may need to use polyfills":"Add one of these imports before your first `import … from 'openai'`:\n- `import 'openai/shims/node'` (if you're running on Node)\n- `import 'openai/shims/web'` (otherwise)\n";let t,r,s,i;try{t=fetch,r=Request,s=Response,i=Headers}catch(a){throw new Error(`this environment is missing the following Web Fetch API type: ${a.message}. ${e}`)}return{kind:"web",fetch:t,Request:r,Response:s,Headers:i,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${e}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${e}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${e}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${e}`)}},getMultipartRequestOptions:async(a,o)=>({...o,body:new pl(a)}),getDefaultAgent:a=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/openai/openai-node#file-uploads")},isFsReadStream:a=>!1}}xr||fl(ml(),{auto:!0});let F=class extends Error{},de=class Ys extends F{constructor(e,t,r,s){super(`${Ys.makeMessage(e,t,r)}`),this.status=e,this.headers=s;const i=t;this.error=i,this.code=i==null?void 0:i.code,this.param=i==null?void 0:i.param,this.type=i==null?void 0:i.type}static makeMessage(e,t,r){const s=t!=null&&t.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):r;return e&&s?`${e} ${s}`:e?`${e} status code (no body)`:s||"(no status code or body)"}static generate(e,t,r,s){if(!e)return new qr({cause:Qs(t)});const i=t==null?void 0:t.error;return e===400?new wi(e,i,r,s):e===401?new Ti(e,i,r,s):e===403?new Ei(e,i,r,s):e===404?new Oi(e,i,r,s):e===409?new Pi(e,i,r,s):e===422?new Ai(e,i,r,s):e===429?new Ii(e,i,r,s):e>=500?new ki(e,i,r,s):new Ys(e,i,r,s)}},at=class extends de{constructor({message:e}={}){super(void 0,void 0,e||"Request was aborted.",void 0),this.status=void 0}},qr=class extends de{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),this.status=void 0,t&&(this.cause=t)}},Wn=class extends qr{constructor({message:e}={}){super({message:e??"Request timed out."})}},wi=class extends de{constructor(){super(...arguments),this.status=400}},Ti=class extends de{constructor(){super(...arguments),this.status=401}},Ei=class extends de{constructor(){super(...arguments),this.status=403}},Oi=class extends de{constructor(){super(...arguments),this.status=404}},Pi=class extends de{constructor(){super(...arguments),this.status=409}},Ai=class extends de{constructor(){super(...arguments),this.status=422}},Ii=class extends de{constructor(){super(...arguments),this.status=429}},ki=class extends de{};const gl=Object.freeze(Object.defineProperty({__proto__:null,APIConnectionError:qr,APIConnectionTimeoutError:Wn,APIError:de,APIUserAbortError:at,AuthenticationError:Ti,BadRequestError:wi,ConflictError:Pi,InternalServerError:ki,NotFoundError:Oi,OpenAIError:F,PermissionDeniedError:Ei,RateLimitError:Ii,UnprocessableEntityError:Ai},Symbol.toStringTag,{value:"Module"}));class nt{constructor(e,t){this.iterator=e,this.controller=t}static fromSSEResponse(e,t){let r=!1;const s=new yl;async function*i(){if(!e.body)throw t.abort(),new F("Attempted to iterate over a response with no body");const o=new Tt,c=ha(e.body);for await(const l of c)for(const d of o.decode(l)){const f=s.decode(d);f&&(yield f)}for(const l of o.flush()){const d=s.decode(l);d&&(yield d)}}async function*a(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let o=!1;try{for await(const c of i())if(!o){if(c.data.startsWith("[DONE]")){o=!0;continue}if(c.event===null){let l;try{l=JSON.parse(c.data)}catch(d){throw console.error("Could not parse message into JSON:",c.data),console.error("From chunk:",c.raw),d}if(l&&l.error)throw new de(void 0,l.error,void 0,void 0);yield l}}o=!0}catch(c){if(c instanceof Error&&c.name==="AbortError")return;throw c}finally{o||t.abort()}}return new nt(a,t)}static fromReadableStream(e,t){let r=!1;async function*s(){const a=new Tt,o=ha(e);for await(const c of o)for(const l of a.decode(c))yield l;for(const c of a.flush())yield c}async function*i(){if(r)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");r=!0;let a=!1;try{for await(const o of s())a||o&&(yield JSON.parse(o));a=!0}catch(o){if(o instanceof Error&&o.name==="AbortError")return;throw o}finally{a||t.abort()}}return new nt(i,t)}[Symbol.asyncIterator](){return this.iterator()}tee(){const e=[],t=[],r=this.iterator(),s=i=>({next:()=>{if(i.length===0){const a=r.next();e.push(a),t.push(a)}return i.shift()}});return[new nt(()=>s(e),this.controller),new nt(()=>s(t),this.controller)]}toReadableStream(){const e=this;let t;const r=new TextEncoder;return new Co({async start(){t=e[Symbol.asyncIterator]()},async pull(s){try{const{value:i,done:a}=await t.next();if(a)return s.close();const o=r.encode(JSON.stringify(i)+`
`);s.enqueue(o)}catch(i){s.error(i)}},async cancel(){var s;await((s=t.return)==null?void 0:s.call(t))}})}}class yl{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(e){if(e.endsWith("\r")&&(e=e.substring(0,e.length-1)),!e){if(!this.event&&!this.data.length)return null;const i={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],i}if(this.chunks.push(e),e.startsWith(":"))return null;let[t,r,s]=_l(e,":");return s.startsWith(" ")&&(s=s.substring(1)),t==="event"?this.event=s:t==="data"&&this.data.push(s),null}}class Tt{constructor(){this.buffer=[],this.trailingCR=!1}decode(e){let t=this.decodeText(e);if(this.trailingCR&&(t="\r"+t,this.trailingCR=!1),t.endsWith("\r")&&(this.trailingCR=!0,t=t.slice(0,-1)),!t)return[];const r=Tt.NEWLINE_CHARS.has(t[t.length-1]||"");let s=t.split(Tt.NEWLINE_REGEXP);return s.length===1&&!r?(this.buffer.push(s[0]),[]):(this.buffer.length>0&&(s=[this.buffer.join("")+s[0],...s.slice(1)],this.buffer=[]),r||(this.buffer=[s.pop()||""]),s)}decodeText(e){if(e==null)return"";if(typeof e=="string")return e;if(typeof Buffer<"u"){if(e instanceof Buffer)return e.toString();if(e instanceof Uint8Array)return Buffer.from(e).toString();throw new F(`Unexpected: received non-Uint8Array (${e.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(e instanceof Uint8Array||e instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(e);throw new F(`Unexpected: received non-Uint8Array/ArrayBuffer (${e.constructor.name}) in a web platform. Please report this error.`)}throw new F("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const e=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,e}}Tt.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","","\u2028","\u2029"]);Tt.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function _l(n,e){const t=n.indexOf(e);return t!==-1?[n.substring(0,t),e,n.substring(t+e.length)]:[n,"",""]}function ha(n){if(n[Symbol.asyncIterator])return n;const e=n.getReader();return{async next(){try{const t=await e.read();return t!=null&&t.done&&e.releaseLock(),t}catch(t){throw e.releaseLock(),t}},async return(){const t=e.cancel();return e.releaseLock(),await t,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const $o=n=>n!=null&&typeof n=="object"&&typeof n.url=="string"&&typeof n.blob=="function",bl=n=>n!=null&&typeof n=="object"&&typeof n.name=="string"&&typeof n.lastModified=="number"&&No(n),No=n=>n!=null&&typeof n=="object"&&typeof n.size=="number"&&typeof n.type=="string"&&typeof n.text=="function"&&typeof n.slice=="function"&&typeof n.arrayBuffer=="function",vl=n=>bl(n)||$o(n)||jo(n);async function Do(n,e,t={}){var s;if(n=await n,$o(n)){const i=await n.blob();return e||(e=new URL(n.url).pathname.split(/[\\/]/).pop()??"unknown_file"),new Ws([i],e,t)}const r=await wl(n);if(e||(e=El(n)??"unknown_file"),!t.type){const i=(s=r[0])==null?void 0:s.type;typeof i=="string"&&(t={...t,type:i})}return new Ws(r,e,t)}async function wl(n){var t;let e=[];if(typeof n=="string"||ArrayBuffer.isView(n)||n instanceof ArrayBuffer)e.push(n);else if(No(n))e.push(await n.arrayBuffer());else if(Ol(n))for await(const r of n)e.push(r);else throw new Error(`Unexpected data type: ${typeof n}; constructor: ${(t=n==null?void 0:n.constructor)==null?void 0:t.name}; props: ${Tl(n)}`);return e}function Tl(n){return`[${Object.getOwnPropertyNames(n).map(t=>`"${t}"`).join(", ")}]`}function El(n){var e;return Os(n.name)||Os(n.filename)||((e=Os(n.path))==null?void 0:e.split(/[\\/]/).pop())}const Os=n=>{if(typeof n=="string")return n;if(typeof Buffer<"u"&&n instanceof Buffer)return String(n)},Ol=n=>n!=null&&typeof n=="object"&&typeof n[Symbol.asyncIterator]=="function",fa=n=>n&&typeof n=="object"&&n.body&&n[Symbol.toStringTag]==="MultipartBody",Dr=async n=>{const e=await Pl(n.body);return So(e,n)},Pl=async n=>{const e=new ko;return await Promise.all(Object.entries(n||{}).map(([t,r])=>Xs(e,t,r))),e},Xs=async(n,e,t)=>{if(t!==void 0){if(t==null)throw new TypeError(`Received null for "${e}"; to pass null in FormData, you must use the string 'null'`);if(typeof t=="string"||typeof t=="number"||typeof t=="boolean")n.append(e,String(t));else if(vl(t)){const r=await Do(t);n.append(e,r)}else if(Array.isArray(t))await Promise.all(t.map(r=>Xs(n,e+"[]",r)));else if(typeof t=="object")await Promise.all(Object.entries(t).map(([r,s])=>Xs(n,`${e}[${r}]`,s)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${t} instead`)}};var dn={},Al=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},Il=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},tn;async function Lo(n){const{response:e}=n;if(n.options.stream)return Rr("response",e.status,e.url,e.headers,e.body),nt.fromSSEResponse(e,n.controller);if(e.status===204)return null;if(n.options.__binaryResponse)return e;const t=e.headers.get("content-type");if(t!=null&&t.includes("application/json")){const s=await e.json();return Rr("response",e.status,e.url,e.headers,s),s}const r=await e.text();return Rr("response",e.status,e.url,e.headers,r),r}class Yn extends Promise{constructor(e,t=Lo){super(r=>{r(null)}),this.responsePromise=e,this.parseResponse=t}_thenUnwrap(e){return new Yn(this.responsePromise,async t=>e(await this.parseResponse(t)))}asResponse(){return this.responsePromise.then(e=>e.response)}async withResponse(){const[e,t]=await Promise.all([this.parse(),this.asResponse()]);return{data:e,response:t}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(e,t){return this.parse().then(e,t)}catch(e){return this.parse().catch(e)}finally(e){return this.parse().finally(e)}}class kl{constructor({baseURL:e,maxRetries:t=2,timeout:r=6e5,httpAgent:s,fetch:i}){this.baseURL=e,this.maxRetries=Ps("maxRetries",t),this.timeout=Ps("timeout",r),this.httpAgent=s,this.fetch=i??Io}authHeaders(e){return{}}defaultHeaders(e){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...$l(),...this.authHeaders(e)}}validateHeaders(e,t){}defaultIdempotencyKey(){return`stainless-node-retry-${Zl()}`}get(e,t){return this.methodRequest("get",e,t)}post(e,t){return this.methodRequest("post",e,t)}patch(e,t){return this.methodRequest("patch",e,t)}put(e,t){return this.methodRequest("put",e,t)}delete(e,t){return this.methodRequest("delete",e,t)}methodRequest(e,t,r){return this.request(Promise.resolve(r).then(s=>({method:e,path:t,...s})))}getAPIList(e,t,r){return this.requestAPIList(t,{method:"get",path:e,...r})}calculateContentLength(e){if(typeof e=="string"){if(typeof Buffer<"u")return Buffer.byteLength(e,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(e).length.toString()}return null}buildRequest(e){var v;const{method:t,path:r,query:s,headers:i={}}=e,a=fa(e.body)?e.body.body:e.body?JSON.stringify(e.body,null,2):null,o=this.calculateContentLength(a),c=this.buildURL(r,s);"timeout"in e&&Ps("timeout",e.timeout);const l=e.timeout??this.timeout,d=e.httpAgent??this.httpAgent??xo(c),f=l+1e3;typeof((v=d==null?void 0:d.options)==null?void 0:v.timeout)=="number"&&f>(d.options.timeout??0)&&(d.options.timeout=f),this.idempotencyHeader&&t!=="get"&&(e.idempotencyKey||(e.idempotencyKey=this.defaultIdempotencyKey()),i[this.idempotencyHeader]=e.idempotencyKey);const m={...o&&{"Content-Length":o},...this.defaultHeaders(e),...i};fa(e.body)&&xr!=="node"&&delete m["Content-Type"],Object.keys(m).forEach(T=>m[T]===null&&delete m[T]);const b={method:t,...a&&{body:a},headers:m,...d&&{agent:d},signal:e.signal??null};return this.validateHeaders(m,i),{req:b,url:c,timeout:l}}async prepareRequest(e,{url:t,options:r}){}parseHeaders(e){return e?Symbol.iterator in e?Object.fromEntries(Array.from(e).map(t=>[...t])):{...e}:{}}makeStatusError(e,t,r,s){return de.generate(e,t,r,s)}request(e,t=null){return new Yn(this.makeRequest(e,t))}async makeRequest(e,t){var d,f;const r=await e;t==null&&(t=r.maxRetries??this.maxRetries);const{req:s,url:i,timeout:a}=this.buildRequest(r);if(await this.prepareRequest(s,{url:i,options:r}),Rr("request",i,r,s.headers),(d=r.signal)!=null&&d.aborted)throw new at;const o=new AbortController,c=await this.fetchWithTimeout(i,s,a,o).catch(Qs);if(c instanceof Error){if((f=r.signal)!=null&&f.aborted)throw new at;if(t)return this.retryRequest(r,t);throw c.name==="AbortError"?new Wn:new qr({cause:c})}const l=Sl(c.headers);if(!c.ok){if(t&&this.shouldRetry(c))return this.retryRequest(r,t,l);const m=await c.text().catch(w=>Qs(w).message),b=Nl(m),v=b?void 0:m;throw Rr("response",c.status,i,l,v),this.makeStatusError(c.status,b,v,l)}return{response:c,options:r,controller:o}}requestAPIList(e,t){const r=this.makeRequest(t,null);return new Cl(this,r,e)}buildURL(e,t){const r=Ll(e)?new URL(e):new URL(this.baseURL+(this.baseURL.endsWith("/")&&e.startsWith("/")?e.slice(1):e)),s=this.defaultQuery();return Mo(s)||(t={...s,...t}),t&&(r.search=this.stringifyQuery(t)),r.toString()}stringifyQuery(e){return Object.entries(e).filter(([t,r])=>typeof r<"u").map(([t,r])=>{if(typeof r=="string"||typeof r=="number"||typeof r=="boolean")return`${encodeURIComponent(t)}=${encodeURIComponent(r)}`;if(r===null)return`${encodeURIComponent(t)}=`;throw new F(`Cannot stringify type ${typeof r}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(e,t,r,s){const{signal:i,...a}=t||{};i&&i.addEventListener("abort",()=>s.abort());const o=setTimeout(()=>s.abort(),r);return this.getRequestClient().fetch.call(void 0,e,{signal:s.signal,...a}).finally(()=>{clearTimeout(o)})}getRequestClient(){return{fetch:this.fetch}}shouldRetry(e){const t=e.headers.get("x-should-retry");return t==="true"?!0:t==="false"?!1:e.status===408||e.status===409||e.status===429||e.status>=500}async retryRequest(e,t,r){let s;const i=r==null?void 0:r["retry-after"];if(i){const a=parseInt(i);Number.isNaN(a)?s=Date.parse(i)-Date.now():s=a*1e3}if(!s||!Number.isInteger(s)||s<=0||s>60*1e3){const a=e.maxRetries??this.maxRetries;s=this.calculateDefaultRetryTimeoutMillis(t,a)}return await Zo(s),this.makeRequest(e,t-1)}calculateDefaultRetryTimeoutMillis(e,t){const i=t-e,a=Math.min(.5*Math.pow(2,i),8),o=1-Math.random()*.25;return a*o*1e3}getUserAgent(){return`${this.constructor.name}/JS ${$t}`}}class Uo{constructor(e,t,r,s){tn.set(this,void 0),Al(this,tn,e,"f"),this.options=s,this.response=t,this.body=r}hasNextPage(){return this.getPaginatedItems().length?this.nextPageInfo()!=null:!1}async getNextPage(){const e=this.nextPageInfo();if(!e)throw new F("No next page expected; please check `.hasNextPage()` before calling `.getNextPage()`.");const t={...this.options};if("params"in e)t.query={...t.query,...e.params};else if("url"in e){const r=[...Object.entries(t.query||{}),...e.url.searchParams.entries()];for(const[s,i]of r)e.url.searchParams.set(s,i);t.query=void 0,t.path=e.url.toString()}return await Il(this,tn,"f").requestAPIList(this.constructor,t)}async*iterPages(){let e=this;for(yield e;e.hasNextPage();)e=await e.getNextPage(),yield e}async*[(tn=new WeakMap,Symbol.asyncIterator)](){for await(const e of this.iterPages())for(const t of e.getPaginatedItems())yield t}}class Cl extends Yn{constructor(e,t,r){super(t,async s=>new r(e,s.response,await Lo(s),s.options))}async*[Symbol.asyncIterator](){const e=await this;for await(const t of e)yield t}}const Sl=n=>new Proxy(Object.fromEntries(n.entries()),{get(e,t){const r=t.toString();return e[r.toLowerCase()]||e[r]}}),xl={method:!0,path:!0,query:!0,body:!0,headers:!0,maxRetries:!0,stream:!0,timeout:!0,httpAgent:!0,signal:!0,idempotencyKey:!0,__binaryResponse:!0},De=n=>typeof n=="object"&&n!==null&&!Mo(n)&&Object.keys(n).every(e=>Ul(xl,e)),Rl=()=>{if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$t,"X-Stainless-OS":ma(Deno.build.os),"X-Stainless-Arch":pa(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":Deno.version};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$t,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$t,"X-Stainless-OS":ma(process.platform),"X-Stainless-Arch":pa(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const n=jl();return n?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$t,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${n.browser}`,"X-Stainless-Runtime-Version":n.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":$t,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function jl(){if(typeof navigator>"u"||!navigator)return null;const n=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:e,pattern:t}of n){const r=t.exec(navigator.userAgent);if(r){const s=r[1]||0,i=r[2]||0,a=r[3]||0;return{browser:e,version:`${s}.${i}.${a}`}}}return null}const pa=n=>n==="x32"?"x32":n==="x86_64"||n==="x64"?"x64":n==="arm"?"arm":n==="aarch64"||n==="arm64"?"arm64":n?`other:${n}`:"unknown",ma=n=>(n=n.toLowerCase(),n.includes("ios")?"iOS":n==="android"?"Android":n==="darwin"?"MacOS":n==="win32"?"Windows":n==="freebsd"?"FreeBSD":n==="openbsd"?"OpenBSD":n==="linux"?"Linux":n?`Other:${n}`:"Unknown");let ga;const $l=()=>ga??(ga=Rl()),Nl=n=>{try{return JSON.parse(n)}catch{return}},Dl=new RegExp("^(?:[a-z]+:)?//","i"),Ll=n=>Dl.test(n),Zo=n=>new Promise(e=>setTimeout(e,n)),Ps=(n,e)=>{if(typeof e!="number"||!Number.isInteger(e))throw new F(`${n} must be an integer`);if(e<0)throw new F(`${n} must be a positive integer`);return e},Qs=n=>n instanceof Error?n:new Error(n),As=n=>{var e,t;if(typeof process<"u")return(dn==null?void 0:dn[n])??void 0;if(typeof Deno<"u")return(t=(e=Deno.env)==null?void 0:e.get)==null?void 0:t.call(e,n)};function Mo(n){if(!n)return!0;for(const e in n)return!1;return!0}function Ul(n,e){return Object.prototype.hasOwnProperty.call(n,e)}function Rr(n,...e){typeof process<"u"&&dn.DEBUG==="true"&&console.log(`OpenAI:DEBUG:${n}`,...e)}const Zl=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)}),Ml=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u";class Xn extends Uo{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[],this.object=r.object}getPaginatedItems(){return this.data??[]}nextPageParams(){return null}nextPageInfo(){return null}}class Ge extends Uo{constructor(e,t,r,s){super(e,t,r,s),this.data=r.data||[]}getPaginatedItems(){return this.data??[]}nextPageParams(){const e=this.nextPageInfo();if(!e)return null;if("params"in e)return e.params;const t=Object.fromEntries(e.url.searchParams);return Object.keys(t).length?t:null}nextPageInfo(){var r;const e=this.getPaginatedItems();if(!e.length)return null;const t=(r=e[e.length-1])==null?void 0:r.id;return t?{params:{after:t}}:null}}class z{constructor(e){this._client=e}}let yn=class extends z{create(e,t){return this._client.post("/chat/completions",{body:e,...t,stream:e.stream??!1})}};yn||(yn={});let _n=class extends z{constructor(){super(...arguments),this.completions=new yn(this._client)}};(function(n){n.Completions=yn})(_n||(_n={}));class bn extends z{create(e,t){return this._client.post("/audio/speech",{body:e,...t,__binaryResponse:!0})}}bn||(bn={});class vn extends z{create(e,t){return this._client.post("/audio/transcriptions",Dr({body:e,...t}))}}vn||(vn={});class wn extends z{create(e,t){return this._client.post("/audio/translations",Dr({body:e,...t}))}}wn||(wn={});class Tn extends z{constructor(){super(...arguments),this.transcriptions=new vn(this._client),this.translations=new wn(this._client),this.speech=new bn(this._client)}}(function(n){n.Transcriptions=vn,n.Translations=wn,n.Speech=bn})(Tn||(Tn={}));let En=class extends z{create(e,t,r){return this._client.post(`/assistants/${e}/files`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e,t={},r){return De(t)?this.list(e,{},t):this._client.getAPIList(`/assistants/${e}/files`,Ci,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t,r){return this._client.delete(`/assistants/${e}/files/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}};class Ci extends Ge{}(function(n){n.AssistantFilesPage=Ci})(En||(En={}));class On extends z{constructor(){super(...arguments),this.files=new En(this._client)}create(e,t){return this._client.post("/assistants",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/assistants/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}list(e={},t){return De(e)?this.list({},e):this._client.getAPIList("/assistants",Si,{query:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}del(e,t){return this._client.delete(`/assistants/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}class Si extends Ge{}(function(n){n.AssistantsPage=Si,n.Files=En,n.AssistantFilesPage=Ci})(On||(On={}));function ya(n){return typeof n.parse=="function"}const Zt=n=>(n==null?void 0:n.role)==="assistant",Fo=n=>(n==null?void 0:n.role)==="function",Bo=n=>(n==null?void 0:n.role)==="tool";var Te=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},N=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},ne,hn,fn,Or,Pr,pn,Ar,Fe,Ir,mn,gn,Nt,ei,Pn,ti,ri,ni,si,Vo,ii;const _a=10;class zo{constructor(){ne.add(this),this.controller=new AbortController,hn.set(this,void 0),fn.set(this,()=>{}),Or.set(this,()=>{}),Pr.set(this,void 0),pn.set(this,()=>{}),Ar.set(this,()=>{}),Fe.set(this,{}),this._chatCompletions=[],this.messages=[],Ir.set(this,!1),mn.set(this,!1),gn.set(this,!1),Nt.set(this,!1),si.set(this,e=>{if(Te(this,mn,!0,"f"),e instanceof Error&&e.name==="AbortError"&&(e=new at),e instanceof at)return Te(this,gn,!0,"f"),this._emit("abort",e);if(e instanceof F)return this._emit("error",e);if(e instanceof Error){const t=new F(e.message);return t.cause=e,this._emit("error",t)}return this._emit("error",new F(String(e)))}),Te(this,hn,new Promise((e,t)=>{Te(this,fn,e,"f"),Te(this,Or,t,"f")}),"f"),Te(this,Pr,new Promise((e,t)=>{Te(this,pn,e,"f"),Te(this,Ar,t,"f")}),"f"),N(this,hn,"f").catch(()=>{}),N(this,Pr,"f").catch(()=>{})}_run(e){setTimeout(()=>{e().then(()=>{this._emitFinal(),this._emit("end")},N(this,si,"f"))},0)}_addChatCompletion(e){var r;this._chatCompletions.push(e),this._emit("chatCompletion",e);const t=(r=e.choices[0])==null?void 0:r.message;return t&&this._addMessage(t),e}_addMessage(e,t=!0){if("content"in e||(e.content=null),this.messages.push(e),t){if(this._emit("message",e),(Fo(e)||Bo(e))&&e.content)this._emit("functionCallResult",e.content);else if(Zt(e)&&e.function_call)this._emit("functionCall",e.function_call);else if(Zt(e)&&e.tool_calls)for(const r of e.tool_calls)r.type==="function"&&this._emit("functionCall",r.function)}}_connected(){this.ended||(N(this,fn,"f").call(this),this._emit("connect"))}get ended(){return N(this,Ir,"f")}get errored(){return N(this,mn,"f")}get aborted(){return N(this,gn,"f")}abort(){this.controller.abort()}on(e,t){return(N(this,Fe,"f")[e]||(N(this,Fe,"f")[e]=[])).push({listener:t}),this}off(e,t){const r=N(this,Fe,"f")[e];if(!r)return this;const s=r.findIndex(i=>i.listener===t);return s>=0&&r.splice(s,1),this}once(e,t){return(N(this,Fe,"f")[e]||(N(this,Fe,"f")[e]=[])).push({listener:t,once:!0}),this}emitted(e){return new Promise((t,r)=>{Te(this,Nt,!0,"f"),e!=="error"&&this.once("error",r),this.once(e,t)})}async done(){Te(this,Nt,!0,"f"),await N(this,Pr,"f")}async finalChatCompletion(){await this.done();const e=this._chatCompletions[this._chatCompletions.length-1];if(!e)throw new F("stream ended without producing a ChatCompletion");return e}async finalContent(){return await this.done(),N(this,ne,"m",ei).call(this)}async finalMessage(){return await this.done(),N(this,ne,"m",Pn).call(this)}async finalFunctionCall(){return await this.done(),N(this,ne,"m",ti).call(this)}async finalFunctionCallResult(){return await this.done(),N(this,ne,"m",ri).call(this)}async totalUsage(){return await this.done(),N(this,ne,"m",ni).call(this)}allChatCompletions(){return[...this._chatCompletions]}_emit(e,...t){if(N(this,Ir,"f"))return;e==="end"&&(Te(this,Ir,!0,"f"),N(this,pn,"f").call(this));const r=N(this,Fe,"f")[e];if(r&&(N(this,Fe,"f")[e]=r.filter(s=>!s.once),r.forEach(({listener:s})=>s(...t))),e==="abort"){const s=t[0];!N(this,Nt,"f")&&!(r!=null&&r.length)&&Promise.reject(s),N(this,Or,"f").call(this,s),N(this,Ar,"f").call(this,s),this._emit("end");return}if(e==="error"){const s=t[0];!N(this,Nt,"f")&&!(r!=null&&r.length)&&Promise.reject(s),N(this,Or,"f").call(this,s),N(this,Ar,"f").call(this,s),this._emit("end")}}_emitFinal(){const e=this._chatCompletions[this._chatCompletions.length-1];e&&this._emit("finalChatCompletion",e);const t=N(this,ne,"m",Pn).call(this);t&&this._emit("finalMessage",t);const r=N(this,ne,"m",ei).call(this);r&&this._emit("finalContent",r);const s=N(this,ne,"m",ti).call(this);s&&this._emit("finalFunctionCall",s);const i=N(this,ne,"m",ri).call(this);i!=null&&this._emit("finalFunctionCallResult",i),this._chatCompletions.some(a=>a.usage)&&this._emit("totalUsage",N(this,ne,"m",ni).call(this))}async _createChatCompletion(e,t,r){const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),N(this,ne,"m",Vo).call(this,t);const i=await e.create({...t,stream:!1},{...r,signal:this.controller.signal});return this._connected(),this._addChatCompletion(i)}async _runChatCompletion(e,t,r){for(const s of t.messages)this._addMessage(s,!1);return await this._createChatCompletion(e,t,r)}async _runFunctions(e,t,r){var m;const s="function",{function_call:i="auto",stream:a,...o}=t,c=typeof i!="string"&&(i==null?void 0:i.name),{maxChatCompletions:l=_a}=r||{},d={};for(const b of t.functions)d[b.name||b.function.name]=b;const f=t.functions.map(b=>({name:b.name||b.function.name,parameters:b.parameters,description:b.description}));for(const b of t.messages)this._addMessage(b,!1);for(let b=0;b<l;++b){const T=(m=(await this._createChatCompletion(e,{...o,function_call:i,functions:f,messages:[...this.messages]},r)).choices[0])==null?void 0:m.message;if(!T)throw new F("missing message in ChatCompletion response");if(!T.function_call)return;const{name:w,arguments:P}=T.function_call,k=d[w];if(k){if(c&&c!==w){const B=`Invalid function_call: ${JSON.stringify(w)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,name:w,content:B});continue}}else{const B=`Invalid function_call: ${JSON.stringify(w)}. Available options are: ${f.map(q=>JSON.stringify(q.name)).join(", ")}. Please try again`;this._addMessage({role:s,name:w,content:B});continue}let I;try{I=ya(k)?await k.parse(P):P}catch(B){this._addMessage({role:s,name:w,content:B instanceof Error?B.message:String(B)});continue}const Z=await k.function(I,this),D=N(this,ne,"m",ii).call(this,Z);if(this._addMessage({role:s,name:w,content:D}),c)return}}async _runTools(e,t,r){var m,b;const s="tool",{tool_choice:i="auto",stream:a,...o}=t,c=typeof i!="string"&&((m=i==null?void 0:i.function)==null?void 0:m.name),{maxChatCompletions:l=_a}=r||{},d={};for(const v of t.tools)v.type==="function"&&(d[v.function.name||v.function.function.name]=v.function);const f="tools"in t?t.tools.map(v=>v.type==="function"?{type:"function",function:{name:v.function.name||v.function.function.name,parameters:v.function.parameters,description:v.function.description}}:v):void 0;for(const v of t.messages)this._addMessage(v,!1);for(let v=0;v<l;++v){const w=(b=(await this._createChatCompletion(e,{...o,tool_choice:i,tools:f,messages:[...this.messages]},r)).choices[0])==null?void 0:b.message;if(!w)throw new F("missing message in ChatCompletion response");if(!w.tool_calls)return;for(const P of w.tool_calls){if(P.type!=="function")continue;const k=P.id,{name:I,arguments:Z}=P.function,D=d[I];if(D){if(c&&c!==I){const oe=`Invalid tool_call: ${JSON.stringify(I)}. ${JSON.stringify(c)} requested. Please try again`;this._addMessage({role:s,tool_call_id:k,content:oe});continue}}else{const oe=`Invalid tool_call: ${JSON.stringify(I)}. Available options are: ${f.map(he=>JSON.stringify(he.function.name)).join(", ")}. Please try again`;this._addMessage({role:s,tool_call_id:k,content:oe});continue}let B;try{B=ya(D)?await D.parse(Z):Z}catch(oe){const he=oe instanceof Error?oe.message:String(oe);this._addMessage({role:s,tool_call_id:k,content:he});continue}const q=await D.function(B,this),me=N(this,ne,"m",ii).call(this,q);if(this._addMessage({role:s,tool_call_id:k,content:me}),c)return}}}}hn=new WeakMap,fn=new WeakMap,Or=new WeakMap,Pr=new WeakMap,pn=new WeakMap,Ar=new WeakMap,Fe=new WeakMap,Ir=new WeakMap,mn=new WeakMap,gn=new WeakMap,Nt=new WeakMap,si=new WeakMap,ne=new WeakSet,ei=function(){return N(this,ne,"m",Pn).call(this).content??null},Pn=function(){let e=this.messages.length;for(;e-- >0;){const t=this.messages[e];if(Zt(t))return{...t,content:t.content??null}}throw new F("stream ended without producing a ChatCompletionMessage with role=assistant")},ti=function(){var e,t;for(let r=this.messages.length-1;r>=0;r--){const s=this.messages[r];if(Zt(s)&&(s!=null&&s.function_call))return s.function_call;if(Zt(s)&&((e=s==null?void 0:s.tool_calls)!=null&&e.length))return(t=s.tool_calls.at(-1))==null?void 0:t.function}},ri=function(){for(let e=this.messages.length-1;e>=0;e--){const t=this.messages[e];if(Fo(t)&&t.content!=null||Bo(t)&&t.content!=null&&this.messages.some(r=>{var s;return r.role==="assistant"&&((s=r.tool_calls)==null?void 0:s.some(i=>i.type==="function"&&i.id===t.tool_call_id))}))return t.content}},ni=function(){const e={completion_tokens:0,prompt_tokens:0,total_tokens:0};for(const{usage:t}of this._chatCompletions)t&&(e.completion_tokens+=t.completion_tokens,e.prompt_tokens+=t.prompt_tokens,e.total_tokens+=t.total_tokens);return e},Vo=function(e){if(e.n!=null&&e.n>1)throw new F("ChatCompletion convenience helpers only support n=1 at this time. To use n>1, please use chat.completions.create() directly.")},ii=function(e){return typeof e=="string"?e:e===void 0?"undefined":JSON.stringify(e)};class Lr extends zo{static runFunctions(e,t,r){const s=new Lr,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,r){const s=new Lr,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}_addMessage(e){super._addMessage(e),Zt(e)&&e.content&&this._emit("content",e.content)}}var Ee=function(n,e,t,r){if(t==="a"&&!r)throw new TypeError("Private accessor was defined without a getter");if(typeof e=="function"?n!==e||!r:!e.has(n))throw new TypeError("Cannot read private member from an object whose class did not declare it");return t==="m"?r:t==="a"?r.call(n):r?r.value:e.get(n)},Is=function(n,e,t,r,s){if(r==="m")throw new TypeError("Private method is not writable");if(r==="a"&&!s)throw new TypeError("Private accessor was defined without a setter");if(typeof e=="function"?n!==e||!s:!e.has(n))throw new TypeError("Cannot write private member to an object whose class did not declare it");return r==="a"?s.call(n,t):s?s.value=t:e.set(n,t),t},xe,Xe,ks,Cs,rn,ba;class Ur extends zo{constructor(){super(...arguments),xe.add(this),Xe.set(this,void 0)}get currentChatCompletionSnapshot(){return Ee(this,Xe,"f")}static fromReadableStream(e){const t=new Ur;return t._run(()=>t._fromReadableStream(e)),t}static createChatCompletion(e,t,r){const s=new Ur;return s._run(()=>s._runChatCompletion(e,{...t,stream:!0},{...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"stream"}})),s}async _createChatCompletion(e,t,r){var a;const s=r==null?void 0:r.signal;s&&(s.aborted&&this.controller.abort(),s.addEventListener("abort",()=>this.controller.abort())),Ee(this,xe,"m",ks).call(this);const i=await e.create({...t,stream:!0},{...r,signal:this.controller.signal});this._connected();for await(const o of i)Ee(this,xe,"m",Cs).call(this,o);if((a=i.controller.signal)!=null&&a.aborted)throw new at;return this._addChatCompletion(Ee(this,xe,"m",rn).call(this))}async _fromReadableStream(e,t){var a;const r=t==null?void 0:t.signal;r&&(r.aborted&&this.controller.abort(),r.addEventListener("abort",()=>this.controller.abort())),Ee(this,xe,"m",ks).call(this),this._connected();const s=nt.fromReadableStream(e,this.controller);let i;for await(const o of s)i&&i!==o.id&&this._addChatCompletion(Ee(this,xe,"m",rn).call(this)),Ee(this,xe,"m",Cs).call(this,o),i=o.id;if((a=s.controller.signal)!=null&&a.aborted)throw new at;return this._addChatCompletion(Ee(this,xe,"m",rn).call(this))}[(Xe=new WeakMap,xe=new WeakSet,ks=function(){this.ended||Is(this,Xe,void 0,"f")},Cs=function(t){var a,o,c;if(this.ended)return;const r=Ee(this,xe,"m",ba).call(this,t);this._emit("chunk",t,r);const s=(o=(a=t.choices[0])==null?void 0:a.delta)==null?void 0:o.content,i=(c=r.choices[0])==null?void 0:c.message;s!=null&&(i==null?void 0:i.role)==="assistant"&&(i!=null&&i.content)&&this._emit("content",s,i.content)},rn=function(){if(this.ended)throw new F("stream has ended, this shouldn't happen");const t=Ee(this,Xe,"f");if(!t)throw new F("request ended without sending any chunks");return Is(this,Xe,void 0,"f"),Fl(t)},ba=function(t){var r,s,i;let a=Ee(this,Xe,"f");const{choices:o,...c}=t;a?Object.assign(a,c):a=Is(this,Xe,{...c,choices:[]},"f");for(const{delta:l,finish_reason:d,index:f,logprobs:m=null,...b}of t.choices){let v=a.choices[f];if(!v){a.choices[f]={finish_reason:d,index:f,message:l,logprobs:m,...b};continue}if(m&&(v.logprobs?m.content&&((r=v.logprobs).content??(r.content=[]),v.logprobs.content.push(...m.content)):v.logprobs=m),d&&(v.finish_reason=d),Object.assign(v,b),!l)continue;const{content:T,function_call:w,role:P,tool_calls:k}=l;if(T&&(v.message.content=(v.message.content||"")+T),P&&(v.message.role=P),w&&(v.message.function_call?(w.name&&(v.message.function_call.name=w.name),w.arguments&&((s=v.message.function_call).arguments??(s.arguments=""),v.message.function_call.arguments+=w.arguments)):v.message.function_call=w),k){v.message.tool_calls||(v.message.tool_calls=[]);for(const{index:I,id:Z,type:D,function:B}of k){const q=(i=v.message.tool_calls)[I]??(i[I]={});Z&&(q.id=Z),D&&(q.type=D),B&&(q.function??(q.function={arguments:""})),B!=null&&B.name&&(q.function.name=B.name),B!=null&&B.arguments&&(q.function.arguments+=B.arguments)}}}return a},Symbol.asyncIterator)](){const e=[],t=[];let r=!1;return this.on("chunk",s=>{const i=t.shift();i?i(s):e.push(s)}),this.on("end",()=>{r=!0;for(const s of t)s(void 0);t.length=0}),{next:async()=>e.length?{value:e.shift(),done:!1}:r?{value:void 0,done:!0}:new Promise(i=>t.push(i)).then(i=>i?{value:i,done:!1}:{value:void 0,done:!0})}}toReadableStream(){return new nt(this[Symbol.asyncIterator].bind(this),this.controller).toReadableStream()}}function Fl(n){const{id:e,choices:t,created:r,model:s}=n;return{id:e,choices:t.map(({message:i,finish_reason:a,index:o,logprobs:c})=>{if(!a)throw new F(`missing finish_reason for choice ${o}`);const{content:l=null,function_call:d,tool_calls:f}=i,m=i.role;if(!m)throw new F(`missing role for choice ${o}`);if(d){const{arguments:b,name:v}=d;if(b==null)throw new F(`missing function_call.arguments for choice ${o}`);if(!v)throw new F(`missing function_call.name for choice ${o}`);return{message:{content:l,function_call:{arguments:b,name:v},role:m},finish_reason:a,index:o,logprobs:c}}return f?{index:o,finish_reason:a,logprobs:c,message:{role:m,content:l,tool_calls:f.map((b,v)=>{const{function:T,type:w,id:P}=b,{arguments:k,name:I}=T||{};if(P==null)throw new F(`missing choices[${o}].tool_calls[${v}].id
${nn(n)}`);if(w==null)throw new F(`missing choices[${o}].tool_calls[${v}].type
${nn(n)}`);if(I==null)throw new F(`missing choices[${o}].tool_calls[${v}].function.name
${nn(n)}`);if(k==null)throw new F(`missing choices[${o}].tool_calls[${v}].function.arguments
${nn(n)}`);return{id:P,type:w,function:{name:I,arguments:k}}})}}:{message:{content:l,role:m},finish_reason:a,index:o,logprobs:c}}),created:r,model:s,object:"chat.completion"}}function nn(n){return JSON.stringify(n)}class Mt extends Ur{static fromReadableStream(e){const t=new Mt;return t._run(()=>t._fromReadableStream(e)),t}static runFunctions(e,t,r){const s=new Mt,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runFunctions"}};return s._run(()=>s._runFunctions(e,t,i)),s}static runTools(e,t,r){const s=new Mt,i={...r,headers:{...r==null?void 0:r.headers,"X-Stainless-Helper-Method":"runTools"}};return s._run(()=>s._runTools(e,t,i)),s}}let qo=class extends z{runFunctions(e,t){return e.stream?Mt.runFunctions(this._client.chat.completions,e,t):Lr.runFunctions(this._client.chat.completions,e,t)}runTools(e,t){return e.stream?Mt.runTools(this._client.chat.completions,e,t):Lr.runTools(this._client.chat.completions,e,t)}stream(e,t){return Ur.createChatCompletion(this._client.chat.completions,e,t)}};class An extends z{constructor(){super(...arguments),this.completions=new qo(this._client)}}(function(n){n.Completions=qo})(An||(An={}));let In=class extends z{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/messages/${t}/files/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return De(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/messages/${t}/files`,xi,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}};class xi extends Ge{}(function(n){n.MessageFilesPage=xi})(In||(In={}));class kn extends z{constructor(){super(...arguments),this.files=new In(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/messages`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/messages/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/messages/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return De(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/messages`,Ri,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}}class Ri extends Ge{}(function(n){n.ThreadMessagesPage=Ri,n.Files=In,n.MessageFilesPage=xi})(kn||(kn={}));class Cn extends z{retrieve(e,t,r,s){return this._client.get(`/threads/${e}/runs/${t}/steps/${r}`,{...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t,r={},s){return De(r)?this.list(e,t,{},r):this._client.getAPIList(`/threads/${e}/runs/${t}/steps`,ji,{query:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}}class ji extends Ge{}(function(n){n.RunStepsPage=ji})(Cn||(Cn={}));class Sn extends z{constructor(){super(...arguments),this.steps=new Cn(this._client)}create(e,t,r){return this._client.post(`/threads/${e}/runs`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}retrieve(e,t,r){return this._client.get(`/threads/${e}/runs/${t}`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}update(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}list(e,t={},r){return De(t)?this.list(e,{},t):this._client.getAPIList(`/threads/${e}/runs`,$i,{query:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}cancel(e,t,r){return this._client.post(`/threads/${e}/runs/${t}/cancel`,{...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}submitToolOutputs(e,t,r,s){return this._client.post(`/threads/${e}/runs/${t}/submit_tool_outputs`,{body:r,...s,headers:{"OpenAI-Beta":"assistants=v1",...s==null?void 0:s.headers}})}}class $i extends Ge{}(function(n){n.RunsPage=$i,n.Steps=Cn,n.RunStepsPage=ji})(Sn||(Sn={}));class xn extends z{constructor(){super(...arguments),this.runs=new Sn(this._client),this.messages=new kn(this._client)}create(e={},t){return De(e)?this.create({},e):this._client.post("/threads",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}retrieve(e,t){return this._client.get(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}update(e,t,r){return this._client.post(`/threads/${e}`,{body:t,...r,headers:{"OpenAI-Beta":"assistants=v1",...r==null?void 0:r.headers}})}del(e,t){return this._client.delete(`/threads/${e}`,{...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}createAndRun(e,t){return this._client.post("/threads/runs",{body:e,...t,headers:{"OpenAI-Beta":"assistants=v1",...t==null?void 0:t.headers}})}}(function(n){n.Runs=Sn,n.RunsPage=$i,n.Messages=kn,n.ThreadMessagesPage=Ri})(xn||(xn={}));class Rn extends z{constructor(){super(...arguments),this.chat=new An(this._client),this.assistants=new On(this._client),this.threads=new xn(this._client)}}(function(n){n.Chat=An,n.Assistants=On,n.AssistantsPage=Si,n.Threads=xn})(Rn||(Rn={}));class jn extends z{create(e,t){return this._client.post("/completions",{body:e,...t,stream:e.stream??!1})}}jn||(jn={});let $n=class extends z{create(e,t){return this._client.post("/embeddings",{body:e,...t})}};$n||($n={});class Nn extends z{create(e,t){return this._client.post("/edits",{body:e,...t})}}Nn||(Nn={});class Dn extends z{create(e,t){return this._client.post("/files",Dr({body:e,...t}))}retrieve(e,t){return this._client.get(`/files/${e}`,t)}list(e={},t){return De(e)?this.list({},e):this._client.getAPIList("/files",Ni,{query:e,...t})}del(e,t){return this._client.delete(`/files/${e}`,t)}content(e,t){return this._client.get(`/files/${e}/content`,{...t,__binaryResponse:!0})}retrieveContent(e,t){return this._client.get(`/files/${e}/content`,{...t,headers:{Accept:"application/json",...t==null?void 0:t.headers}})}async waitForProcessing(e,{pollInterval:t=5e3,maxWait:r=30*60*1e3}={}){const s=new Set(["processed","error","deleted"]),i=Date.now();let a=await this.retrieve(e);for(;!a.status||!s.has(a.status);)if(await Zo(t),a=await this.retrieve(e),Date.now()-i>r)throw new Wn({message:`Giving up on waiting for file ${e} to finish processing after ${r} milliseconds.`});return a}}class Ni extends Xn{}(function(n){n.FileObjectsPage=Ni})(Dn||(Dn={}));class Ln extends z{create(e,t){return this._client.post("/fine-tunes",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine-tunes/${e}`,t)}list(e){return this._client.getAPIList("/fine-tunes",Di,e)}cancel(e,t){return this._client.post(`/fine-tunes/${e}/cancel`,t)}listEvents(e,t,r){return this._client.get(`/fine-tunes/${e}/events`,{query:t,timeout:864e5,...r,stream:(t==null?void 0:t.stream)??!1})}}class Di extends Xn{}(function(n){n.FineTunesPage=Di})(Ln||(Ln={}));class Un extends z{create(e,t){return this._client.post("/fine_tuning/jobs",{body:e,...t})}retrieve(e,t){return this._client.get(`/fine_tuning/jobs/${e}`,t)}list(e={},t){return De(e)?this.list({},e):this._client.getAPIList("/fine_tuning/jobs",Li,{query:e,...t})}cancel(e,t){return this._client.post(`/fine_tuning/jobs/${e}/cancel`,t)}listEvents(e,t={},r){return De(t)?this.listEvents(e,{},t):this._client.getAPIList(`/fine_tuning/jobs/${e}/events`,Ui,{query:t,...r})}}class Li extends Ge{}class Ui extends Ge{}(function(n){n.FineTuningJobsPage=Li,n.FineTuningJobEventsPage=Ui})(Un||(Un={}));class Zn extends z{constructor(){super(...arguments),this.jobs=new Un(this._client)}}(function(n){n.Jobs=Un,n.FineTuningJobsPage=Li,n.FineTuningJobEventsPage=Ui})(Zn||(Zn={}));class Mn extends z{createVariation(e,t){return this._client.post("/images/variations",Dr({body:e,...t}))}edit(e,t){return this._client.post("/images/edits",Dr({body:e,...t}))}generate(e,t){return this._client.post("/images/generations",{body:e,...t})}}Mn||(Mn={});class Fn extends z{retrieve(e,t){return this._client.get(`/models/${e}`,t)}list(e){return this._client.getAPIList("/models",Zi,e)}del(e,t){return this._client.delete(`/models/${e}`,t)}}class Zi extends Xn{}(function(n){n.ModelsPage=Zi})(Fn||(Fn={}));class Bn extends z{create(e,t){return this._client.post("/moderations",{body:e,...t})}}Bn||(Bn={});var Ko;let G=class extends kl{constructor({baseURL:e=As("OPENAI_BASE_URL"),apiKey:t=As("OPENAI_API_KEY"),organization:r=As("OPENAI_ORG_ID")??null,...s}={}){if(t===void 0)throw new F("The OPENAI_API_KEY environment variable is missing or empty; either provide it, or instantiate the OpenAI client with an apiKey option, like new OpenAI({ apiKey: 'My API Key' }).");const i={apiKey:t,organization:r,...s,baseURL:e??"https://api.openai.com/v1"};if(!i.dangerouslyAllowBrowser&&Ml())throw new F(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new OpenAI({ apiKey, dangerouslyAllowBrowser: true });

https://help.openai.com/en/articles/5112595-best-practices-for-api-key-safety
`);super({baseURL:i.baseURL,timeout:i.timeout??6e5,httpAgent:i.httpAgent,maxRetries:i.maxRetries,fetch:i.fetch}),this.completions=new jn(this),this.chat=new _n(this),this.edits=new Nn(this),this.embeddings=new $n(this),this.files=new Dn(this),this.images=new Mn(this),this.audio=new Tn(this),this.moderations=new Bn(this),this.models=new Fn(this),this.fineTuning=new Zn(this),this.fineTunes=new Ln(this),this.beta=new Rn(this),this._options=i,this.apiKey=t,this.organization=r}defaultQuery(){return this._options.defaultQuery}defaultHeaders(e){return{...super.defaultHeaders(e),"OpenAI-Organization":this.organization,...this._options.defaultHeaders}}authHeaders(e){return{Authorization:`Bearer ${this.apiKey}`}}};Ko=G;G.OpenAI=Ko;G.OpenAIError=F;G.APIError=de;G.APIConnectionError=qr;G.APIConnectionTimeoutError=Wn;G.APIUserAbortError=at;G.NotFoundError=Oi;G.ConflictError=Pi;G.RateLimitError=Ii;G.BadRequestError=wi;G.AuthenticationError=Ti;G.InternalServerError=ki;G.PermissionDeniedError=Ei;G.UnprocessableEntityError=Ai;const{OpenAIError:Og,APIError:Pg,APIConnectionError:Ag,APIConnectionTimeoutError:Bl,APIUserAbortError:Vl,NotFoundError:Ig,ConflictError:kg,RateLimitError:Cg,BadRequestError:Sg,AuthenticationError:xg,InternalServerError:Rg,PermissionDeniedError:jg,UnprocessableEntityError:$g}=gl;(function(n){n.toFile=Do,n.fileFromPath=Ro,n.Page=Xn,n.CursorPage=Ge,n.Completions=jn,n.Chat=_n,n.Edits=Nn,n.Embeddings=$n,n.Files=Dn,n.FileObjectsPage=Ni,n.Images=Mn,n.Audio=Tn,n.Moderations=Bn,n.Models=Fn,n.ModelsPage=Zi,n.FineTuning=Zn,n.FineTunes=Ln,n.FineTunesPage=Di,n.Beta=Rn})(G||(G={}));var zl=function(n,e){if(typeof n!="string")throw new TypeError("Expected a string");return e=typeof e>"u"?"_":e,n.replace(/([a-z\d])([A-Z])/g,"$1"+e+"$2").replace(/([A-Z]+)([A-Z][a-z\d]+)/g,"$1"+e+"$2").toLowerCase()};const ql=_i(zl);var Ho={exports:{}};const Kl=/[\p{Lu}]/u,Hl=/[\p{Ll}]/u,va=/^[\p{Lu}](?![\p{Lu}])/gu,Jo=/([\p{Alpha}\p{N}_]|$)/u,Go=/[_.\- ]+/,Jl=new RegExp("^"+Go.source),wa=new RegExp(Go.source+Jo.source,"gu"),Ta=new RegExp("\\d+"+Jo.source,"gu"),Gl=(n,e,t)=>{let r=!1,s=!1,i=!1;for(let a=0;a<n.length;a++){const o=n[a];r&&Kl.test(o)?(n=n.slice(0,a)+"-"+n.slice(a),r=!1,i=s,s=!0,a++):s&&i&&Hl.test(o)?(n=n.slice(0,a-1)+"-"+n.slice(a-1),i=s,s=!1,r=!0):(r=e(o)===o&&t(o)!==o,i=s,s=t(o)===o&&e(o)!==o)}return n},Wl=(n,e)=>(va.lastIndex=0,n.replace(va,t=>e(t))),Yl=(n,e)=>(wa.lastIndex=0,Ta.lastIndex=0,n.replace(wa,(t,r)=>e(r)).replace(Ta,t=>e(t))),Wo=(n,e)=>{if(!(typeof n=="string"||Array.isArray(n)))throw new TypeError("Expected the input to be `string | string[]`");if(e={pascalCase:!1,preserveConsecutiveUppercase:!1,...e},Array.isArray(n)?n=n.map(i=>i.trim()).filter(i=>i.length).join("-"):n=n.trim(),n.length===0)return"";const t=e.locale===!1?i=>i.toLowerCase():i=>i.toLocaleLowerCase(e.locale),r=e.locale===!1?i=>i.toUpperCase():i=>i.toLocaleUpperCase(e.locale);return n.length===1?e.pascalCase?r(n):t(n):(n!==t(n)&&(n=Gl(n,t,r)),n=n.replace(Jl,""),e.preserveConsecutiveUppercase?n=Wl(n,t):n=t(n),e.pascalCase&&(n=r(n.charAt(0))+n.slice(1)),Yl(n,r))};Ho.exports=Wo;Ho.exports.default=Wo;function Xl(n,e){return(e==null?void 0:e[n])||ql(n)}function Ql(n,e,t){const r={};for(const s in n)Object.hasOwn(n,s)&&(r[e(s,t)]=n[s]);return r}function Ea(n){return Array.isArray(n)?[...n]:{...n}}function ed(n,e){const t=Ea(n);for(const[r,s]of Object.entries(e)){const[i,...a]=r.split(".").reverse();let o=t;for(const c of a.reverse()){if(o[c]===void 0)break;o[c]=Ea(o[c]),o=o[c]}o[i]!==void 0&&(o[i]={lc:1,type:"secret",id:[s]})}return t}function Yo(n){const e=Object.getPrototypeOf(n);return typeof n.lc_name=="function"&&(typeof e.lc_name!="function"||n.lc_name()!==e.lc_name())?n.lc_name():n.name}class ot{static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Yo(this.constructor)]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}constructor(e,...t){Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.lc_kwargs=e||{}}toJSON(){if(!this.lc_serializable)return this.toJSONNotImplemented();if(this.lc_kwargs instanceof ot||typeof this.lc_kwargs!="object"||Array.isArray(this.lc_kwargs))return this.toJSONNotImplemented();const e={},t={},r=Object.keys(this.lc_kwargs).reduce((s,i)=>(s[i]=i in this?this[i]:this.lc_kwargs[i],s),{});for(let s=Object.getPrototypeOf(this);s;s=Object.getPrototypeOf(s))Object.assign(e,Reflect.get(s,"lc_aliases",this)),Object.assign(t,Reflect.get(s,"lc_secrets",this)),Object.assign(r,Reflect.get(s,"lc_attributes",this));return Object.keys(t).forEach(s=>{let i=this,a=r;const[o,...c]=s.split(".").reverse();for(const l of c.reverse()){if(!(l in i)||i[l]===void 0)return;(!(l in a)||a[l]===void 0)&&(typeof i[l]=="object"&&i[l]!=null?a[l]={}:Array.isArray(i[l])&&(a[l]=[])),i=i[l],a=a[l]}o in i&&i[o]!==void 0&&(a[o]=a[o]||i[o])}),{lc:1,type:"constructor",id:this.lc_id,kwargs:Ql(Object.keys(t).length?ed(r,t):r,Xl,e)}}toJSONNotImplemented(){return{lc:1,type:"not_implemented",id:this.lc_id}}}function Jt(n,e){return typeof n=="string"?typeof e=="string"?n+e:[{type:"text",text:n},...e]:Array.isArray(e)?[...n,...e]:[...n,{type:"text",text:e}]}class Kr extends ot{get lc_aliases(){return{additional_kwargs:"additional_kwargs"}}get text(){return typeof this.content=="string"?this.content:""}constructor(e,t){typeof e=="string"&&(e={content:e,additional_kwargs:t}),e.additional_kwargs||(e.additional_kwargs={}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","messages"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"content",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"additional_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name=e.name,this.content=e.content,this.additional_kwargs=e.additional_kwargs}toDict(){return{type:this._getType(),data:this.toJSON().kwargs}}toChunk(){const e=this._getType();if(e==="human")return new Zr({...this});if(e==="ai")return new Mr({...this});if(e==="system")return new Fr({...this});if(e==="function")return new Br({...this});if(Mi.isInstance(this))return new Vr({...this});throw new Error("Unknown message type.")}}function Oa(n){return Array.isArray(n)&&n.every(e=>typeof e.index=="number")}class Gt extends Kr{static _mergeAdditionalKwargs(e,t){var s,i;const r={...e};for(const[a,o]of Object.entries(t))if(r[a]===void 0)r[a]=o;else{if(typeof r[a]!=typeof o)throw new Error(`additional_kwargs[${a}] already exists in the message chunk, but with a different type.`);if(typeof r[a]=="string")r[a]=r[a]+o;else if(!Array.isArray(r[a])&&typeof r[a]=="object")r[a]=this._mergeAdditionalKwargs(r[a],o);else if(a==="tool_calls"&&Oa(r[a])&&Oa(o))for(const c of o)((s=r[a])==null?void 0:s[c.index])!==void 0?r[a]=(i=r[a])==null?void 0:i.map((l,d)=>d!==c.index?l:{...l,...c,function:{name:c.function.name??l.function.name,arguments:(l.function.arguments??"")+(c.function.arguments??"")}}):r[a][c.index]=c;else throw new Error(`additional_kwargs[${a}] already exists in this message chunk.`)}return r}}class Vn extends Kr{static lc_name(){return"HumanMessage"}_getType(){return"human"}}class Zr extends Gt{static lc_name(){return"HumanMessageChunk"}_getType(){return"human"}concat(e){return new Zr({content:Jt(this.content,e.content),additional_kwargs:Zr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class Xo extends Kr{static lc_name(){return"AIMessage"}_getType(){return"ai"}}class Mr extends Gt{static lc_name(){return"AIMessageChunk"}_getType(){return"ai"}concat(e){return new Mr({content:Jt(this.content,e.content),additional_kwargs:Mr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class td extends Kr{static lc_name(){return"SystemMessage"}_getType(){return"system"}}class Fr extends Gt{static lc_name(){return"SystemMessageChunk"}_getType(){return"system"}concat(e){return new Fr({content:Jt(this.content,e.content),additional_kwargs:Fr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs)})}}class Br extends Gt{static lc_name(){return"FunctionMessageChunk"}_getType(){return"function"}concat(e){return new Br({content:Jt(this.content,e.content),additional_kwargs:Br._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),name:this.name??""})}}class zn extends Gt{constructor(e){super(e),Object.defineProperty(this,"tool_call_id",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.tool_call_id=e.tool_call_id}static lc_name(){return"ToolMessageChunk"}_getType(){return"tool"}concat(e){return new zn({content:Jt(this.content,e.content),additional_kwargs:zn._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),tool_call_id:this.tool_call_id})}}class Mi extends Kr{static lc_name(){return"ChatMessage"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}static isInstance(e){return e._getType()==="generic"}}function rd(n){return typeof(n==null?void 0:n._getType)=="function"}function kr(n){if(typeof n=="string")return new Vn(n);if(rd(n))return n;const[e,t]=n;if(e==="human"||e==="user")return new Vn({content:t});if(e==="ai"||e==="assistant")return new Xo({content:t});if(e==="system")return new td({content:t});throw new Error("Unable to coerce message from array: only human, AI, or system message coercion is currently supported.")}class Vr extends Gt{static lc_name(){return"ChatMessageChunk"}constructor(e,t){typeof e=="string"&&(e={content:e,role:t}),super(e),Object.defineProperty(this,"role",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.role=e.role}_getType(){return"generic"}concat(e){return new Vr({content:Jt(this.content,e.content),additional_kwargs:Vr._mergeAdditionalKwargs(this.additional_kwargs,e.additional_kwargs),role:this.role})}}function Qo(n,e="Human",t="AI"){const r=[];for(const s of n){let i;if(s._getType()==="human")i=e;else if(s._getType()==="ai")i=t;else if(s._getType()==="system")i="System";else if(s._getType()==="function")i="Function";else if(s._getType()==="tool")i="Tool";else if(s._getType()==="generic")i=s.role;else throw new Error(`Got unsupported message type: ${s._getType()}`);const a=s.name?`${s.name}, `:"";r.push(`${i}: ${a}${s.content}`)}return r.join(`
`)}const Pa="__run";class Fi{constructor(e){Object.defineProperty(this,"text",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"generationInfo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.text=e.text,this.generationInfo=e.generationInfo}concat(e){return new Fi({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo}})}}class Bi extends Fi{constructor(e){super(e),Object.defineProperty(this,"message",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.message=e.message}concat(e){return new Bi({text:this.text+e.text,generationInfo:{...this.generationInfo,...e.generationInfo},message:this.message.concat(e.message)})}}var Ss={};const nd=()=>typeof window<"u"&&typeof window.document<"u",sd=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",id=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),ec=()=>typeof Deno<"u",ad=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!ec(),od=()=>{let n;return nd()?n="browser":ad()?n="node":sd()?n="webworker":id()?n="jsdom":ec()?n="deno":n="other",n};let xs;async function cd(){return xs===void 0&&(xs={library:"langchain-js",runtime:od()}),xs}function J(n){try{return typeof process<"u"?Ss==null?void 0:Ss[n]:void 0}catch{return}}/*
 * [js-sha1]{@link https://github.com/emn178/js-sha1}
 *
 * @version 0.6.0
 * @author Chen, Yi-Cyuan [emn178@gmail.com]
 * @copyright Chen, Yi-Cyuan 2014-2017
 * @license MIT
 */var ud=typeof window=="object"?window:{},$="0123456789abcdef".split(""),ld=[-2147483648,8388608,32768,128],Oe=[24,16,8,0],W=[];function ke(n){n?(W[0]=W[16]=W[1]=W[2]=W[3]=W[4]=W[5]=W[6]=W[7]=W[8]=W[9]=W[10]=W[11]=W[12]=W[13]=W[14]=W[15]=0,this.blocks=W):this.blocks=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.h0=1732584193,this.h1=4023233417,this.h2=2562383102,this.h3=271733878,this.h4=3285377520,this.block=this.start=this.bytes=this.hBytes=0,this.finalized=this.hashed=!1,this.first=!0}ke.prototype.update=function(n){if(!this.finalized){var e=typeof n!="string";e&&n.constructor===ud.ArrayBuffer&&(n=new Uint8Array(n));for(var t,r=0,s,i=n.length||0,a=this.blocks;r<i;){if(this.hashed&&(this.hashed=!1,a[0]=this.block,a[16]=a[1]=a[2]=a[3]=a[4]=a[5]=a[6]=a[7]=a[8]=a[9]=a[10]=a[11]=a[12]=a[13]=a[14]=a[15]=0),e)for(s=this.start;r<i&&s<64;++r)a[s>>2]|=n[r]<<Oe[s++&3];else for(s=this.start;r<i&&s<64;++r)t=n.charCodeAt(r),t<128?a[s>>2]|=t<<Oe[s++&3]:t<2048?(a[s>>2]|=(192|t>>6)<<Oe[s++&3],a[s>>2]|=(128|t&63)<<Oe[s++&3]):t<55296||t>=57344?(a[s>>2]|=(224|t>>12)<<Oe[s++&3],a[s>>2]|=(128|t>>6&63)<<Oe[s++&3],a[s>>2]|=(128|t&63)<<Oe[s++&3]):(t=65536+((t&1023)<<10|n.charCodeAt(++r)&1023),a[s>>2]|=(240|t>>18)<<Oe[s++&3],a[s>>2]|=(128|t>>12&63)<<Oe[s++&3],a[s>>2]|=(128|t>>6&63)<<Oe[s++&3],a[s>>2]|=(128|t&63)<<Oe[s++&3]);this.lastByteIndex=s,this.bytes+=s-this.start,s>=64?(this.block=a[16],this.start=s-64,this.hash(),this.hashed=!0):this.start=s}return this.bytes>4294967295&&(this.hBytes+=this.bytes/4294967296<<0,this.bytes=this.bytes%4294967296),this}};ke.prototype.finalize=function(){if(!this.finalized){this.finalized=!0;var n=this.blocks,e=this.lastByteIndex;n[16]=this.block,n[e>>2]|=ld[e&3],this.block=n[16],e>=56&&(this.hashed||this.hash(),n[0]=this.block,n[16]=n[1]=n[2]=n[3]=n[4]=n[5]=n[6]=n[7]=n[8]=n[9]=n[10]=n[11]=n[12]=n[13]=n[14]=n[15]=0),n[14]=this.hBytes<<3|this.bytes>>>29,n[15]=this.bytes<<3,this.hash()}};ke.prototype.hash=function(){var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4,i,a,o,c=this.blocks;for(a=16;a<80;++a)o=c[a-3]^c[a-8]^c[a-14]^c[a-16],c[a]=o<<1|o>>>31;for(a=0;a<20;a+=5)i=e&t|~e&r,o=n<<5|n>>>27,s=o+i+s+1518500249+c[a]<<0,e=e<<30|e>>>2,i=n&e|~n&t,o=s<<5|s>>>27,r=o+i+r+1518500249+c[a+1]<<0,n=n<<30|n>>>2,i=s&n|~s&e,o=r<<5|r>>>27,t=o+i+t+1518500249+c[a+2]<<0,s=s<<30|s>>>2,i=r&s|~r&n,o=t<<5|t>>>27,e=o+i+e+1518500249+c[a+3]<<0,r=r<<30|r>>>2,i=t&r|~t&s,o=e<<5|e>>>27,n=o+i+n+1518500249+c[a+4]<<0,t=t<<30|t>>>2;for(;a<40;a+=5)i=e^t^r,o=n<<5|n>>>27,s=o+i+s+1859775393+c[a]<<0,e=e<<30|e>>>2,i=n^e^t,o=s<<5|s>>>27,r=o+i+r+1859775393+c[a+1]<<0,n=n<<30|n>>>2,i=s^n^e,o=r<<5|r>>>27,t=o+i+t+1859775393+c[a+2]<<0,s=s<<30|s>>>2,i=r^s^n,o=t<<5|t>>>27,e=o+i+e+1859775393+c[a+3]<<0,r=r<<30|r>>>2,i=t^r^s,o=e<<5|e>>>27,n=o+i+n+1859775393+c[a+4]<<0,t=t<<30|t>>>2;for(;a<60;a+=5)i=e&t|e&r|t&r,o=n<<5|n>>>27,s=o+i+s-1894007588+c[a]<<0,e=e<<30|e>>>2,i=n&e|n&t|e&t,o=s<<5|s>>>27,r=o+i+r-1894007588+c[a+1]<<0,n=n<<30|n>>>2,i=s&n|s&e|n&e,o=r<<5|r>>>27,t=o+i+t-1894007588+c[a+2]<<0,s=s<<30|s>>>2,i=r&s|r&n|s&n,o=t<<5|t>>>27,e=o+i+e-1894007588+c[a+3]<<0,r=r<<30|r>>>2,i=t&r|t&s|r&s,o=e<<5|e>>>27,n=o+i+n-1894007588+c[a+4]<<0,t=t<<30|t>>>2;for(;a<80;a+=5)i=e^t^r,o=n<<5|n>>>27,s=o+i+s-899497514+c[a]<<0,e=e<<30|e>>>2,i=n^e^t,o=s<<5|s>>>27,r=o+i+r-899497514+c[a+1]<<0,n=n<<30|n>>>2,i=s^n^e,o=r<<5|r>>>27,t=o+i+t-899497514+c[a+2]<<0,s=s<<30|s>>>2,i=r^s^n,o=t<<5|t>>>27,e=o+i+e-899497514+c[a+3]<<0,r=r<<30|r>>>2,i=t^r^s,o=e<<5|e>>>27,n=o+i+n-899497514+c[a+4]<<0,t=t<<30|t>>>2;this.h0=this.h0+n<<0,this.h1=this.h1+e<<0,this.h2=this.h2+t<<0,this.h3=this.h3+r<<0,this.h4=this.h4+s<<0};ke.prototype.hex=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return $[n>>28&15]+$[n>>24&15]+$[n>>20&15]+$[n>>16&15]+$[n>>12&15]+$[n>>8&15]+$[n>>4&15]+$[n&15]+$[e>>28&15]+$[e>>24&15]+$[e>>20&15]+$[e>>16&15]+$[e>>12&15]+$[e>>8&15]+$[e>>4&15]+$[e&15]+$[t>>28&15]+$[t>>24&15]+$[t>>20&15]+$[t>>16&15]+$[t>>12&15]+$[t>>8&15]+$[t>>4&15]+$[t&15]+$[r>>28&15]+$[r>>24&15]+$[r>>20&15]+$[r>>16&15]+$[r>>12&15]+$[r>>8&15]+$[r>>4&15]+$[r&15]+$[s>>28&15]+$[s>>24&15]+$[s>>20&15]+$[s>>16&15]+$[s>>12&15]+$[s>>8&15]+$[s>>4&15]+$[s&15]};ke.prototype.toString=ke.prototype.hex;ke.prototype.digest=function(){this.finalize();var n=this.h0,e=this.h1,t=this.h2,r=this.h3,s=this.h4;return[n>>24&255,n>>16&255,n>>8&255,n&255,e>>24&255,e>>16&255,e>>8&255,e&255,t>>24&255,t>>16&255,t>>8&255,t&255,r>>24&255,r>>16&255,r>>8&255,r&255,s>>24&255,s>>16&255,s>>8&255,s&255]};ke.prototype.array=ke.prototype.digest;ke.prototype.arrayBuffer=function(){this.finalize();var n=new ArrayBuffer(20),e=new DataView(n);return e.setUint32(0,this.h0),e.setUint32(4,this.h1),e.setUint32(8,this.h2),e.setUint32(12,this.h3),e.setUint32(16,this.h4),n};const dd=n=>new ke(!0).update(n).hex(),Aa=(...n)=>dd(n.join("_"));class hd{}const fd=new Map;class Vi extends hd{constructor(e){super(),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.cache=e??new Map}lookup(e,t){return Promise.resolve(this.cache.get(Aa(e,t))??null)}async update(e,t,r){this.cache.set(Aa(e,t),r)}static global(){return new Vi(fd)}}class tc extends ot{}class rc extends tc{static lc_name(){return"StringPromptValue"}constructor(e){super({value:e}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"value",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.value=e}toString(){return this.value}toChatMessages(){return[new Vn(this.value)]}}class pd extends tc{static lc_name(){return"ChatPromptValue"}constructor(e){Array.isArray(e)&&(e={messages:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompt_values"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"messages",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.messages=e.messages}toString(){return Qo(this.messages)}toChatMessages(){return this.messages}}var Qn={exports:{}},nc={};function be(n,e){typeof e=="boolean"&&(e={forever:e}),this._originalTimeouts=JSON.parse(JSON.stringify(n)),this._timeouts=n,this._options=e||{},this._maxRetryTime=e&&e.maxRetryTime||1/0,this._fn=null,this._errors=[],this._attempts=1,this._operationTimeout=null,this._operationTimeoutCb=null,this._timeout=null,this._operationStart=null,this._timer=null,this._options.forever&&(this._cachedTimeouts=this._timeouts.slice(0))}var md=be;be.prototype.reset=function(){this._attempts=1,this._timeouts=this._originalTimeouts.slice(0)};be.prototype.stop=function(){this._timeout&&clearTimeout(this._timeout),this._timer&&clearTimeout(this._timer),this._timeouts=[],this._cachedTimeouts=null};be.prototype.retry=function(n){if(this._timeout&&clearTimeout(this._timeout),!n)return!1;var e=new Date().getTime();if(n&&e-this._operationStart>=this._maxRetryTime)return this._errors.push(n),this._errors.unshift(new Error("RetryOperation timeout occurred")),!1;this._errors.push(n);var t=this._timeouts.shift();if(t===void 0)if(this._cachedTimeouts)this._errors.splice(0,this._errors.length-1),t=this._cachedTimeouts.slice(-1);else return!1;var r=this;return this._timer=setTimeout(function(){r._attempts++,r._operationTimeoutCb&&(r._timeout=setTimeout(function(){r._operationTimeoutCb(r._attempts)},r._operationTimeout),r._options.unref&&r._timeout.unref()),r._fn(r._attempts)},t),this._options.unref&&this._timer.unref(),!0};be.prototype.attempt=function(n,e){this._fn=n,e&&(e.timeout&&(this._operationTimeout=e.timeout),e.cb&&(this._operationTimeoutCb=e.cb));var t=this;this._operationTimeoutCb&&(this._timeout=setTimeout(function(){t._operationTimeoutCb()},t._operationTimeout)),this._operationStart=new Date().getTime(),this._fn(this._attempts)};be.prototype.try=function(n){console.log("Using RetryOperation.try() is deprecated"),this.attempt(n)};be.prototype.start=function(n){console.log("Using RetryOperation.start() is deprecated"),this.attempt(n)};be.prototype.start=be.prototype.try;be.prototype.errors=function(){return this._errors};be.prototype.attempts=function(){return this._attempts};be.prototype.mainError=function(){if(this._errors.length===0)return null;for(var n={},e=null,t=0,r=0;r<this._errors.length;r++){var s=this._errors[r],i=s.message,a=(n[i]||0)+1;n[i]=a,a>=t&&(e=s,t=a)}return e};(function(n){var e=md;n.operation=function(t){var r=n.timeouts(t);return new e(r,{forever:t&&(t.forever||t.retries===1/0),unref:t&&t.unref,maxRetryTime:t&&t.maxRetryTime})},n.timeouts=function(t){if(t instanceof Array)return[].concat(t);var r={retries:10,factor:2,minTimeout:1*1e3,maxTimeout:1/0,randomize:!1};for(var s in t)r[s]=t[s];if(r.minTimeout>r.maxTimeout)throw new Error("minTimeout is greater than maxTimeout");for(var i=[],a=0;a<r.retries;a++)i.push(this.createTimeout(a,r));return t&&t.forever&&!i.length&&i.push(this.createTimeout(a,r)),i.sort(function(o,c){return o-c}),i},n.createTimeout=function(t,r){var s=r.randomize?Math.random()+1:1,i=Math.round(s*Math.max(r.minTimeout,1)*Math.pow(r.factor,t));return i=Math.min(i,r.maxTimeout),i},n.wrap=function(t,r,s){if(r instanceof Array&&(s=r,r=null),!s){s=[];for(var i in t)typeof t[i]=="function"&&s.push(i)}for(var a=0;a<s.length;a++){var o=s[a],c=t[o];t[o]=(function(d){var f=n.operation(r),m=Array.prototype.slice.call(arguments,1),b=m.pop();m.push(function(v){f.retry(v)||(v&&(arguments[0]=f.mainError()),b.apply(this,arguments))}),f.attempt(function(){d.apply(t,m)})}).bind(t,c),t[o].options=r}}})(nc);var gd=nc;const yd=gd,_d=["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Network request failed"];class sc extends Error{constructor(e){super(),e instanceof Error?(this.originalError=e,{message:e}=e):(this.originalError=new Error(e),this.originalError.stack=this.stack),this.name="AbortError",this.message=e}}const bd=(n,e,t)=>{const r=t.retries-(e-1);return n.attemptNumber=e,n.retriesLeft=r,n},vd=n=>_d.includes(n),ic=(n,e)=>new Promise((t,r)=>{e={onFailedAttempt:()=>{},retries:10,...e};const s=yd.operation(e);s.attempt(async i=>{try{t(await n(i))}catch(a){if(!(a instanceof Error)){r(new TypeError(`Non-error was thrown: "${a}". You should only throw errors.`));return}if(a instanceof sc)s.stop(),r(a.originalError);else if(a instanceof TypeError&&!vd(a.message))s.stop(),r(a);else{bd(a,i,e);try{await e.onFailedAttempt(a)}catch(o){r(o);return}s.retry(a)||r(s.mainError())}}})});Qn.exports=ic;Qn.exports.default=ic;Qn.exports.AbortError=sc;var wd=Qn.exports;const qn=_i(wd);var ac={},oc={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function r(){}Object.create&&(r.prototype=Object.create(null),new r().__proto__||(t=!1));function s(c,l,d){this.fn=c,this.context=l,this.once=d||!1}function i(c,l,d,f,m){if(typeof d!="function")throw new TypeError("The listener must be a function");var b=new s(d,f||c,m),v=t?t+l:l;return c._events[v]?c._events[v].fn?c._events[v]=[c._events[v],b]:c._events[v].push(b):(c._events[v]=b,c._eventsCount++),c}function a(c,l){--c._eventsCount===0?c._events=new r:delete c._events[l]}function o(){this._events=new r,this._eventsCount=0}o.prototype.eventNames=function(){var l=[],d,f;if(this._eventsCount===0)return l;for(f in d=this._events)e.call(d,f)&&l.push(t?f.slice(1):f);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(d)):l},o.prototype.listeners=function(l){var d=t?t+l:l,f=this._events[d];if(!f)return[];if(f.fn)return[f.fn];for(var m=0,b=f.length,v=new Array(b);m<b;m++)v[m]=f[m].fn;return v},o.prototype.listenerCount=function(l){var d=t?t+l:l,f=this._events[d];return f?f.fn?1:f.length:0},o.prototype.emit=function(l,d,f,m,b,v){var T=t?t+l:l;if(!this._events[T])return!1;var w=this._events[T],P=arguments.length,k,I;if(w.fn){switch(w.once&&this.removeListener(l,w.fn,void 0,!0),P){case 1:return w.fn.call(w.context),!0;case 2:return w.fn.call(w.context,d),!0;case 3:return w.fn.call(w.context,d,f),!0;case 4:return w.fn.call(w.context,d,f,m),!0;case 5:return w.fn.call(w.context,d,f,m,b),!0;case 6:return w.fn.call(w.context,d,f,m,b,v),!0}for(I=1,k=new Array(P-1);I<P;I++)k[I-1]=arguments[I];w.fn.apply(w.context,k)}else{var Z=w.length,D;for(I=0;I<Z;I++)switch(w[I].once&&this.removeListener(l,w[I].fn,void 0,!0),P){case 1:w[I].fn.call(w[I].context);break;case 2:w[I].fn.call(w[I].context,d);break;case 3:w[I].fn.call(w[I].context,d,f);break;case 4:w[I].fn.call(w[I].context,d,f,m);break;default:if(!k)for(D=1,k=new Array(P-1);D<P;D++)k[D-1]=arguments[D];w[I].fn.apply(w[I].context,k)}}return!0},o.prototype.on=function(l,d,f){return i(this,l,d,f,!1)},o.prototype.once=function(l,d,f){return i(this,l,d,f,!0)},o.prototype.removeListener=function(l,d,f,m){var b=t?t+l:l;if(!this._events[b])return this;if(!d)return a(this,b),this;var v=this._events[b];if(v.fn)v.fn===d&&(!m||v.once)&&(!f||v.context===f)&&a(this,b);else{for(var T=0,w=[],P=v.length;T<P;T++)(v[T].fn!==d||m&&!v[T].once||f&&v[T].context!==f)&&w.push(v[T]);w.length?this._events[b]=w.length===1?w[0]:w:a(this,b)}return this},o.prototype.removeAllListeners=function(l){var d;return l?(d=t?t+l:l,this._events[d]&&a(this,d)):(this._events=new r,this._eventsCount=0),this},o.prototype.off=o.prototype.removeListener,o.prototype.addListener=o.prototype.on,o.prefixed=t,o.EventEmitter=o,n.exports=o})(oc);var Td=oc.exports,es={exports:{}},Ed=(n,e)=>(e=e||(()=>{}),n.then(t=>new Promise(r=>{r(e())}).then(()=>t),t=>new Promise(r=>{r(e())}).then(()=>{throw t})));const Od=Ed;class cc extends Error{constructor(e){super(e),this.name="TimeoutError"}}const uc=(n,e,t)=>new Promise((r,s)=>{if(typeof e!="number"||e<0)throw new TypeError("Expected `milliseconds` to be a positive number");if(e===1/0){r(n);return}const i=setTimeout(()=>{if(typeof t=="function"){try{r(t())}catch(c){s(c)}return}const a=typeof t=="string"?t:`Promise timed out after ${e} milliseconds`,o=t instanceof Error?t:new cc(a);typeof n.cancel=="function"&&n.cancel(),s(o)},e);Od(n.then(r,s),()=>{clearTimeout(i)})});es.exports=uc;es.exports.default=uc;es.exports.TimeoutError=cc;var Pd=es.exports,zi={},qi={};Object.defineProperty(qi,"__esModule",{value:!0});function Ad(n,e,t){let r=0,s=n.length;for(;s>0;){const i=s/2|0;let a=r+i;t(n[a],e)<=0?(r=++a,s-=i+1):s=i}return r}qi.default=Ad;Object.defineProperty(zi,"__esModule",{value:!0});const Id=qi;class kd{constructor(){this._queue=[]}enqueue(e,t){t=Object.assign({priority:0},t);const r={priority:t.priority,run:e};if(this.size&&this._queue[this.size-1].priority>=t.priority){this._queue.push(r);return}const s=Id.default(this._queue,r,(i,a)=>a.priority-i.priority);this._queue.splice(s,0,r)}dequeue(){const e=this._queue.shift();return e==null?void 0:e.run}filter(e){return this._queue.filter(t=>t.priority===e.priority).map(t=>t.run)}get size(){return this._queue.length}}zi.default=kd;Object.defineProperty(ac,"__esModule",{value:!0});const Cd=Td,lc=Pd,Sd=zi,sn=()=>{},xd=new lc.TimeoutError;class Rd extends Cd{constructor(e){var t,r,s,i;if(super(),this._intervalCount=0,this._intervalEnd=0,this._pendingCount=0,this._resolveEmpty=sn,this._resolveIdle=sn,e=Object.assign({carryoverConcurrencyCount:!1,intervalCap:1/0,interval:0,concurrency:1/0,autoStart:!0,queueClass:Sd.default},e),!(typeof e.intervalCap=="number"&&e.intervalCap>=1))throw new TypeError(`Expected \`intervalCap\` to be a number from 1 and up, got \`${(r=(t=e.intervalCap)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:""}\` (${typeof e.intervalCap})`);if(e.interval===void 0||!(Number.isFinite(e.interval)&&e.interval>=0))throw new TypeError(`Expected \`interval\` to be a finite number >= 0, got \`${(i=(s=e.interval)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""}\` (${typeof e.interval})`);this._carryoverConcurrencyCount=e.carryoverConcurrencyCount,this._isIntervalIgnored=e.intervalCap===1/0||e.interval===0,this._intervalCap=e.intervalCap,this._interval=e.interval,this._queue=new e.queueClass,this._queueClass=e.queueClass,this.concurrency=e.concurrency,this._timeout=e.timeout,this._throwOnTimeout=e.throwOnTimeout===!0,this._isPaused=e.autoStart===!1}get _doesIntervalAllowAnother(){return this._isIntervalIgnored||this._intervalCount<this._intervalCap}get _doesConcurrentAllowAnother(){return this._pendingCount<this._concurrency}_next(){this._pendingCount--,this._tryToStartAnother(),this.emit("next")}_resolvePromises(){this._resolveEmpty(),this._resolveEmpty=sn,this._pendingCount===0&&(this._resolveIdle(),this._resolveIdle=sn,this.emit("idle"))}_onResumeInterval(){this._onInterval(),this._initializeIntervalIfNeeded(),this._timeoutId=void 0}_isIntervalPaused(){const e=Date.now();if(this._intervalId===void 0){const t=this._intervalEnd-e;if(t<0)this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0;else return this._timeoutId===void 0&&(this._timeoutId=setTimeout(()=>{this._onResumeInterval()},t)),!0}return!1}_tryToStartAnother(){if(this._queue.size===0)return this._intervalId&&clearInterval(this._intervalId),this._intervalId=void 0,this._resolvePromises(),!1;if(!this._isPaused){const e=!this._isIntervalPaused();if(this._doesIntervalAllowAnother&&this._doesConcurrentAllowAnother){const t=this._queue.dequeue();return t?(this.emit("active"),t(),e&&this._initializeIntervalIfNeeded(),!0):!1}}return!1}_initializeIntervalIfNeeded(){this._isIntervalIgnored||this._intervalId!==void 0||(this._intervalId=setInterval(()=>{this._onInterval()},this._interval),this._intervalEnd=Date.now()+this._interval)}_onInterval(){this._intervalCount===0&&this._pendingCount===0&&this._intervalId&&(clearInterval(this._intervalId),this._intervalId=void 0),this._intervalCount=this._carryoverConcurrencyCount?this._pendingCount:0,this._processQueue()}_processQueue(){for(;this._tryToStartAnother(););}get concurrency(){return this._concurrency}set concurrency(e){if(!(typeof e=="number"&&e>=1))throw new TypeError(`Expected \`concurrency\` to be a number from 1 and up, got \`${e}\` (${typeof e})`);this._concurrency=e,this._processQueue()}async add(e,t={}){return new Promise((r,s)=>{const i=async()=>{this._pendingCount++,this._intervalCount++;try{const a=this._timeout===void 0&&t.timeout===void 0?e():lc.default(Promise.resolve(e()),t.timeout===void 0?this._timeout:t.timeout,()=>{(t.throwOnTimeout===void 0?this._throwOnTimeout:t.throwOnTimeout)&&s(xd)});r(await a)}catch(a){s(a)}this._next()};this._queue.enqueue(i,t),this._tryToStartAnother(),this.emit("add")})}async addAll(e,t){return Promise.all(e.map(async r=>this.add(r,t)))}start(){return this._isPaused?(this._isPaused=!1,this._processQueue(),this):this}pause(){this._isPaused=!0}clear(){this._queue=new this._queueClass}async onEmpty(){if(this._queue.size!==0)return new Promise(e=>{const t=this._resolveEmpty;this._resolveEmpty=()=>{t(),e()}})}async onIdle(){if(!(this._pendingCount===0&&this._queue.size===0))return new Promise(e=>{const t=this._resolveIdle;this._resolveIdle=()=>{t(),e()}})}get size(){return this._queue.size}sizeBy(e){return this._queue.filter(e).length}get pending(){return this._pendingCount}get isPaused(){return this._isPaused}get timeout(){return this._timeout}set timeout(e){this._timeout=e}}var ze=ac.default=Rd;const jd=[400,401,402,403,404,405,406,407,408,409],$d=n=>{var t,r;if(n.message.startsWith("Cancel")||n.message.startsWith("TimeoutError")||n.name==="TimeoutError"||n.message.startsWith("AbortError")||n.name==="AbortError"||(n==null?void 0:n.code)==="ECONNABORTED")throw n;const e=((t=n==null?void 0:n.response)==null?void 0:t.status)??(n==null?void 0:n.status);if(e&&jd.includes(+e))throw n;if(((r=n==null?void 0:n.error)==null?void 0:r.code)==="insufficient_quota"){const s=new Error(n==null?void 0:n.message);throw s.name="InsufficientQuotaError",s}};let ts=class{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6,this.onFailedAttempt=e.onFailedAttempt??$d;const t="default"in ze?ze.default:ze;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>qn(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt:this.onFailedAttempt,retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}};var rs={};rs.byteLength=Ld;rs.toByteArray=Zd;rs.fromByteArray=Bd;var Re=[],_e=[],Nd=typeof Uint8Array<"u"?Uint8Array:Array,Rs="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";for(var kt=0,Dd=Rs.length;kt<Dd;++kt)Re[kt]=Rs[kt],_e[Rs.charCodeAt(kt)]=kt;_e[45]=62;_e[95]=63;function dc(n){var e=n.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var t=n.indexOf("=");t===-1&&(t=e);var r=t===e?0:4-t%4;return[t,r]}function Ld(n){var e=dc(n),t=e[0],r=e[1];return(t+r)*3/4-r}function Ud(n,e,t){return(e+t)*3/4-t}function Zd(n){var e,t=dc(n),r=t[0],s=t[1],i=new Nd(Ud(n,r,s)),a=0,o=s>0?r-4:r,c;for(c=0;c<o;c+=4)e=_e[n.charCodeAt(c)]<<18|_e[n.charCodeAt(c+1)]<<12|_e[n.charCodeAt(c+2)]<<6|_e[n.charCodeAt(c+3)],i[a++]=e>>16&255,i[a++]=e>>8&255,i[a++]=e&255;return s===2&&(e=_e[n.charCodeAt(c)]<<2|_e[n.charCodeAt(c+1)]>>4,i[a++]=e&255),s===1&&(e=_e[n.charCodeAt(c)]<<10|_e[n.charCodeAt(c+1)]<<4|_e[n.charCodeAt(c+2)]>>2,i[a++]=e>>8&255,i[a++]=e&255),i}function Md(n){return Re[n>>18&63]+Re[n>>12&63]+Re[n>>6&63]+Re[n&63]}function Fd(n,e,t){for(var r,s=[],i=e;i<t;i+=3)r=(n[i]<<16&16711680)+(n[i+1]<<8&65280)+(n[i+2]&255),s.push(Md(r));return s.join("")}function Bd(n){for(var e,t=n.length,r=t%3,s=[],i=16383,a=0,o=t-r;a<o;a+=i)s.push(Fd(n,a,a+i>o?o:a+i));return r===1?(e=n[t-1],s.push(Re[e>>2]+Re[e<<4&63]+"==")):r===2&&(e=(n[t-2]<<8)+n[t-1],s.push(Re[e>>10]+Re[e>>4&63]+Re[e<<2&63]+"=")),s.join("")}var Vd=Object.defineProperty,zd=(n,e,t)=>e in n?Vd(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,qd=(n,e,t)=>(zd(n,typeof e!="symbol"?e+"":e,t),t);function Kd(n,e){let t=Array.from({length:n.length},(r,s)=>({start:s,end:s+1}));for(;t.length>1;){let r=null;for(let s=0;s<t.length-1;s++){const i=n.slice(t[s].start,t[s+1].end),a=e.get(i.join(","));a!=null&&(r==null||a<r[0])&&(r=[a,s])}if(r!=null){const s=r[1];t[s]={start:t[s].start,end:t[s+1].end},t.splice(s+1,1)}else break}return t}function Hd(n,e){return n.length===1?[e.get(n.join(","))]:Kd(n,e).map(t=>e.get(n.slice(t.start,t.end).join(","))).filter(t=>t!=null)}function Jd(n){return n.replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}var ai=class{constructor(n,e){Ye(this,"specialTokens");Ye(this,"inverseSpecialTokens");Ye(this,"patStr");Ye(this,"textEncoder",new TextEncoder);Ye(this,"textDecoder",new TextDecoder("utf-8"));Ye(this,"rankMap",new Map);Ye(this,"textMap",new Map);this.patStr=n.pat_str;const t=n.bpe_ranks.split(`
`).filter(Boolean).reduce((r,s)=>{const[i,a,...o]=s.split(" "),c=Number.parseInt(a,10);return o.forEach((l,d)=>r[l]=c+d),r},{});for(const[r,s]of Object.entries(t)){const i=rs.toByteArray(r);this.rankMap.set(i.join(","),s),this.textMap.set(s,i)}this.specialTokens={...n.special_tokens,...e},this.inverseSpecialTokens=Object.entries(this.specialTokens).reduce((r,[s,i])=>(r[i]=this.textEncoder.encode(s),r),{})}encode(n,e=[],t="all"){const r=new RegExp(this.patStr,"ug"),s=ai.specialTokenRegex(Object.keys(this.specialTokens)),i=[],a=new Set(e==="all"?Object.keys(this.specialTokens):e),o=new Set(t==="all"?Object.keys(this.specialTokens).filter(l=>!a.has(l)):t);if(o.size>0){const l=ai.specialTokenRegex([...o]),d=n.match(l);if(d!=null)throw new Error(`The text contains a special token that is not allowed: ${d[0]}`)}let c=0;for(;;){let l=null,d=c;for(;s.lastIndex=d,l=s.exec(n),!(l==null||a.has(l[0]));)d=l.index+1;const f=(l==null?void 0:l.index)??n.length;for(const b of n.substring(c,f).matchAll(r)){const v=this.textEncoder.encode(b[0]),T=this.rankMap.get(v.join(","));if(T!=null){i.push(T);continue}i.push(...Hd(v,this.rankMap))}if(l==null)break;let m=this.specialTokens[l[0]];i.push(m),c=l.index+l[0].length}return i}decode(n){const e=[];let t=0;for(let i=0;i<n.length;++i){const a=n[i],o=this.textMap.get(a)??this.inverseSpecialTokens[a];o!=null&&(e.push(o),t+=o.length)}const r=new Uint8Array(t);let s=0;for(const i of e)r.set(i,s),s+=i.length;return this.textDecoder.decode(r)}},hc=ai;qd(hc,"specialTokenRegex",n=>new RegExp(n.map(e=>Jd(e)).join("|"),"g"));function Gd(n){switch(n){case"gpt2":return"gpt2";case"code-cushman-001":case"code-cushman-002":case"code-davinci-001":case"code-davinci-002":case"cushman-codex":case"davinci-codex":case"davinci-002":case"text-davinci-002":case"text-davinci-003":return"p50k_base";case"code-davinci-edit-001":case"text-davinci-edit-001":return"p50k_edit";case"ada":case"babbage":case"babbage-002":case"code-search-ada-code-001":case"code-search-babbage-code-001":case"curie":case"davinci":case"text-ada-001":case"text-babbage-001":case"text-curie-001":case"text-davinci-001":case"text-search-ada-doc-001":case"text-search-babbage-doc-001":case"text-search-curie-doc-001":case"text-search-davinci-doc-001":case"text-similarity-ada-001":case"text-similarity-babbage-001":case"text-similarity-curie-001":case"text-similarity-davinci-001":return"r50k_base";case"gpt-3.5-turbo-16k-0613":case"gpt-3.5-turbo-16k":case"gpt-3.5-turbo-0613":case"gpt-3.5-turbo-0301":case"gpt-3.5-turbo":case"gpt-4-32k-0613":case"gpt-4-32k-0314":case"gpt-4-32k":case"gpt-4-0613":case"gpt-4-0314":case"gpt-4":case"gpt-3.5-turbo-1106":case"gpt-35-turbo":case"gpt-4-1106-preview":case"gpt-4-vision-preview":case"text-embedding-ada-002":return"cl100k_base";default:throw new Error("Unknown model")}}const an={},Wd=new ts({});async function Yd(n){return n in an||(an[n]=Wd.fetch(`https://tiktoken.pages.dev/js/${n}.json`).then(e=>e.json()).then(e=>new hc(e)).catch(e=>{throw delete an[n],e})),await an[n]}async function Xd(n){return Yd(Gd(n))}let on;const Qd=new Uint8Array(16);function eh(){if(!on&&(on=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!on))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return on(Qd)}const th=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function rh(n){return typeof n=="string"&&th.test(n)}const Q=[];for(let n=0;n<256;++n)Q.push((n+256).toString(16).slice(1));function nh(n,e=0){return Q[n[e+0]]+Q[n[e+1]]+Q[n[e+2]]+Q[n[e+3]]+"-"+Q[n[e+4]]+Q[n[e+5]]+"-"+Q[n[e+6]]+Q[n[e+7]]+"-"+Q[n[e+8]]+Q[n[e+9]]+"-"+Q[n[e+10]]+Q[n[e+11]]+Q[n[e+12]]+Q[n[e+13]]+Q[n[e+14]]+Q[n[e+15]]}const sh=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Ia={randomUUID:sh};function Ve(n,e,t){if(Ia.randomUUID&&!e&&!n)return Ia.randomUUID();n=n||{};const r=n.random||(n.rng||eh)();if(r[6]=r[6]&15|64,r[8]=r[8]&63|128,e){t=t||0;for(let s=0;s<16;++s)e[t+s]=r[s];return e}return nh(r)}var js={};class ih{}class Hr extends ih{get lc_namespace(){return["langchain_core","callbacks",this.name]}get lc_secrets(){}get lc_attributes(){}get lc_aliases(){}static lc_name(){return this.name}get lc_id(){return[...this.lc_namespace,Yo(this.constructor)]}constructor(e){super(),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"lc_kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"ignoreLLM",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreChain",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreAgent",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"ignoreRetriever",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"awaitHandlers",{enumerable:!0,configurable:!0,writable:!0,value:typeof process<"u"?(js==null?void 0:js.LANGCHAIN_CALLBACKS_BACKGROUND)!=="true":!0}),this.lc_kwargs=e||{},e&&(this.ignoreLLM=e.ignoreLLM??this.ignoreLLM,this.ignoreChain=e.ignoreChain??this.ignoreChain,this.ignoreAgent=e.ignoreAgent??this.ignoreAgent,this.ignoreRetriever=e.ignoreRetriever??this.ignoreRetriever)}copy(){return new this.constructor(this)}toJSON(){return ot.prototype.toJSON.call(this)}toJSONNotImplemented(){return ot.prototype.toJSONNotImplemented.call(this)}static fromMethods(e){class t extends Hr{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ve()}),Object.assign(this,e)}}return new t}}var Ki={exports:{}};Ki.exports;(function(n){const t=(i=0)=>a=>`\x1B[${38+i};5;${a}m`,r=(i=0)=>(a,o,c)=>`\x1B[${38+i};2;${a};${o};${c}m`;function s(){const i=new Map,a={modifier:{reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29]},color:{black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],blackBright:[90,39],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39]},bgColor:{bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgBlackBright:[100,49],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49]}};a.color.gray=a.color.blackBright,a.bgColor.bgGray=a.bgColor.bgBlackBright,a.color.grey=a.color.blackBright,a.bgColor.bgGrey=a.bgColor.bgBlackBright;for(const[o,c]of Object.entries(a)){for(const[l,d]of Object.entries(c))a[l]={open:`\x1B[${d[0]}m`,close:`\x1B[${d[1]}m`},c[l]=a[l],i.set(d[0],d[1]);Object.defineProperty(a,o,{value:c,enumerable:!1})}return Object.defineProperty(a,"codes",{value:i,enumerable:!1}),a.color.close="\x1B[39m",a.bgColor.close="\x1B[49m",a.color.ansi256=t(),a.color.ansi16m=r(),a.bgColor.ansi256=t(10),a.bgColor.ansi16m=r(10),Object.defineProperties(a,{rgbToAnsi256:{value:(o,c,l)=>o===c&&c===l?o<8?16:o>248?231:Math.round((o-8)/247*24)+232:16+36*Math.round(o/255*5)+6*Math.round(c/255*5)+Math.round(l/255*5),enumerable:!1},hexToRgb:{value:o=>{const c=/(?<colorString>[a-f\d]{6}|[a-f\d]{3})/i.exec(o.toString(16));if(!c)return[0,0,0];let{colorString:l}=c.groups;l.length===3&&(l=l.split("").map(f=>f+f).join(""));const d=Number.parseInt(l,16);return[d>>16&255,d>>8&255,d&255]},enumerable:!1},hexToAnsi256:{value:o=>a.rgbToAnsi256(...a.hexToRgb(o)),enumerable:!1}}),a}Object.defineProperty(n,"exports",{enumerable:!0,get:s})})(Ki);var ah=Ki.exports;const fc=_i(ah);function $s(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}function oh(n){return n.replace(/[-:.]/g,"")}function ch(n,e){return oh(`${new Date(n).toISOString().slice(0,-1)}000Z`)+e}class ns extends Hr{constructor(e){super(...arguments),Object.defineProperty(this,"runMap",{enumerable:!0,configurable:!0,writable:!0,value:new Map})}copy(){return this}_addChildRun(e,t){e.child_runs.push(t)}async _startTrace(e){var s;const t=ch(e.start_time,e.id),r={...e};if(r.parent_run_id!==void 0){const i=this.runMap.get(r.parent_run_id);i&&(this._addChildRun(i,r),i.child_execution_order=Math.max(i.child_execution_order,r.child_execution_order),r.trace_id=i.trace_id,i.dotted_order!==void 0?r.dotted_order=[i.dotted_order,t].join("."):console.warn(`Parent run with UUID ${r.parent_run_id} not found.`))}else r.trace_id=r.id,r.dotted_order=t;this.runMap.set(r.id,r),await((s=this.onRunCreate)==null?void 0:s.call(this,r))}async _endTrace(e){var r;const t=e.parent_run_id!==void 0&&this.runMap.get(e.parent_run_id);t?t.child_execution_order=Math.max(t.child_execution_order,e.child_execution_order):await this.persistRun(e),this.runMap.delete(e.id),await((r=this.onRunUpdate)==null?void 0:r.call(this,e))}_getExecutionOrder(e){const t=e!==void 0&&this.runMap.get(e);return t?t.child_execution_order+1:1}async handleLLMStart(e,t,r,s,i,a,o,c){var b;const l=this._getExecutionOrder(s),d=Date.now(),f=o?{...i,metadata:o}:i,m={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{prompts:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:a||[]};return await this._startTrace(m),await((b=this.onLLMStart)==null?void 0:b.call(this,m)),m}async handleChatModelStart(e,t,r,s,i,a,o,c){var b;const l=this._getExecutionOrder(s),d=Date.now(),f=o?{...i,metadata:o}:i,m={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:{messages:t},execution_order:l,child_runs:[],child_execution_order:l,run_type:"llm",extra:f??{},tags:a||[]};return await this._startTrace(m),await((b=this.onLLMStart)==null?void 0:b.call(this,m)),m}async handleLLMEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.outputs=e,r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleLLMError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="llm")throw new Error("No LLM run to end.");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onLLMError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleChainStart(e,t,r,s,i,a,o,c){var m;const l=this._getExecutionOrder(s),d=Date.now(),f={id:r,name:c??e.id[e.id.length-1],parent_run_id:s,start_time:d,serialized:e,events:[{name:"start",time:new Date(d).toISOString()}],inputs:t,execution_order:l,child_execution_order:l,run_type:o??"chain",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(f),await((m=this.onChainStart)==null?void 0:m.call(this,f)),f}async handleChainEnd(e,t,r,s,i){var o;const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.outputs=$s(e,"output"),a.events.push({name:"end",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=$s(i.inputs,"input")),await((o=this.onChainEnd)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleChainError(e,t,r,s,i){var o;const a=this.runMap.get(t);if(!a)throw new Error("No chain run to end.");return a.end_time=Date.now(),a.error=e.message,a.events.push({name:"error",time:new Date(a.end_time).toISOString()}),(i==null?void 0:i.inputs)!==void 0&&(a.inputs=$s(i.inputs,"input")),await((o=this.onChainError)==null?void 0:o.call(this,a)),await this._endTrace(a),a}async handleToolStart(e,t,r,s,i,a,o){var f;const c=this._getExecutionOrder(s),l=Date.now(),d={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{input:t},execution_order:c,child_execution_order:c,run_type:"tool",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(d),await((f=this.onToolStart)==null?void 0:f.call(this,d)),d}async handleToolEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.outputs={output:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onToolEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleToolError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="tool")throw new Error("No tool run to end");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onToolError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleAgentAction(e,t){var i;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="chain")return;const s=r;s.actions=s.actions||[],s.actions.push(e),s.events.push({name:"agent_action",time:new Date().toISOString(),kwargs:{action:e}}),await((i=this.onAgentAction)==null?void 0:i.call(this,r))}async handleAgentEnd(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"agent_end",time:new Date().toISOString(),kwargs:{action:e}}),await((s=this.onAgentEnd)==null?void 0:s.call(this,r)))}async handleRetrieverStart(e,t,r,s,i,a,o){var f;const c=this._getExecutionOrder(s),l=Date.now(),d={id:r,name:o??e.id[e.id.length-1],parent_run_id:s,start_time:l,serialized:e,events:[{name:"start",time:new Date(l).toISOString()}],inputs:{query:t},execution_order:c,child_execution_order:c,run_type:"retriever",child_runs:[],extra:a?{metadata:a}:{},tags:i||[]};return await this._startTrace(d),await((f=this.onRetrieverStart)==null?void 0:f.call(this,d)),d}async handleRetrieverEnd(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.outputs={documents:e},r.events.push({name:"end",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverEnd)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleRetrieverError(e,t){var s;const r=this.runMap.get(t);if(!r||(r==null?void 0:r.run_type)!=="retriever")throw new Error("No retriever run to end");return r.end_time=Date.now(),r.error=e.message,r.events.push({name:"error",time:new Date(r.end_time).toISOString()}),await((s=this.onRetrieverError)==null?void 0:s.call(this,r)),await this._endTrace(r),r}async handleText(e,t){var s;const r=this.runMap.get(t);!r||(r==null?void 0:r.run_type)!=="chain"||(r.events.push({name:"text",time:new Date().toISOString(),kwargs:{text:e}}),await((s=this.onText)==null?void 0:s.call(this,r)))}async handleLLMNewToken(e,t,r,s,i,a){var c;const o=this.runMap.get(r);if(!o||(o==null?void 0:o.run_type)!=="llm")throw new Error('Invalid "runId" provided to "handleLLMNewToken" callback.');return o.events.push({name:"new_token",time:new Date().toISOString(),kwargs:{token:e,idx:t,chunk:a==null?void 0:a.chunk}}),await((c=this.onLLMNewToken)==null?void 0:c.call(this,o,e)),o}}function ce(n,e){return`${n.open}${e}${n.close}`}function Pe(n,e){try{return JSON.stringify(n,null,2)}catch{return e}}function Qe(n){if(!n.end_time)return"";const e=n.end_time-n.start_time;return e<1e3?`${e}ms`:`${(e/1e3).toFixed(2)}s`}const{color:le}=fc;class ka extends ns{constructor(){super(...arguments),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"console_callback_handler"})}persistRun(e){return Promise.resolve()}getParents(e){const t=[];let r=e;for(;r.parent_run_id;){const s=this.runMap.get(r.parent_run_id);if(s)t.push(s),r=s;else break}return t}getBreadcrumbs(e){const r=[...this.getParents(e).reverse(),e].map((s,i,a)=>{const o=`${s.execution_order}:${s.run_type}:${s.name}`;return i===a.length-1?ce(fc.bold,o):o}).join(" > ");return ce(le.grey,r)}onChainStart(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.green,"[chain/start]")} [${t}] Entering Chain run with input: ${Pe(e.inputs,"[inputs]")}`)}onChainEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.cyan,"[chain/end]")} [${t}] [${Qe(e)}] Exiting Chain run with output: ${Pe(e.outputs,"[outputs]")}`)}onChainError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.red,"[chain/error]")} [${t}] [${Qe(e)}] Chain run errored with error: ${Pe(e.error,"[error]")}`)}onLLMStart(e){const t=this.getBreadcrumbs(e),r="prompts"in e.inputs?{prompts:e.inputs.prompts.map(s=>s.trim())}:e.inputs;console.log(`${ce(le.green,"[llm/start]")} [${t}] Entering LLM run with input: ${Pe(r,"[inputs]")}`)}onLLMEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.cyan,"[llm/end]")} [${t}] [${Qe(e)}] Exiting LLM run with output: ${Pe(e.outputs,"[response]")}`)}onLLMError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.red,"[llm/error]")} [${t}] [${Qe(e)}] LLM run errored with error: ${Pe(e.error,"[error]")}`)}onToolStart(e){var r;const t=this.getBreadcrumbs(e);console.log(`${ce(le.green,"[tool/start]")} [${t}] Entering Tool run with input: "${(r=e.inputs.input)==null?void 0:r.trim()}"`)}onToolEnd(e){var r,s;const t=this.getBreadcrumbs(e);console.log(`${ce(le.cyan,"[tool/end]")} [${t}] [${Qe(e)}] Exiting Tool run with output: "${(s=(r=e.outputs)==null?void 0:r.output)==null?void 0:s.trim()}"`)}onToolError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.red,"[tool/error]")} [${t}] [${Qe(e)}] Tool run errored with error: ${Pe(e.error,"[error]")}`)}onRetrieverStart(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.green,"[retriever/start]")} [${t}] Entering Retriever run with input: ${Pe(e.inputs,"[inputs]")}`)}onRetrieverEnd(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.cyan,"[retriever/end]")} [${t}] [${Qe(e)}] Exiting Retriever run with output: ${Pe(e.outputs,"[outputs]")}`)}onRetrieverError(e){const t=this.getBreadcrumbs(e);console.log(`${ce(le.red,"[retriever/error]")} [${t}] [${Qe(e)}] Retriever run errored with error: ${Pe(e.error,"[error]")}`)}onAgentAction(e){const t=e,r=this.getBreadcrumbs(e);console.log(`${ce(le.blue,"[agent/action]")} [${r}] Agent selected action: ${Pe(t.actions[t.actions.length-1],"[action]")}`)}}const uh=[400,401,403,404,405,406,407,408,409];class lh{constructor(e){Object.defineProperty(this,"maxConcurrency",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxRetries",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queue",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.maxConcurrency=e.maxConcurrency??1/0,this.maxRetries=e.maxRetries??6;const t="default"in ze?ze.default:ze;this.queue=new t({concurrency:this.maxConcurrency})}call(e,...t){return this.queue.add(()=>qn(()=>e(...t).catch(r=>{throw r instanceof Error?r:new Error(r)}),{onFailedAttempt(r){var i;if(r.message.startsWith("Cancel")||r.message.startsWith("TimeoutError")||r.message.startsWith("AbortError")||(r==null?void 0:r.code)==="ECONNABORTED")throw r;const s=(i=r==null?void 0:r.response)==null?void 0:i.status;if(s&&uh.includes(+s))throw r},retries:this.maxRetries,randomize:!0}),{throwOnTimeout:!0})}callWithOptions(e,t,...r){return e.signal?Promise.race([this.call(t,...r),new Promise((s,i)=>{var a;(a=e.signal)==null||a.addEventListener("abort",()=>{i(new Error("AbortError"))})})]):this.call(t,...r)}fetch(...e){return this.call(()=>fetch(...e).then(t=>t.ok?t:Promise.reject(t)))}}function Ca(n){return typeof(n==null?void 0:n._getType)=="function"}function Sa(n){const e={type:n._getType(),data:{content:n.content}};return n!=null&&n.additional_kwargs&&Object.keys(n.additional_kwargs).length>0&&(e.data.additional_kwargs={...n.additional_kwargs}),e}var Ns={};const dh=()=>typeof window<"u"&&typeof window.document<"u",hh=()=>typeof globalThis=="object"&&globalThis.constructor&&globalThis.constructor.name==="DedicatedWorkerGlobalScope",fh=()=>typeof window<"u"&&window.name==="nodejs"||typeof navigator<"u"&&(navigator.userAgent.includes("Node.js")||navigator.userAgent.includes("jsdom")),pc=()=>typeof Deno<"u",ph=()=>typeof process<"u"&&typeof process.versions<"u"&&typeof process.versions.node<"u"&&!pc(),mh=()=>{let n;return dh()?n="browser":ph()?n="node":hh()?n="webworker":fh()?n="jsdom":pc()?n="deno":n="other",n};let Ds;async function gh(){if(Ds===void 0){const n=mh(),e=yh();Ds={library:"langsmith",runtime:n,...e}}return Ds}function Ft(n){try{return typeof process<"u"?Ns==null?void 0:Ns[n]:void 0}catch{return}}let Ls;function yh(){if(Ls!==void 0)return Ls;const n=["VERCEL_GIT_COMMIT_SHA","NEXT_PUBLIC_VERCEL_GIT_COMMIT_SHA","COMMIT_REF","RENDER_GIT_COMMIT","CI_COMMIT_SHA","CIRCLE_SHA1","CF_PAGES_COMMIT_SHA","REACT_APP_GIT_SHA","SOURCE_VERSION","GITHUB_SHA","TRAVIS_COMMIT","GIT_COMMIT","BUILD_VCS_NUMBER","bamboo_planRepository_revision","Build.SourceVersion","BITBUCKET_COMMIT","DRONE_COMMIT_SHA","SEMAPHORE_GIT_SHA","BUILDKITE_COMMIT"],e={};for(const t of n){const r=Ft(t);r!==void 0&&(e[t]=r)}return Ls=e,e}const xa=n=>{const t=n.replace("http://","").replace("https://","").split("/")[0].split(":")[0];return t==="localhost"||t==="127.0.0.1"||t==="::1"},ht=async(n,e)=>{const t=await n.text();if(!n.ok)throw new Error(`Failed to ${e}: ${n.status} ${n.statusText} ${t}`)};async function _h(n){const e=[];for await(const t of n)e.push(t);return e}function Us(n){if(n!==void 0)return n.trim().replace(/^"(.*)"$/,"$1").replace(/^'(.*)'$/,"$1")}function Ra(n){return Ft("LANGCHAIN_HIDE_INPUTS")==="true"?{}:n}function ja(n){return Ft("LANGCHAIN_HIDE_OUTPUTS")==="true"?{}:n}function K(n){if(!rh(n))throw new Error(`Invalid UUID: ${n}`)}class Hi{constructor(e={}){Object.defineProperty(this,"apiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"apiUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webUrl",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout_ms",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_tenantId",{enumerable:!0,configurable:!0,writable:!0,value:null});const t=Hi.getDefaultClientConfig();this.apiUrl=Us(e.apiUrl??t.apiUrl)??"",this.apiKey=Us(e.apiKey??t.apiKey),this.webUrl=Us(e.webUrl??t.webUrl),this.validateApiKeyIfHosted(),this.timeout_ms=e.timeout_ms??4e3,this.caller=new lh(e.callerOptions??{})}static getDefaultClientConfig(){const e=Ft("LANGCHAIN_API_KEY");return{apiUrl:Ft("LANGCHAIN_ENDPOINT")??(e?"https://api.smith.langchain.com":"http://localhost:1984"),apiKey:e,webUrl:void 0}}validateApiKeyIfHosted(){if(!xa(this.apiUrl)&&!this.apiKey)throw new Error("API key must be provided when using hosted LangSmith API")}getHostUrl(){return this.webUrl?this.webUrl:xa(this.apiUrl)?(this.webUrl="http://localhost","http://localhost"):this.apiUrl.includes("/api")?(this.webUrl=this.apiUrl.replace("/api",""),this.webUrl):this.apiUrl.split(".",1)[0].includes("dev")?(this.webUrl="https://dev.smith.langchain.com","https://dev.smith.langchain.com"):(this.webUrl="https://smith.langchain.com","https://smith.langchain.com")}get headers(){const e={};return this.apiKey&&(e["x-api-key"]=`${this.apiKey}`),e}async _getResponse(e,t){const r=(t==null?void 0:t.toString())??"",s=`${this.apiUrl}${e}?${r}`,i=await this.caller.call(fetch,s,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to fetch ${e}: ${i.status} ${i.statusText}`);return i}async _get(e,t){return(await this._getResponse(e,t)).json()}async*_getPaginated(e,t=new URLSearchParams){let r=Number(t.get("offset"))||0;const s=Number(t.get("limit"))||100;for(;;){t.set("offset",String(r)),t.set("limit",String(s));const i=`${this.apiUrl}${e}?${t}`,a=await this.caller.call(fetch,i,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!a.ok)throw new Error(`Failed to fetch ${e}: ${a.status} ${a.statusText}`);const o=await a.json();if(o.length===0||(yield o,o.length<s))break;r+=o.length}}async*_getCursorPaginatedList(e,t=null,r="POST",s="runs"){let i=t?{...t}:{};for(;;){const o=await(await this.caller.call(fetch,`${this.apiUrl}${e}`,{method:r,headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms),body:JSON.stringify(i)})).json();if(!o||!o[s])break;yield o[s];const c=o.cursors;if(!c||!c.next)break;i.cursor=c.next}}async createRun(e){const t={...this.headers,"Content-Type":"application/json"},r=e.extra??{},s=await gh(),i=e.project_name;delete e.project_name;const a={session_name:i,...e,extra:{...e.extra,runtime:{...s,...r.runtime}}};a.inputs=Ra(a.inputs),a.outputs&&(a.outputs=ja(a.outputs));const o=await this.caller.call(fetch,`${this.apiUrl}/runs`,{method:"POST",headers:t,body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});await ht(o,"create run")}async updateRun(e,t){K(e),t.inputs&&(t.inputs=Ra(t.inputs)),t.outputs&&(t.outputs=ja(t.outputs));const r={...this.headers,"Content-Type":"application/json"},s=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}`,{method:"PATCH",headers:r,body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});await ht(s,"update run")}async readRun(e,{loadChildRuns:t}={loadChildRuns:!1}){K(e);let r=await this._get(`/runs/${e}`);return t&&r.child_run_ids&&(r=await this._loadChildRuns(r)),r}async getRunUrl({runId:e,run:t,projectOpts:r}){if(t!==void 0){let s;t.session_id?s=t.session_id:r!=null&&r.projectName?s=(await this.readProject({projectName:r==null?void 0:r.projectName})).id:r!=null&&r.projectId?s=r==null?void 0:r.projectId:s=(await this.readProject({projectName:Ft("LANGCHAIN_PROJECT")||"default"})).id;const i=await this._getTenantId();return`${this.getHostUrl()}/o/${i}/projects/p/${s}/r/${t.id}?poll=true`}else if(e!==void 0){const s=await this.readRun(e);if(!s.app_path)throw new Error(`Run ${e} has no app_path`);return`${this.getHostUrl()}${s.app_path}`}else throw new Error("Must provide either runId or run")}async _loadChildRuns(e){const t=await _h(this.listRuns({id:e.child_run_ids})),r={},s={};t.sort((i,a)=>((i==null?void 0:i.dotted_order)??"").localeCompare((a==null?void 0:a.dotted_order)??""));for(const i of t){if(i.parent_run_id===null||i.parent_run_id===void 0)throw new Error(`Child run ${i.id} has no parent`);i.parent_run_id in r||(r[i.parent_run_id]=[]),r[i.parent_run_id].push(i),s[i.id]=i}e.child_runs=r[e.id]||[];for(const i in r)i!==e.id&&(s[i].child_runs=r[i]);return e}async*listRuns({projectId:e,projectName:t,parentRunId:r,referenceExampleId:s,startTime:i,executionOrder:a,runType:o,error:c,id:l,query:d,filter:f,limit:m}){let b=e;if(t){if(e)throw new Error("Only one of projectId or projectName may be given");b=(await this.readProject({projectName:t})).id}const v={session:b?[b]:null,run_type:o,reference_example:s,query:d,filter:f,execution_order:a,parent_run:r?[r]:null,start_time:i?i.toISOString():null,error:c,id:l,limit:m};for await(const T of this._getCursorPaginatedList("/runs",v))yield*T}async shareRun(e,{shareId:t}={}){const r={run_id:e,share_token:t||Ve()};K(e);const i=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();if(i===null||!("share_token"in i))throw new Error("Invalid response from server");return`${this.getHostUrl()}/public/${i.share_token}/r`}async unshareRun(e){K(e);const t=await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await ht(t,"unshare run")}async readRunSharedLink(e){K(e);const r=await(await this.caller.call(fetch,`${this.apiUrl}/runs/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();if(!(r===null||!("share_token"in r)))return`${this.getHostUrl()}/public/${r.share_token}/r`}async listSharedRuns(e,{runIds:t}={}){const r=new URLSearchParams({share_token:e});if(t!==void 0)for(const a of t)r.append("id",a);return K(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/runs${r}`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async readDatasetSharedSchema(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id),K(e);const s=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json();return s.url=`${this.getHostUrl()}/public/${s.share_token}/d`,s}async shareDataset(e,t){if(!e&&!t)throw new Error("Either datasetId or datasetName must be given");e||(e=(await this.readDataset({datasetName:t})).id);const r={dataset_id:e};K(e);const i=await(await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"PUT",headers:this.headers,body:JSON.stringify(r),signal:AbortSignal.timeout(this.timeout_ms)})).json();return i.url=`${this.getHostUrl()}/public/${i.share_token}/d`,i}async unshareDataset(e){K(e);const t=await this.caller.call(fetch,`${this.apiUrl}/datasets/${e}/share`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await ht(t,"unshare dataset")}async readSharedDataset(e){return K(e),await(await this.caller.call(fetch,`${this.apiUrl}/public/${e}/datasets`,{method:"GET",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)})).json()}async createProject({projectName:e,description:t=null,metadata:r=null,upsert:s=!1,projectExtra:i=null,referenceDatasetId:a=null}){const o=s?"?upsert=true":"",c=`${this.apiUrl}/sessions${o}`,l=i||{};r&&(l.metadata=r);const d={name:e,extra:l,description:t};a!==null&&(d.reference_dataset_id=a);const f=await this.caller.call(fetch,c,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(d),signal:AbortSignal.timeout(this.timeout_ms)}),m=await f.json();if(!f.ok)throw new Error(`Failed to create session ${e}: ${f.status} ${f.statusText}`);return m}async updateProject(e,{name:t=null,description:r=null,metadata:s=null,projectExtra:i=null,endTime:a=null}){const o=`${this.apiUrl}/sessions/${e}`;let c=i;s&&(c={...c||{},metadata:s});const l={name:t,extra:c,description:r,end_time:a?new Date(a).toISOString():null},d=await this.caller.call(fetch,o,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)}),f=await d.json();if(!d.ok)throw new Error(`Failed to update project ${e}: ${d.status} ${d.statusText}`);return f}async readProject({projectId:e,projectName:t}){let r="/sessions";const s=new URLSearchParams;if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");if(e!==void 0)K(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide projectName or projectId");const i=await this._get(r,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Project[id=${e}, name=${t}] not found`);a=i[0]}else a=i;return a}async _getTenantId(){if(this._tenantId!==null)return this._tenantId;const e=new URLSearchParams({limit:"1"});for await(const t of this._getPaginated("/sessions",e))return this._tenantId=t[0].tenant_id,t[0].tenant_id;throw new Error("No projects found to resolve tenant.")}async*listProjects({projectIds:e,name:t,nameContains:r,referenceDatasetId:s,referenceDatasetName:i,referenceFree:a}={}){const o=new URLSearchParams;if(e!==void 0)for(const c of e)o.append("id",c);if(t!==void 0&&o.append("name",t),r!==void 0&&o.append("name_contains",r),s!==void 0)o.append("reference_dataset",s);else if(i!==void 0){const c=await this.readDataset({datasetName:i});o.append("reference_dataset",c.id)}a!==void 0&&o.append("reference_free",a.toString());for await(const c of this._getPaginated("/sessions",o))yield*c}async deleteProject({projectId:e,projectName:t}){let r;if(e===void 0&&t===void 0)throw new Error("Must provide projectName or projectId");if(e!==void 0&&t!==void 0)throw new Error("Must provide either projectName or projectId, not both");e===void 0?r=(await this.readProject({projectName:t})).id:r=e,K(r);const s=await this.caller.call(fetch,`${this.apiUrl}/sessions/${r}`,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});await ht(s,`delete session ${r} (${t})`)}async uploadCsv({csvFile:e,fileName:t,inputKeys:r,outputKeys:s,description:i,dataType:a,name:o}){const c=`${this.apiUrl}/datasets/upload`,l=new FormData;l.append("file",e,t),r.forEach(m=>{l.append("input_keys",m)}),s.forEach(m=>{l.append("output_keys",m)}),i&&l.append("description",i),a&&l.append("data_type",a),o&&l.append("name",o);const d=await this.caller.call(fetch,c,{method:"POST",headers:this.headers,body:l,signal:AbortSignal.timeout(this.timeout_ms)});if(!d.ok){const m=await d.json();throw m.detail&&m.detail.includes("already exists")?new Error(`Dataset ${t} already exists`):new Error(`Failed to upload CSV: ${d.status} ${d.statusText}`)}return await d.json()}async createDataset(e,{description:t,dataType:r}={}){const s={name:e,description:t};r&&(s.data_type=r);const i=await this.caller.call(fetch,`${this.apiUrl}/datasets`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(s),signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok){const o=await i.json();throw o.detail&&o.detail.includes("already exists")?new Error(`Dataset ${e} already exists`):new Error(`Failed to create dataset ${i.status} ${i.statusText}`)}return await i.json()}async readDataset({datasetId:e,datasetName:t}){let r="/datasets";const s=new URLSearchParams({limit:"1"});if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)K(e),r+=`/${e}`;else if(t!==void 0)s.append("name",t);else throw new Error("Must provide datasetName or datasetId");const i=await this._get(r,s);let a;if(Array.isArray(i)){if(i.length===0)throw new Error(`Dataset[id=${e}, name=${t}] not found`);a=i[0]}else a=i;return a}async readDatasetOpenaiFinetuning({datasetId:e,datasetName:t}){const r="/datasets";if(e===void 0)if(t!==void 0)e=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide datasetName or datasetId");return(await(await this._getResponse(`${r}/${e}/openai_ft`)).text()).trim().split(`
`).map(o=>JSON.parse(o))}async*listDatasets({limit:e=100,offset:t=0,datasetIds:r,datasetName:s,datasetNameContains:i}={}){const a="/datasets",o=new URLSearchParams({limit:e.toString(),offset:t.toString()});if(r!==void 0)for(const c of r)o.append("id",c);s!==void 0&&o.append("name",s),i!==void 0&&o.append("name_contains",i);for await(const c of this._getPaginated(a,o))yield*c}async deleteDataset({datasetId:e,datasetName:t}){let r="/datasets",s=e;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(t!==void 0&&(s=(await this.readDataset({datasetName:t})).id),s!==void 0)K(s),r+=`/${s}`;else throw new Error("Must provide datasetName or datasetId");const i=await this.caller.call(fetch,this.apiUrl+r,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!i.ok)throw new Error(`Failed to delete ${r}: ${i.status} ${i.statusText}`);await i.json()}async createExample(e,t,{datasetId:r,datasetName:s,createdAt:i,exampleId:a}){let o=r;if(o===void 0&&s===void 0)throw new Error("Must provide either datasetName or datasetId");if(o!==void 0&&s!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");o===void 0&&(o=(await this.readDataset({datasetName:s})).id);const l={dataset_id:o,inputs:e,outputs:t,created_at:(i||new Date).toISOString(),id:a},d=await this.caller.call(fetch,`${this.apiUrl}/examples`,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(l),signal:AbortSignal.timeout(this.timeout_ms)});if(!d.ok)throw new Error(`Failed to create example: ${d.status} ${d.statusText}`);return await d.json()}async createLLMExample(e,t,r){return this.createExample({input:e},{output:t},r)}async createChatExample(e,t,r){const s=e.map(a=>Ca(a)?Sa(a):a),i=Ca(t)?Sa(t):t;return this.createExample({input:s},{output:i},r)}async readExample(e){K(e);const t=`/examples/${e}`;return await this._get(t)}async*listExamples({datasetId:e,datasetName:t,exampleIds:r}={}){let s;if(e!==void 0&&t!==void 0)throw new Error("Must provide either datasetName or datasetId, not both");if(e!==void 0)s=e;else if(t!==void 0)s=(await this.readDataset({datasetName:t})).id;else throw new Error("Must provide a datasetName or datasetId");const i=new URLSearchParams({dataset:s});if(r!==void 0)for(const a of r)i.append("id",a);for await(const a of this._getPaginated("/examples",i))yield*a}async deleteExample(e){K(e);const t=`/examples/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async updateExample(e,t){K(e);const r=await this.caller.call(fetch,`${this.apiUrl}/examples/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(t),signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to update example ${e}: ${r.status} ${r.statusText}`);return await r.json()}async evaluateRun(e,t,{sourceInfo:r,loadChildRuns:s}={loadChildRuns:!1}){let i;if(typeof e=="string")i=await this.readRun(e,{loadChildRuns:s});else if(typeof e=="object"&&"id"in e)i=e;else throw new Error(`Invalid run type: ${typeof e}`);let a;i.reference_example_id!==null&&i.reference_example_id!==void 0&&(a=await this.readExample(i.reference_example_id));const o=await t.evaluateRun(i,a);let c=r??{};return o.evaluatorInfo&&(c={...c,...o.evaluatorInfo}),await this.createFeedback(i.id,o.key,{score:o.score,value:o.value,comment:o.comment,correction:o.correction,sourceInfo:c,feedbackSourceType:"model"})}async createFeedback(e,t,{score:r,value:s,correction:i,comment:a,sourceInfo:o,feedbackSourceType:c="api",sourceRunId:l,feedbackId:d,eager:f=!1}){var w;const m={type:c??"api",metadata:o??{}};l!==void 0&&(m==null?void 0:m.metadata)!==void 0&&!m.metadata.__run&&(m.metadata.__run={run_id:l}),(m==null?void 0:m.metadata)!==void 0&&((w=m.metadata.__run)==null?void 0:w.run_id)!==void 0&&K(m.metadata.__run.run_id);const b={id:d??Ve(),run_id:e,key:t,score:r,value:s,correction:i,comment:a,feedback_source:m},v=`${this.apiUrl}/feedback`+(f?"/eager":""),T=await this.caller.call(fetch,v,{method:"POST",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(b),signal:AbortSignal.timeout(this.timeout_ms)});return await ht(T,"create feedback"),b}async updateFeedback(e,{score:t,value:r,correction:s,comment:i}){const a={};t!=null&&(a.score=t),r!=null&&(a.value=r),s!=null&&(a.correction=s),i!=null&&(a.comment=i),K(e);const o=await this.caller.call(fetch,`${this.apiUrl}/feedback/${e}`,{method:"PATCH",headers:{...this.headers,"Content-Type":"application/json"},body:JSON.stringify(a),signal:AbortSignal.timeout(this.timeout_ms)});await ht(o,"update feedback")}async readFeedback(e){K(e);const t=`/feedback/${e}`;return await this._get(t)}async deleteFeedback(e){K(e);const t=`/feedback/${e}`,r=await this.caller.call(fetch,this.apiUrl+t,{method:"DELETE",headers:this.headers,signal:AbortSignal.timeout(this.timeout_ms)});if(!r.ok)throw new Error(`Failed to delete ${t}: ${r.status} ${r.statusText}`);await r.json()}async*listFeedback({runIds:e,feedbackKeys:t,feedbackSourceTypes:r}={}){const s=new URLSearchParams;if(e&&s.append("run",e.join(",")),t)for(const i of t)s.append("key",i);if(r)for(const i of r)s.append("source",i);for await(const i of this._getPaginated("/feedback",s))yield*i}}class bh extends ns{constructor(e={}){super(e),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"langchain_tracer"}),Object.defineProperty(this,"projectName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exampleId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{exampleId:t,projectName:r,client:s}=e;this.projectName=r??J("LANGCHAIN_PROJECT")??J("LANGCHAIN_SESSION"),this.exampleId=t,this.client=s??new Hi({})}async _convertToCreate(e,t=void 0){return{...e,extra:{...e.extra,runtime:await cd()},child_runs:void 0,session_name:this.projectName,reference_example_id:e.parent_run_id?void 0:t}}async persistRun(e){}async _persistRunSingle(e){const t=await this._convertToCreate(e,this.exampleId);await this.client.createRun(t)}async _updateRunSingle(e){const t={end_time:e.end_time,error:e.error,outputs:e.outputs,events:e.events,inputs:e.inputs};await this.client.updateRun(e.id,t)}async onRetrieverStart(e){await this._persistRunSingle(e)}async onRetrieverEnd(e){await this._updateRunSingle(e)}async onRetrieverError(e){await this._updateRunSingle(e)}async onLLMStart(e){await this._persistRunSingle(e)}async onLLMEnd(e){await this._updateRunSingle(e)}async onLLMError(e){await this._updateRunSingle(e)}async onChainStart(e){await this._persistRunSingle(e)}async onChainEnd(e){await this._updateRunSingle(e)}async onChainError(e){await this._updateRunSingle(e)}async onToolStart(e){await this._persistRunSingle(e)}async onToolEnd(e){await this._updateRunSingle(e)}async onToolError(e){await this._updateRunSingle(e)}}async function vh(){return new bh}let Zs;function wh(){const n="default"in ze?ze.default:ze;return new n({autoStart:!0,concurrency:1})}async function ee(n,e){e===!0?await n():(typeof Zs>"u"&&(Zs=wh()),Zs.add(n))}function Th(n){return n?Array.isArray(n)||"name"in n?{callbacks:n}:n:{}}class Eh{setHandler(e){return this.setHandlers([e])}}class ss{constructor(e,t,r,s,i,a,o,c){Object.defineProperty(this,"runId",{enumerable:!0,configurable:!0,writable:!0,value:e}),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:a}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:o}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:c})}async handleText(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;try{await((r=t.handleText)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleText: ${s}`)}},t.awaitHandlers)))}}class Oh extends ss{getChild(e){const t=new ue(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleRetrieverEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch{console.error(`Error in handler ${t.constructor.name}, handleRetriever`)}},t.awaitHandlers)))}async handleRetrieverError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreRetriever)try{await((r=t.handleRetrieverError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleRetrieverError: ${s}`)}},t.awaitHandlers)))}}class $a extends ss{async handleLLMNewToken(e,t,r,s,i,a){await Promise.all(this.handlers.map(o=>ee(async()=>{var c;if(!o.ignoreLLM)try{await((c=o.handleLLMNewToken)==null?void 0:c.call(o,e,t??{prompt:0,completion:0},this.runId,this._parentRunId,this.tags,a))}catch(l){console.error(`Error in handler ${o.constructor.name}, handleLLMNewToken: ${l}`)}},o.awaitHandlers)))}async handleLLMError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMError: ${s}`)}},t.awaitHandlers)))}async handleLLMEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreLLM)try{await((r=t.handleLLMEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleLLMEnd: ${s}`)}},t.awaitHandlers)))}}class Ph extends ss{getChild(e){const t=new ue(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleChainError(e,t,r,s,i){await Promise.all(this.handlers.map(a=>ee(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainError)==null?void 0:o.call(a,e,this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${a.constructor.name}, handleChainError: ${c}`)}},a.awaitHandlers)))}async handleChainEnd(e,t,r,s,i){await Promise.all(this.handlers.map(a=>ee(async()=>{var o;if(!a.ignoreChain)try{await((o=a.handleChainEnd)==null?void 0:o.call(a,e,this.runId,this._parentRunId,this.tags,i))}catch(c){console.error(`Error in handler ${a.constructor.name}, handleChainEnd: ${c}`)}},a.awaitHandlers)))}async handleAgentAction(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentAction)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentAction: ${s}`)}},t.awaitHandlers)))}async handleAgentEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleAgentEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleAgentEnd: ${s}`)}},t.awaitHandlers)))}}class Ah extends ss{getChild(e){const t=new ue(this.runId);return t.setHandlers(this.inheritableHandlers),t.addTags(this.inheritableTags),t.addMetadata(this.inheritableMetadata),e&&t.addTags([e],!1),t}async handleToolError(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolError)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolError: ${s}`)}},t.awaitHandlers)))}async handleToolEnd(e){await Promise.all(this.handlers.map(t=>ee(async()=>{var r;if(!t.ignoreAgent)try{await((r=t.handleToolEnd)==null?void 0:r.call(t,e,this.runId,this._parentRunId,this.tags))}catch(s){console.error(`Error in handler ${t.constructor.name}, handleToolEnd: ${s}`)}},t.awaitHandlers)))}}class ue extends Eh{constructor(e,t){super(),Object.defineProperty(this,"handlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableHandlers",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"inheritableTags",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"inheritableMetadata",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"callback_manager"}),Object.defineProperty(this,"_parentRunId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.handlers=(t==null?void 0:t.handlers)??this.handlers,this.inheritableHandlers=(t==null?void 0:t.inheritableHandlers)??this.inheritableHandlers,this.tags=(t==null?void 0:t.tags)??this.tags,this.inheritableTags=(t==null?void 0:t.inheritableTags)??this.inheritableTags,this.metadata=(t==null?void 0:t.metadata)??this.metadata,this.inheritableMetadata=(t==null?void 0:t.inheritableMetadata)??this.inheritableMetadata,this._parentRunId=e}async handleLLMStart(e,t,r=void 0,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0){return Promise.all(t.map(async l=>{const d=Ve();return await Promise.all(this.handlers.map(f=>ee(async()=>{var m;if(!f.ignoreLLM)try{await((m=f.handleLLMStart)==null?void 0:m.call(f,e,[l],d,this._parentRunId,i,this.tags,this.metadata,c))}catch(b){console.error(`Error in handler ${f.constructor.name}, handleLLMStart: ${b}`)}},f.awaitHandlers))),new $a(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChatModelStart(e,t,r=void 0,s=void 0,i=void 0,a=void 0,o=void 0,c=void 0){return Promise.all(t.map(async l=>{const d=Ve();return await Promise.all(this.handlers.map(f=>ee(async()=>{var m,b;if(!f.ignoreLLM)try{if(f.handleChatModelStart)await((m=f.handleChatModelStart)==null?void 0:m.call(f,e,[l],d,this._parentRunId,i,this.tags,this.metadata,c));else if(f.handleLLMStart){const v=Qo(l);await((b=f.handleLLMStart)==null?void 0:b.call(f,e,[v],d,this._parentRunId,i,this.tags,this.metadata,c))}}catch(v){console.error(`Error in handler ${f.constructor.name}, handleLLMStart: ${v}`)}},f.awaitHandlers))),new $a(d,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}))}async handleChainStart(e,t,r=Ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>ee(async()=>{var l;if(!c.ignoreChain)try{await((l=c.handleChainStart)==null?void 0:l.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,s,o))}catch(d){console.error(`Error in handler ${c.constructor.name}, handleChainStart: ${d}`)}},c.awaitHandlers))),new Ph(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleToolStart(e,t,r=Ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>ee(async()=>{var l;if(!c.ignoreAgent)try{await((l=c.handleToolStart)==null?void 0:l.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(d){console.error(`Error in handler ${c.constructor.name}, handleToolStart: ${d}`)}},c.awaitHandlers))),new Ah(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}async handleRetrieverStart(e,t,r=Ve(),s=void 0,i=void 0,a=void 0,o=void 0){return await Promise.all(this.handlers.map(c=>ee(async()=>{var l;if(!c.ignoreRetriever)try{await((l=c.handleRetrieverStart)==null?void 0:l.call(c,e,t,r,this._parentRunId,this.tags,this.metadata,o))}catch(d){console.error(`Error in handler ${c.constructor.name}, handleRetrieverStart: ${d}`)}},c.awaitHandlers))),new Oh(r,this.handlers,this.inheritableHandlers,this.tags,this.inheritableTags,this.metadata,this.inheritableMetadata,this._parentRunId)}addHandler(e,t=!0){this.handlers.push(e),t&&this.inheritableHandlers.push(e)}removeHandler(e){this.handlers=this.handlers.filter(t=>t!==e),this.inheritableHandlers=this.inheritableHandlers.filter(t=>t!==e)}setHandlers(e,t=!0){this.handlers=[],this.inheritableHandlers=[];for(const r of e)this.addHandler(r,t)}addTags(e,t=!0){this.removeTags(e),this.tags.push(...e),t&&this.inheritableTags.push(...e)}removeTags(e){this.tags=this.tags.filter(t=>!e.includes(t)),this.inheritableTags=this.inheritableTags.filter(t=>!e.includes(t))}addMetadata(e,t=!0){this.metadata={...this.metadata,...e},t&&(this.inheritableMetadata={...this.inheritableMetadata,...e})}removeMetadata(e){for(const t of Object.keys(e))delete this.metadata[t],delete this.inheritableMetadata[t]}copy(e=[],t=!0){const r=new ue(this._parentRunId);for(const s of this.handlers){const i=this.inheritableHandlers.includes(s);r.addHandler(s,i)}for(const s of this.tags){const i=this.inheritableTags.includes(s);r.addTags([s],i)}for(const s of Object.keys(this.metadata)){const i=Object.keys(this.inheritableMetadata).includes(s);r.addMetadata({[s]:this.metadata[s]},i)}for(const s of e)r.handlers.filter(i=>i.name==="console_callback_handler").some(i=>i.name===s.name)||r.addHandler(s,t);return r}static fromHandlers(e){class t extends Hr{constructor(){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:Ve()}),Object.assign(this,e)}}const r=new this;return r.addHandler(new t),r}static async configure(e,t,r,s,i,a,o){let c;(e||t)&&(Array.isArray(e)||!e?(c=new ue,c.setHandlers((e==null?void 0:e.map(Na))??[],!0)):c=e,c=c.copy(Array.isArray(t)?t.map(Na):t==null?void 0:t.handlers,!1));const l=J("LANGCHAIN_VERBOSE")==="true"||(o==null?void 0:o.verbose),d=J("LANGCHAIN_TRACING_V2")==="true",f=d||(J("LANGCHAIN_TRACING")??!1);if(l||f){if(c||(c=new ue),l&&!c.handlers.some(m=>m.name===ka.prototype.name)){const m=new ka;c.addHandler(m,!0)}f&&!c.handlers.some(m=>m.name==="langchain_tracer")&&d&&c.addHandler(await vh(),!0)}return(r||s)&&c&&(c.addTags(r??[]),c.addTags(s??[],!1)),(i||a)&&c&&(c.addMetadata(i??{}),c.addMetadata(a??{},!1)),c}}function Na(n){return"name"in n?n:Hr.fromMethods(n)}/*!
 * https://github.com/Starcounter-Jack/JSON-Patch
 * (c) 2017-2022 Joachim Wester
 * MIT licensed
 */const Ih=Object.prototype.hasOwnProperty;function kh(n,e){return Ih.call(n,e)}function Ch(n){if(Array.isArray(n)){const t=new Array(n.length);for(let r=0;r<t.length;r++)t[r]=""+r;return t}if(Object.keys)return Object.keys(n);let e=[];for(let t in n)kh(n,t)&&e.push(t);return e}function qt(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function oi(n){let e=0;const t=n.length;let r;for(;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function Sh(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function ci(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(let t=0,r=n.length;t<r;t++)if(ci(n[t]))return!0}else if(typeof n=="object"){const t=Ch(n),r=t.length;for(var e=0;e<r;e++)if(ci(n[t[e]]))return!0}}return!1}function Da(n,e){const t=[n];for(const r in e){const s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s<"u"&&t.push(`${r}: ${s}`)}return t.join(`
`)}class xh extends Error{constructor(e,t,r,s,i){super(Da(e,{name:t,index:r,operation:s,tree:i})),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:t}),Object.defineProperty(this,"index",{enumerable:!0,configurable:!0,writable:!0,value:r}),Object.defineProperty(this,"operation",{enumerable:!0,configurable:!0,writable:!0,value:s}),Object.defineProperty(this,"tree",{enumerable:!0,configurable:!0,writable:!0,value:i}),Object.setPrototypeOf(this,new.target.prototype),this.message=Da(e,{name:t,index:r,operation:s,tree:i})}}const H=xh,Ut={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){let r=ui(t,this.path);r&&(r=qt(r));const s=jr(t,{op:"remove",path:this.from}).removed;return jr(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:r}},copy:function(n,e,t){const r=ui(t,this.from);return jr(t,{op:"add",path:this.path,value:qt(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:Kn(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}};var Rh={add:function(n,e,t){return oi(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:Ut.move,copy:Ut.copy,test:Ut.test,_get:Ut._get};function ui(n,e){if(e=="")return n;var t={op:"_get",path:e};return jr(n,t),t.value}function jr(n,e,t=!1,r=!0,s=!0,i=0){if(t&&(typeof t=="function"?t(e,0,n,e.path):li(e,0)),e.path===""){let a={newDocument:n};if(e.op==="add")return a.newDocument=e.value,a;if(e.op==="replace")return a.newDocument=e.value,a.removed=n,a;if(e.op==="move"||e.op==="copy")return a.newDocument=ui(n,e.from),e.op==="move"&&(a.removed=n),a;if(e.op==="test"){if(a.test=Kn(n,e.value),a.test===!1)throw new H("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return a.newDocument=n,a}else{if(e.op==="remove")return a.removed=n,a.newDocument=null,a;if(e.op==="_get")return e.value=n,a;if(t)throw new H("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,n);return a}}else{r||(n=qt(n));const o=(e.path||"").split("/");let c=n,l=1,d=o.length,f,m,b;for(typeof t=="function"?b=t:b=li;;){if(m=o[l],m&&m.indexOf("~")!=-1&&(m=Sh(m)),s&&(m=="__proto__"||m=="prototype"&&l>0&&o[l-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&f===void 0&&(c[m]===void 0?f=o.slice(0,l).join("/"):l==d-1&&(f=e.path),f!==void 0&&b(e,0,n,f)),l++,Array.isArray(c)){if(m==="-")m=c.length;else{if(t&&!oi(m))throw new H("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,n);oi(m)&&(m=~~m)}if(l>=d){if(t&&e.op==="add"&&m>c.length)throw new H("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,n);const v=Rh[e.op].call(e,c,m,n);if(v.test===!1)throw new H("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return v}}else if(l>=d){const v=Ut[e.op].call(e,c,m,n);if(v.test===!1)throw new H("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return v}if(c=c[m],t&&l<d&&(!c||typeof c!="object"))throw new H("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,n)}}}function Ji(n,e,t,r=!0,s=!0){if(t&&!Array.isArray(e))throw new H("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=qt(n));const i=new Array(e.length);for(let a=0,o=e.length;a<o;a++)i[a]=jr(n,e[a],t,!0,s,a),n=i[a].newDocument;return i.newDocument=n,i}function li(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new H("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(Ut[n.op]){if(typeof n.path!="string")throw new H("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new H('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new H("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new H("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&ci(n.value))throw new H("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var s=n.path.split("/").length,i=r.split("/").length;if(s!==i+1&&s!==i)throw new H("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new H("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var a={op:"_get",path:n.from,value:void 0},o=jh([a],t);if(o&&o.name==="OPERATION_PATH_UNRESOLVABLE")throw new H("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new H("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function jh(n,e,t){try{if(!Array.isArray(n))throw new H("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)Ji(qt(e),qt(n),t||!0);else{t=t||li;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(s){if(s instanceof H)return s;throw s}}function Kn(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),s,i,a;if(t&&r){if(i=n.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!Kn(n[s],e[s]))return!1;return!0}if(t!=r)return!1;var o=Object.keys(n);if(i=o.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(o[s]))return!1;for(s=i;s--!==0;)if(a=o[s],!Kn(n[a],e[a]))return!1;return!0}return n!==n&&e!==e}class Ke extends ReadableStream{constructor(){super(...arguments),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}ensureReader(){this.reader||(this.reader=this.getReader())}async next(){this.ensureReader();try{const e=await this.reader.read();return e.done&&this.reader.releaseLock(),{done:e.done,value:e.value}}catch(e){throw this.reader.releaseLock(),e}}async return(){if(this.ensureReader(),this.locked){const e=this.reader.cancel();this.reader.releaseLock(),await e}return{done:!0,value:void 0}}async throw(e){if(this.ensureReader(),this.locked){const t=this.reader.cancel();this.reader.releaseLock(),await t}throw e}[Symbol.asyncIterator](){return this}static fromReadableStream(e){const t=e.getReader();return new Ke({start(r){return s();function s(){return t.read().then(({done:i,value:a})=>{if(i){r.close();return}return r.enqueue(a),s()})}},cancel(){t.releaseLock()}})}static fromAsyncGenerator(e){return new Ke({async pull(t){const{value:r,done:s}=await e.next();s&&t.close(),t.enqueue(r)}})}}function mc(n,e=2){const t=Array.from({length:e},()=>[]);return t.map(async function*(s){for(;;)if(s.length===0){const i=await n.next();for(const a of t)a.push(i)}else{if(s[0].done)return;yield s.shift().value}})}function Bt(n,e){if(Array.isArray(n)&&Array.isArray(e))return n.concat(e);if(typeof n=="string"&&typeof e=="string")return n+e;if(typeof n=="number"&&typeof e=="number")return n+e;if("concat"in n&&typeof n.concat=="function")return n.concat(e);if(typeof n=="object"&&typeof e=="object"){const t={...n};for(const[r,s]of Object.entries(e))r in t?t[r]=Bt(t[r],s):t[r]=s;return t}else throw new Error(`Cannot concat ${typeof n} and ${typeof e}`)}class $h{constructor(e,t){Object.defineProperty(this,"generator",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"setup",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResult",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"firstResultUsed",{enumerable:!0,configurable:!0,writable:!0,value:!1}),this.generator=e,this.setup=new Promise((r,s)=>{this.firstResult=e.next(),this.firstResult.then(t).then(r,s)})}async next(...e){return this.firstResultUsed?this.generator.next(...e):(this.firstResultUsed=!0,this.firstResult)}async return(e){return this.generator.return(e)}async throw(e){return this.generator.throw(e)}[Symbol.asyncIterator](){return this}}async function Nh(n,e,t,...r){const s=new $h(e,t),i=await s.setup;return{output:n(s,i,...r),setup:i}}class yt{constructor(e){Object.defineProperty(this,"ops",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.ops=e.ops}concat(e){const t=this.ops.concat(e.ops),r=Ji({},t);return new Gi({ops:t,state:r[r.length-1].newDocument})}}class Gi extends yt{constructor(e){super(e),Object.defineProperty(this,"state",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.state=e.state}concat(e){const t=this.ops.concat(e.ops),r=Ji(this.state,e.ops);return new Gi({ops:t,state:r[r.length-1].newDocument})}}class Dh extends ns{constructor(e){super(e),Object.defineProperty(this,"autoClose",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"includeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"includeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeNames",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTypes",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"excludeTags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"keyMapByRunId",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"counterMapByRunName",{enumerable:!0,configurable:!0,writable:!0,value:{}}),Object.defineProperty(this,"transformStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"writer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"receiveStream",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"log_stream_tracer"}),this.autoClose=(e==null?void 0:e.autoClose)??!0,this.includeNames=e==null?void 0:e.includeNames,this.includeTypes=e==null?void 0:e.includeTypes,this.includeTags=e==null?void 0:e.includeTags,this.excludeNames=e==null?void 0:e.excludeNames,this.excludeTypes=e==null?void 0:e.excludeTypes,this.excludeTags=e==null?void 0:e.excludeTags,this.transformStream=new TransformStream,this.writer=this.transformStream.writable.getWriter(),this.receiveStream=Ke.fromReadableStream(this.transformStream.readable)}[Symbol.asyncIterator](){return this.receiveStream}async persistRun(e){}_includeRun(e){if(e.parent_run_id===void 0)return!1;const t=e.tags??[];let r=this.includeNames===void 0&&this.includeTags===void 0&&this.includeTypes===void 0;return this.includeNames!==void 0&&(r=r||this.includeNames.includes(e.name)),this.includeTypes!==void 0&&(r=r||this.includeTypes.includes(e.run_type)),this.includeTags!==void 0&&(r=r||t.find(s=>{var i;return(i=this.includeTags)==null?void 0:i.includes(s)})!==void 0),this.excludeNames!==void 0&&(r=r&&!this.excludeNames.includes(e.name)),this.excludeTypes!==void 0&&(r=r&&!this.excludeTypes.includes(e.run_type)),this.excludeTags!==void 0&&(r=r&&t.every(s=>{var i;return!((i=this.excludeTags)!=null&&i.includes(s))})),r}async onRunCreate(e){var s;if(e.parent_run_id===void 0&&await this.writer.write(new yt({ops:[{op:"replace",path:"",value:{id:e.id,streamed_output:[],final_output:void 0,logs:{}}}]})),!this._includeRun(e))return;this.counterMapByRunName[e.name]===void 0&&(this.counterMapByRunName[e.name]=0),this.counterMapByRunName[e.name]+=1;const t=this.counterMapByRunName[e.name];this.keyMapByRunId[e.id]=t===1?e.name:`${e.name}:${t}`;const r={id:e.id,name:e.name,type:e.run_type,tags:e.tags??[],metadata:((s=e.extra)==null?void 0:s.metadata)??{},start_time:new Date(e.start_time).toISOString(),streamed_output_str:[],final_output:void 0,end_time:void 0};await this.writer.write(new yt({ops:[{op:"add",path:`/logs/${this.keyMapByRunId[e.id]}`,value:r}]}))}async onRunUpdate(e){try{const t=this.keyMapByRunId[e.id];if(t===void 0)return;const r=[{op:"add",path:`/logs/${t}/final_output`,value:e.outputs}];e.end_time!==void 0&&r.push({op:"add",path:`/logs/${t}/end_time`,value:new Date(e.end_time).toISOString()});const s=new yt({ops:r});await this.writer.write(s)}finally{if(e.parent_run_id===void 0){const t=new yt({ops:[{op:"replace",path:"/final_output",value:e.outputs}]});await this.writer.write(t),this.autoClose&&await this.writer.close()}}}async onLLMNewToken(e,t){const r=this.keyMapByRunId[e.id];if(r===void 0)return;const s=new yt({ops:[{op:"add",path:`/logs/${r}/streamed_output_str/-`,value:t}]});await this.writer.write(s)}}const La=25;async function wt(n){return ue.configure(n==null?void 0:n.callbacks,void 0,n==null?void 0:n.tags,void 0,n==null?void 0:n.metadata)}function Ua(n,e){const t={...n};if(e)for(const r of Object.keys(e))if(r==="metadata")t[r]={...t[r],...e[r]};else if(r==="tags")t[r]=(t[r]??[]).concat(e[r]??[]);else if(r==="configurable")t[r]={...t[r],...e[r]};else if(r==="callbacks"){const s=t.callbacks,i=e.callbacks??n.callbacks;if(Array.isArray(i))if(!s)t.callbacks=i;else if(Array.isArray(s))t.callbacks=s.concat(i);else{const a=s.copy();for(const o of i)a.addHandler(o,!0);t.callbacks=a}else if(i)if(!s)t.callbacks=i;else if(Array.isArray(s)){const a=i.copy();for(const o of s)a.addHandler(o,!0);t.callbacks=a}else t.callbacks=new ue(i.parentRunId,{handlers:s.handlers.concat(i.handlers),inheritableHandlers:s.inheritableHandlers.concat(i.inheritableHandlers),tags:Array.from(new Set(s.tags.concat(i.tags))),inheritableTags:Array.from(new Set(s.inheritableTags.concat(i.inheritableTags))),metadata:{...s.metadata,...i.metadata}})}else t[r]=e[r]??t[r];return t}class gc extends ns{constructor({config:e,onStart:t,onEnd:r,onError:s}){super(),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:"RootListenersTracer"}),Object.defineProperty(this,"rootId",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnStart",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnEnd",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"argOnError",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.config=e,this.argOnStart=t,this.argOnEnd=r,this.argOnError=s}persistRun(e){return Promise.resolve()}async onRunCreate(e){this.rootId||(this.rootId=e.id,this.argOnStart&&(this.argOnStart.length===1?await this.argOnStart(e):this.argOnStart.length===2&&await this.argOnStart(e,this.config)))}async onRunUpdate(e){e.id===this.rootId&&(e.error?this.argOnError&&(this.argOnError.length===1?await this.argOnError(e):this.argOnError.length===2&&await this.argOnError(e,this.config)):this.argOnEnd&&(this.argOnEnd.length===1?await this.argOnEnd(e):this.argOnEnd.length===2&&await this.argOnEnd(e,this.config)))}}function ae(n,e){return n&&!Array.isArray(n)&&typeof n=="object"?n:{[e]:n}}class X extends ot{constructor(){super(...arguments),Object.defineProperty(this,"lc_runnable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0})}getName(e){const t=this.name??this.constructor.lc_name()??this.constructor.name;return e?`${t}${e}`:t}bind(e){return new Vt({bound:this,kwargs:e,config:{}})}map(){return new Hn({bound:this})}withRetry(e){return new Lh({bound:this,kwargs:{},config:{},maxAttemptNumber:e==null?void 0:e.stopAfterAttempt,...e})}withConfig(e){return new Vt({bound:this,config:e,kwargs:{}})}withFallbacks(e){return new Uh({runnable:this,fallbacks:e.fallbacks})}_getOptionsList(e,t=0){if(Array.isArray(e)){if(e.length!==t)throw new Error(`Passed "options" must be an array with the same length as the inputs, but got ${e.length} options for ${t} inputs`);return e}return Array.from({length:t},()=>e)}async batch(e,t,r){const s=this._getOptionsList(t??{},e.length),i=new ts({maxConcurrency:r==null?void 0:r.maxConcurrency,onFailedAttempt:o=>{throw o}}),a=e.map((o,c)=>i.call(async()=>{try{return await this.invoke(o,s[c])}catch(l){if(r!=null&&r.returnExceptions)return l;throw l}}));return Promise.all(a)}async*_streamIterator(e,t){yield this.invoke(e,t)}async stream(e,t){return Ke.fromAsyncGenerator(this._streamIterator(e,t))}_separateRunnableConfigFromCallOptions(e={}){const t={callbacks:e.callbacks,tags:e.tags,metadata:e.metadata,runName:e.runName,configurable:e.configurable},r={...e};return delete r.callbacks,delete r.tags,delete r.metadata,delete r.runName,delete r.configurable,[t,r]}async _callWithConfig(e,t,r){const s=await wt(r),i=await(s==null?void 0:s.handleChainStart(this.toJSON(),ae(t,"input"),void 0,r==null?void 0:r.runType,void 0,void 0,(r==null?void 0:r.runName)??this.getName()));let a;try{a=await e.bind(this)(t,r,i)}catch(o){throw await(i==null?void 0:i.handleChainError(o)),o}return await(i==null?void 0:i.handleChainEnd(ae(a,"output"))),a}async _batchWithConfig(e,t,r,s){const i=this._getOptionsList(r??{},t.length),a=await Promise.all(i.map(wt)),o=await Promise.all(a.map((l,d)=>l==null?void 0:l.handleChainStart(this.toJSON(),ae(t[d],"input"),void 0,i[d].runType,void 0,void 0,i[d].runName??this.getName())));let c;try{c=await e(t,i,o,s)}catch(l){throw await Promise.all(o.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(o.map(l=>l==null?void 0:l.handleChainEnd(ae(c,"output")))),c}async*_transformStreamWithConfig(e,t,r){let s,i=!0,a,o=!0;const c=await wt(r);async function*l(){for await(const f of e){if(i)if(s===void 0)s=f;else try{s=Bt(s,f)}catch{s=void 0,i=!1}yield f}}let d;try{const f=await Nh(t,l(),async()=>c==null?void 0:c.handleChainStart(this.toJSON(),{input:""},void 0,r==null?void 0:r.runType,void 0,void 0,(r==null?void 0:r.runName)??this.getName()),r);d=f.setup;for await(const m of f.output)if(yield m,o)if(a===void 0)a=m;else try{a=Bt(a,m)}catch{a=void 0,o=!1}}catch(f){throw await(d==null?void 0:d.handleChainError(f,void 0,void 0,void 0,{inputs:ae(s,"input")})),f}await(d==null?void 0:d.handleChainEnd(a??{},void 0,void 0,void 0,{inputs:ae(s,"input")}))}_patchConfig(e={},t=void 0,r=void 0){const s={...e};return t!==void 0?(delete s.runName,{...s,callbacks:t}):(r!==void 0&&(s.recursionLimit=r),s)}pipe(e){return new st({first:this,last:vt(e)})}pick(e){return this.pipe(new Zh(e))}assign(e){return this.pipe(new yc(new Wt({steps:e})))}async*transform(e,t){let r;for await(const s of e)r===void 0?r=s:r=Bt(r,s);yield*this._streamIterator(r,t)}async*streamLog(e,t,r){const s=new Dh({...r,autoClose:!1}),i=t??{},{callbacks:a}=i;if(a===void 0)i.callbacks=[s];else if(Array.isArray(a))i.callbacks=a.concat([s]);else{const d=a.copy();d.inheritableHandlers.push(s),i.callbacks=d}const o=await this.stream(e,i);async function c(){try{for await(const d of o){const f=new yt({ops:[{op:"add",path:"/streamed_output/-",value:d}]});await s.writer.write(f)}}finally{await s.writer.close()}}const l=c();try{for await(const d of s)yield d}finally{await l}}static isRunnable(e){return e?e.lc_runnable:!1}withListeners({onStart:e,onEnd:t,onError:r}){return new Vt({bound:this,config:{},configFactories:[s=>({callbacks:[new gc({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class Vt extends X{static lc_name(){return"RunnableBinding"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"config",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"kwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"configFactories",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound,this.kwargs=e.kwargs,this.config=e.config,this.configFactories=e.configFactories}getName(e){return this.bound.getName(e)}async _mergeConfig(e){const t=Ua(this.config,e);return Ua(t,...this.configFactories?await Promise.all(this.configFactories.map(async r=>await r(t))):[])}bind(e){return new this.constructor({bound:this.bound,kwargs:{...this.kwargs,...e},config:this.config})}withConfig(e){return new this.constructor({bound:this.bound,kwargs:this.kwargs,config:{...this.config,...e}})}withRetry(e){return new this.constructor({bound:this.bound.withRetry(e),kwargs:this.kwargs,config:this.config})}async invoke(e,t){return this.bound.invoke(e,await this._mergeConfig({...t,...this.kwargs}))}async batch(e,t,r){const s=Array.isArray(t)?await Promise.all(t.map(async i=>this._mergeConfig({...i,...this.kwargs}))):await this._mergeConfig({...t,...this.kwargs});return this.bound.batch(e,s,r)}async*_streamIterator(e,t){yield*this.bound._streamIterator(e,await this._mergeConfig({...t,...this.kwargs}))}async stream(e,t){return this.bound.stream(e,await this._mergeConfig({...t,...this.kwargs}))}async*transform(e,t){yield*this.bound.transform(e,await this._mergeConfig({...t,...this.kwargs}))}static isRunnableBinding(e){return e.bound&&X.isRunnable(e.bound)}withListeners({onStart:e,onEnd:t,onError:r}){return new Vt({bound:this.bound,kwargs:this.kwargs,config:this.config,configFactories:[s=>({callbacks:[new gc({config:s,onStart:e,onEnd:t,onError:r})]})]})}}class Hn extends X{static lc_name(){return"RunnableEach"}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"bound",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.bound=e.bound}bind(e){return new Hn({bound:this.bound.bind(e)})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _invoke(e,t,r){return this.bound.batch(e,this._patchConfig(t,r==null?void 0:r.getChild()))}withListeners({onStart:e,onEnd:t,onError:r}){return new Hn({bound:this.bound.withListeners({onStart:e,onEnd:t,onError:r})})}}class Lh extends Vt{static lc_name(){return"RunnableRetry"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"maxAttemptNumber",{enumerable:!0,configurable:!0,writable:!0,value:3}),Object.defineProperty(this,"onFailedAttempt",{enumerable:!0,configurable:!0,writable:!0,value:()=>{}}),this.maxAttemptNumber=e.maxAttemptNumber??this.maxAttemptNumber,this.onFailedAttempt=e.onFailedAttempt??this.onFailedAttempt}_patchConfigForRetry(e,t,r){const s=e>1?`retry:attempt:${e}`:void 0;return this._patchConfig(t,r==null?void 0:r.getChild(s))}async _invoke(e,t,r){return qn(s=>super.invoke(e,this._patchConfigForRetry(s,t,r)),{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async _batch(e,t,r,s){const i={};try{await qn(async a=>{const o=e.map((m,b)=>b).filter(m=>i[m.toString()]===void 0||i[m.toString()]instanceof Error),c=o.map(m=>e[m]),l=o.map(m=>this._patchConfigForRetry(a,t==null?void 0:t[m],r==null?void 0:r[m])),d=await super.batch(c,l,{...s,returnExceptions:!0});let f;for(let m=0;m<d.length;m+=1){const b=d[m],v=o[m];b instanceof Error&&f===void 0&&(f=b),i[v.toString()]=b}if(f)throw f;return d},{onFailedAttempt:this.onFailedAttempt,retries:Math.max(this.maxAttemptNumber-1,0),randomize:!0})}catch(a){if((s==null?void 0:s.returnExceptions)!==!0)throw a}return Object.keys(i).sort((a,o)=>parseInt(a,10)-parseInt(o,10)).map(a=>i[parseInt(a,10)])}async batch(e,t,r){return this._batchWithConfig(this._batch.bind(this),e,t,r)}}class st extends X{static lc_name(){return"RunnableSequence"}constructor(e){super(e),Object.defineProperty(this,"first",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"middle",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"last",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),this.first=e.first,this.middle=e.middle??this.middle,this.last=e.last,this.name=e.name}get steps(){return[this.first,...this.middle,this.last]}async invoke(e,t){const r=await wt(t),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),ae(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let i=e,a;try{const o=[this.first,...this.middle];for(let c=0;c<o.length;c+=1)i=await o[c].invoke(i,this._patchConfig(t,s==null?void 0:s.getChild(`seq:step:${c+1}`)));a=await this.last.invoke(i,this._patchConfig(t,s==null?void 0:s.getChild(`seq:step:${this.steps.length}`)))}catch(o){throw await(s==null?void 0:s.handleChainError(o)),o}return await(s==null?void 0:s.handleChainEnd(ae(a,"output"))),a}async batch(e,t,r){const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(wt)),a=await Promise.all(i.map((l,d)=>l==null?void 0:l.handleChainStart(this.toJSON(),ae(e[d],"input"),void 0,void 0,void 0,void 0,s[d].runName)));let o=e,c;try{const l=[this.first,...this.middle];for(let d=0;d<l.length;d+=1)o=await l[d].batch(o,a.map((m,b)=>this._patchConfig(s[b],m==null?void 0:m.getChild(`seq:step:${d+1}`))),r);c=await this.last.batch(o,a.map(d=>this._patchConfig(s[this.steps.length-1],d==null?void 0:d.getChild(`seq:step:${this.steps.length}`))),r)}catch(l){throw await Promise.all(a.map(d=>d==null?void 0:d.handleChainError(l))),l}return await Promise.all(a.map((l,d)=>l==null?void 0:l.handleChainEnd(ae(c[d],"output")))),c}async*_streamIterator(e,t){const r=await wt(t),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),ae(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),i=[this.first,...this.middle,this.last];let a=!0,o;async function*c(){yield e}try{let l=i[0].transform(c(),this._patchConfig(t,s==null?void 0:s.getChild("seq:step:1")));for(let d=1;d<i.length;d+=1)l=await i[d].transform(l,this._patchConfig(t,s==null?void 0:s.getChild(`seq:step:${d+1}`)));for await(const d of l)if(yield d,a)if(o===void 0)o=d;else try{o=Bt(o,d)}catch{o=void 0,a=!1}}catch(l){throw await(s==null?void 0:s.handleChainError(l)),l}await(s==null?void 0:s.handleChainEnd(ae(o,"output")))}pipe(e){return st.isRunnableSequence(e)?new st({first:this.first,middle:this.middle.concat([this.last,e.first,...e.middle]),last:e.last,name:this.name??e.name}):new st({first:this.first,middle:[...this.middle,this.last],last:vt(e),name:this.name})}static isRunnableSequence(e){return Array.isArray(e.middle)&&X.isRunnable(e)}static from([e,...t],r){return new st({first:vt(e),middle:t.slice(0,-1).map(vt),last:vt(t[t.length-1]),name:r})}}class Wt extends X{static lc_name(){return"RunnableMap"}getStepsKeys(){return Object.keys(this.steps)}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"steps",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.steps={};for(const[t,r]of Object.entries(e.steps))this.steps[t]=vt(r)}static from(e){return new Wt({steps:e})}async invoke(e,t){const r=await wt(t),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),{input:e},void 0,void 0,void 0,void 0,t==null?void 0:t.runName)),i={};try{await Promise.all(Object.entries(this.steps).map(async([a,o])=>{i[a]=await o.invoke(e,this._patchConfig(t,s==null?void 0:s.getChild(`map:key:${a}`)))}))}catch(a){throw await(s==null?void 0:s.handleChainError(a)),a}return await(s==null?void 0:s.handleChainEnd(i)),i}async*_transform(e,t,r){const s={...this.steps},i=mc(e,Object.keys(s).length),a=new Map(Object.entries(s).map(([o,c],l)=>{const d=c.transform(i[l],this._patchConfig(r,t==null?void 0:t.getChild(`map:key:${o}`)));return[o,d.next().then(f=>({key:o,gen:d,result:f}))]}));for(;a.size;){const{key:o,result:c,gen:l}=await Promise.race(a.values());a.delete(o),c.done||(yield{[o]:c.value},a.set(o,l.next().then(d=>({key:o,gen:l,result:d}))))}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}return Ke.fromAsyncGenerator(this.transform(r(),t))}}class Wi extends X{static lc_name(){return"RunnableLambda"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"func",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.func=e.func}static from(e){return new Wi({func:e})}async _invoke(e,t,r){let s=await this.func(e,{config:t});if(s&&X.isRunnable(s)){if((t==null?void 0:t.recursionLimit)===0)throw new Error("Recursion limit reached.");s=await s.invoke(e,this._patchConfig(t,r==null?void 0:r.getChild(),((t==null?void 0:t.recursionLimit)??La)-1))}return s}async invoke(e,t){return this._callWithConfig(this._invoke,e,t)}async*_transform(e,t,r){let s;for await(const a of e)if(s===void 0)s=a;else try{s=Bt(s,a)}catch{s=a}const i=await this.func(s,{config:r});if(i&&X.isRunnable(i)){if((r==null?void 0:r.recursionLimit)===0)throw new Error("Recursion limit reached.");const a=await i.stream(s,this._patchConfig(r,t==null?void 0:t.getChild(),((r==null?void 0:r.recursionLimit)??La)-1));for await(const o of a)yield o}else yield i}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}return Ke.fromAsyncGenerator(this.transform(r(),t))}}class Uh extends X{static lc_name(){return"RunnableWithFallbacks"}constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"runnable",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"fallbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.runnable=e.runnable,this.fallbacks=e.fallbacks}*runnables(){yield this.runnable;for(const e of this.fallbacks)yield e}async invoke(e,t){const r=await ue.configure(t==null?void 0:t.callbacks,void 0,t==null?void 0:t.tags,void 0,t==null?void 0:t.metadata),s=await(r==null?void 0:r.handleChainStart(this.toJSON(),ae(e,"input"),void 0,void 0,void 0,void 0,t==null?void 0:t.runName));let i;for(const a of this.runnables())try{const o=await a.invoke(e,this._patchConfig(t,s==null?void 0:s.getChild()));return await(s==null?void 0:s.handleChainEnd(ae(o,"output"))),o}catch(o){i===void 0&&(i=o)}throw i===void 0?new Error("No error stored at end of fallback."):(await(s==null?void 0:s.handleChainError(i)),i)}async batch(e,t,r){if(r!=null&&r.returnExceptions)throw new Error("Not implemented.");const s=this._getOptionsList(t??{},e.length),i=await Promise.all(s.map(c=>ue.configure(c==null?void 0:c.callbacks,void 0,c==null?void 0:c.tags,void 0,c==null?void 0:c.metadata))),a=await Promise.all(i.map((c,l)=>c==null?void 0:c.handleChainStart(this.toJSON(),ae(e[l],"input"),void 0,void 0,void 0,void 0,s[l].runName)));let o;for(const c of this.runnables())try{const l=await c.batch(e,a.map((d,f)=>this._patchConfig(s[f],d==null?void 0:d.getChild())),r);return await Promise.all(a.map((d,f)=>d==null?void 0:d.handleChainEnd(ae(l[f],"output")))),l}catch(l){o===void 0&&(o=l)}throw o?(await Promise.all(a.map(c=>c==null?void 0:c.handleChainError(o))),o):new Error("No error stored at end of fallbacks.")}}function vt(n){if(typeof n=="function")return new Wi({func:n});if(X.isRunnable(n))return n;if(!Array.isArray(n)&&typeof n=="object"){const e={};for(const[t,r]of Object.entries(n))e[t]=vt(r);return new Wt({steps:e})}else throw new Error(`Expected a Runnable, function or object.
Instead got an unsupported type.`)}class yc extends X{static lc_name(){return"RunnableAssign"}constructor(e){e instanceof Wt&&(e={mapper:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"mapper",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.mapper=e.mapper}async invoke(e,t){const r=await this.mapper.invoke(e,t);return{...e,...r}}async*_transform(e,t,r){const s=this.mapper.getStepsKeys(),[i,a]=mc(e),o=this.mapper.transform(a,this._patchConfig(r,t==null?void 0:t.getChild())),c=o.next();for await(const l of i){if(typeof l!="object"||Array.isArray(l))throw new Error(`RunnableAssign can only be used with objects as input, got ${typeof l}`);const d=Object.fromEntries(Object.entries(l).filter(([f])=>!s.includes(f)));Object.keys(d).length>0&&(yield d)}yield(await c).value;for await(const l of o)yield l}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}return Ke.fromAsyncGenerator(this.transform(r(),t))}}class Zh extends X{static lc_name(){return"RunnablePick"}constructor(e){(typeof e=="string"||Array.isArray(e))&&(e={keys:e}),super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"keys",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keys=e.keys}async _pick(e){if(typeof this.keys=="string")return e[this.keys];{const t=this.keys.map(r=>[r,e[r]]).filter(r=>r[1]!==void 0);return t.length===0?void 0:Object.fromEntries(t)}}async invoke(e,t){return this._callWithConfig(this._pick.bind(this),e,t)}async*_transform(e){for await(const t of e){const r=await this._pick(t);r!==void 0&&(yield r)}}transform(e,t){return this._transformStreamWithConfig(e,this._transform.bind(this),t)}async stream(e,t){async function*r(){yield e}return Ke.fromAsyncGenerator(this.transform(r(),t))}}const Mh=n=>n.startsWith("gpt-3.5-turbo-16k")?"gpt-3.5-turbo-16k":n.startsWith("gpt-3.5-turbo-")?"gpt-3.5-turbo":n.startsWith("gpt-4-32k")?"gpt-4-32k":n.startsWith("gpt-4-")?"gpt-4":n,Fh=()=>!1;class Bh extends X{get lc_attributes(){return{callbacks:void 0,verbose:void 0}}constructor(e){super(e),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.verbose=e.verbose??Fh(),this.callbacks=e.callbacks,this.tags=e.tags??[],this.metadata=e.metadata??{}}}class Vh extends Bh{get callKeys(){return["stop","timeout","signal","tags","metadata","callbacks"]}constructor({callbacks:e,callbackManager:t,...r}){super({callbacks:e??t,...r}),Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"cache",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"_encoding",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),typeof r.cache=="object"?this.cache=r.cache:r.cache?this.cache=Vi.global():this.cache=void 0,this.caller=new ts(r??{})}async getNumTokens(e){if(typeof e!="string")return 0;let t=Math.ceil(e.length/4);if(!this._encoding)try{this._encoding=await Xd("modelName"in this?Mh(this.modelName):"gpt2")}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}if(this._encoding)try{t=this._encoding.encode(e).length}catch(r){console.warn("Failed to calculate number of tokens, falling back to approximate count",r)}return t}static _convertInputToPromptValue(e){return typeof e=="string"?new rc(e):Array.isArray(e)?new pd(e.map(kr)):e}_identifyingParams(){return{}}_getSerializedCacheKeyParametersForCall(e){const t={...this._identifyingParams(),...e,_type:this._llmType(),_model:this._modelType()};return Object.entries(t).filter(([i,a])=>a!==void 0).map(([i,a])=>`${i}:${JSON.stringify(a)}`).sort().join(",")}serialize(){return{...this._identifyingParams(),_type:this._llmType(),_model:this._modelType()}}static async deserialize(e){throw new Error("Use .toJSON() instead")}}class _t extends Vh{constructor(e){super(e),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","chat_models",this._llmType()]})}_separateRunnableConfigFromCallOptions(e){const[t,r]=super._separateRunnableConfigFromCallOptions(e);return r!=null&&r.timeout&&!r.signal&&(r.signal=AbortSignal.timeout(r.timeout)),[t,r]}async invoke(e,t){const r=_t._convertInputToPromptValue(e);return(await this.generatePrompt([r],t,t==null?void 0:t.callbacks)).generations[0][0].message}async*_streamResponseChunks(e,t,r){throw new Error("Not implemented.")}async*_streamIterator(e,t){if(this._streamResponseChunks===_t.prototype._streamResponseChunks)yield this.invoke(e,t);else{const s=_t._convertInputToPromptValue(e).toChatMessages(),[i,a]=this._separateRunnableConfigFromCallOptions(t),o=await ue.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:a,invocation_params:this==null?void 0:this.invocationParams(a),batch_size:1},l=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),[s],void 0,void 0,c,void 0,void 0,i.runName));let d;try{for await(const f of this._streamResponseChunks(s,a,l==null?void 0:l[0]))yield f.message,d?d=d.concat(f):d=f}catch(f){throw await Promise.all((l??[]).map(m=>m==null?void 0:m.handleLLMError(f))),f}await Promise.all((l??[]).map(f=>f==null?void 0:f.handleLLMEnd({generations:[[d]]})))}}async _generateUncached(e,t,r){var m;const s=e.map(b=>b.map(kr)),i=await ue.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),a={options:t,invocation_params:this==null?void 0:this.invocationParams(t),batch_size:1},o=await(i==null?void 0:i.handleChatModelStart(this.toJSON(),s,void 0,void 0,a,void 0,void 0,r.runName)),c=await Promise.allSettled(s.map((b,v)=>this._generate(b,{...t,promptIndex:v},o==null?void 0:o[v]))),l=[],d=[];await Promise.all(c.map(async(b,v)=>{var T,w;if(b.status==="fulfilled"){const P=b.value;return l[v]=P.generations,d[v]=P.llmOutput,(T=o==null?void 0:o[v])==null?void 0:T.handleLLMEnd({generations:[P.generations],llmOutput:P.llmOutput})}else return await((w=o==null?void 0:o[v])==null?void 0:w.handleLLMError(b.reason)),Promise.reject(b.reason)}));const f={generations:l,llmOutput:d.length?(m=this._combineLLMOutput)==null?void 0:m.call(this,...d):void 0};return Object.defineProperty(f,Pa,{value:o?{runIds:o==null?void 0:o.map(b=>b.runId)}:void 0,configurable:!0}),f}async _generateCached({messages:e,cache:t,llmStringKey:r,parsedOptions:s,handledOptions:i}){const a=e.map(T=>T.map(kr)),o=await ue.configure(i.callbacks,this.callbacks,i.tags,this.tags,i.metadata,this.metadata,{verbose:this.verbose}),c={options:s,invocation_params:this==null?void 0:this.invocationParams(s),batch_size:1,cached:!0},l=await(o==null?void 0:o.handleChatModelStart(this.toJSON(),a,void 0,void 0,c,void 0,void 0,i.runName)),d=[],m=(await Promise.allSettled(a.map(async(T,w)=>{const P=_t._convertInputToPromptValue(T).toString(),k=await t.lookup(P,r);return k==null&&d.push(w),k}))).map((T,w)=>({result:T,runManager:l==null?void 0:l[w]})).filter(({result:T})=>T.status==="fulfilled"&&T.value!=null||T.status==="rejected"),b=[];await Promise.all(m.map(async({result:T,runManager:w},P)=>{if(T.status==="fulfilled"){const k=T.value;return b[P]=k,k.length&&await(w==null?void 0:w.handleLLMNewToken(k[0].text)),w==null?void 0:w.handleLLMEnd({generations:[k]})}else return await(w==null?void 0:w.handleLLMError(T.reason)),Promise.reject(T.reason)}));const v={generations:b,missingPromptIndices:d};return Object.defineProperty(v,Pa,{value:l?{runIds:l==null?void 0:l.map(T=>T.runId)}:void 0,configurable:!0}),v}async generate(e,t,r){let s;Array.isArray(t)?s={stop:t}:s=t;const i=e.map(b=>b.map(kr)),[a,o]=this._separateRunnableConfigFromCallOptions(s);if(a.callbacks=a.callbacks??r,!this.cache)return this._generateUncached(i,o,a);const{cache:c}=this,l=this._getSerializedCacheKeyParametersForCall(o),{generations:d,missingPromptIndices:f}=await this._generateCached({messages:i,cache:c,llmStringKey:l,parsedOptions:o,handledOptions:a});let m={};if(f.length>0){const b=await this._generateUncached(f.map(v=>i[v]),o,a);await Promise.all(b.generations.map(async(v,T)=>{const w=f[T];d[w]=v;const P=_t._convertInputToPromptValue(i[w]).toString();return c.update(P,l,v)})),m=b.llmOutput??{}}return{generations:d,llmOutput:m}}invocationParams(e){return{}}_modelType(){return"base_chat_model"}serialize(){return{...this.invocationParams(),_type:this._llmType(),_model:this._modelType()}}async generatePrompt(e,t,r){const s=e.map(i=>i.toChatMessages());return this.generate(s,t,r)}async call(e,t,r){return(await this.generate([e.map(kr)],t,r)).generations[0][0].message}async callPrompt(e,t,r){const s=e.toChatMessages();return this.call(s,t,r)}async predictMessages(e,t,r){return this.call(e,t,r)}async predict(e,t,r){const s=new Vn(e),i=await this.call([s],t,r);if(typeof i.content!="string")throw new Error("Cannot use predict when output is not a string.");return i.content}}function _c(n){const{azureOpenAIApiDeploymentName:e,azureOpenAIApiInstanceName:t,azureOpenAIApiKey:r,azureOpenAIBasePath:s,baseURL:i}=n;if(r&&s&&e)return`${s}/${e}`;if(r){if(!t)throw new Error("azureOpenAIApiInstanceName is required when using azureOpenAIApiKey");if(!e)throw new Error("azureOpenAIApiDeploymentName is a required parameter when using azureOpenAIApiKey");return`https://${t}.openai.azure.com/openai/deployments/${e}`}return i}var bc={},is={},ar={},as={},di={},je={},os={},Jr={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.getParsedType=n.ZodParsedType=n.objectUtil=n.util=void 0;var e;(function(r){r.assertEqual=o=>o;function s(o){}r.assertIs=s;function i(o){throw new Error}r.assertNever=i,r.arrayToEnum=o=>{const c={};for(const l of o)c[l]=l;return c},r.getValidEnumValues=o=>{const c=r.objectKeys(o).filter(d=>typeof o[o[d]]!="number"),l={};for(const d of c)l[d]=o[d];return r.objectValues(l)},r.objectValues=o=>r.objectKeys(o).map(function(c){return o[c]}),r.objectKeys=typeof Object.keys=="function"?o=>Object.keys(o):o=>{const c=[];for(const l in o)Object.prototype.hasOwnProperty.call(o,l)&&c.push(l);return c},r.find=(o,c)=>{for(const l of o)if(c(l))return l},r.isInteger=typeof Number.isInteger=="function"?o=>Number.isInteger(o):o=>typeof o=="number"&&isFinite(o)&&Math.floor(o)===o;function a(o,c=" | "){return o.map(l=>typeof l=="string"?`'${l}'`:l).join(c)}r.joinValues=a,r.jsonStringifyReplacer=(o,c)=>typeof c=="bigint"?c.toString():c})(e=n.util||(n.util={})),function(r){r.mergeShapes=(s,i)=>({...s,...i})}(n.objectUtil||(n.objectUtil={})),n.ZodParsedType=e.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]);const t=r=>{switch(typeof r){case"undefined":return n.ZodParsedType.undefined;case"string":return n.ZodParsedType.string;case"number":return isNaN(r)?n.ZodParsedType.nan:n.ZodParsedType.number;case"boolean":return n.ZodParsedType.boolean;case"function":return n.ZodParsedType.function;case"bigint":return n.ZodParsedType.bigint;case"symbol":return n.ZodParsedType.symbol;case"object":return Array.isArray(r)?n.ZodParsedType.array:r===null?n.ZodParsedType.null:r.then&&typeof r.then=="function"&&r.catch&&typeof r.catch=="function"?n.ZodParsedType.promise:typeof Map<"u"&&r instanceof Map?n.ZodParsedType.map:typeof Set<"u"&&r instanceof Set?n.ZodParsedType.set:typeof Date<"u"&&r instanceof Date?n.ZodParsedType.date:n.ZodParsedType.object;default:return n.ZodParsedType.unknown}};n.getParsedType=t})(Jr);var $e={};Object.defineProperty($e,"__esModule",{value:!0});$e.ZodError=$e.quotelessJson=$e.ZodIssueCode=void 0;const vc=Jr;$e.ZodIssueCode=vc.util.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);const zh=n=>JSON.stringify(n,null,2).replace(/"([^"]+)":/g,"$1:");$e.quotelessJson=zh;class hi extends Error{constructor(e){super(),this.issues=[],this.addIssue=r=>{this.issues=[...this.issues,r]},this.addIssues=(r=[])=>{this.issues=[...this.issues,...r]};const t=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,t):this.__proto__=t,this.name="ZodError",this.issues=e}get errors(){return this.issues}format(e){const t=e||function(i){return i.message},r={_errors:[]},s=i=>{for(const a of i.issues)if(a.code==="invalid_union")a.unionErrors.map(s);else if(a.code==="invalid_return_type")s(a.returnTypeError);else if(a.code==="invalid_arguments")s(a.argumentsError);else if(a.path.length===0)r._errors.push(t(a));else{let o=r,c=0;for(;c<a.path.length;){const l=a.path[c];c===a.path.length-1?(o[l]=o[l]||{_errors:[]},o[l]._errors.push(t(a))):o[l]=o[l]||{_errors:[]},o=o[l],c++}}};return s(this),r}toString(){return this.message}get message(){return JSON.stringify(this.issues,vc.util.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(e=t=>t.message){const t={},r=[];for(const s of this.issues)s.path.length>0?(t[s.path[0]]=t[s.path[0]]||[],t[s.path[0]].push(e(s))):r.push(e(s));return{formErrors:r,fieldErrors:t}}get formErrors(){return this.flatten()}}$e.ZodError=hi;hi.create=n=>new hi(n);Object.defineProperty(os,"__esModule",{value:!0});const ft=Jr,re=$e,qh=(n,e)=>{let t;switch(n.code){case re.ZodIssueCode.invalid_type:n.received===ft.ZodParsedType.undefined?t="Required":t=`Expected ${n.expected}, received ${n.received}`;break;case re.ZodIssueCode.invalid_literal:t=`Invalid literal value, expected ${JSON.stringify(n.expected,ft.util.jsonStringifyReplacer)}`;break;case re.ZodIssueCode.unrecognized_keys:t=`Unrecognized key(s) in object: ${ft.util.joinValues(n.keys,", ")}`;break;case re.ZodIssueCode.invalid_union:t="Invalid input";break;case re.ZodIssueCode.invalid_union_discriminator:t=`Invalid discriminator value. Expected ${ft.util.joinValues(n.options)}`;break;case re.ZodIssueCode.invalid_enum_value:t=`Invalid enum value. Expected ${ft.util.joinValues(n.options)}, received '${n.received}'`;break;case re.ZodIssueCode.invalid_arguments:t="Invalid function arguments";break;case re.ZodIssueCode.invalid_return_type:t="Invalid function return type";break;case re.ZodIssueCode.invalid_date:t="Invalid date";break;case re.ZodIssueCode.invalid_string:typeof n.validation=="object"?"includes"in n.validation?(t=`Invalid input: must include "${n.validation.includes}"`,typeof n.validation.position=="number"&&(t=`${t} at one or more positions greater than or equal to ${n.validation.position}`)):"startsWith"in n.validation?t=`Invalid input: must start with "${n.validation.startsWith}"`:"endsWith"in n.validation?t=`Invalid input: must end with "${n.validation.endsWith}"`:ft.util.assertNever(n.validation):n.validation!=="regex"?t=`Invalid ${n.validation}`:t="Invalid";break;case re.ZodIssueCode.too_small:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at least":"more than"} ${n.minimum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at least":"over"} ${n.minimum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${n.minimum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly equal to ":n.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(n.minimum))}`:t="Invalid input";break;case re.ZodIssueCode.too_big:n.type==="array"?t=`Array must contain ${n.exact?"exactly":n.inclusive?"at most":"less than"} ${n.maximum} element(s)`:n.type==="string"?t=`String must contain ${n.exact?"exactly":n.inclusive?"at most":"under"} ${n.maximum} character(s)`:n.type==="number"?t=`Number must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="bigint"?t=`BigInt must be ${n.exact?"exactly":n.inclusive?"less than or equal to":"less than"} ${n.maximum}`:n.type==="date"?t=`Date must be ${n.exact?"exactly":n.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(n.maximum))}`:t="Invalid input";break;case re.ZodIssueCode.custom:t="Invalid input";break;case re.ZodIssueCode.invalid_intersection_types:t="Intersection results could not be merged";break;case re.ZodIssueCode.not_multiple_of:t=`Number must be a multiple of ${n.multipleOf}`;break;case re.ZodIssueCode.not_finite:t="Number must be finite";break;default:t=e.defaultError,ft.util.assertNever(n)}return{message:t}};os.default=qh;var Kh=ie&&ie.__importDefault||function(n){return n&&n.__esModule?n:{default:n}};Object.defineProperty(je,"__esModule",{value:!0});je.getErrorMap=je.setErrorMap=je.defaultErrorMap=void 0;const wc=Kh(os);je.defaultErrorMap=wc.default;let Tc=wc.default;function Hh(n){Tc=n}je.setErrorMap=Hh;function Jh(){return Tc}je.getErrorMap=Jh;var Yi={};(function(n){var e=ie&&ie.__importDefault||function(b){return b&&b.__esModule?b:{default:b}};Object.defineProperty(n,"__esModule",{value:!0}),n.isAsync=n.isValid=n.isDirty=n.isAborted=n.OK=n.DIRTY=n.INVALID=n.ParseStatus=n.addIssueToContext=n.EMPTY_PATH=n.makeIssue=void 0;const t=je,r=e(os),s=b=>{const{data:v,path:T,errorMaps:w,issueData:P}=b,k=[...T,...P.path||[]],I={...P,path:k};let Z="";const D=w.filter(B=>!!B).slice().reverse();for(const B of D)Z=B(I,{data:v,defaultError:Z}).message;return{...P,path:k,message:P.message||Z}};n.makeIssue=s,n.EMPTY_PATH=[];function i(b,v){const T=(0,n.makeIssue)({issueData:v,data:b.data,path:b.path,errorMaps:[b.common.contextualErrorMap,b.schemaErrorMap,(0,t.getErrorMap)(),r.default].filter(w=>!!w)});b.common.issues.push(T)}n.addIssueToContext=i;class a{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(v,T){const w=[];for(const P of T){if(P.status==="aborted")return n.INVALID;P.status==="dirty"&&v.dirty(),w.push(P.value)}return{status:v.value,value:w}}static async mergeObjectAsync(v,T){const w=[];for(const P of T)w.push({key:await P.key,value:await P.value});return a.mergeObjectSync(v,w)}static mergeObjectSync(v,T){const w={};for(const P of T){const{key:k,value:I}=P;if(k.status==="aborted"||I.status==="aborted")return n.INVALID;k.status==="dirty"&&v.dirty(),I.status==="dirty"&&v.dirty(),k.value!=="__proto__"&&(typeof I.value<"u"||P.alwaysSet)&&(w[k.value]=I.value)}return{status:v.value,value:w}}}n.ParseStatus=a,n.INVALID=Object.freeze({status:"aborted"});const o=b=>({status:"dirty",value:b});n.DIRTY=o;const c=b=>({status:"valid",value:b});n.OK=c;const l=b=>b.status==="aborted";n.isAborted=l;const d=b=>b.status==="dirty";n.isDirty=d;const f=b=>b.status==="valid";n.isValid=f;const m=b=>typeof Promise<"u"&&b instanceof Promise;n.isAsync=m})(Yi);var Ec={};Object.defineProperty(Ec,"__esModule",{value:!0});var Oc={},Pc={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.errorUtil=void 0,function(e){e.errToObj=t=>typeof t=="string"?{message:t}:t||{},e.toString=t=>typeof t=="string"?t:t==null?void 0:t.message}(n.errorUtil||(n.errorUtil={}))})(Pc);(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.date=n.boolean=n.bigint=n.array=n.any=n.coerce=n.ZodFirstPartyTypeKind=n.late=n.ZodSchema=n.Schema=n.custom=n.ZodReadonly=n.ZodPipeline=n.ZodBranded=n.BRAND=n.ZodNaN=n.ZodCatch=n.ZodDefault=n.ZodNullable=n.ZodOptional=n.ZodTransformer=n.ZodEffects=n.ZodPromise=n.ZodNativeEnum=n.ZodEnum=n.ZodLiteral=n.ZodLazy=n.ZodFunction=n.ZodSet=n.ZodMap=n.ZodRecord=n.ZodTuple=n.ZodIntersection=n.ZodDiscriminatedUnion=n.ZodUnion=n.ZodObject=n.ZodArray=n.ZodVoid=n.ZodNever=n.ZodUnknown=n.ZodAny=n.ZodNull=n.ZodUndefined=n.ZodSymbol=n.ZodDate=n.ZodBoolean=n.ZodBigInt=n.ZodNumber=n.ZodString=n.ZodType=void 0,n.NEVER=n.void=n.unknown=n.union=n.undefined=n.tuple=n.transformer=n.symbol=n.string=n.strictObject=n.set=n.record=n.promise=n.preprocess=n.pipeline=n.ostring=n.optional=n.onumber=n.oboolean=n.object=n.number=n.nullable=n.null=n.never=n.nativeEnum=n.nan=n.map=n.literal=n.lazy=n.intersection=n.instanceof=n.function=n.enum=n.effect=n.discriminatedUnion=void 0;const e=je,t=Pc,r=Yi,s=Jr,i=$e;class a{constructor(u,h,p,_){this._cachedPath=[],this.parent=u,this.data=h,this._path=p,this._key=_}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}}const o=(g,u)=>{if((0,r.isValid)(u))return{success:!0,data:u.value};if(!g.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const h=new i.ZodError(g.common.issues);return this._error=h,this._error}}};function c(g){if(!g)return{};const{errorMap:u,invalid_type_error:h,required_error:p,description:_}=g;if(u&&(h||p))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return u?{errorMap:u,description:_}:{errorMap:(O,E)=>O.code!=="invalid_type"?{message:E.defaultError}:typeof E.data>"u"?{message:p??E.defaultError}:{message:h??E.defaultError},description:_}}class l{constructor(u){this.spa=this.safeParseAsync,this._def=u,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this)}get description(){return this._def.description}_getType(u){return(0,s.getParsedType)(u.data)}_getOrReturnCtx(u,h){return h||{common:u.parent.common,data:u.data,parsedType:(0,s.getParsedType)(u.data),schemaErrorMap:this._def.errorMap,path:u.path,parent:u.parent}}_processInputParams(u){return{status:new r.ParseStatus,ctx:{common:u.parent.common,data:u.data,parsedType:(0,s.getParsedType)(u.data),schemaErrorMap:this._def.errorMap,path:u.path,parent:u.parent}}}_parseSync(u){const h=this._parse(u);if((0,r.isAsync)(h))throw new Error("Synchronous parse encountered promise.");return h}_parseAsync(u){const h=this._parse(u);return Promise.resolve(h)}parse(u,h){const p=this.safeParse(u,h);if(p.success)return p.data;throw p.error}safeParse(u,h){var p;const _={common:{issues:[],async:(p=h==null?void 0:h.async)!==null&&p!==void 0?p:!1,contextualErrorMap:h==null?void 0:h.errorMap},path:(h==null?void 0:h.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:u,parsedType:(0,s.getParsedType)(u)},y=this._parseSync({data:u,path:_.path,parent:_});return o(_,y)}async parseAsync(u,h){const p=await this.safeParseAsync(u,h);if(p.success)return p.data;throw p.error}async safeParseAsync(u,h){const p={common:{issues:[],contextualErrorMap:h==null?void 0:h.errorMap,async:!0},path:(h==null?void 0:h.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:u,parsedType:(0,s.getParsedType)(u)},_=this._parse({data:u,path:p.path,parent:p}),y=await((0,r.isAsync)(_)?_:Promise.resolve(_));return o(p,y)}refine(u,h){const p=_=>typeof h=="string"||typeof h>"u"?{message:h}:typeof h=="function"?h(_):h;return this._refinement((_,y)=>{const O=u(_),E=()=>y.addIssue({code:i.ZodIssueCode.custom,...p(_)});return typeof Promise<"u"&&O instanceof Promise?O.then(C=>C?!0:(E(),!1)):O?!0:(E(),!1)})}refinement(u,h){return this._refinement((p,_)=>u(p)?!0:(_.addIssue(typeof h=="function"?h(p,_):h),!1))}_refinement(u){return new we({schema:this,typeName:x.ZodEffects,effect:{type:"refinement",refinement:u}})}superRefine(u){return this._refinement(u)}optional(){return Me.create(this,this._def)}nullable(){return dt.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return fe.create(this,this._def)}promise(){return It.create(this,this._def)}or(u){return j.create([this,u],this._def)}and(u){return Qt.create(this,u,this._def)}transform(u){return new we({...c(this._def),schema:this,typeName:x.ZodEffects,effect:{type:"transform",transform:u}})}default(u){const h=typeof u=="function"?u:()=>u;return new sr({...c(this._def),innerType:this,defaultValue:h,typeName:x.ZodDefault})}brand(){return new aa({typeName:x.ZodBranded,type:this,...c(this._def)})}catch(u){const h=typeof u=="function"?u:()=>u;return new Xr({...c(this._def),innerType:this,catchValue:h,typeName:x.ZodCatch})}describe(u){const h=this.constructor;return new h({...this._def,description:u})}pipe(u){return ir.create(this,u)}readonly(){return en.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}}n.ZodType=l,n.Schema=l,n.ZodSchema=l;const d=/^c[^\s-]{8,}$/i,f=/^[a-z][a-z0-9]*$/,m=/^[0-9A-HJKMNP-TV-Z]{26}$/,b=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,v=/^(?!\.)(?!.*\.\.)([A-Z0-9_+-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i,T="^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$";let w;const P=/^(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))$/,k=/^(([a-f0-9]{1,4}:){7}|::([a-f0-9]{1,4}:){0,6}|([a-f0-9]{1,4}:){1}:([a-f0-9]{1,4}:){0,5}|([a-f0-9]{1,4}:){2}:([a-f0-9]{1,4}:){0,4}|([a-f0-9]{1,4}:){3}:([a-f0-9]{1,4}:){0,3}|([a-f0-9]{1,4}:){4}:([a-f0-9]{1,4}:){0,2}|([a-f0-9]{1,4}:){5}:([a-f0-9]{1,4}:){0,1})([a-f0-9]{1,4}|(((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2}))\.){3}((25[0-5])|(2[0-4][0-9])|(1[0-9]{2})|([0-9]{1,2})))$/,I=g=>g.precision?g.offset?new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${g.precision}}(([+-]\\d{2}(:?\\d{2})?)|Z)$`):new RegExp(`^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}\\.\\d{${g.precision}}Z$`):g.precision===0?g.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}Z$"):g.offset?new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?(([+-]\\d{2}(:?\\d{2})?)|Z)$"):new RegExp("^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d+)?Z$");function Z(g,u){return!!((u==="v4"||!u)&&P.test(g)||(u==="v6"||!u)&&k.test(g))}class D extends l{_parse(u){if(this._def.coerce&&(u.data=String(u.data)),this._getType(u)!==s.ZodParsedType.string){const y=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(y,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.string,received:y.parsedType}),r.INVALID}const p=new r.ParseStatus;let _;for(const y of this._def.checks)if(y.kind==="min")u.data.length<y.value&&(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.too_small,minimum:y.value,type:"string",inclusive:!0,exact:!1,message:y.message}),p.dirty());else if(y.kind==="max")u.data.length>y.value&&(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.too_big,maximum:y.value,type:"string",inclusive:!0,exact:!1,message:y.message}),p.dirty());else if(y.kind==="length"){const O=u.data.length>y.value,E=u.data.length<y.value;(O||E)&&(_=this._getOrReturnCtx(u,_),O?(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.too_big,maximum:y.value,type:"string",inclusive:!0,exact:!0,message:y.message}):E&&(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.too_small,minimum:y.value,type:"string",inclusive:!0,exact:!0,message:y.message}),p.dirty())}else if(y.kind==="email")v.test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"email",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty());else if(y.kind==="emoji")w||(w=new RegExp(T,"u")),w.test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"emoji",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty());else if(y.kind==="uuid")b.test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"uuid",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty());else if(y.kind==="cuid")d.test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"cuid",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty());else if(y.kind==="cuid2")f.test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"cuid2",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty());else if(y.kind==="ulid")m.test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"ulid",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty());else if(y.kind==="url")try{new URL(u.data)}catch{_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"url",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty()}else y.kind==="regex"?(y.regex.lastIndex=0,y.regex.test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"regex",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty())):y.kind==="trim"?u.data=u.data.trim():y.kind==="includes"?u.data.includes(y.value,y.position)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.invalid_string,validation:{includes:y.value,position:y.position},message:y.message}),p.dirty()):y.kind==="toLowerCase"?u.data=u.data.toLowerCase():y.kind==="toUpperCase"?u.data=u.data.toUpperCase():y.kind==="startsWith"?u.data.startsWith(y.value)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.invalid_string,validation:{startsWith:y.value},message:y.message}),p.dirty()):y.kind==="endsWith"?u.data.endsWith(y.value)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.invalid_string,validation:{endsWith:y.value},message:y.message}),p.dirty()):y.kind==="datetime"?I(y).test(u.data)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.invalid_string,validation:"datetime",message:y.message}),p.dirty()):y.kind==="ip"?Z(u.data,y.version)||(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{validation:"ip",code:i.ZodIssueCode.invalid_string,message:y.message}),p.dirty()):s.util.assertNever(y);return{status:p.value,value:u.data}}_regex(u,h,p){return this.refinement(_=>u.test(_),{validation:h,code:i.ZodIssueCode.invalid_string,...t.errorUtil.errToObj(p)})}_addCheck(u){return new D({...this._def,checks:[...this._def.checks,u]})}email(u){return this._addCheck({kind:"email",...t.errorUtil.errToObj(u)})}url(u){return this._addCheck({kind:"url",...t.errorUtil.errToObj(u)})}emoji(u){return this._addCheck({kind:"emoji",...t.errorUtil.errToObj(u)})}uuid(u){return this._addCheck({kind:"uuid",...t.errorUtil.errToObj(u)})}cuid(u){return this._addCheck({kind:"cuid",...t.errorUtil.errToObj(u)})}cuid2(u){return this._addCheck({kind:"cuid2",...t.errorUtil.errToObj(u)})}ulid(u){return this._addCheck({kind:"ulid",...t.errorUtil.errToObj(u)})}ip(u){return this._addCheck({kind:"ip",...t.errorUtil.errToObj(u)})}datetime(u){var h;return typeof u=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,message:u}):this._addCheck({kind:"datetime",precision:typeof(u==null?void 0:u.precision)>"u"?null:u==null?void 0:u.precision,offset:(h=u==null?void 0:u.offset)!==null&&h!==void 0?h:!1,...t.errorUtil.errToObj(u==null?void 0:u.message)})}regex(u,h){return this._addCheck({kind:"regex",regex:u,...t.errorUtil.errToObj(h)})}includes(u,h){return this._addCheck({kind:"includes",value:u,position:h==null?void 0:h.position,...t.errorUtil.errToObj(h==null?void 0:h.message)})}startsWith(u,h){return this._addCheck({kind:"startsWith",value:u,...t.errorUtil.errToObj(h)})}endsWith(u,h){return this._addCheck({kind:"endsWith",value:u,...t.errorUtil.errToObj(h)})}min(u,h){return this._addCheck({kind:"min",value:u,...t.errorUtil.errToObj(h)})}max(u,h){return this._addCheck({kind:"max",value:u,...t.errorUtil.errToObj(h)})}length(u,h){return this._addCheck({kind:"length",value:u,...t.errorUtil.errToObj(h)})}nonempty(u){return this.min(1,t.errorUtil.errToObj(u))}trim(){return new D({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new D({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new D({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(u=>u.kind==="datetime")}get isEmail(){return!!this._def.checks.find(u=>u.kind==="email")}get isURL(){return!!this._def.checks.find(u=>u.kind==="url")}get isEmoji(){return!!this._def.checks.find(u=>u.kind==="emoji")}get isUUID(){return!!this._def.checks.find(u=>u.kind==="uuid")}get isCUID(){return!!this._def.checks.find(u=>u.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(u=>u.kind==="cuid2")}get isULID(){return!!this._def.checks.find(u=>u.kind==="ulid")}get isIP(){return!!this._def.checks.find(u=>u.kind==="ip")}get minLength(){let u=null;for(const h of this._def.checks)h.kind==="min"&&(u===null||h.value>u)&&(u=h.value);return u}get maxLength(){let u=null;for(const h of this._def.checks)h.kind==="max"&&(u===null||h.value<u)&&(u=h.value);return u}}n.ZodString=D,D.create=g=>{var u;return new D({checks:[],typeName:x.ZodString,coerce:(u=g==null?void 0:g.coerce)!==null&&u!==void 0?u:!1,...c(g)})};function B(g,u){const h=(g.toString().split(".")[1]||"").length,p=(u.toString().split(".")[1]||"").length,_=h>p?h:p,y=parseInt(g.toFixed(_).replace(".","")),O=parseInt(u.toFixed(_).replace(".",""));return y%O/Math.pow(10,_)}class q extends l{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(u){if(this._def.coerce&&(u.data=Number(u.data)),this._getType(u)!==s.ZodParsedType.number){const y=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(y,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.number,received:y.parsedType}),r.INVALID}let p;const _=new r.ParseStatus;for(const y of this._def.checks)y.kind==="int"?s.util.isInteger(u.data)||(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:"integer",received:"float",message:y.message}),_.dirty()):y.kind==="min"?(y.inclusive?u.data<y.value:u.data<=y.value)&&(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_small,minimum:y.value,type:"number",inclusive:y.inclusive,exact:!1,message:y.message}),_.dirty()):y.kind==="max"?(y.inclusive?u.data>y.value:u.data>=y.value)&&(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_big,maximum:y.value,type:"number",inclusive:y.inclusive,exact:!1,message:y.message}),_.dirty()):y.kind==="multipleOf"?B(u.data,y.value)!==0&&(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.not_multiple_of,multipleOf:y.value,message:y.message}),_.dirty()):y.kind==="finite"?Number.isFinite(u.data)||(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.not_finite,message:y.message}),_.dirty()):s.util.assertNever(y);return{status:_.value,value:u.data}}gte(u,h){return this.setLimit("min",u,!0,t.errorUtil.toString(h))}gt(u,h){return this.setLimit("min",u,!1,t.errorUtil.toString(h))}lte(u,h){return this.setLimit("max",u,!0,t.errorUtil.toString(h))}lt(u,h){return this.setLimit("max",u,!1,t.errorUtil.toString(h))}setLimit(u,h,p,_){return new q({...this._def,checks:[...this._def.checks,{kind:u,value:h,inclusive:p,message:t.errorUtil.toString(_)}]})}_addCheck(u){return new q({...this._def,checks:[...this._def.checks,u]})}int(u){return this._addCheck({kind:"int",message:t.errorUtil.toString(u)})}positive(u){return this._addCheck({kind:"min",value:0,inclusive:!1,message:t.errorUtil.toString(u)})}negative(u){return this._addCheck({kind:"max",value:0,inclusive:!1,message:t.errorUtil.toString(u)})}nonpositive(u){return this._addCheck({kind:"max",value:0,inclusive:!0,message:t.errorUtil.toString(u)})}nonnegative(u){return this._addCheck({kind:"min",value:0,inclusive:!0,message:t.errorUtil.toString(u)})}multipleOf(u,h){return this._addCheck({kind:"multipleOf",value:u,message:t.errorUtil.toString(h)})}finite(u){return this._addCheck({kind:"finite",message:t.errorUtil.toString(u)})}safe(u){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:t.errorUtil.toString(u)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:t.errorUtil.toString(u)})}get minValue(){let u=null;for(const h of this._def.checks)h.kind==="min"&&(u===null||h.value>u)&&(u=h.value);return u}get maxValue(){let u=null;for(const h of this._def.checks)h.kind==="max"&&(u===null||h.value<u)&&(u=h.value);return u}get isInt(){return!!this._def.checks.find(u=>u.kind==="int"||u.kind==="multipleOf"&&s.util.isInteger(u.value))}get isFinite(){let u=null,h=null;for(const p of this._def.checks){if(p.kind==="finite"||p.kind==="int"||p.kind==="multipleOf")return!0;p.kind==="min"?(h===null||p.value>h)&&(h=p.value):p.kind==="max"&&(u===null||p.value<u)&&(u=p.value)}return Number.isFinite(h)&&Number.isFinite(u)}}n.ZodNumber=q,q.create=g=>new q({checks:[],typeName:x.ZodNumber,coerce:(g==null?void 0:g.coerce)||!1,...c(g)});class me extends l{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(u){if(this._def.coerce&&(u.data=BigInt(u.data)),this._getType(u)!==s.ZodParsedType.bigint){const y=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(y,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.bigint,received:y.parsedType}),r.INVALID}let p;const _=new r.ParseStatus;for(const y of this._def.checks)y.kind==="min"?(y.inclusive?u.data<y.value:u.data<=y.value)&&(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_small,type:"bigint",minimum:y.value,inclusive:y.inclusive,message:y.message}),_.dirty()):y.kind==="max"?(y.inclusive?u.data>y.value:u.data>=y.value)&&(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_big,type:"bigint",maximum:y.value,inclusive:y.inclusive,message:y.message}),_.dirty()):y.kind==="multipleOf"?u.data%y.value!==BigInt(0)&&(p=this._getOrReturnCtx(u,p),(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.not_multiple_of,multipleOf:y.value,message:y.message}),_.dirty()):s.util.assertNever(y);return{status:_.value,value:u.data}}gte(u,h){return this.setLimit("min",u,!0,t.errorUtil.toString(h))}gt(u,h){return this.setLimit("min",u,!1,t.errorUtil.toString(h))}lte(u,h){return this.setLimit("max",u,!0,t.errorUtil.toString(h))}lt(u,h){return this.setLimit("max",u,!1,t.errorUtil.toString(h))}setLimit(u,h,p,_){return new me({...this._def,checks:[...this._def.checks,{kind:u,value:h,inclusive:p,message:t.errorUtil.toString(_)}]})}_addCheck(u){return new me({...this._def,checks:[...this._def.checks,u]})}positive(u){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:t.errorUtil.toString(u)})}negative(u){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:t.errorUtil.toString(u)})}nonpositive(u){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:t.errorUtil.toString(u)})}nonnegative(u){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:t.errorUtil.toString(u)})}multipleOf(u,h){return this._addCheck({kind:"multipleOf",value:u,message:t.errorUtil.toString(h)})}get minValue(){let u=null;for(const h of this._def.checks)h.kind==="min"&&(u===null||h.value>u)&&(u=h.value);return u}get maxValue(){let u=null;for(const h of this._def.checks)h.kind==="max"&&(u===null||h.value<u)&&(u=h.value);return u}}n.ZodBigInt=me,me.create=g=>{var u;return new me({checks:[],typeName:x.ZodBigInt,coerce:(u=g==null?void 0:g.coerce)!==null&&u!==void 0?u:!1,...c(g)})};class oe extends l{_parse(u){if(this._def.coerce&&(u.data=!!u.data),this._getType(u)!==s.ZodParsedType.boolean){const p=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.boolean,received:p.parsedType}),r.INVALID}return(0,r.OK)(u.data)}}n.ZodBoolean=oe,oe.create=g=>new oe({typeName:x.ZodBoolean,coerce:(g==null?void 0:g.coerce)||!1,...c(g)});class he extends l{_parse(u){if(this._def.coerce&&(u.data=new Date(u.data)),this._getType(u)!==s.ZodParsedType.date){const y=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(y,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.date,received:y.parsedType}),r.INVALID}if(isNaN(u.data.getTime())){const y=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(y,{code:i.ZodIssueCode.invalid_date}),r.INVALID}const p=new r.ParseStatus;let _;for(const y of this._def.checks)y.kind==="min"?u.data.getTime()<y.value&&(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.too_small,message:y.message,inclusive:!0,exact:!1,minimum:y.value,type:"date"}),p.dirty()):y.kind==="max"?u.data.getTime()>y.value&&(_=this._getOrReturnCtx(u,_),(0,r.addIssueToContext)(_,{code:i.ZodIssueCode.too_big,message:y.message,inclusive:!0,exact:!1,maximum:y.value,type:"date"}),p.dirty()):s.util.assertNever(y);return{status:p.value,value:new Date(u.data.getTime())}}_addCheck(u){return new he({...this._def,checks:[...this._def.checks,u]})}min(u,h){return this._addCheck({kind:"min",value:u.getTime(),message:t.errorUtil.toString(h)})}max(u,h){return this._addCheck({kind:"max",value:u.getTime(),message:t.errorUtil.toString(h)})}get minDate(){let u=null;for(const h of this._def.checks)h.kind==="min"&&(u===null||h.value>u)&&(u=h.value);return u!=null?new Date(u):null}get maxDate(){let u=null;for(const h of this._def.checks)h.kind==="max"&&(u===null||h.value<u)&&(u=h.value);return u!=null?new Date(u):null}}n.ZodDate=he,he.create=g=>new he({checks:[],coerce:(g==null?void 0:g.coerce)||!1,typeName:x.ZodDate,...c(g)});class Ot extends l{_parse(u){if(this._getType(u)!==s.ZodParsedType.symbol){const p=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.symbol,received:p.parsedType}),r.INVALID}return(0,r.OK)(u.data)}}n.ZodSymbol=Ot,Ot.create=g=>new Ot({typeName:x.ZodSymbol,...c(g)});class ct extends l{_parse(u){if(this._getType(u)!==s.ZodParsedType.undefined){const p=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.undefined,received:p.parsedType}),r.INVALID}return(0,r.OK)(u.data)}}n.ZodUndefined=ct,ct.create=g=>new ct({typeName:x.ZodUndefined,...c(g)});class ut extends l{_parse(u){if(this._getType(u)!==s.ZodParsedType.null){const p=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.null,received:p.parsedType}),r.INVALID}return(0,r.OK)(u.data)}}n.ZodNull=ut,ut.create=g=>new ut({typeName:x.ZodNull,...c(g)});class Le extends l{constructor(){super(...arguments),this._any=!0}_parse(u){return(0,r.OK)(u.data)}}n.ZodAny=Le,Le.create=g=>new Le({typeName:x.ZodAny,...c(g)});class Ue extends l{constructor(){super(...arguments),this._unknown=!0}_parse(u){return(0,r.OK)(u.data)}}n.ZodUnknown=Ue,Ue.create=g=>new Ue({typeName:x.ZodUnknown,...c(g)});class ve extends l{_parse(u){const h=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.never,received:h.parsedType}),r.INVALID}}n.ZodNever=ve,ve.create=g=>new ve({typeName:x.ZodNever,...c(g)});class Pt extends l{_parse(u){if(this._getType(u)!==s.ZodParsedType.undefined){const p=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.void,received:p.parsedType}),r.INVALID}return(0,r.OK)(u.data)}}n.ZodVoid=Pt,Pt.create=g=>new Pt({typeName:x.ZodVoid,...c(g)});class fe extends l{_parse(u){const{ctx:h,status:p}=this._processInputParams(u),_=this._def;if(h.parsedType!==s.ZodParsedType.array)return(0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.array,received:h.parsedType}),r.INVALID;if(_.exactLength!==null){const O=h.data.length>_.exactLength.value,E=h.data.length<_.exactLength.value;(O||E)&&((0,r.addIssueToContext)(h,{code:O?i.ZodIssueCode.too_big:i.ZodIssueCode.too_small,minimum:E?_.exactLength.value:void 0,maximum:O?_.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:_.exactLength.message}),p.dirty())}if(_.minLength!==null&&h.data.length<_.minLength.value&&((0,r.addIssueToContext)(h,{code:i.ZodIssueCode.too_small,minimum:_.minLength.value,type:"array",inclusive:!0,exact:!1,message:_.minLength.message}),p.dirty()),_.maxLength!==null&&h.data.length>_.maxLength.value&&((0,r.addIssueToContext)(h,{code:i.ZodIssueCode.too_big,maximum:_.maxLength.value,type:"array",inclusive:!0,exact:!1,message:_.maxLength.message}),p.dirty()),h.common.async)return Promise.all([...h.data].map((O,E)=>_.type._parseAsync(new a(h,O,h.path,E)))).then(O=>r.ParseStatus.mergeArray(p,O));const y=[...h.data].map((O,E)=>_.type._parseSync(new a(h,O,h.path,E)));return r.ParseStatus.mergeArray(p,y)}get element(){return this._def.type}min(u,h){return new fe({...this._def,minLength:{value:u,message:t.errorUtil.toString(h)}})}max(u,h){return new fe({...this._def,maxLength:{value:u,message:t.errorUtil.toString(h)}})}length(u,h){return new fe({...this._def,exactLength:{value:u,message:t.errorUtil.toString(h)}})}nonempty(u){return this.min(1,u)}}n.ZodArray=fe,fe.create=(g,u)=>new fe({type:g,minLength:null,maxLength:null,exactLength:null,typeName:x.ZodArray,...c(u)});function S(g){if(g instanceof R){const u={};for(const h in g.shape){const p=g.shape[h];u[h]=Me.create(S(p))}return new R({...g._def,shape:()=>u})}else return g instanceof fe?new fe({...g._def,type:S(g.element)}):g instanceof Me?Me.create(S(g.unwrap())):g instanceof dt?dt.create(S(g.unwrap())):g instanceof Se?Se.create(g.items.map(u=>S(u))):g}class R extends l{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const u=this._def.shape(),h=s.util.objectKeys(u);return this._cached={shape:u,keys:h}}_parse(u){if(this._getType(u)!==s.ZodParsedType.object){const A=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(A,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.object,received:A.parsedType}),r.INVALID}const{status:p,ctx:_}=this._processInputParams(u),{shape:y,keys:O}=this._getCached(),E=[];if(!(this._def.catchall instanceof ve&&this._def.unknownKeys==="strip"))for(const A in _.data)O.includes(A)||E.push(A);const C=[];for(const A of O){const U=y[A],ge=_.data[A];C.push({key:{status:"valid",value:A},value:U._parse(new a(_,ge,_.path,A)),alwaysSet:A in _.data})}if(this._def.catchall instanceof ve){const A=this._def.unknownKeys;if(A==="passthrough")for(const U of E)C.push({key:{status:"valid",value:U},value:{status:"valid",value:_.data[U]}});else if(A==="strict")E.length>0&&((0,r.addIssueToContext)(_,{code:i.ZodIssueCode.unrecognized_keys,keys:E}),p.dirty());else if(A!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const A=this._def.catchall;for(const U of E){const ge=_.data[U];C.push({key:{status:"valid",value:U},value:A._parse(new a(_,ge,_.path,U)),alwaysSet:U in _.data})}}return _.common.async?Promise.resolve().then(async()=>{const A=[];for(const U of C){const ge=await U.key;A.push({key:ge,value:await U.value,alwaysSet:U.alwaysSet})}return A}).then(A=>r.ParseStatus.mergeObjectSync(p,A)):r.ParseStatus.mergeObjectSync(p,C)}get shape(){return this._def.shape()}strict(u){return t.errorUtil.errToObj,new R({...this._def,unknownKeys:"strict",...u!==void 0?{errorMap:(h,p)=>{var _,y,O,E;const C=(O=(y=(_=this._def).errorMap)===null||y===void 0?void 0:y.call(_,h,p).message)!==null&&O!==void 0?O:p.defaultError;return h.code==="unrecognized_keys"?{message:(E=t.errorUtil.errToObj(u).message)!==null&&E!==void 0?E:C}:{message:C}}}:{}})}strip(){return new R({...this._def,unknownKeys:"strip"})}passthrough(){return new R({...this._def,unknownKeys:"passthrough"})}extend(u){return new R({...this._def,shape:()=>({...this._def.shape(),...u})})}merge(u){return new R({unknownKeys:u._def.unknownKeys,catchall:u._def.catchall,shape:()=>({...this._def.shape(),...u._def.shape()}),typeName:x.ZodObject})}setKey(u,h){return this.augment({[u]:h})}catchall(u){return new R({...this._def,catchall:u})}pick(u){const h={};return s.util.objectKeys(u).forEach(p=>{u[p]&&this.shape[p]&&(h[p]=this.shape[p])}),new R({...this._def,shape:()=>h})}omit(u){const h={};return s.util.objectKeys(this.shape).forEach(p=>{u[p]||(h[p]=this.shape[p])}),new R({...this._def,shape:()=>h})}deepPartial(){return S(this)}partial(u){const h={};return s.util.objectKeys(this.shape).forEach(p=>{const _=this.shape[p];u&&!u[p]?h[p]=_:h[p]=_.optional()}),new R({...this._def,shape:()=>h})}required(u){const h={};return s.util.objectKeys(this.shape).forEach(p=>{if(u&&!u[p])h[p]=this.shape[p];else{let y=this.shape[p];for(;y instanceof Me;)y=y._def.innerType;h[p]=y}}),new R({...this._def,shape:()=>h})}keyof(){return ia(s.util.objectKeys(this.shape))}}n.ZodObject=R,R.create=(g,u)=>new R({shape:()=>g,unknownKeys:"strip",catchall:ve.create(),typeName:x.ZodObject,...c(u)}),R.strictCreate=(g,u)=>new R({shape:()=>g,unknownKeys:"strict",catchall:ve.create(),typeName:x.ZodObject,...c(u)}),R.lazycreate=(g,u)=>new R({shape:g,unknownKeys:"strip",catchall:ve.create(),typeName:x.ZodObject,...c(u)});class j extends l{_parse(u){const{ctx:h}=this._processInputParams(u),p=this._def.options;function _(y){for(const E of y)if(E.result.status==="valid")return E.result;for(const E of y)if(E.result.status==="dirty")return h.common.issues.push(...E.ctx.common.issues),E.result;const O=y.map(E=>new i.ZodError(E.ctx.common.issues));return(0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_union,unionErrors:O}),r.INVALID}if(h.common.async)return Promise.all(p.map(async y=>{const O={...h,common:{...h.common,issues:[]},parent:null};return{result:await y._parseAsync({data:h.data,path:h.path,parent:O}),ctx:O}})).then(_);{let y;const O=[];for(const C of p){const A={...h,common:{...h.common,issues:[]},parent:null},U=C._parseSync({data:h.data,path:h.path,parent:A});if(U.status==="valid")return U;U.status==="dirty"&&!y&&(y={result:U,ctx:A}),A.common.issues.length&&O.push(A.common.issues)}if(y)return h.common.issues.push(...y.ctx.common.issues),y.result;const E=O.map(C=>new i.ZodError(C));return(0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_union,unionErrors:E}),r.INVALID}}get options(){return this._def.options}}n.ZodUnion=j,j.create=(g,u)=>new j({options:g,typeName:x.ZodUnion,...c(u)});const Ce=g=>g instanceof tr?Ce(g.schema):g instanceof we?Ce(g.innerType()):g instanceof rr?[g.value]:g instanceof We?g.options:g instanceof nr?Object.keys(g.enum):g instanceof sr?Ce(g._def.innerType):g instanceof ct?[void 0]:g instanceof ut?[null]:null;class Ze extends l{_parse(u){const{ctx:h}=this._processInputParams(u);if(h.parsedType!==s.ZodParsedType.object)return(0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.object,received:h.parsedType}),r.INVALID;const p=this.discriminator,_=h.data[p],y=this.optionsMap.get(_);return y?h.common.async?y._parseAsync({data:h.data,path:h.path,parent:h}):y._parseSync({data:h.data,path:h.path,parent:h}):((0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[p]}),r.INVALID)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(u,h,p){const _=new Map;for(const y of h){const O=Ce(y.shape[u]);if(!O)throw new Error(`A discriminator value for key \`${u}\` could not be extracted from all schema options`);for(const E of O){if(_.has(E))throw new Error(`Discriminator property ${String(u)} has duplicate value ${String(E)}`);_.set(E,y)}}return new Ze({typeName:x.ZodDiscriminatedUnion,discriminator:u,options:h,optionsMap:_,...c(p)})}}n.ZodDiscriminatedUnion=Ze;function Xt(g,u){const h=(0,s.getParsedType)(g),p=(0,s.getParsedType)(u);if(g===u)return{valid:!0,data:g};if(h===s.ZodParsedType.object&&p===s.ZodParsedType.object){const _=s.util.objectKeys(u),y=s.util.objectKeys(g).filter(E=>_.indexOf(E)!==-1),O={...g,...u};for(const E of y){const C=Xt(g[E],u[E]);if(!C.valid)return{valid:!1};O[E]=C.data}return{valid:!0,data:O}}else if(h===s.ZodParsedType.array&&p===s.ZodParsedType.array){if(g.length!==u.length)return{valid:!1};const _=[];for(let y=0;y<g.length;y++){const O=g[y],E=u[y],C=Xt(O,E);if(!C.valid)return{valid:!1};_.push(C.data)}return{valid:!0,data:_}}else return h===s.ZodParsedType.date&&p===s.ZodParsedType.date&&+g==+u?{valid:!0,data:g}:{valid:!1}}class Qt extends l{_parse(u){const{status:h,ctx:p}=this._processInputParams(u),_=(y,O)=>{if((0,r.isAborted)(y)||(0,r.isAborted)(O))return r.INVALID;const E=Xt(y.value,O.value);return E.valid?(((0,r.isDirty)(y)||(0,r.isDirty)(O))&&h.dirty(),{status:h.value,value:E.data}):((0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_intersection_types}),r.INVALID)};return p.common.async?Promise.all([this._def.left._parseAsync({data:p.data,path:p.path,parent:p}),this._def.right._parseAsync({data:p.data,path:p.path,parent:p})]).then(([y,O])=>_(y,O)):_(this._def.left._parseSync({data:p.data,path:p.path,parent:p}),this._def.right._parseSync({data:p.data,path:p.path,parent:p}))}}n.ZodIntersection=Qt,Qt.create=(g,u,h)=>new Qt({left:g,right:u,typeName:x.ZodIntersection,...c(h)});class Se extends l{_parse(u){const{status:h,ctx:p}=this._processInputParams(u);if(p.parsedType!==s.ZodParsedType.array)return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.array,received:p.parsedType}),r.INVALID;if(p.data.length<this._def.items.length)return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),r.INVALID;!this._def.rest&&p.data.length>this._def.items.length&&((0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),h.dirty());const y=[...p.data].map((O,E)=>{const C=this._def.items[E]||this._def.rest;return C?C._parse(new a(p,O,p.path,E)):null}).filter(O=>!!O);return p.common.async?Promise.all(y).then(O=>r.ParseStatus.mergeArray(h,O)):r.ParseStatus.mergeArray(h,y)}get items(){return this._def.items}rest(u){return new Se({...this._def,rest:u})}}n.ZodTuple=Se,Se.create=(g,u)=>{if(!Array.isArray(g))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Se({items:g,typeName:x.ZodTuple,rest:null,...c(u)})};class er extends l{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(u){const{status:h,ctx:p}=this._processInputParams(u);if(p.parsedType!==s.ZodParsedType.object)return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.object,received:p.parsedType}),r.INVALID;const _=[],y=this._def.keyType,O=this._def.valueType;for(const E in p.data)_.push({key:y._parse(new a(p,E,p.path,E)),value:O._parse(new a(p,p.data[E],p.path,E))});return p.common.async?r.ParseStatus.mergeObjectAsync(h,_):r.ParseStatus.mergeObjectSync(h,_)}get element(){return this._def.valueType}static create(u,h,p){return h instanceof l?new er({keyType:u,valueType:h,typeName:x.ZodRecord,...c(p)}):new er({keyType:D.create(),valueType:u,typeName:x.ZodRecord,...c(h)})}}n.ZodRecord=er;class Yr extends l{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(u){const{status:h,ctx:p}=this._processInputParams(u);if(p.parsedType!==s.ZodParsedType.map)return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.map,received:p.parsedType}),r.INVALID;const _=this._def.keyType,y=this._def.valueType,O=[...p.data.entries()].map(([E,C],A)=>({key:_._parse(new a(p,E,p.path,[A,"key"])),value:y._parse(new a(p,C,p.path,[A,"value"]))}));if(p.common.async){const E=new Map;return Promise.resolve().then(async()=>{for(const C of O){const A=await C.key,U=await C.value;if(A.status==="aborted"||U.status==="aborted")return r.INVALID;(A.status==="dirty"||U.status==="dirty")&&h.dirty(),E.set(A.value,U.value)}return{status:h.value,value:E}})}else{const E=new Map;for(const C of O){const A=C.key,U=C.value;if(A.status==="aborted"||U.status==="aborted")return r.INVALID;(A.status==="dirty"||U.status==="dirty")&&h.dirty(),E.set(A.value,U.value)}return{status:h.value,value:E}}}}n.ZodMap=Yr,Yr.create=(g,u,h)=>new Yr({valueType:u,keyType:g,typeName:x.ZodMap,...c(h)});class lt extends l{_parse(u){const{status:h,ctx:p}=this._processInputParams(u);if(p.parsedType!==s.ZodParsedType.set)return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.set,received:p.parsedType}),r.INVALID;const _=this._def;_.minSize!==null&&p.data.size<_.minSize.value&&((0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_small,minimum:_.minSize.value,type:"set",inclusive:!0,exact:!1,message:_.minSize.message}),h.dirty()),_.maxSize!==null&&p.data.size>_.maxSize.value&&((0,r.addIssueToContext)(p,{code:i.ZodIssueCode.too_big,maximum:_.maxSize.value,type:"set",inclusive:!0,exact:!1,message:_.maxSize.message}),h.dirty());const y=this._def.valueType;function O(C){const A=new Set;for(const U of C){if(U.status==="aborted")return r.INVALID;U.status==="dirty"&&h.dirty(),A.add(U.value)}return{status:h.value,value:A}}const E=[...p.data.values()].map((C,A)=>y._parse(new a(p,C,p.path,A)));return p.common.async?Promise.all(E).then(C=>O(C)):O(E)}min(u,h){return new lt({...this._def,minSize:{value:u,message:t.errorUtil.toString(h)}})}max(u,h){return new lt({...this._def,maxSize:{value:u,message:t.errorUtil.toString(h)}})}size(u,h){return this.min(u,h).max(u,h)}nonempty(u){return this.min(1,u)}}n.ZodSet=lt,lt.create=(g,u)=>new lt({valueType:g,minSize:null,maxSize:null,typeName:x.ZodSet,...c(u)});class At extends l{constructor(){super(...arguments),this.validate=this.implement}_parse(u){const{ctx:h}=this._processInputParams(u);if(h.parsedType!==s.ZodParsedType.function)return(0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.function,received:h.parsedType}),r.INVALID;function p(E,C){return(0,r.makeIssue)({data:E,path:h.path,errorMaps:[h.common.contextualErrorMap,h.schemaErrorMap,(0,e.getErrorMap)(),e.defaultErrorMap].filter(A=>!!A),issueData:{code:i.ZodIssueCode.invalid_arguments,argumentsError:C}})}function _(E,C){return(0,r.makeIssue)({data:E,path:h.path,errorMaps:[h.common.contextualErrorMap,h.schemaErrorMap,(0,e.getErrorMap)(),e.defaultErrorMap].filter(A=>!!A),issueData:{code:i.ZodIssueCode.invalid_return_type,returnTypeError:C}})}const y={errorMap:h.common.contextualErrorMap},O=h.data;if(this._def.returns instanceof It){const E=this;return(0,r.OK)(async function(...C){const A=new i.ZodError([]),U=await E._def.args.parseAsync(C,y).catch(Es=>{throw A.addIssue(p(C,Es)),A}),ge=await Reflect.apply(O,this,U);return await E._def.returns._def.type.parseAsync(ge,y).catch(Es=>{throw A.addIssue(_(ge,Es)),A})})}else{const E=this;return(0,r.OK)(function(...C){const A=E._def.args.safeParse(C,y);if(!A.success)throw new i.ZodError([p(C,A.error)]);const U=Reflect.apply(O,this,A.data),ge=E._def.returns.safeParse(U,y);if(!ge.success)throw new i.ZodError([_(U,ge.error)]);return ge.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...u){return new At({...this._def,args:Se.create(u).rest(Ue.create())})}returns(u){return new At({...this._def,returns:u})}implement(u){return this.parse(u)}strictImplement(u){return this.parse(u)}static create(u,h,p){return new At({args:u||Se.create([]).rest(Ue.create()),returns:h||Ue.create(),typeName:x.ZodFunction,...c(p)})}}n.ZodFunction=At;class tr extends l{get schema(){return this._def.getter()}_parse(u){const{ctx:h}=this._processInputParams(u);return this._def.getter()._parse({data:h.data,path:h.path,parent:h})}}n.ZodLazy=tr,tr.create=(g,u)=>new tr({getter:g,typeName:x.ZodLazy,...c(u)});class rr extends l{_parse(u){if(u.data!==this._def.value){const h=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(h,{received:h.data,code:i.ZodIssueCode.invalid_literal,expected:this._def.value}),r.INVALID}return{status:"valid",value:u.data}}get value(){return this._def.value}}n.ZodLiteral=rr,rr.create=(g,u)=>new rr({value:g,typeName:x.ZodLiteral,...c(u)});function ia(g,u){return new We({values:g,typeName:x.ZodEnum,...c(u)})}class We extends l{_parse(u){if(typeof u.data!="string"){const h=this._getOrReturnCtx(u),p=this._def.values;return(0,r.addIssueToContext)(h,{expected:s.util.joinValues(p),received:h.parsedType,code:i.ZodIssueCode.invalid_type}),r.INVALID}if(this._def.values.indexOf(u.data)===-1){const h=this._getOrReturnCtx(u),p=this._def.values;return(0,r.addIssueToContext)(h,{received:h.data,code:i.ZodIssueCode.invalid_enum_value,options:p}),r.INVALID}return(0,r.OK)(u.data)}get options(){return this._def.values}get enum(){const u={};for(const h of this._def.values)u[h]=h;return u}get Values(){const u={};for(const h of this._def.values)u[h]=h;return u}get Enum(){const u={};for(const h of this._def.values)u[h]=h;return u}extract(u){return We.create(u)}exclude(u){return We.create(this.options.filter(h=>!u.includes(h)))}}n.ZodEnum=We,We.create=ia;class nr extends l{_parse(u){const h=s.util.getValidEnumValues(this._def.values),p=this._getOrReturnCtx(u);if(p.parsedType!==s.ZodParsedType.string&&p.parsedType!==s.ZodParsedType.number){const _=s.util.objectValues(h);return(0,r.addIssueToContext)(p,{expected:s.util.joinValues(_),received:p.parsedType,code:i.ZodIssueCode.invalid_type}),r.INVALID}if(h.indexOf(u.data)===-1){const _=s.util.objectValues(h);return(0,r.addIssueToContext)(p,{received:p.data,code:i.ZodIssueCode.invalid_enum_value,options:_}),r.INVALID}return(0,r.OK)(u.data)}get enum(){return this._def.values}}n.ZodNativeEnum=nr,nr.create=(g,u)=>new nr({values:g,typeName:x.ZodNativeEnum,...c(u)});class It extends l{unwrap(){return this._def.type}_parse(u){const{ctx:h}=this._processInputParams(u);if(h.parsedType!==s.ZodParsedType.promise&&h.common.async===!1)return(0,r.addIssueToContext)(h,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.promise,received:h.parsedType}),r.INVALID;const p=h.parsedType===s.ZodParsedType.promise?h.data:Promise.resolve(h.data);return(0,r.OK)(p.then(_=>this._def.type.parseAsync(_,{path:h.path,errorMap:h.common.contextualErrorMap})))}}n.ZodPromise=It,It.create=(g,u)=>new It({type:g,typeName:x.ZodPromise,...c(u)});class we extends l{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===x.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(u){const{status:h,ctx:p}=this._processInputParams(u),_=this._def.effect||null,y={addIssue:O=>{(0,r.addIssueToContext)(p,O),O.fatal?h.abort():h.dirty()},get path(){return p.path}};if(y.addIssue=y.addIssue.bind(y),_.type==="preprocess"){const O=_.transform(p.data,y);return p.common.issues.length?{status:"dirty",value:p.data}:p.common.async?Promise.resolve(O).then(E=>this._def.schema._parseAsync({data:E,path:p.path,parent:p})):this._def.schema._parseSync({data:O,path:p.path,parent:p})}if(_.type==="refinement"){const O=E=>{const C=_.refinement(E,y);if(p.common.async)return Promise.resolve(C);if(C instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return E};if(p.common.async===!1){const E=this._def.schema._parseSync({data:p.data,path:p.path,parent:p});return E.status==="aborted"?r.INVALID:(E.status==="dirty"&&h.dirty(),O(E.value),{status:h.value,value:E.value})}else return this._def.schema._parseAsync({data:p.data,path:p.path,parent:p}).then(E=>E.status==="aborted"?r.INVALID:(E.status==="dirty"&&h.dirty(),O(E.value).then(()=>({status:h.value,value:E.value}))))}if(_.type==="transform")if(p.common.async===!1){const O=this._def.schema._parseSync({data:p.data,path:p.path,parent:p});if(!(0,r.isValid)(O))return O;const E=_.transform(O.value,y);if(E instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:h.value,value:E}}else return this._def.schema._parseAsync({data:p.data,path:p.path,parent:p}).then(O=>(0,r.isValid)(O)?Promise.resolve(_.transform(O.value,y)).then(E=>({status:h.value,value:E})):O);s.util.assertNever(_)}}n.ZodEffects=we,n.ZodTransformer=we,we.create=(g,u,h)=>new we({schema:g,typeName:x.ZodEffects,effect:u,...c(h)}),we.createWithPreprocess=(g,u,h)=>new we({schema:u,effect:{type:"preprocess",transform:g},typeName:x.ZodEffects,...c(h)});class Me extends l{_parse(u){return this._getType(u)===s.ZodParsedType.undefined?(0,r.OK)(void 0):this._def.innerType._parse(u)}unwrap(){return this._def.innerType}}n.ZodOptional=Me,Me.create=(g,u)=>new Me({innerType:g,typeName:x.ZodOptional,...c(u)});class dt extends l{_parse(u){return this._getType(u)===s.ZodParsedType.null?(0,r.OK)(null):this._def.innerType._parse(u)}unwrap(){return this._def.innerType}}n.ZodNullable=dt,dt.create=(g,u)=>new dt({innerType:g,typeName:x.ZodNullable,...c(u)});class sr extends l{_parse(u){const{ctx:h}=this._processInputParams(u);let p=h.data;return h.parsedType===s.ZodParsedType.undefined&&(p=this._def.defaultValue()),this._def.innerType._parse({data:p,path:h.path,parent:h})}removeDefault(){return this._def.innerType}}n.ZodDefault=sr,sr.create=(g,u)=>new sr({innerType:g,typeName:x.ZodDefault,defaultValue:typeof u.default=="function"?u.default:()=>u.default,...c(u)});class Xr extends l{_parse(u){const{ctx:h}=this._processInputParams(u),p={...h,common:{...h.common,issues:[]}},_=this._def.innerType._parse({data:p.data,path:p.path,parent:{...p}});return(0,r.isAsync)(_)?_.then(y=>({status:"valid",value:y.status==="valid"?y.value:this._def.catchValue({get error(){return new i.ZodError(p.common.issues)},input:p.data})})):{status:"valid",value:_.status==="valid"?_.value:this._def.catchValue({get error(){return new i.ZodError(p.common.issues)},input:p.data})}}removeCatch(){return this._def.innerType}}n.ZodCatch=Xr,Xr.create=(g,u)=>new Xr({innerType:g,typeName:x.ZodCatch,catchValue:typeof u.catch=="function"?u.catch:()=>u.catch,...c(u)});class Qr extends l{_parse(u){if(this._getType(u)!==s.ZodParsedType.nan){const p=this._getOrReturnCtx(u);return(0,r.addIssueToContext)(p,{code:i.ZodIssueCode.invalid_type,expected:s.ZodParsedType.nan,received:p.parsedType}),r.INVALID}return{status:"valid",value:u.data}}}n.ZodNaN=Qr,Qr.create=g=>new Qr({typeName:x.ZodNaN,...c(g)}),n.BRAND=Symbol("zod_brand");class aa extends l{_parse(u){const{ctx:h}=this._processInputParams(u),p=h.data;return this._def.type._parse({data:p,path:h.path,parent:h})}unwrap(){return this._def.type}}n.ZodBranded=aa;class ir extends l{_parse(u){const{status:h,ctx:p}=this._processInputParams(u);if(p.common.async)return(async()=>{const y=await this._def.in._parseAsync({data:p.data,path:p.path,parent:p});return y.status==="aborted"?r.INVALID:y.status==="dirty"?(h.dirty(),(0,r.DIRTY)(y.value)):this._def.out._parseAsync({data:y.value,path:p.path,parent:p})})();{const _=this._def.in._parseSync({data:p.data,path:p.path,parent:p});return _.status==="aborted"?r.INVALID:_.status==="dirty"?(h.dirty(),{status:"dirty",value:_.value}):this._def.out._parseSync({data:_.value,path:p.path,parent:p})}}static create(u,h){return new ir({in:u,out:h,typeName:x.ZodPipeline})}}n.ZodPipeline=ir;class en extends l{_parse(u){const h=this._def.innerType._parse(u);return(0,r.isValid)(h)&&(h.value=Object.freeze(h.value)),h}}n.ZodReadonly=en,en.create=(g,u)=>new en({innerType:g,typeName:x.ZodReadonly,...c(u)});const Kc=(g,u={},h)=>g?Le.create().superRefine((p,_)=>{var y,O;if(!g(p)){const E=typeof u=="function"?u(p):typeof u=="string"?{message:u}:u,C=(O=(y=E.fatal)!==null&&y!==void 0?y:h)!==null&&O!==void 0?O:!0,A=typeof E=="string"?{message:E}:E;_.addIssue({code:"custom",...A,fatal:C})}}):Le.create();n.custom=Kc,n.late={object:R.lazycreate};var x;(function(g){g.ZodString="ZodString",g.ZodNumber="ZodNumber",g.ZodNaN="ZodNaN",g.ZodBigInt="ZodBigInt",g.ZodBoolean="ZodBoolean",g.ZodDate="ZodDate",g.ZodSymbol="ZodSymbol",g.ZodUndefined="ZodUndefined",g.ZodNull="ZodNull",g.ZodAny="ZodAny",g.ZodUnknown="ZodUnknown",g.ZodNever="ZodNever",g.ZodVoid="ZodVoid",g.ZodArray="ZodArray",g.ZodObject="ZodObject",g.ZodUnion="ZodUnion",g.ZodDiscriminatedUnion="ZodDiscriminatedUnion",g.ZodIntersection="ZodIntersection",g.ZodTuple="ZodTuple",g.ZodRecord="ZodRecord",g.ZodMap="ZodMap",g.ZodSet="ZodSet",g.ZodFunction="ZodFunction",g.ZodLazy="ZodLazy",g.ZodLiteral="ZodLiteral",g.ZodEnum="ZodEnum",g.ZodEffects="ZodEffects",g.ZodNativeEnum="ZodNativeEnum",g.ZodOptional="ZodOptional",g.ZodNullable="ZodNullable",g.ZodDefault="ZodDefault",g.ZodCatch="ZodCatch",g.ZodPromise="ZodPromise",g.ZodBranded="ZodBranded",g.ZodPipeline="ZodPipeline",g.ZodReadonly="ZodReadonly"})(x=n.ZodFirstPartyTypeKind||(n.ZodFirstPartyTypeKind={}));const Hc=(g,u={message:`Input not instance of ${g.name}`})=>(0,n.custom)(h=>h instanceof g,u);n.instanceof=Hc;const oa=D.create;n.string=oa;const ca=q.create;n.number=ca;const Jc=Qr.create;n.nan=Jc;const Gc=me.create;n.bigint=Gc;const ua=oe.create;n.boolean=ua;const Wc=he.create;n.date=Wc;const Yc=Ot.create;n.symbol=Yc;const Xc=ct.create;n.undefined=Xc;const Qc=ut.create;n.null=Qc;const eu=Le.create;n.any=eu;const tu=Ue.create;n.unknown=tu;const ru=ve.create;n.never=ru;const nu=Pt.create;n.void=nu;const su=fe.create;n.array=su;const iu=R.create;n.object=iu;const au=R.strictCreate;n.strictObject=au;const ou=j.create;n.union=ou;const cu=Ze.create;n.discriminatedUnion=cu;const uu=Qt.create;n.intersection=uu;const lu=Se.create;n.tuple=lu;const du=er.create;n.record=du;const hu=Yr.create;n.map=hu;const fu=lt.create;n.set=fu;const pu=At.create;n.function=pu;const mu=tr.create;n.lazy=mu;const gu=rr.create;n.literal=gu;const yu=We.create;n.enum=yu;const _u=nr.create;n.nativeEnum=_u;const bu=It.create;n.promise=bu;const la=we.create;n.effect=la,n.transformer=la;const vu=Me.create;n.optional=vu;const wu=dt.create;n.nullable=wu;const Tu=we.createWithPreprocess;n.preprocess=Tu;const Eu=ir.create;n.pipeline=Eu;const Ou=()=>oa().optional();n.ostring=Ou;const Pu=()=>ca().optional();n.onumber=Pu;const Au=()=>ua().optional();n.oboolean=Au,n.coerce={string:g=>D.create({...g,coerce:!0}),number:g=>q.create({...g,coerce:!0}),boolean:g=>oe.create({...g,coerce:!0}),bigint:g=>me.create({...g,coerce:!0}),date:g=>he.create({...g,coerce:!0})},n.NEVER=r.INVALID})(Oc);(function(n){var e=ie&&ie.__createBinding||(Object.create?function(r,s,i,a){a===void 0&&(a=i),Object.defineProperty(r,a,{enumerable:!0,get:function(){return s[i]}})}:function(r,s,i,a){a===void 0&&(a=i),r[a]=s[i]}),t=ie&&ie.__exportStar||function(r,s){for(var i in r)i!=="default"&&!Object.prototype.hasOwnProperty.call(s,i)&&e(s,r,i)};Object.defineProperty(n,"__esModule",{value:!0}),t(je,n),t(Yi,n),t(Ec,n),t(Jr,n),t(Oc,n),t($e,n)})(di);(function(n){var e=ie&&ie.__createBinding||(Object.create?function(a,o,c,l){l===void 0&&(l=c),Object.defineProperty(a,l,{enumerable:!0,get:function(){return o[c]}})}:function(a,o,c,l){l===void 0&&(l=c),a[l]=o[c]}),t=ie&&ie.__setModuleDefault||(Object.create?function(a,o){Object.defineProperty(a,"default",{enumerable:!0,value:o})}:function(a,o){a.default=o}),r=ie&&ie.__importStar||function(a){if(a&&a.__esModule)return a;var o={};if(a!=null)for(var c in a)c!=="default"&&Object.prototype.hasOwnProperty.call(a,c)&&e(o,a,c);return t(o,a),o},s=ie&&ie.__exportStar||function(a,o){for(var c in a)c!=="default"&&!Object.prototype.hasOwnProperty.call(o,c)&&e(o,a,c)};Object.defineProperty(n,"__esModule",{value:!0}),n.z=void 0;const i=r(di);n.z=i,s(di,n),n.default=i})(as);var cs={};Object.defineProperty(cs,"__esModule",{value:!0});cs.parseAnyDef=void 0;function Gh(){return{}}cs.parseAnyDef=Gh;var or={},He={};Object.defineProperty(He,"__esModule",{value:!0});He.setResponseValueAndErrors=He.addErrorMessage=void 0;function Ac(n,e,t,r){r!=null&&r.errorMessages&&t&&(n.errorMessage=Object.assign(Object.assign({},n.errorMessage),{[e]:t}))}He.addErrorMessage=Ac;function Wh(n,e,t,r,s){n[e]=t,Ac(n,e,r,s)}He.setResponseValueAndErrors=Wh;var Za;function Yh(){if(Za)return or;Za=1,Object.defineProperty(or,"__esModule",{value:!0}),or.parseArrayDef=void 0;const n=as,e=He,t=te();function r(s,i){var a,o;const c={type:"array"};return((o=(a=s.type)===null||a===void 0?void 0:a._def)===null||o===void 0?void 0:o.typeName)!==n.ZodFirstPartyTypeKind.ZodAny&&(c.items=(0,t.parseDef)(s.type._def,Object.assign(Object.assign({},i),{currentPath:[...i.currentPath,"items"]}))),s.minLength&&(0,e.setResponseValueAndErrors)(c,"minItems",s.minLength.value,s.minLength.message,i),s.maxLength&&(0,e.setResponseValueAndErrors)(c,"maxItems",s.maxLength.value,s.maxLength.message,i),c}return or.parseArrayDef=r,or}var us={};Object.defineProperty(us,"__esModule",{value:!0});us.parseBigintDef=void 0;function Xh(){return{type:"integer",format:"int64"}}us.parseBigintDef=Xh;var ls={};Object.defineProperty(ls,"__esModule",{value:!0});ls.parseBooleanDef=void 0;function Qh(){return{type:"boolean"}}ls.parseBooleanDef=Qh;var cr={},Ma;function ef(){if(Ma)return cr;Ma=1,Object.defineProperty(cr,"__esModule",{value:!0}),cr.parseBrandedDef=void 0;const n=te();function e(t,r){return(0,n.parseDef)(t.type._def,r)}return cr.parseBrandedDef=e,cr}var ur={},Fa;function tf(){if(Fa)return ur;Fa=1,Object.defineProperty(ur,"__esModule",{value:!0}),ur.parseCatchDef=void 0;const n=te(),e=(t,r)=>(0,n.parseDef)(t.innerType._def,r);return ur.parseCatchDef=e,ur}var ds={};Object.defineProperty(ds,"__esModule",{value:!0});ds.parseDateDef=void 0;function rf(){return{type:"string",format:"date-time"}}ds.parseDateDef=rf;var lr={},Ba;function nf(){if(Ba)return lr;Ba=1,Object.defineProperty(lr,"__esModule",{value:!0}),lr.parseDefaultDef=void 0;const n=te();function e(t,r){return Object.assign(Object.assign({},(0,n.parseDef)(t.innerType._def,r)),{default:t.defaultValue()})}return lr.parseDefaultDef=e,lr}var dr={},Va;function sf(){if(Va)return dr;Va=1,Object.defineProperty(dr,"__esModule",{value:!0}),dr.parseEffectsDef=void 0;const n=te();function e(t,r){return r.effectStrategy==="input"?(0,n.parseDef)(t.schema._def,r):{}}return dr.parseEffectsDef=e,dr}var hs={};Object.defineProperty(hs,"__esModule",{value:!0});hs.parseEnumDef=void 0;function af(n){return{type:"string",enum:n.values}}hs.parseEnumDef=af;var hr={},za;function of(){if(za)return hr;za=1,Object.defineProperty(hr,"__esModule",{value:!0}),hr.parseIntersectionDef=void 0;const n=te();function e(t,r){const s=[(0,n.parseDef)(t.left._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf","0"]})),(0,n.parseDef)(t.right._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf","1"]}))].filter(i=>!!i);return s.length?{allOf:s}:void 0}return hr.parseIntersectionDef=e,hr}var fs={};Object.defineProperty(fs,"__esModule",{value:!0});fs.parseLiteralDef=void 0;function cf(n,e){const t=typeof n.value;return t!=="bigint"&&t!=="number"&&t!=="boolean"&&t!=="string"?{type:Array.isArray(n.value)?"array":"object"}:e.target==="openApi3"?{type:t==="bigint"?"integer":t,enum:[n.value]}:{type:t==="bigint"?"integer":t,const:n.value}}fs.parseLiteralDef=cf;var fr={},qa;function uf(){if(qa)return fr;qa=1,Object.defineProperty(fr,"__esModule",{value:!0}),fr.parseMapDef=void 0;const n=te();function e(t,r){const s=(0,n.parseDef)(t.keyType._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items","items","0"]}))||{},i=(0,n.parseDef)(t.valueType._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items","items","1"]}))||{};return{type:"array",maxItems:125,items:{type:"array",items:[s,i],minItems:2,maxItems:2}}}return fr.parseMapDef=e,fr}var ps={};Object.defineProperty(ps,"__esModule",{value:!0});ps.parseNativeEnumDef=void 0;function lf(n){const e=n.values,r=Object.keys(n.values).filter(i=>typeof e[e[i]]!="number").map(i=>e[i]),s=Array.from(new Set(r.map(i=>typeof i)));return{type:s.length===1?s[0]==="string"?"string":"number":["string","number"],enum:r}}ps.parseNativeEnumDef=lf;var ms={};Object.defineProperty(ms,"__esModule",{value:!0});ms.parseNeverDef=void 0;function df(){return{not:{}}}ms.parseNeverDef=df;var gs={};Object.defineProperty(gs,"__esModule",{value:!0});gs.parseNullDef=void 0;function hf(n){return n.target==="openApi3"?{enum:["null"],nullable:!0}:{type:"null"}}gs.parseNullDef=hf;var pr={},Ms={},Ka;function Ic(){return Ka||(Ka=1,function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.parseUnionDef=n.primitiveMappings=void 0;const e=te();n.primitiveMappings={ZodString:"string",ZodNumber:"number",ZodBigInt:"integer",ZodBoolean:"boolean",ZodNull:"null"};function t(s,i){if(i.target==="openApi3")return r(s,i);const a=s.options instanceof Map?Array.from(s.options.values()):s.options;if(a.every(o=>o._def.typeName in n.primitiveMappings&&(!o._def.checks||!o._def.checks.length))){const o=a.reduce((c,l)=>{const d=n.primitiveMappings[l._def.typeName];return d&&!c.includes(d)?[...c,d]:c},[]);return{type:o.length>1?o:o[0]}}else if(a.every(o=>o._def.typeName==="ZodLiteral")){const o=a.reduce((c,l)=>{const d=typeof l._def.value;switch(d){case"string":case"number":case"boolean":return[...c,d];case"bigint":return[...c,"integer"];case"object":if(l._def.value===null)return[...c,"null"];case"symbol":case"undefined":case"function":default:return c}},[]);if(o.length===a.length){const c=o.filter((l,d,f)=>f.indexOf(l)===d);return{type:c.length>1?c:c[0],enum:a.reduce((l,d)=>l.includes(d._def.value)?l:[...l,d._def.value],[])}}}else if(a.every(o=>o._def.typeName==="ZodEnum"))return{type:"string",enum:a.reduce((o,c)=>[...o,...c._def.values.filter(l=>!o.includes(l))],[])};return r(s,i)}n.parseUnionDef=t;const r=(s,i)=>{const a=(s.options instanceof Map?Array.from(s.options.values()):s.options).map((o,c)=>(0,e.parseDef)(o._def,Object.assign(Object.assign({},i),{currentPath:[...i.currentPath,"anyOf",`${c}`]}))).filter(o=>!!o&&(!i.strictUnions||typeof o=="object"&&Object.keys(o).length>0));return a.length?{anyOf:a}:void 0}}(Ms)),Ms}var Ha;function ff(){if(Ha)return pr;Ha=1,Object.defineProperty(pr,"__esModule",{value:!0}),pr.parseNullableDef=void 0;const n=te(),e=Ic();function t(r,s){if(["ZodString","ZodNumber","ZodBigInt","ZodBoolean","ZodNull"].includes(r.innerType._def.typeName)&&(!r.innerType._def.checks||!r.innerType._def.checks.length))return s.target==="openApi3"?{type:e.primitiveMappings[r.innerType._def.typeName],nullable:!0}:{type:[e.primitiveMappings[r.innerType._def.typeName],"null"]};const i=(0,n.parseDef)(r.innerType._def,Object.assign(Object.assign({},s),{currentPath:[...s.currentPath,"anyOf","0"]}));return i?s.target==="openApi3"?Object.assign(Object.assign({},i),{nullable:!0}):{anyOf:[i,{type:"null"}]}:void 0}return pr.parseNullableDef=t,pr}var ys={};Object.defineProperty(ys,"__esModule",{value:!0});ys.parseNumberDef=void 0;const et=He;function pf(n,e){const t={type:"number"};if(!n.checks)return t;for(const r of n.checks)switch(r.kind){case"int":t.type="integer",(0,et.addErrorMessage)(t,"type",r.message,e);break;case"min":e.target==="jsonSchema7"?r.inclusive?(0,et.setResponseValueAndErrors)(t,"minimum",r.value,r.message,e):(0,et.setResponseValueAndErrors)(t,"exclusiveMinimum",r.value,r.message,e):(r.inclusive||(t.exclusiveMinimum=!0),(0,et.setResponseValueAndErrors)(t,"minimum",r.value,r.message,e));break;case"max":e.target==="jsonSchema7"?r.inclusive?(0,et.setResponseValueAndErrors)(t,"maximum",r.value,r.message,e):(0,et.setResponseValueAndErrors)(t,"exclusiveMaximum",r.value,r.message,e):(r.inclusive||(t.exclusiveMaximum=!0),(0,et.setResponseValueAndErrors)(t,"maximum",r.value,r.message,e));break;case"multipleOf":(0,et.setResponseValueAndErrors)(t,"multipleOf",r.value,r.message,e);break}return t}ys.parseNumberDef=pf;var mr={},Ja;function mf(){if(Ja)return mr;Ja=1,Object.defineProperty(mr,"__esModule",{value:!0}),mr.parseObjectDef=void 0;const n=te();function e(t,r){var s;const i=Object.assign(Object.assign({type:"object"},Object.entries(t.shape()).reduce((a,[o,c])=>{if(c===void 0||c._def===void 0)return a;const l=(0,n.parseDef)(c._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"properties",o],propertyPath:[...r.currentPath,"properties",o]}));return l===void 0?a:{properties:Object.assign(Object.assign({},a.properties),{[o]:l}),required:c.isOptional()?a.required:[...a.required,o]}},{properties:{},required:[]})),{additionalProperties:t.catchall._def.typeName==="ZodNever"?t.unknownKeys==="passthrough":(s=(0,n.parseDef)(t.catchall._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"additionalProperties"]})))!==null&&s!==void 0?s:!0});return i.required.length||delete i.required,i}return mr.parseObjectDef=e,mr}var gr={},Ga;function gf(){if(Ga)return gr;Ga=1,Object.defineProperty(gr,"__esModule",{value:!0}),gr.parseOptionalDef=void 0;const n=te(),e=(t,r)=>{var s;if(r.currentPath.toString()===((s=r.propertyPath)===null||s===void 0?void 0:s.toString()))return(0,n.parseDef)(t.innerType._def,r);const i=(0,n.parseDef)(t.innerType._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"anyOf","1"]}));return i?{anyOf:[{not:{}},i]}:{}};return gr.parseOptionalDef=e,gr}var yr={},Wa;function yf(){if(Wa)return yr;Wa=1,Object.defineProperty(yr,"__esModule",{value:!0}),yr.parsePipelineDef=void 0;const n=te(),e=(t,r)=>{const s=(0,n.parseDef)(t.in._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf","0"]})),i=(0,n.parseDef)(t.out._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"allOf",s?"1":"0"]}));return{allOf:[s,i].filter(a=>a!==void 0)}};return yr.parsePipelineDef=e,yr}var _r={},Ya;function _f(){if(Ya)return _r;Ya=1,Object.defineProperty(_r,"__esModule",{value:!0}),_r.parsePromiseDef=void 0;const n=te();function e(t,r){return(0,n.parseDef)(t.type._def,r)}return _r.parsePromiseDef=e,_r}var br={},Gr={};Object.defineProperty(Gr,"__esModule",{value:!0});Gr.parseStringDef=void 0;const Be=He;function bf(n,e){const t={type:"string"};if(n.checks)for(const r of n.checks)switch(r.kind){case"min":(0,Be.setResponseValueAndErrors)(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e);break;case"max":(0,Be.setResponseValueAndErrors)(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break;case"email":(0,Be.setResponseValueAndErrors)(t,"format","email",r.message,e);break;case"url":(0,Be.setResponseValueAndErrors)(t,"format","uri",r.message,e);break;case"uuid":(0,Be.setResponseValueAndErrors)(t,"format","uuid",r.message,e);break;case"regex":vr(t,r.regex.source,r.message,e);break;case"cuid":vr(t,"^c[^\\s-]{8,}$",r.message,e);break;case"cuid2":vr(t,"^[a-z][a-z0-9]*$",r.message,e);break;case"startsWith":vr(t,"^"+Xa(r.value),r.message,e);break;case"endsWith":vr(t,Xa(r.value)+"$",r.message,e);break;case"trim":break;case"datetime":(0,Be.setResponseValueAndErrors)(t,"format","date-time",r.message,e);break;case"length":(0,Be.setResponseValueAndErrors)(t,"minLength",typeof t.minLength=="number"?Math.max(t.minLength,r.value):r.value,r.message,e),(0,Be.setResponseValueAndErrors)(t,"maxLength",typeof t.maxLength=="number"?Math.min(t.maxLength,r.value):r.value,r.message,e);break}return t}Gr.parseStringDef=bf;const Xa=n=>Array.from(n).map(e=>/[a-zA-Z0-9]/.test(e)?e:`\\${e}`).join(""),vr=(n,e,t,r)=>{var s;n.pattern||!((s=n.allOf)===null||s===void 0)&&s.some(i=>i.pattern)?(n.allOf||(n.allOf=[]),n.pattern&&(n.allOf.push(Object.assign({pattern:n.pattern},n.errorMessage&&r.errorMessages&&{errorMessage:{pattern:n.errorMessage.pattern}})),delete n.pattern,n.errorMessage&&(delete n.errorMessage.pattern,Object.keys(n.errorMessage).length===0&&delete n.errorMessage)),n.allOf.push(Object.assign({pattern:e},t&&r.errorMessages&&{errorMessage:{pattern:t}}))):(0,Be.setResponseValueAndErrors)(n,"pattern",e,t,r)};var Qa;function vf(){if(Qa)return br;Qa=1,Object.defineProperty(br,"__esModule",{value:!0}),br.parseRecordDef=void 0;const n=as,e=te(),t=Gr;function r(s,i){var a,o,c;const l={type:"object",additionalProperties:(0,e.parseDef)(s.valueType._def,Object.assign(Object.assign({},i),{currentPath:[...i.currentPath,"additionalProperties"]}))||{}};if(((a=s.keyType)===null||a===void 0?void 0:a._def.typeName)===n.ZodFirstPartyTypeKind.ZodString&&(!((o=s.keyType._def.checks)===null||o===void 0)&&o.length)){const d=Object.entries((0,t.parseStringDef)(s.keyType._def,i)).reduce((f,[m,b])=>m==="type"?f:Object.assign(Object.assign({},f),{[m]:b}),{});return Object.assign(Object.assign({},l),{propertyNames:d})}else if(((c=s.keyType)===null||c===void 0?void 0:c._def.typeName)===n.ZodFirstPartyTypeKind.ZodEnum)return Object.assign(Object.assign({},l),{propertyNames:{enum:s.keyType._def.values}});return l}return br.parseRecordDef=r,br}var wr={},eo;function wf(){if(eo)return wr;eo=1,Object.defineProperty(wr,"__esModule",{value:!0}),wr.parseSetDef=void 0;const n=He,e=te();function t(r,s){const a={type:"array",items:(0,e.parseDef)(r.valueType._def,Object.assign(Object.assign({},s),{currentPath:[...s.currentPath,"items"]}))};return r.minSize&&(0,n.setResponseValueAndErrors)(a,"minItems",r.minSize.value,r.minSize.message,s),r.maxSize&&(0,n.setResponseValueAndErrors)(a,"maxItems",r.maxSize.value,r.maxSize.message,s),a}return wr.parseSetDef=t,wr}var Tr={},to;function Tf(){if(to)return Tr;to=1,Object.defineProperty(Tr,"__esModule",{value:!0}),Tr.parseTupleDef=void 0;const n=te();function e(t,r){return t.rest?{type:"array",minItems:t.items.length,items:t.items.map((s,i)=>(0,n.parseDef)(s._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items",`${i}`]}))).reduce((s,i)=>i===void 0?s:[...s,i],[]),additionalItems:(0,n.parseDef)(t.rest._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"additionalItems"]}))}:{type:"array",minItems:t.items.length,maxItems:t.items.length,items:t.items.map((s,i)=>(0,n.parseDef)(s._def,Object.assign(Object.assign({},r),{currentPath:[...r.currentPath,"items",`${i}`]}))).reduce((s,i)=>i===void 0?s:[...s,i],[])}}return Tr.parseTupleDef=e,Tr}var _s={};Object.defineProperty(_s,"__esModule",{value:!0});_s.parseUndefinedDef=void 0;function Ef(){return{not:{}}}_s.parseUndefinedDef=Ef;var bs={};Object.defineProperty(bs,"__esModule",{value:!0});bs.parseUnknownDef=void 0;function Of(){return{}}bs.parseUnknownDef=Of;var ro;function te(){if(ro)return ar;ro=1,Object.defineProperty(ar,"__esModule",{value:!0}),ar.parseDef=void 0;const n=as,e=cs,t=Yh(),r=us,s=ls,i=ef(),a=tf(),o=ds,c=nf(),l=sf(),d=hs,f=of(),m=fs,b=uf(),v=ps,T=ms,w=gs,P=ff(),k=ys,I=mf(),Z=gf(),D=yf(),B=_f(),q=vf(),me=wf(),oe=Gr,he=Tf(),Ot=_s,ct=Ic(),ut=bs;function Le(S,R){const j=R.seen.find(Xt=>Object.is(Xt.def,S));if(j)return Ue(j,R);const Ce={def:S,path:R.currentPath,jsonSchema:void 0};R.seen.push(Ce);const Ze=Pt(S,S.typeName,R);return Ze&&fe(S,Ze),Ce.jsonSchema=Ze,Ze}ar.parseDef=Le;const Ue=(S,R)=>{switch(R.$refStrategy){case"root":return{$ref:S.path.length===0?"":S.path.length===1?`${S.path[0]}/`:S.path.join("/")};case"relative":return{$ref:ve(R.currentPath,S.path)};case"none":return S.path.length<R.currentPath.length&&S.path.every((j,Ce)=>R.currentPath[Ce]===j)?(console.warn(`Recursive reference detected at ${R.currentPath.join("/")}! Defaulting to any`),{}):S.jsonSchema}},ve=(S,R)=>{let j=0;for(;j<S.length&&j<R.length&&S[j]===R[j];j++);return[(S.length-j).toString(),...R.slice(j)].join("/")},Pt=(S,R,j)=>{switch(R){case n.ZodFirstPartyTypeKind.ZodString:return(0,oe.parseStringDef)(S,j);case n.ZodFirstPartyTypeKind.ZodNumber:return(0,k.parseNumberDef)(S,j);case n.ZodFirstPartyTypeKind.ZodObject:return(0,I.parseObjectDef)(S,j);case n.ZodFirstPartyTypeKind.ZodBigInt:return(0,r.parseBigintDef)();case n.ZodFirstPartyTypeKind.ZodBoolean:return(0,s.parseBooleanDef)();case n.ZodFirstPartyTypeKind.ZodDate:return(0,o.parseDateDef)();case n.ZodFirstPartyTypeKind.ZodUndefined:return(0,Ot.parseUndefinedDef)();case n.ZodFirstPartyTypeKind.ZodNull:return(0,w.parseNullDef)(j);case n.ZodFirstPartyTypeKind.ZodArray:return(0,t.parseArrayDef)(S,j);case n.ZodFirstPartyTypeKind.ZodUnion:case n.ZodFirstPartyTypeKind.ZodDiscriminatedUnion:return(0,ct.parseUnionDef)(S,j);case n.ZodFirstPartyTypeKind.ZodIntersection:return(0,f.parseIntersectionDef)(S,j);case n.ZodFirstPartyTypeKind.ZodTuple:return(0,he.parseTupleDef)(S,j);case n.ZodFirstPartyTypeKind.ZodRecord:return(0,q.parseRecordDef)(S,j);case n.ZodFirstPartyTypeKind.ZodLiteral:return(0,m.parseLiteralDef)(S,j);case n.ZodFirstPartyTypeKind.ZodEnum:return(0,d.parseEnumDef)(S);case n.ZodFirstPartyTypeKind.ZodNativeEnum:return(0,v.parseNativeEnumDef)(S);case n.ZodFirstPartyTypeKind.ZodNullable:return(0,P.parseNullableDef)(S,j);case n.ZodFirstPartyTypeKind.ZodOptional:return(0,Z.parseOptionalDef)(S,j);case n.ZodFirstPartyTypeKind.ZodMap:return(0,b.parseMapDef)(S,j);case n.ZodFirstPartyTypeKind.ZodSet:return(0,me.parseSetDef)(S,j);case n.ZodFirstPartyTypeKind.ZodLazy:return Le(S.getter()._def,j);case n.ZodFirstPartyTypeKind.ZodPromise:return(0,B.parsePromiseDef)(S,j);case n.ZodFirstPartyTypeKind.ZodNaN:case n.ZodFirstPartyTypeKind.ZodNever:return(0,T.parseNeverDef)();case n.ZodFirstPartyTypeKind.ZodEffects:return(0,l.parseEffectsDef)(S,j);case n.ZodFirstPartyTypeKind.ZodAny:return(0,e.parseAnyDef)();case n.ZodFirstPartyTypeKind.ZodUnknown:return(0,ut.parseUnknownDef)();case n.ZodFirstPartyTypeKind.ZodDefault:return(0,c.parseDefaultDef)(S,j);case n.ZodFirstPartyTypeKind.ZodBranded:return(0,i.parseBrandedDef)(S,j);case n.ZodFirstPartyTypeKind.ZodCatch:return(0,a.parseCatchDef)(S,j);case n.ZodFirstPartyTypeKind.ZodPipeline:return(0,D.parsePipelineDef)(S,j);case n.ZodFirstPartyTypeKind.ZodFunction:case n.ZodFirstPartyTypeKind.ZodVoid:case n.ZodFirstPartyTypeKind.ZodSymbol:return;default:return(Ce=>{})()}},fe=(S,R)=>(S.description&&(R.description=S.description),R);return ar}var vs={},kc={};(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.getDefaultOptions=n.defaultOptions=void 0,n.defaultOptions={name:void 0,$refStrategy:"root",basePath:["#"],effectStrategy:"input",definitionPath:"definitions",target:"jsonSchema7",strictUnions:!1,definitions:{},errorMessages:!1};const e=t=>typeof t=="string"?Object.assign(Object.assign({},n.defaultOptions),{name:t}):Object.assign(Object.assign({},n.defaultOptions),t);n.getDefaultOptions=e})(kc);Object.defineProperty(vs,"__esModule",{value:!0});vs.getRefs=void 0;const Pf=kc,Af=n=>{const e=(0,Pf.getDefaultOptions)(n),t=e.name!==void 0?[...e.basePath,e.definitionPath,e.name]:e.basePath;return Object.assign(Object.assign({},e),{currentPath:t,propertyPath:void 0,seen:[]})};vs.getRefs=Af;Object.defineProperty(is,"__esModule",{value:!0});is.zodToJsonSchema=void 0;const no=te(),If=vs,kf=(n,e)=>{var t;const r=(0,If.getRefs)(e),s=typeof e=="object"&&e.definitions?Object.entries(e.definitions).reduce((c,[l,d])=>{var f;return Object.assign(Object.assign({},c),{[l]:(f=(0,no.parseDef)(d._def,Object.assign(Object.assign({},r),{currentPath:[...r.basePath,r.definitionPath,l]})))!==null&&f!==void 0?f:{}})},{}):void 0,i=typeof e=="string"?e:e==null?void 0:e.name,a=(t=(0,no.parseDef)(n._def,i===void 0?r:Object.assign(Object.assign({},r),{currentPath:[...r.basePath,r.definitionPath,i]})))!==null&&t!==void 0?t:{},o=i===void 0?s?Object.assign(Object.assign({},a),{[r.definitionPath]:s}):a:{$ref:[...r.$refStrategy==="relative"?[]:r.basePath,r.definitionPath,i].join("/"),[r.definitionPath]:Object.assign(Object.assign({},s),{[i]:a})};return r.target==="jsonSchema7"&&(o.$schema="http://json-schema.org/draft-07/schema#"),o};is.zodToJsonSchema=kf;(function(n){Object.defineProperty(n,"__esModule",{value:!0}),n.zodToJsonSchema=void 0;const e=is;Object.defineProperty(n,"zodToJsonSchema",{enumerable:!0,get:function(){return e.zodToJsonSchema}}),n.default=e.zodToJsonSchema})(bc);function Cc(n){let e;return n.constructor.name===Bl.name?(e=new Error(n.message),e.name="TimeoutError"):n.constructor.name===Vl.name?(e=new Error(n.message),e.name="AbortError"):e=n,e}function Cf(n){const e=bc.zodToJsonSchema(n.schema);return{type:"function",function:{name:n.name,description:n.description,parameters:e}}}function Sf(n){return n.anyOf!==void 0&&Array.isArray(n.anyOf)}function xf(n){const e=["namespace functions {",""];for(const t of n)t.description&&e.push(`// ${t.description}`),Object.keys(t.parameters.properties??{}).length>0?(e.push(`type ${t.name} = (_: {`),e.push(Sc(t.parameters,0)),e.push("}) => any;")):e.push(`type ${t.name} = () => any;`),e.push("");return e.push("} // namespace functions"),e.join(`
`)}function Sc(n,e){var r;const t=[];for(const[s,i]of Object.entries(n.properties??{}))i.description&&e<2&&t.push(`// ${i.description}`),(r=n.required)!=null&&r.includes(s)?t.push(`${s}: ${Jn(i,e)},`):t.push(`${s}?: ${Jn(i,e)},`);return t.map(s=>" ".repeat(e)+s).join(`
`)}function Jn(n,e){if(Sf(n))return n.anyOf.map(t=>Jn(t,e)).join(" | ");switch(n.type){case"string":return n.enum?n.enum.map(t=>`"${t}"`).join(" | "):"string";case"number":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"integer":return n.enum?n.enum.map(t=>`${t}`).join(" | "):"number";case"boolean":return"boolean";case"null":return"null";case"object":return["{",Sc(n,e+2),"}"].join(`
`);case"array":return n.items?`${Jn(n.items,e)}[]`:"any[]";default:return""}}function Rf(n){return n.role!=="system"&&n.role!=="assistant"&&n.role!=="user"&&n.role!=="function"&&n.role!=="tool"&&console.warn(`Unknown message role: ${n.role}`),n.role}function xc(n){const e=n._getType();switch(e){case"system":return"system";case"ai":return"assistant";case"human":return"user";case"function":return"function";case"tool":return"tool";case"generic":{if(!Mi.isInstance(n))throw new Error("Invalid generic chat message");return Rf(n)}default:throw new Error(`Unknown message type: ${e}`)}}function jf(n){switch(n.role){case"assistant":return new Xo(n.content||"",{function_call:n.function_call,tool_calls:n.tool_calls});default:return new Mi(n.content||"",n.role??"unknown")}}function $f(n,e){const t=n.role??e,r=n.content??"";let s;return n.function_call?s={function_call:n.function_call}:n.tool_calls?s={tool_calls:n.tool_calls}:s={},t==="user"?new Zr({content:r}):t==="assistant"?new Mr({content:r,additional_kwargs:s}):t==="system"?new Fr({content:r}):t==="function"?new Br({content:r,additional_kwargs:s,name:n.name}):t==="tool"?new zn({content:r,additional_kwargs:s,tool_call_id:n.tool_call_id}):new Vr({content:r,role:t})}function so(n){return n.map(e=>({role:xc(e),content:e.content,name:e.name,function_call:e.additional_kwargs.function_call,tool_calls:e.additional_kwargs.tool_calls,tool_call_id:e.tool_call_id}))}class Nf extends _t{static lc_name(){return"ChatOpenAI"}get callKeys(){return[...super.callKeys,"options","function_call","functions","tools","tool_choice","promptIndex","response_format","seed"]}get lc_secrets(){return{openAIApiKey:"OPENAI_API_KEY",azureOpenAIApiKey:"AZURE_OPENAI_API_KEY",organization:"OPENAI_ORGANIZATION"}}get lc_aliases(){return{modelName:"model",openAIApiKey:"openai_api_key",azureOpenAIApiVersion:"azure_openai_api_version",azureOpenAIApiKey:"azure_openai_api_key",azureOpenAIApiInstanceName:"azure_openai_api_instance_name",azureOpenAIApiDeploymentName:"azure_openai_api_deployment_name"}}constructor(e,t){var r,s,i,a,o,c,l,d;if(super(e??{}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"temperature",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"topP",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"frequencyPenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"presencePenalty",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"n",{enumerable:!0,configurable:!0,writable:!0,value:1}),Object.defineProperty(this,"logitBias",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"gpt-3.5-turbo"}),Object.defineProperty(this,"modelKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stop",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"user",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"streaming",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"maxTokens",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"openAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.openAIApiKey=(e==null?void 0:e.openAIApiKey)??J("OPENAI_API_KEY"),this.azureOpenAIApiKey=(e==null?void 0:e.azureOpenAIApiKey)??J("AZURE_OPENAI_API_KEY"),!this.azureOpenAIApiKey&&!this.openAIApiKey)throw new Error("OpenAI or Azure OpenAI API key not found");if(this.azureOpenAIApiInstanceName=(e==null?void 0:e.azureOpenAIApiInstanceName)??J("AZURE_OPENAI_API_INSTANCE_NAME"),this.azureOpenAIApiDeploymentName=(e==null?void 0:e.azureOpenAIApiDeploymentName)??J("AZURE_OPENAI_API_DEPLOYMENT_NAME"),this.azureOpenAIApiVersion=(e==null?void 0:e.azureOpenAIApiVersion)??J("AZURE_OPENAI_API_VERSION"),this.azureOpenAIBasePath=(e==null?void 0:e.azureOpenAIBasePath)??J("AZURE_OPENAI_BASE_PATH"),this.organization=((r=e==null?void 0:e.configuration)==null?void 0:r.organization)??J("OPENAI_ORGANIZATION"),this.modelName=(e==null?void 0:e.modelName)??this.modelName,this.modelKwargs=(e==null?void 0:e.modelKwargs)??{},this.timeout=e==null?void 0:e.timeout,this.temperature=(e==null?void 0:e.temperature)??this.temperature,this.topP=(e==null?void 0:e.topP)??this.topP,this.frequencyPenalty=(e==null?void 0:e.frequencyPenalty)??this.frequencyPenalty,this.presencePenalty=(e==null?void 0:e.presencePenalty)??this.presencePenalty,this.maxTokens=e==null?void 0:e.maxTokens,this.n=(e==null?void 0:e.n)??this.n,this.logitBias=e==null?void 0:e.logitBias,this.stop=e==null?void 0:e.stop,this.user=e==null?void 0:e.user,this.streaming=(e==null?void 0:e.streaming)??!1,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");this.openAIApiKey=this.openAIApiKey??""}this.clientConfig={apiKey:this.openAIApiKey,organization:this.organization,baseURL:(t==null?void 0:t.basePath)??((s=e==null?void 0:e.configuration)==null?void 0:s.basePath),dangerouslyAllowBrowser:!0,defaultHeaders:((i=t==null?void 0:t.baseOptions)==null?void 0:i.headers)??((o=(a=e==null?void 0:e.configuration)==null?void 0:a.baseOptions)==null?void 0:o.headers),defaultQuery:((c=t==null?void 0:t.baseOptions)==null?void 0:c.params)??((d=(l=e==null?void 0:e.configuration)==null?void 0:l.baseOptions)==null?void 0:d.params),...t,...e==null?void 0:e.configuration}}invocationParams(e){function t(s){return s!==void 0&&s.every(i=>Array.isArray(i.lc_namespace))}return{model:this.modelName,temperature:this.temperature,top_p:this.topP,frequency_penalty:this.frequencyPenalty,presence_penalty:this.presencePenalty,max_tokens:this.maxTokens===-1?void 0:this.maxTokens,n:this.n,logit_bias:this.logitBias,stop:(e==null?void 0:e.stop)??this.stop,user:this.user,stream:this.streaming,functions:e==null?void 0:e.functions,function_call:e==null?void 0:e.function_call,tools:t(e==null?void 0:e.tools)?e==null?void 0:e.tools.map(Cf):e==null?void 0:e.tools,tool_choice:e==null?void 0:e.tool_choice,response_format:e==null?void 0:e.response_format,seed:e==null?void 0:e.seed,...this.modelKwargs}}_identifyingParams(){return{model_name:this.modelName,...this.invocationParams(),...this.clientConfig}}async*_streamResponseChunks(e,t,r){var c;const s=so(e),i={...this.invocationParams(t),messages:s,stream:!0};let a;const o=await this.completionWithRetry(i,t);for await(const l of o){const d=l==null?void 0:l.choices[0];if(!d)continue;const{delta:f}=d;if(!f)continue;const m=$f(f,a);a=f.role??a;const b={prompt:t.promptIndex??0,completion:d.index??0};if(typeof m.content!="string"){console.log("[WARNING]: Received non-string content from OpenAI. This is currently not supported.");continue}const v=new Bi({message:m,text:m.content,generationInfo:b});yield v,r==null||r.handleLLMNewToken(v.text??"",b,void 0,void 0,void 0,{chunk:v})}if((c=t.signal)!=null&&c.aborted)throw new Error("AbortError")}identifyingParams(){return this._identifyingParams()}async _generate(e,t,r){var o,c;const s={},i=this.invocationParams(t),a=so(e);if(i.stream){const l=this._streamResponseChunks(e,t,r),d={};for await(const w of l){const P=((o=w.generationInfo)==null?void 0:o.completion)??0;d[P]===void 0?d[P]=w:d[P]=d[P].concat(w)}const f=Object.entries(d).sort(([w],[P])=>parseInt(w,10)-parseInt(P,10)).map(([w,P])=>P),{functions:m,function_call:b}=this.invocationParams(t),v=await this.getEstimatedTokenCountFromPrompt(e,m,b),T=await this.getNumTokensFromGenerations(f);return s.promptTokens=v,s.completionTokens=T,s.totalTokens=v+T,{generations:f,llmOutput:{estimatedTokenUsage:s}}}else{const l=await this.completionWithRetry({...i,stream:!1,messages:a},{signal:t==null?void 0:t.signal,...t==null?void 0:t.options}),{completion_tokens:d,prompt_tokens:f,total_tokens:m}=(l==null?void 0:l.usage)??{};d&&(s.completionTokens=(s.completionTokens??0)+d),f&&(s.promptTokens=(s.promptTokens??0)+f),m&&(s.totalTokens=(s.totalTokens??0)+m);const b=[];for(const v of(l==null?void 0:l.choices)??[]){const w={text:((c=v.message)==null?void 0:c.content)??"",message:jf(v.message??{role:"assistant"})};v.finish_reason&&(w.generationInfo={finish_reason:v.finish_reason}),b.push(w)}return{generations:b,llmOutput:{tokenUsage:s}}}}async getEstimatedTokenCountFromPrompt(e,t,r){let s=(await this.getNumTokensFromMessages(e)).totalCount;if(t&&r!=="auto"){const i=xf(t);s+=await this.getNumTokens(i),s+=9}return t&&e.find(i=>i._getType()==="system")&&(s-=4),r==="none"?s+=1:typeof r=="object"&&(s+=await this.getNumTokens(r.name)+4),s}async getNumTokensFromGenerations(e){return(await Promise.all(e.map(async r=>{var s;return(s=r.message.additional_kwargs)!=null&&s.function_call?(await this.getNumTokensFromMessages([r.message])).countPerMessage[0]:await this.getNumTokens(r.message.content)}))).reduce((r,s)=>r+s,0)}async getNumTokensFromMessages(e){let t=0,r=0,s=0;this.modelName==="gpt-3.5-turbo-0301"?(r=4,s=-1):(r=3,s=1);const i=await Promise.all(e.map(async a=>{var m,b,v,T,w;const o=await this.getNumTokens(a.content),c=await this.getNumTokens(xc(a)),l=a.name!==void 0?s+await this.getNumTokens(a.name):0;let d=o+r+c+l;const f=a;return f._getType()==="function"&&(d-=2),(m=f.additional_kwargs)!=null&&m.function_call&&(d+=3),(b=f==null?void 0:f.additional_kwargs.function_call)!=null&&b.name&&(d+=await this.getNumTokens((v=f.additional_kwargs.function_call)==null?void 0:v.name)),(T=f.additional_kwargs.function_call)!=null&&T.arguments&&(d+=await this.getNumTokens(JSON.stringify(JSON.parse((w=f.additional_kwargs.function_call)==null?void 0:w.arguments)))),t+=d,d}));return t+=3,{totalCount:t,countPerMessage:i}}async completionWithRetry(e,t){const r=this._getClientOptions(t);return this.caller.call(async()=>{try{return await this.client.chat.completions.create(e,r)}catch(s){throw Cc(s)}})}_getClientOptions(e){if(!this.client){const r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},s=_c(r),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new G(i)}const t={...this.clientConfig,...e};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),t}_llmType(){return"openai"}_combineLLMOutput(...e){return e.reduce((t,r)=>(r&&r.tokenUsage&&(t.tokenUsage.completionTokens+=r.tokenUsage.completionTokens??0,t.tokenUsage.promptTokens+=r.tokenUsage.promptTokens??0,t.tokenUsage.totalTokens+=r.tokenUsage.totalTokens??0),t),{tokenUsage:{completionTokens:0,promptTokens:0,totalTokens:0}})}}const Df=(n,e)=>n.reduce((t,r,s)=>{const i=Math.floor(s/e),a=t[i]||[];return t[i]=a.concat([r]),t},[]);class Lf{constructor(e){Object.defineProperty(this,"caller",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.caller=new ts(e??{})}}class Uf extends Lf{constructor(e,t){var l,d,f;const r={maxConcurrency:2,...e};super(r),Object.defineProperty(this,"modelName",{enumerable:!0,configurable:!0,writable:!0,value:"text-embedding-ada-002"}),Object.defineProperty(this,"batchSize",{enumerable:!0,configurable:!0,writable:!0,value:512}),Object.defineProperty(this,"stripNewLines",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"timeout",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiVersion",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiKey",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiInstanceName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIApiDeploymentName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"azureOpenAIBasePath",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"organization",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"clientConfig",{enumerable:!0,configurable:!0,writable:!0,value:void 0});let s=(r==null?void 0:r.openAIApiKey)??J("OPENAI_API_KEY");const i=(r==null?void 0:r.azureOpenAIApiKey)??J("AZURE_OPENAI_API_KEY");if(!i&&!s)throw new Error("OpenAI or Azure OpenAI API key not found");const a=(r==null?void 0:r.azureOpenAIApiInstanceName)??J("AZURE_OPENAI_API_INSTANCE_NAME"),o=((r==null?void 0:r.azureOpenAIApiEmbeddingsDeploymentName)||(r==null?void 0:r.azureOpenAIApiDeploymentName))??(J("AZURE_OPENAI_API_EMBEDDINGS_DEPLOYMENT_NAME")||J("AZURE_OPENAI_API_DEPLOYMENT_NAME")),c=(r==null?void 0:r.azureOpenAIApiVersion)??J("AZURE_OPENAI_API_VERSION");if(this.azureOpenAIBasePath=(r==null?void 0:r.azureOpenAIBasePath)??J("AZURE_OPENAI_BASE_PATH"),this.organization=((l=r==null?void 0:r.configuration)==null?void 0:l.organization)??J("OPENAI_ORGANIZATION"),this.modelName=(r==null?void 0:r.modelName)??this.modelName,this.batchSize=(r==null?void 0:r.batchSize)??(i?1:this.batchSize),this.stripNewLines=(r==null?void 0:r.stripNewLines)??this.stripNewLines,this.timeout=r==null?void 0:r.timeout,this.azureOpenAIApiVersion=c,this.azureOpenAIApiKey=i,this.azureOpenAIApiInstanceName=a,this.azureOpenAIApiDeploymentName=o,this.azureOpenAIApiKey){if(!this.azureOpenAIApiInstanceName&&!this.azureOpenAIBasePath)throw new Error("Azure OpenAI API instance name not found");if(!this.azureOpenAIApiDeploymentName)throw new Error("Azure OpenAI API deployment name not found");if(!this.azureOpenAIApiVersion)throw new Error("Azure OpenAI API version not found");s=s??""}this.clientConfig={apiKey:s,organization:this.organization,baseURL:t==null?void 0:t.basePath,dangerouslyAllowBrowser:!0,defaultHeaders:(d=t==null?void 0:t.baseOptions)==null?void 0:d.headers,defaultQuery:(f=t==null?void 0:t.baseOptions)==null?void 0:f.params,...t,...e==null?void 0:e.configuration}}async embedDocuments(e){const t=Df(this.stripNewLines?e.map(a=>a.replace(/\n/g," ")):e,this.batchSize),r=t.map(a=>this.embeddingWithRetry({model:this.modelName,input:a})),s=await Promise.all(r),i=[];for(let a=0;a<s.length;a+=1){const o=t[a],{data:c}=s[a];for(let l=0;l<o.length;l+=1)i.push(c[l].embedding)}return i}async embedQuery(e){const{data:t}=await this.embeddingWithRetry({model:this.modelName,input:this.stripNewLines?e.replace(/\n/g," "):e});return t[0].embedding}async embeddingWithRetry(e){if(!this.client){const r={azureOpenAIApiDeploymentName:this.azureOpenAIApiDeploymentName,azureOpenAIApiInstanceName:this.azureOpenAIApiInstanceName,azureOpenAIApiKey:this.azureOpenAIApiKey,azureOpenAIBasePath:this.azureOpenAIBasePath,baseURL:this.clientConfig.baseURL},s=_c(r),i={...this.clientConfig,baseURL:s,timeout:this.timeout,maxRetries:0};i.baseURL||delete i.baseURL,this.client=new G(i)}const t={};return this.azureOpenAIApiKey&&(t.headers={"api-key":this.azureOpenAIApiKey,...t.headers},t.query={"api-version":this.azureOpenAIApiVersion,...t.query}),this.caller.call(async()=>{try{return await this.client.embeddings.create(e,t)}catch(r){throw Cc(r)}})}}const Zf="modulepreload",Mf=function(n){return"/"+n},io={},qe=function(e,t,r){let s=Promise.resolve();if(t&&t.length>0){const i=document.getElementsByTagName("link");s=Promise.all(t.map(a=>{if(a=Mf(a),a in io)return;io[a]=!0;const o=a.endsWith(".css"),c=o?'[rel="stylesheet"]':"";if(!!r)for(let f=i.length-1;f>=0;f--){const m=i[f];if(m.href===a&&(!o||m.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${a}"]${c}`))return;const d=document.createElement("link");if(d.rel=o?"stylesheet":Zf,o||(d.as="script",d.crossOrigin=""),d.href=a,document.head.appendChild(d),o)return new Promise((f,m)=>{d.addEventListener("load",f),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${a}`)))})}))}return s.then(()=>e()).catch(i=>{const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=i,window.dispatchEvent(a),!a.defaultPrevented)throw i})};class Ff extends X{get lc_attributes(){return{partialVariables:void 0}}constructor(e){super(e),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","prompts",this._getPromptType()]}),Object.defineProperty(this,"inputVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"outputParser",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"partialVariables",{enumerable:!0,configurable:!0,writable:!0,value:void 0});const{inputVariables:t}=e;if(t.includes("stop"))throw new Error("Cannot have an input variable named 'stop', as it is used internally, please rename.");Object.assign(this,e)}async mergePartialAndUserVariables(e){const t=this.partialVariables??{},r={};for(const[i,a]of Object.entries(t))typeof a=="string"?r[i]=a:r[i]=await a();return{...r,...e}}async invoke(e,t){return this._callWithConfig(r=>this.formatPromptValue(r),e,{...t,runType:"prompt"})}serialize(){throw new Error("Use .toJSON() instead")}static async deserialize(e){switch(e._type){case"prompt":{const{PromptTemplate:t}=await qe(()=>Promise.resolve().then(()=>ao),void 0);return t.deserialize(e)}case void 0:{const{PromptTemplate:t}=await qe(()=>Promise.resolve().then(()=>ao),void 0);return t.deserialize({...e,_type:"prompt"})}case"few_shot":{const{FewShotPromptTemplate:t}=await qe(()=>import("./few_shot-7vlWKo0B.js"),__vite__mapDeps([]));return t.deserialize(e)}default:throw new Error(`Invalid prompt type in config: ${e._type}`)}}}class Bf extends Ff{async formatPromptValue(e){const t=await this.format(e);return new rc(t)}}const Rc=n=>{const e=n.split(""),t=[],r=(i,a)=>{for(let o=a;o<e.length;o+=1)if(i.includes(e[o]))return o;return-1};let s=0;for(;s<e.length;)if(e[s]==="{"&&s+1<e.length&&e[s+1]==="{")t.push({type:"literal",text:"{"}),s+=2;else if(e[s]==="}"&&s+1<e.length&&e[s+1]==="}")t.push({type:"literal",text:"}"}),s+=2;else if(e[s]==="{"){const i=r("}",s);if(i<0)throw new Error("Unclosed '{' in template.");t.push({type:"variable",name:e.slice(s+1,i).join("")}),s=i+1}else{if(e[s]==="}")throw new Error("Single '}' in template.");{const i=r("{}",s),a=(i<0?e.slice(s):e.slice(s,i)).join("");t.push({type:"literal",text:a}),s=i<0?e.length:i}}return t},Vf=(n,e)=>Rc(n).reduce((t,r)=>{if(r.type==="variable"){if(r.name in e)return t+e[r.name];throw new Error(`Missing value for input ${r.name}`)}return t+r.text},""),fi={"f-string":Vf},zf={"f-string":Rc},jc=(n,e,t)=>fi[e](n,t),qf=(n,e)=>zf[e](n),Kf=(n,e,t)=>{if(!(e in fi)){const r=Object.keys(fi);throw new Error(`Invalid template format. Got \`${e}\`;
                         should be one of ${r}`)}try{const r=t.reduce((s,i)=>(s[i]="foo",s),{});jc(n,e,r)}catch(r){throw new Error(`Invalid prompt schema: ${r.message}`)}};class it extends Bf{static lc_name(){return"PromptTemplate"}constructor(e){if(super(e),Object.defineProperty(this,"template",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"templateFormat",{enumerable:!0,configurable:!0,writable:!0,value:"f-string"}),Object.defineProperty(this,"validateTemplate",{enumerable:!0,configurable:!0,writable:!0,value:!0}),Object.assign(this,e),this.validateTemplate){let t=this.inputVariables;this.partialVariables&&(t=t.concat(Object.keys(this.partialVariables))),Kf(this.template,this.templateFormat,t)}}_getPromptType(){return"prompt"}async format(e){const t=await this.mergePartialAndUserVariables(e);return jc(this.template,this.templateFormat,t)}static fromExamples(e,t,r,s=`

`,i=""){const a=[i,...e,t].join(s);return new it({inputVariables:r,template:a})}static fromTemplate(e,{templateFormat:t="f-string",...r}={}){const s=new Set;return qf(e,t).forEach(i=>{i.type==="variable"&&s.add(i.name)}),new it({inputVariables:[...s],templateFormat:t,template:e,...r})}async partial(e){const t=this.inputVariables.filter(i=>!(i in e)),r={...this.partialVariables??{},...e},s={...this,inputVariables:t,partialVariables:r};return new it(s)}serialize(){if(this.outputParser!==void 0)throw new Error("Cannot serialize a prompt template with an output parser");return{_type:this._getPromptType(),input_variables:this.inputVariables,template:this.template,template_format:this.templateFormat}}static async deserialize(e){if(!e.template)throw new Error("Prompt template must have a template");return new it({inputVariables:e.input_variables,template:e.template,templateFormat:e.template_format})}}const ao=Object.freeze(Object.defineProperty({__proto__:null,PromptTemplate:it},Symbol.toStringTag,{value:"Module"}));class Fs{constructor(e){Object.defineProperty(this,"pageContent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.pageContent=e.pageContent?e.pageContent.toString():this.pageContent,this.metadata=e.metadata??{}}}class Hf extends X{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","runnables"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"RunnablePassthrough"}async invoke(e,t){return this._callWithConfig(r=>Promise.resolve(r),e,t)}transform(e,t){return this._transformStreamWithConfig(e,r=>r,t)}static assign(e){return new yc(new Wt({steps:e}))}}class Jf extends X{parseResultWithPrompt(e,t,r){return this.parseResult(e,r)}async invoke(e,t){return typeof e=="string"?this._callWithConfig(async r=>this.parseResult([{text:r}]),e,{...t,runType:"parser"}):this._callWithConfig(async r=>this.parseResult([{message:r,text:typeof r.content=="string"?r.content:JSON.stringify(r.content)}]),e,{...t,runType:"parser"})}}class Gf extends Jf{parseResult(e,t){return this.parse(e[0].text,t)}async parseWithPrompt(e,t,r){return this.parse(e,r)}_type(){throw new Error("_type not implemented")}}class Wf extends Gf{async*_transform(e){for await(const t of e)typeof t=="string"?yield this.parseResult([{text:t}]):yield this.parseResult([{message:t,text:typeof t.content=="string"?t.content:JSON.stringify(t.content)}])}async*transform(e,t){yield*this._transformStreamWithConfig(e,this._transform.bind(this),{...t,runType:"parser"})}}class $c extends Wf{constructor(){super(...arguments),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain_core","output_parsers","string"]}),Object.defineProperty(this,"lc_serializable",{enumerable:!0,configurable:!0,writable:!0,value:!0})}static lc_name(){return"StrOutputParser"}parse(e){return Promise.resolve(e)}getFormatInstructions(){return""}}class Yf extends X{constructor(e){super(e),Object.defineProperty(this,"callbacks",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tags",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metadata",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"verbose",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.callbacks=e==null?void 0:e.callbacks,this.tags=(e==null?void 0:e.tags)??[],this.metadata=(e==null?void 0:e.metadata)??{},this.verbose=(e==null?void 0:e.verbose)??!1}_getRelevantDocuments(e,t){throw new Error("Not implemented!")}async invoke(e,t){return this.getRelevantDocuments(e,t)}async getRelevantDocuments(e,t){const r=Th(t),s=await ue.configure(r.callbacks,this.callbacks,r.tags,this.tags,r.metadata,this.metadata,{verbose:this.verbose}),i=await(s==null?void 0:s.handleRetrieverStart(this.toJSON(),e,void 0,void 0,void 0,void 0,r.runName));try{const a=await this._getRelevantDocuments(e,i);return await(i==null?void 0:i.handleRetrieverEnd(a)),a}catch(a){throw await(i==null?void 0:i.handleRetrieverError(a)),a}}}class Bs extends Yf{static lc_name(){return"VectorStoreRetriever"}get lc_namespace(){return["langchain_core","vectorstores"]}_vectorstoreType(){return this.vectorStore._vectorstoreType()}constructor(e){super(e),Object.defineProperty(this,"vectorStore",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"k",{enumerable:!0,configurable:!0,writable:!0,value:4}),Object.defineProperty(this,"searchType",{enumerable:!0,configurable:!0,writable:!0,value:"similarity"}),Object.defineProperty(this,"searchKwargs",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.vectorStore=e.vectorStore,this.k=e.k??this.k,this.searchType=e.searchType??this.searchType,this.filter=e.filter,e.searchType==="mmr"&&(this.searchKwargs=e.searchKwargs)}async _getRelevantDocuments(e,t){if(this.searchType==="mmr"){if(typeof this.vectorStore.maxMarginalRelevanceSearch!="function")throw new Error(`The vector store backing this retriever, ${this._vectorstoreType()} does not support max marginal relevance search.`);return this.vectorStore.maxMarginalRelevanceSearch(e,{k:this.k,filter:this.filter,...this.searchKwargs},t==null?void 0:t.getChild("vectorstore"))}return this.vectorStore.similaritySearch(e,this.k,this.filter,t==null?void 0:t.getChild("vectorstore"))}async addDocuments(e,t){return this.vectorStore.addDocuments(e,t)}}class Xf extends ot{constructor(e,t){super(t),Object.defineProperty(this,"lc_namespace",{enumerable:!0,configurable:!0,writable:!0,value:["langchain","vectorstores",this._vectorstoreType()]}),Object.defineProperty(this,"embeddings",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.embeddings=e}async delete(e){throw new Error("Not implemented.")}async similaritySearch(e,t=4,r=void 0,s=void 0){return(await this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)).map(a=>a[0])}async similaritySearchWithScore(e,t=4,r=void 0,s=void 0){return this.similaritySearchVectorWithScore(await this.embeddings.embedQuery(e),t,r)}static fromTexts(e,t,r,s){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}static fromDocuments(e,t,r){throw new Error("the Langchain vectorstore implementation you are using forgot to override this, please report a bug")}asRetriever(e,t,r,s,i,a){if(typeof e=="number")return new Bs({vectorStore:this,k:e,filter:t,tags:[...s??[],this._vectorstoreType()],metadata:i,verbose:a,callbacks:r});{const o={vectorStore:this,k:e==null?void 0:e.k,filter:e==null?void 0:e.filter,tags:[...(e==null?void 0:e.tags)??[],this._vectorstoreType()],metadata:e==null?void 0:e.metadata,verbose:e==null?void 0:e.verbose,callbacks:e==null?void 0:e.callbacks,searchType:e==null?void 0:e.searchType};return(e==null?void 0:e.searchType)==="mmr"?new Bs({...o,searchKwargs:e.searchKwargs}):new Bs({...o})}}}function Qf(n,e){let t=0,r=0,s=0;for(let i=0;i<n.length;i++)t+=n[i]*e[i],r+=n[i]*n[i],s+=e[i]*e[i];return t/(Math.sqrt(r)*Math.sqrt(s))}function ep(n,e,t){if(n.length===0||n[0].length===0||e.length===0||e[0].length===0)return[[]];if(n[0].length!==e[0].length)throw new Error(`Number of columns in X and Y must be the same. X has shape ${[n.length,n[0].length]} and Y has shape ${[e.length,e[0].length]}.`);return n.map(r=>e.map(s=>t(r,s)).map(s=>Number.isNaN(s)?0:s))}function oo(n,e){return ep(n,e,Qf)}function tp(n,e,t=.5,r=4){if(Math.min(r,e.length)<=0)return[];const s=Array.isArray(n[0])?n:[n],i=oo(s,e)[0],a=rp(i).maxIndex,o=[e[a]],c=[a];for(;c.length<Math.min(r,e.length);){let l=-1/0,d=-1;const f=oo(e,o);i.forEach((m,b)=>{if(c.includes(b))return;const v=Math.max(...f[b]),T=t*m-(1-t)*v;T>l&&(l=T,d=b)}),o.push(e[d]),c.push(d)}return c}function rp(n){if(n.length===0)return{maxIndex:-1,maxValue:NaN};let e=n[0],t=0;for(let r=1;r<n.length;r+=1)n[r]>e&&(t=r,e=n[r]);return{maxIndex:t,maxValue:e}}class Xi extends Xf{_vectorstoreType(){return"supabase"}constructor(e,t){super(e,t),Object.defineProperty(this,"client",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"tableName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"queryName",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"filter",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"upsertBatchSize",{enumerable:!0,configurable:!0,writable:!0,value:500}),this.client=t.client,this.tableName=t.tableName||"documents",this.queryName=t.queryName||"match_documents",this.filter=t.filter,this.upsertBatchSize=t.upsertBatchSize??this.upsertBatchSize}async addDocuments(e,t){const r=e.map(({pageContent:s})=>s);return this.addVectors(await this.embeddings.embedDocuments(r),e,t)}async addVectors(e,t,r){const s=e.map((a,o)=>({content:t[o].pageContent,embedding:a,metadata:t[o].metadata}));let i=[];for(let a=0;a<s.length;a+=this.upsertBatchSize){const o=s.slice(a,a+this.upsertBatchSize).map((l,d)=>r!=null&&r.ids?{id:r.ids[a+d],...l}:l),c=await this.client.from(this.tableName).upsert(o).select();if(c.error)throw new Error(`Error inserting: ${c.error.message} ${c.status} ${c.statusText}`);c.data&&(i=i.concat(c.data.map(l=>l.id)))}return i}async delete(e){const{ids:t}=e;for(const r of t)await this.client.from(this.tableName).delete().eq("id",r)}async _searchSupabase(e,t,r){if(r&&this.filter)throw new Error("cannot provide both `filter` and `this.filter`");const s=r??this.filter??{},i={query_embedding:e};let a;if(typeof s=="function")a=d=>s(d).limit(t);else if(typeof s=="object")i.filter=s,i.match_count=t,a=d=>d;else throw new Error("invalid filter type");const o=this.client.rpc(this.queryName,i),{data:c,error:l}=await a(o);if(l)throw new Error(`Error searching for documents: ${l.code} ${l.message} ${l.details}`);return c}async similaritySearchVectorWithScore(e,t,r){return(await this._searchSupabase(e,t,r)).map(a=>[new Fs({metadata:a.metadata,pageContent:a.content}),a.similarity])}async maxMarginalRelevanceSearch(e,t){const r=await this.embeddings.embedQuery(e),s=await this._searchSupabase(r,t.fetchK??20,t.filter),i=s.map(o=>o.embedding);return tp(r,i,t.lambda,t.k).map(o=>new Fs({metadata:s[o].metadata,pageContent:s[o].content}))}static async fromTexts(e,t,r,s){const i=[];for(let a=0;a<e.length;a+=1){const o=Array.isArray(t)?t[a]:t,c=new Fs({pageContent:e[a],metadata:o});i.push(c)}return Xi.fromDocuments(i,r,s)}static async fromDocuments(e,t,r){const s=new this(t,r);return await s.addDocuments(e),s}static async fromExistingIndex(e,t){return new this(e,t)}}const np=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>qe(()=>Promise.resolve().then(()=>Wr),void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)};class Qi extends Error{constructor(e,t="FunctionsError",r){super(e),this.name=t,this.context=r}}class sp extends Qi{constructor(e){super("Failed to send a request to the Edge Function","FunctionsFetchError",e)}}class ip extends Qi{constructor(e){super("Relay Error invoking the Edge Function","FunctionsRelayError",e)}}class ap extends Qi{constructor(e){super("Edge Function returned a non-2xx status code","FunctionsHttpError",e)}}var op=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(r.next(d))}catch(f){a(f)}}function c(d){try{l(r.throw(d))}catch(f){a(f)}}function l(d){d.done?i(d.value):s(d.value).then(o,c)}l((r=r.apply(n,e||[])).next())})};class cp{constructor(e,{headers:t={},customFetch:r}={}){this.url=e,this.headers=t,this.fetch=np(r)}setAuth(e){this.headers.Authorization=`Bearer ${e}`}invoke(e,t={}){var r;return op(this,void 0,void 0,function*(){try{const{headers:s,method:i,body:a}=t;let o={},c;a&&(s&&!Object.prototype.hasOwnProperty.call(s,"Content-Type")||!s)&&(typeof Blob<"u"&&a instanceof Blob||a instanceof ArrayBuffer?(o["Content-Type"]="application/octet-stream",c=a):typeof a=="string"?(o["Content-Type"]="text/plain",c=a):typeof FormData<"u"&&a instanceof FormData?c=a:(o["Content-Type"]="application/json",c=JSON.stringify(a)));const l=yield this.fetch(`${this.url}/${e}`,{method:i||"POST",headers:Object.assign(Object.assign(Object.assign({},o),this.headers),s),body:c}).catch(b=>{throw new sp(b)}),d=l.headers.get("x-relay-error");if(d&&d==="true")throw new ip(l);if(!l.ok)throw new ap(l);let f=((r=l.headers.get("Content-Type"))!==null&&r!==void 0?r:"text/plain").split(";")[0].trim(),m;return f==="application/json"?m=yield l.json():f==="application/octet-stream"?m=yield l.blob():f==="multipart/form-data"?m=yield l.formData():m=yield l.text(),{data:m,error:null}}catch(s){return{data:null,error:s}}})}}var up=function(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("unable to locate global object")},Kt=up();const lp=Kt.fetch,ea=Kt.fetch.bind(Kt),Nc=Kt.Headers,dp=Kt.Request,hp=Kt.Response,Wr=Object.freeze(Object.defineProperty({__proto__:null,Headers:Nc,Request:dp,Response:hp,default:ea,fetch:lp},Symbol.toStringTag,{value:"Module"}));class fp{constructor(e){this.shouldThrowOnError=!1,this.method=e.method,this.url=e.url,this.headers=e.headers,this.schema=e.schema,this.body=e.body,this.shouldThrowOnError=e.shouldThrowOnError,this.signal=e.signal,this.isMaybeSingle=e.isMaybeSingle,e.fetch?this.fetch=e.fetch:typeof fetch>"u"?this.fetch=ea:this.fetch=fetch}throwOnError(){return this.shouldThrowOnError=!0,this}then(e,t){this.schema===void 0||(["GET","HEAD"].includes(this.method)?this.headers["Accept-Profile"]=this.schema:this.headers["Content-Profile"]=this.schema),this.method!=="GET"&&this.method!=="HEAD"&&(this.headers["Content-Type"]="application/json");const r=this.fetch;let s=r(this.url.toString(),{method:this.method,headers:this.headers,body:JSON.stringify(this.body),signal:this.signal}).then(async i=>{var a,o,c;let l=null,d=null,f=null,m=i.status,b=i.statusText;if(i.ok){if(this.method!=="HEAD"){const P=await i.text();P===""||(this.headers.Accept==="text/csv"||this.headers.Accept&&this.headers.Accept.includes("application/vnd.pgrst.plan+text")?d=P:d=JSON.parse(P))}const T=(a=this.headers.Prefer)===null||a===void 0?void 0:a.match(/count=(exact|planned|estimated)/),w=(o=i.headers.get("content-range"))===null||o===void 0?void 0:o.split("/");T&&w&&w.length>1&&(f=parseInt(w[1])),this.isMaybeSingle&&this.method==="GET"&&Array.isArray(d)&&(d.length>1?(l={code:"PGRST116",details:`Results contain ${d.length} rows, application/vnd.pgrst.object+json requires 1 row`,hint:null,message:"JSON object requested, multiple (or no) rows returned"},d=null,f=null,m=406,b="Not Acceptable"):d.length===1?d=d[0]:d=null)}else{const T=await i.text();try{l=JSON.parse(T),Array.isArray(l)&&i.status===404&&(d=[],l=null,m=200,b="OK")}catch{i.status===404&&T===""?(m=204,b="No Content"):l={message:T}}if(l&&this.isMaybeSingle&&(!((c=l==null?void 0:l.details)===null||c===void 0)&&c.includes("0 rows"))&&(l=null,m=200,b="OK"),l&&this.shouldThrowOnError)throw l}return{error:l,data:d,count:f,status:m,statusText:b}});return this.shouldThrowOnError||(s=s.catch(i=>{var a,o,c;return{error:{message:`${(a=i==null?void 0:i.name)!==null&&a!==void 0?a:"FetchError"}: ${i==null?void 0:i.message}`,details:`${(o=i==null?void 0:i.stack)!==null&&o!==void 0?o:""}`,hint:"",code:`${(c=i==null?void 0:i.code)!==null&&c!==void 0?c:""}`},data:null,count:null,status:0,statusText:""}})),s.then(e,t)}}class pp extends fp{select(e){let t=!1;const r=(e??"*").split("").map(s=>/\s/.test(s)&&!t?"":(s==='"'&&(t=!t),s)).join("");return this.url.searchParams.set("select",r),this.headers.Prefer&&(this.headers.Prefer+=","),this.headers.Prefer+="return=representation",this}order(e,{ascending:t=!0,nullsFirst:r,foreignTable:s,referencedTable:i=s}={}){const a=i?`${i}.order`:"order",o=this.url.searchParams.get(a);return this.url.searchParams.set(a,`${o?`${o},`:""}${e}.${t?"asc":"desc"}${r===void 0?"":r?".nullsfirst":".nullslast"}`),this}limit(e,{foreignTable:t,referencedTable:r=t}={}){const s=typeof r>"u"?"limit":`${r}.limit`;return this.url.searchParams.set(s,`${e}`),this}range(e,t,{foreignTable:r,referencedTable:s=r}={}){const i=typeof s>"u"?"offset":`${s}.offset`,a=typeof s>"u"?"limit":`${s}.limit`;return this.url.searchParams.set(i,`${e}`),this.url.searchParams.set(a,`${t-e+1}`),this}abortSignal(e){return this.signal=e,this}single(){return this.headers.Accept="application/vnd.pgrst.object+json",this}maybeSingle(){return this.method==="GET"?this.headers.Accept="application/json":this.headers.Accept="application/vnd.pgrst.object+json",this.isMaybeSingle=!0,this}csv(){return this.headers.Accept="text/csv",this}geojson(){return this.headers.Accept="application/geo+json",this}explain({analyze:e=!1,verbose:t=!1,settings:r=!1,buffers:s=!1,wal:i=!1,format:a="text"}={}){var o;const c=[e?"analyze":null,t?"verbose":null,r?"settings":null,s?"buffers":null,i?"wal":null].filter(Boolean).join("|"),l=(o=this.headers.Accept)!==null&&o!==void 0?o:"application/json";return this.headers.Accept=`application/vnd.pgrst.plan+${a}; for="${l}"; options=${c};`,a==="json"?this:this}rollback(){var e;return((e=this.headers.Prefer)!==null&&e!==void 0?e:"").trim().length>0?this.headers.Prefer+=",tx=rollback":this.headers.Prefer="tx=rollback",this}returns(){return this}}class Dt extends pp{eq(e,t){return this.url.searchParams.append(e,`eq.${t}`),this}neq(e,t){return this.url.searchParams.append(e,`neq.${t}`),this}gt(e,t){return this.url.searchParams.append(e,`gt.${t}`),this}gte(e,t){return this.url.searchParams.append(e,`gte.${t}`),this}lt(e,t){return this.url.searchParams.append(e,`lt.${t}`),this}lte(e,t){return this.url.searchParams.append(e,`lte.${t}`),this}like(e,t){return this.url.searchParams.append(e,`like.${t}`),this}likeAllOf(e,t){return this.url.searchParams.append(e,`like(all).{${t.join(",")}}`),this}likeAnyOf(e,t){return this.url.searchParams.append(e,`like(any).{${t.join(",")}}`),this}ilike(e,t){return this.url.searchParams.append(e,`ilike.${t}`),this}ilikeAllOf(e,t){return this.url.searchParams.append(e,`ilike(all).{${t.join(",")}}`),this}ilikeAnyOf(e,t){return this.url.searchParams.append(e,`ilike(any).{${t.join(",")}}`),this}is(e,t){return this.url.searchParams.append(e,`is.${t}`),this}in(e,t){const r=t.map(s=>typeof s=="string"&&new RegExp("[,()]").test(s)?`"${s}"`:`${s}`).join(",");return this.url.searchParams.append(e,`in.(${r})`),this}contains(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cs.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cs.{${t.join(",")}}`):this.url.searchParams.append(e,`cs.${JSON.stringify(t)}`),this}containedBy(e,t){return typeof t=="string"?this.url.searchParams.append(e,`cd.${t}`):Array.isArray(t)?this.url.searchParams.append(e,`cd.{${t.join(",")}}`):this.url.searchParams.append(e,`cd.${JSON.stringify(t)}`),this}rangeGt(e,t){return this.url.searchParams.append(e,`sr.${t}`),this}rangeGte(e,t){return this.url.searchParams.append(e,`nxl.${t}`),this}rangeLt(e,t){return this.url.searchParams.append(e,`sl.${t}`),this}rangeLte(e,t){return this.url.searchParams.append(e,`nxr.${t}`),this}rangeAdjacent(e,t){return this.url.searchParams.append(e,`adj.${t}`),this}overlaps(e,t){return typeof t=="string"?this.url.searchParams.append(e,`ov.${t}`):this.url.searchParams.append(e,`ov.{${t.join(",")}}`),this}textSearch(e,t,{config:r,type:s}={}){let i="";s==="plain"?i="pl":s==="phrase"?i="ph":s==="websearch"&&(i="w");const a=r===void 0?"":`(${r})`;return this.url.searchParams.append(e,`${i}fts${a}.${t}`),this}match(e){return Object.entries(e).forEach(([t,r])=>{this.url.searchParams.append(t,`eq.${r}`)}),this}not(e,t,r){return this.url.searchParams.append(e,`not.${t}.${r}`),this}or(e,{foreignTable:t,referencedTable:r=t}={}){const s=r?`${r}.or`:"or";return this.url.searchParams.append(s,`(${e})`),this}filter(e,t,r){return this.url.searchParams.append(e,`${t}.${r}`),this}}class mp{constructor(e,{headers:t={},schema:r,fetch:s}){this.url=e,this.headers=t,this.schema=r,this.fetch=s}select(e,{head:t=!1,count:r}={}){const s=t?"HEAD":"GET";let i=!1;const a=(e??"*").split("").map(o=>/\s/.test(o)&&!i?"":(o==='"'&&(i=!i),o)).join("");return this.url.searchParams.set("select",a),r&&(this.headers.Prefer=`count=${r}`),new Dt({method:s,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}insert(e,{count:t,defaultToNull:r=!0}={}){const s="POST",i=[];if(this.headers.Prefer&&i.push(this.headers.Prefer),t&&i.push(`count=${t}`),r||i.push("missing=default"),this.headers.Prefer=i.join(","),Array.isArray(e)){const a=e.reduce((o,c)=>o.concat(Object.keys(c)),[]);if(a.length>0){const o=[...new Set(a)].map(c=>`"${c}"`);this.url.searchParams.set("columns",o.join(","))}}return new Dt({method:s,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}upsert(e,{onConflict:t,ignoreDuplicates:r=!1,count:s,defaultToNull:i=!0}={}){const a="POST",o=[`resolution=${r?"ignore":"merge"}-duplicates`];if(t!==void 0&&this.url.searchParams.set("on_conflict",t),this.headers.Prefer&&o.push(this.headers.Prefer),s&&o.push(`count=${s}`),i||o.push("missing=default"),this.headers.Prefer=o.join(","),Array.isArray(e)){const c=e.reduce((l,d)=>l.concat(Object.keys(d)),[]);if(c.length>0){const l=[...new Set(c)].map(d=>`"${d}"`);this.url.searchParams.set("columns",l.join(","))}}return new Dt({method:a,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}update(e,{count:t}={}){const r="PATCH",s=[];return this.headers.Prefer&&s.push(this.headers.Prefer),t&&s.push(`count=${t}`),this.headers.Prefer=s.join(","),new Dt({method:r,url:this.url,headers:this.headers,schema:this.schema,body:e,fetch:this.fetch,allowEmpty:!1})}delete({count:e}={}){const t="DELETE",r=[];return e&&r.push(`count=${e}`),this.headers.Prefer&&r.unshift(this.headers.Prefer),this.headers.Prefer=r.join(","),new Dt({method:t,url:this.url,headers:this.headers,schema:this.schema,fetch:this.fetch,allowEmpty:!1})}}const gp="1.9.1",yp={"X-Client-Info":`postgrest-js/${gp}`};class ta{constructor(e,{headers:t={},schema:r,fetch:s}={}){this.url=e,this.headers=Object.assign(Object.assign({},yp),t),this.schemaName=r,this.fetch=s}from(e){const t=new URL(`${this.url}/${e}`);return new mp(t,{headers:Object.assign({},this.headers),schema:this.schemaName,fetch:this.fetch})}schema(e){return new ta(this.url,{headers:this.headers,schema:e,fetch:this.fetch})}rpc(e,t={},{head:r=!1,count:s}={}){let i;const a=new URL(`${this.url}/rpc/${e}`);let o;r?(i="HEAD",Object.entries(t).forEach(([l,d])=>{a.searchParams.append(l,`${d}`)})):(i="POST",o=t);const c=Object.assign({},this.headers);return s&&(c.Prefer=`count=${s}`),new Dt({method:i,url:a,headers:c,schema:this.schemaName,body:o,fetch:this.fetch,allowEmpty:!1})}}const _p="2.9.1",bp={"X-Client-Info":`realtime-js/${_p}`},vp="1.0.0",Dc=1e4,wp=1e3;var zt;(function(n){n[n.connecting=0]="connecting",n[n.open=1]="open",n[n.closing=2]="closing",n[n.closed=3]="closed"})(zt||(zt={}));var pe;(function(n){n.closed="closed",n.errored="errored",n.joined="joined",n.joining="joining",n.leaving="leaving"})(pe||(pe={}));var Ie;(function(n){n.close="phx_close",n.error="phx_error",n.join="phx_join",n.reply="phx_reply",n.leave="phx_leave",n.access_token="access_token"})(Ie||(Ie={}));var pi;(function(n){n.websocket="websocket"})(pi||(pi={}));var bt;(function(n){n.Connecting="connecting",n.Open="open",n.Closing="closing",n.Closed="closed"})(bt||(bt={}));class Lc{constructor(e,t){this.callback=e,this.timerCalc=t,this.timer=void 0,this.tries=0,this.callback=e,this.timerCalc=t}reset(){this.tries=0,clearTimeout(this.timer)}scheduleTimeout(){clearTimeout(this.timer),this.timer=setTimeout(()=>{this.tries=this.tries+1,this.callback()},this.timerCalc(this.tries+1))}}class Tp{constructor(){this.HEADER_LENGTH=1}decode(e,t){return e.constructor===ArrayBuffer?t(this._binaryDecode(e)):t(typeof e=="string"?JSON.parse(e):{})}_binaryDecode(e){const t=new DataView(e),r=new TextDecoder;return this._decodeBroadcast(e,t,r)}_decodeBroadcast(e,t,r){const s=t.getUint8(1),i=t.getUint8(2);let a=this.HEADER_LENGTH+2;const o=r.decode(e.slice(a,a+s));a=a+s;const c=r.decode(e.slice(a,a+i));a=a+i;const l=JSON.parse(r.decode(e.slice(a,e.byteLength)));return{ref:null,topic:o,event:c,payload:l}}}class Vs{constructor(e,t,r={},s=Dc){this.channel=e,this.event=t,this.payload=r,this.timeout=s,this.sent=!1,this.timeoutTimer=void 0,this.ref="",this.receivedResp=null,this.recHooks=[],this.refEvent=null}resend(e){this.timeout=e,this._cancelRefEvent(),this.ref="",this.refEvent=null,this.receivedResp=null,this.sent=!1,this.send()}send(){this._hasReceived("timeout")||(this.startTimeout(),this.sent=!0,this.channel.socket.push({topic:this.channel.topic,event:this.event,payload:this.payload,ref:this.ref,join_ref:this.channel._joinRef()}))}updatePayload(e){this.payload=Object.assign(Object.assign({},this.payload),e)}receive(e,t){var r;return this._hasReceived(e)&&t((r=this.receivedResp)===null||r===void 0?void 0:r.response),this.recHooks.push({status:e,callback:t}),this}startTimeout(){if(this.timeoutTimer)return;this.ref=this.channel.socket._makeRef(),this.refEvent=this.channel._replyEventName(this.ref);const e=t=>{this._cancelRefEvent(),this._cancelTimeout(),this.receivedResp=t,this._matchReceive(t)};this.channel._on(this.refEvent,{},e),this.timeoutTimer=setTimeout(()=>{this.trigger("timeout",{})},this.timeout)}trigger(e,t){this.refEvent&&this.channel._trigger(this.refEvent,{status:e,response:t})}destroy(){this._cancelRefEvent(),this._cancelTimeout()}_cancelRefEvent(){this.refEvent&&this.channel._off(this.refEvent,{})}_cancelTimeout(){clearTimeout(this.timeoutTimer),this.timeoutTimer=void 0}_matchReceive({status:e,response:t}){this.recHooks.filter(r=>r.status===e).forEach(r=>r.callback(t))}_hasReceived(e){return this.receivedResp&&this.receivedResp.status===e}}var co;(function(n){n.SYNC="sync",n.JOIN="join",n.LEAVE="leave"})(co||(co={}));class $r{constructor(e,t){this.channel=e,this.state={},this.pendingDiffs=[],this.joinRef=null,this.caller={onJoin:()=>{},onLeave:()=>{},onSync:()=>{}};const r=(t==null?void 0:t.events)||{state:"presence_state",diff:"presence_diff"};this.channel._on(r.state,{},s=>{const{onJoin:i,onLeave:a,onSync:o}=this.caller;this.joinRef=this.channel._joinRef(),this.state=$r.syncState(this.state,s,i,a),this.pendingDiffs.forEach(c=>{this.state=$r.syncDiff(this.state,c,i,a)}),this.pendingDiffs=[],o()}),this.channel._on(r.diff,{},s=>{const{onJoin:i,onLeave:a,onSync:o}=this.caller;this.inPendingSyncState()?this.pendingDiffs.push(s):(this.state=$r.syncDiff(this.state,s,i,a),o())}),this.onJoin((s,i,a)=>{this.channel._trigger("presence",{event:"join",key:s,currentPresences:i,newPresences:a})}),this.onLeave((s,i,a)=>{this.channel._trigger("presence",{event:"leave",key:s,currentPresences:i,leftPresences:a})}),this.onSync(()=>{this.channel._trigger("presence",{event:"sync"})})}static syncState(e,t,r,s){const i=this.cloneDeep(e),a=this.transformState(t),o={},c={};return this.map(i,(l,d)=>{a[l]||(c[l]=d)}),this.map(a,(l,d)=>{const f=i[l];if(f){const m=d.map(w=>w.presence_ref),b=f.map(w=>w.presence_ref),v=d.filter(w=>b.indexOf(w.presence_ref)<0),T=f.filter(w=>m.indexOf(w.presence_ref)<0);v.length>0&&(o[l]=v),T.length>0&&(c[l]=T)}else o[l]=d}),this.syncDiff(i,{joins:o,leaves:c},r,s)}static syncDiff(e,t,r,s){const{joins:i,leaves:a}={joins:this.transformState(t.joins),leaves:this.transformState(t.leaves)};return r||(r=()=>{}),s||(s=()=>{}),this.map(i,(o,c)=>{var l;const d=(l=e[o])!==null&&l!==void 0?l:[];if(e[o]=this.cloneDeep(c),d.length>0){const f=e[o].map(b=>b.presence_ref),m=d.filter(b=>f.indexOf(b.presence_ref)<0);e[o].unshift(...m)}r(o,d,c)}),this.map(a,(o,c)=>{let l=e[o];if(!l)return;const d=c.map(f=>f.presence_ref);l=l.filter(f=>d.indexOf(f.presence_ref)<0),e[o]=l,s(o,l,c),l.length===0&&delete e[o]}),e}static map(e,t){return Object.getOwnPropertyNames(e).map(r=>t(r,e[r]))}static transformState(e){return e=this.cloneDeep(e),Object.getOwnPropertyNames(e).reduce((t,r)=>{const s=e[r];return"metas"in s?t[r]=s.metas.map(i=>(i.presence_ref=i.phx_ref,delete i.phx_ref,delete i.phx_ref_prev,i)):t[r]=s,t},{})}static cloneDeep(e){return JSON.parse(JSON.stringify(e))}onJoin(e){this.caller.onJoin=e}onLeave(e){this.caller.onLeave=e}onSync(e){this.caller.onSync=e}inPendingSyncState(){return!this.joinRef||this.joinRef!==this.channel._joinRef()}}var V;(function(n){n.abstime="abstime",n.bool="bool",n.date="date",n.daterange="daterange",n.float4="float4",n.float8="float8",n.int2="int2",n.int4="int4",n.int4range="int4range",n.int8="int8",n.int8range="int8range",n.json="json",n.jsonb="jsonb",n.money="money",n.numeric="numeric",n.oid="oid",n.reltime="reltime",n.text="text",n.time="time",n.timestamp="timestamp",n.timestamptz="timestamptz",n.timetz="timetz",n.tsrange="tsrange",n.tstzrange="tstzrange"})(V||(V={}));const uo=(n,e,t={})=>{var r;const s=(r=t.skipTypes)!==null&&r!==void 0?r:[];return Object.keys(e).reduce((i,a)=>(i[a]=Ep(a,n,e,s),i),{})},Ep=(n,e,t,r)=>{const s=e.find(o=>o.name===n),i=s==null?void 0:s.type,a=t[n];return i&&!r.includes(i)?Uc(i,a):mi(a)},Uc=(n,e)=>{if(n.charAt(0)==="_"){const t=n.slice(1,n.length);return Ip(e,t)}switch(n){case V.bool:return Op(e);case V.float4:case V.float8:case V.int2:case V.int4:case V.int8:case V.numeric:case V.oid:return Pp(e);case V.json:case V.jsonb:return Ap(e);case V.timestamp:return kp(e);case V.abstime:case V.date:case V.daterange:case V.int4range:case V.int8range:case V.money:case V.reltime:case V.text:case V.time:case V.timestamptz:case V.timetz:case V.tsrange:case V.tstzrange:return mi(e);default:return mi(e)}},mi=n=>n,Op=n=>{switch(n){case"t":return!0;case"f":return!1;default:return n}},Pp=n=>{if(typeof n=="string"){const e=parseFloat(n);if(!Number.isNaN(e))return e}return n},Ap=n=>{if(typeof n=="string")try{return JSON.parse(n)}catch(e){return console.log(`JSON parse error: ${e}`),n}return n},Ip=(n,e)=>{if(typeof n!="string")return n;const t=n.length-1,r=n[t];if(n[0]==="{"&&r==="}"){let i;const a=n.slice(1,t);try{i=JSON.parse("["+a+"]")}catch{i=a?a.split(","):[]}return i.map(o=>Uc(e,o))}return n},kp=n=>typeof n=="string"?n.replace(" ","T"):n;var lo;(function(n){n.ALL="*",n.INSERT="INSERT",n.UPDATE="UPDATE",n.DELETE="DELETE"})(lo||(lo={}));var ho;(function(n){n.BROADCAST="broadcast",n.PRESENCE="presence",n.POSTGRES_CHANGES="postgres_changes"})(ho||(ho={}));var fo;(function(n){n.SUBSCRIBED="SUBSCRIBED",n.TIMED_OUT="TIMED_OUT",n.CLOSED="CLOSED",n.CHANNEL_ERROR="CHANNEL_ERROR"})(fo||(fo={}));class ra{constructor(e,t={config:{}},r){this.topic=e,this.params=t,this.socket=r,this.bindings={},this.state=pe.closed,this.joinedOnce=!1,this.pushBuffer=[],this.subTopic=e.replace(/^realtime:/i,""),this.params.config=Object.assign({broadcast:{ack:!1,self:!1},presence:{key:""}},t.config),this.timeout=this.socket.timeout,this.joinPush=new Vs(this,Ie.join,this.params,this.timeout),this.rejoinTimer=new Lc(()=>this._rejoinUntilConnected(),this.socket.reconnectAfterMs),this.joinPush.receive("ok",()=>{this.state=pe.joined,this.rejoinTimer.reset(),this.pushBuffer.forEach(s=>s.send()),this.pushBuffer=[]}),this._onClose(()=>{this.rejoinTimer.reset(),this.socket.log("channel",`close ${this.topic} ${this._joinRef()}`),this.state=pe.closed,this.socket._remove(this)}),this._onError(s=>{this._isLeaving()||this._isClosed()||(this.socket.log("channel",`error ${this.topic}`,s),this.state=pe.errored,this.rejoinTimer.scheduleTimeout())}),this.joinPush.receive("timeout",()=>{this._isJoining()&&(this.socket.log("channel",`timeout ${this.topic}`,this.joinPush.timeout),this.state=pe.errored,this.rejoinTimer.scheduleTimeout())}),this._on(Ie.reply,{},(s,i)=>{this._trigger(this._replyEventName(i),s)}),this.presence=new $r(this),this.broadcastEndpointURL=this._broadcastEndpointURL()}subscribe(e,t=this.timeout){var r,s;if(this.socket.isConnected()||this.socket.connect(),this.joinedOnce)throw"tried to subscribe multiple times. 'subscribe' can only be called a single time per channel instance";{const{config:{broadcast:i,presence:a}}=this.params;this._onError(l=>e&&e("CHANNEL_ERROR",l)),this._onClose(()=>e&&e("CLOSED"));const o={},c={broadcast:i,presence:a,postgres_changes:(s=(r=this.bindings.postgres_changes)===null||r===void 0?void 0:r.map(l=>l.filter))!==null&&s!==void 0?s:[]};this.socket.accessToken&&(o.access_token=this.socket.accessToken),this.updateJoinPayload(Object.assign({config:c},o)),this.joinedOnce=!0,this._rejoin(t),this.joinPush.receive("ok",({postgres_changes:l})=>{var d;if(this.socket.accessToken&&this.socket.setAuth(this.socket.accessToken),l===void 0){e&&e("SUBSCRIBED");return}else{const f=this.bindings.postgres_changes,m=(d=f==null?void 0:f.length)!==null&&d!==void 0?d:0,b=[];for(let v=0;v<m;v++){const T=f[v],{filter:{event:w,schema:P,table:k,filter:I}}=T,Z=l&&l[v];if(Z&&Z.event===w&&Z.schema===P&&Z.table===k&&Z.filter===I)b.push(Object.assign(Object.assign({},T),{id:Z.id}));else{this.unsubscribe(),e&&e("CHANNEL_ERROR",new Error("mismatch between server and client bindings for postgres changes"));return}}this.bindings.postgres_changes=b,e&&e("SUBSCRIBED");return}}).receive("error",l=>{e&&e("CHANNEL_ERROR",new Error(JSON.stringify(Object.values(l).join(", ")||"error")))}).receive("timeout",()=>{e&&e("TIMED_OUT")})}return this}presenceState(){return this.presence.state}async track(e,t={}){return await this.send({type:"presence",event:"track",payload:e},t.timeout||this.timeout)}async untrack(e={}){return await this.send({type:"presence",event:"untrack"},e)}on(e,t,r){return this._on(e,t,r)}async send(e,t={}){var r,s;if(!this._canPush()&&e.type==="broadcast"){const{event:i,payload:a}=e,o={method:"POST",headers:{apikey:(r=this.socket.accessToken)!==null&&r!==void 0?r:"","Content-Type":"application/json"},body:JSON.stringify({messages:[{topic:this.subTopic,event:i,payload:a}]})};try{return(await this._fetchWithTimeout(this.broadcastEndpointURL,o,(s=t.timeout)!==null&&s!==void 0?s:this.timeout)).ok?"ok":"error"}catch(c){return c.name==="AbortError"?"timed out":"error"}}else return new Promise(i=>{var a,o,c;const l=this._push(e.type,e,t.timeout||this.timeout);e.type==="broadcast"&&!(!((c=(o=(a=this.params)===null||a===void 0?void 0:a.config)===null||o===void 0?void 0:o.broadcast)===null||c===void 0)&&c.ack)&&i("ok"),l.receive("ok",()=>i("ok")),l.receive("timeout",()=>i("timed out"))})}updateJoinPayload(e){this.joinPush.updatePayload(e)}unsubscribe(e=this.timeout){this.state=pe.leaving;const t=()=>{this.socket.log("channel",`leave ${this.topic}`),this._trigger(Ie.close,"leave",this._joinRef())};return this.rejoinTimer.reset(),this.joinPush.destroy(),new Promise(r=>{const s=new Vs(this,Ie.leave,{},e);s.receive("ok",()=>{t(),r("ok")}).receive("timeout",()=>{t(),r("timed out")}).receive("error",()=>{r("error")}),s.send(),this._canPush()||s.trigger("ok",{})})}_broadcastEndpointURL(){let e=this.socket.endPoint;return e=e.replace(/^ws/i,"http"),e=e.replace(/(\/socket\/websocket|\/socket|\/websocket)\/?$/i,""),e.replace(/\/+$/,"")+"/api/broadcast"}async _fetchWithTimeout(e,t,r){const s=new AbortController,i=setTimeout(()=>s.abort(),r),a=await this.socket.fetch(e,Object.assign(Object.assign({},t),{signal:s.signal}));return clearTimeout(i),a}_push(e,t,r=this.timeout){if(!this.joinedOnce)throw`tried to push '${e}' to '${this.topic}' before joining. Use channel.subscribe() before pushing events`;let s=new Vs(this,e,t,r);return this._canPush()?s.send():(s.startTimeout(),this.pushBuffer.push(s)),s}_onMessage(e,t,r){return t}_isMember(e){return this.topic===e}_joinRef(){return this.joinPush.ref}_trigger(e,t,r){var s,i;const a=e.toLocaleLowerCase(),{close:o,error:c,leave:l,join:d}=Ie;if(r&&[o,c,l,d].indexOf(a)>=0&&r!==this._joinRef())return;let m=this._onMessage(a,t,r);if(t&&!m)throw"channel onMessage callbacks must return the payload, modified or unmodified";["insert","update","delete"].includes(a)?(s=this.bindings.postgres_changes)===null||s===void 0||s.filter(b=>{var v,T,w;return((v=b.filter)===null||v===void 0?void 0:v.event)==="*"||((w=(T=b.filter)===null||T===void 0?void 0:T.event)===null||w===void 0?void 0:w.toLocaleLowerCase())===a}).map(b=>b.callback(m,r)):(i=this.bindings[a])===null||i===void 0||i.filter(b=>{var v,T,w,P,k,I;if(["broadcast","presence","postgres_changes"].includes(a))if("id"in b){const Z=b.id,D=(v=b.filter)===null||v===void 0?void 0:v.event;return Z&&((T=t.ids)===null||T===void 0?void 0:T.includes(Z))&&(D==="*"||(D==null?void 0:D.toLocaleLowerCase())===((w=t.data)===null||w===void 0?void 0:w.type.toLocaleLowerCase()))}else{const Z=(k=(P=b==null?void 0:b.filter)===null||P===void 0?void 0:P.event)===null||k===void 0?void 0:k.toLocaleLowerCase();return Z==="*"||Z===((I=t==null?void 0:t.event)===null||I===void 0?void 0:I.toLocaleLowerCase())}else return b.type.toLocaleLowerCase()===a}).map(b=>{if(typeof m=="object"&&"ids"in m){const v=m.data,{schema:T,table:w,commit_timestamp:P,type:k,errors:I}=v;m=Object.assign(Object.assign({},{schema:T,table:w,commit_timestamp:P,eventType:k,new:{},old:{},errors:I}),this._getPayloadRecords(v))}b.callback(m,r)})}_isClosed(){return this.state===pe.closed}_isJoined(){return this.state===pe.joined}_isJoining(){return this.state===pe.joining}_isLeaving(){return this.state===pe.leaving}_replyEventName(e){return`chan_reply_${e}`}_on(e,t,r){const s=e.toLocaleLowerCase(),i={type:s,filter:t,callback:r};return this.bindings[s]?this.bindings[s].push(i):this.bindings[s]=[i],this}_off(e,t){const r=e.toLocaleLowerCase();return this.bindings[r]=this.bindings[r].filter(s=>{var i;return!(((i=s.type)===null||i===void 0?void 0:i.toLocaleLowerCase())===r&&ra.isEqual(s.filter,t))}),this}static isEqual(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const r in e)if(e[r]!==t[r])return!1;return!0}_rejoinUntilConnected(){this.rejoinTimer.scheduleTimeout(),this.socket.isConnected()&&this._rejoin()}_onClose(e){this._on(Ie.close,{},e)}_onError(e){this._on(Ie.error,{},t=>e(t))}_canPush(){return this.socket.isConnected()&&this._isJoined()}_rejoin(e=this.timeout){this._isLeaving()||(this.socket._leaveOpenTopic(this.topic),this.state=pe.joining,this.joinPush.resend(e))}_getPayloadRecords(e){const t={new:{},old:{}};return(e.type==="INSERT"||e.type==="UPDATE")&&(t.new=uo(e.columns,e.record)),(e.type==="UPDATE"||e.type==="DELETE")&&(t.old=uo(e.columns,e.old_record)),t}}const Cp=()=>{},Sp=typeof WebSocket<"u";class xp{constructor(e,t){var r;this.accessToken=null,this.channels=[],this.endPoint="",this.headers=bp,this.params={},this.timeout=Dc,this.heartbeatIntervalMs=3e4,this.heartbeatTimer=void 0,this.pendingHeartbeatRef=null,this.ref=0,this.logger=Cp,this.conn=null,this.sendBuffer=[],this.serializer=new Tp,this.stateChangeCallbacks={open:[],close:[],error:[],message:[]},this._resolveFetch=i=>{let a;return i?a=i:typeof fetch>"u"?a=(...o)=>qe(()=>Promise.resolve().then(()=>Wr),void 0).then(({default:c})=>c(...o)):a=fetch,(...o)=>a(...o)},this.endPoint=`${e}/${pi.websocket}`,t!=null&&t.transport?this.transport=t.transport:this.transport=null,t!=null&&t.params&&(this.params=t.params),t!=null&&t.headers&&(this.headers=Object.assign(Object.assign({},this.headers),t.headers)),t!=null&&t.timeout&&(this.timeout=t.timeout),t!=null&&t.logger&&(this.logger=t.logger),t!=null&&t.heartbeatIntervalMs&&(this.heartbeatIntervalMs=t.heartbeatIntervalMs);const s=(r=t==null?void 0:t.params)===null||r===void 0?void 0:r.apikey;s&&(this.accessToken=s),this.reconnectAfterMs=t!=null&&t.reconnectAfterMs?t.reconnectAfterMs:i=>[1e3,2e3,5e3,1e4][i-1]||1e4,this.encode=t!=null&&t.encode?t.encode:(i,a)=>a(JSON.stringify(i)),this.decode=t!=null&&t.decode?t.decode:this.serializer.decode.bind(this.serializer),this.reconnectTimer=new Lc(async()=>{this.disconnect(),this.connect()},this.reconnectAfterMs),this.fetch=this._resolveFetch(t==null?void 0:t.fetch)}connect(){if(!this.conn){if(this.transport){this.conn=new this.transport(this._endPointURL(),void 0,{headers:this.headers});return}if(Sp){this.conn=new WebSocket(this._endPointURL()),this.setupConnection();return}this.conn=new Rp(this._endPointURL(),void 0,{close:()=>{this.conn=null}}),qe(()=>import("./browser-KAJO5fSx.js").then(e=>e.b),__vite__mapDeps([])).then(({default:e})=>{this.conn=new e(this._endPointURL(),void 0,{headers:this.headers}),this.setupConnection()})}}disconnect(e,t){this.conn&&(this.conn.onclose=function(){},e?this.conn.close(e,t??""):this.conn.close(),this.conn=null,this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.reset())}getChannels(){return this.channels}async removeChannel(e){const t=await e.unsubscribe();return this.channels.length===0&&this.disconnect(),t}async removeAllChannels(){const e=await Promise.all(this.channels.map(t=>t.unsubscribe()));return this.disconnect(),e}log(e,t,r){this.logger(e,t,r)}connectionState(){switch(this.conn&&this.conn.readyState){case zt.connecting:return bt.Connecting;case zt.open:return bt.Open;case zt.closing:return bt.Closing;default:return bt.Closed}}isConnected(){return this.connectionState()===bt.Open}channel(e,t={config:{}}){const r=new ra(`realtime:${e}`,t,this);return this.channels.push(r),r}push(e){const{topic:t,event:r,payload:s,ref:i}=e,a=()=>{this.encode(e,o=>{var c;(c=this.conn)===null||c===void 0||c.send(o)})};this.log("push",`${t} ${r} (${i})`,s),this.isConnected()?a():this.sendBuffer.push(a)}setAuth(e){this.accessToken=e,this.channels.forEach(t=>{e&&t.updateJoinPayload({access_token:e}),t.joinedOnce&&t._isJoined()&&t._push(Ie.access_token,{access_token:e})})}_makeRef(){let e=this.ref+1;return e===this.ref?this.ref=0:this.ref=e,this.ref.toString()}_leaveOpenTopic(e){let t=this.channels.find(r=>r.topic===e&&(r._isJoined()||r._isJoining()));t&&(this.log("transport",`leaving duplicate topic "${e}"`),t.unsubscribe())}_remove(e){this.channels=this.channels.filter(t=>t._joinRef()!==e._joinRef())}setupConnection(){this.conn&&(this.conn.binaryType="arraybuffer",this.conn.onopen=()=>this._onConnOpen(),this.conn.onerror=e=>this._onConnError(e),this.conn.onmessage=e=>this._onConnMessage(e),this.conn.onclose=e=>this._onConnClose(e))}_endPointURL(){return this._appendParams(this.endPoint,Object.assign({},this.params,{vsn:vp}))}_onConnMessage(e){this.decode(e.data,t=>{let{topic:r,event:s,payload:i,ref:a}=t;(a&&a===this.pendingHeartbeatRef||s===(i==null?void 0:i.type))&&(this.pendingHeartbeatRef=null),this.log("receive",`${i.status||""} ${r} ${s} ${a&&"("+a+")"||""}`,i),this.channels.filter(o=>o._isMember(r)).forEach(o=>o._trigger(s,i,a)),this.stateChangeCallbacks.message.forEach(o=>o(t))})}_onConnOpen(){this.log("transport",`connected to ${this._endPointURL()}`),this._flushSendBuffer(),this.reconnectTimer.reset(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval(()=>this._sendHeartbeat(),this.heartbeatIntervalMs),this.stateChangeCallbacks.open.forEach(e=>e())}_onConnClose(e){this.log("transport","close",e),this._triggerChanError(),this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.reconnectTimer.scheduleTimeout(),this.stateChangeCallbacks.close.forEach(t=>t(e))}_onConnError(e){this.log("transport",e.message),this._triggerChanError(),this.stateChangeCallbacks.error.forEach(t=>t(e))}_triggerChanError(){this.channels.forEach(e=>e._trigger(Ie.error))}_appendParams(e,t){if(Object.keys(t).length===0)return e;const r=e.match(/\?/)?"&":"?",s=new URLSearchParams(t);return`${e}${r}${s}`}_flushSendBuffer(){this.isConnected()&&this.sendBuffer.length>0&&(this.sendBuffer.forEach(e=>e()),this.sendBuffer=[])}_sendHeartbeat(){var e;if(this.isConnected()){if(this.pendingHeartbeatRef){this.pendingHeartbeatRef=null,this.log("transport","heartbeat timeout. Attempting to re-establish connection"),(e=this.conn)===null||e===void 0||e.close(wp,"hearbeat timeout");return}this.pendingHeartbeatRef=this._makeRef(),this.push({topic:"phoenix",event:"heartbeat",payload:{},ref:this.pendingHeartbeatRef}),this.setAuth(this.accessToken)}}}class Rp{constructor(e,t,r){this.binaryType="arraybuffer",this.onclose=()=>{},this.onerror=()=>{},this.onmessage=()=>{},this.onopen=()=>{},this.readyState=zt.connecting,this.send=()=>{},this.url=null,this.url=e,this.close=r.close}}class na extends Error{constructor(e){super(e),this.__isStorageError=!0,this.name="StorageError"}}function se(n){return typeof n=="object"&&n!==null&&"__isStorageError"in n}class jp extends na{constructor(e,t){super(e),this.name="StorageApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class po extends na{constructor(e,t){super(e),this.name="StorageUnknownError",this.originalError=t}}var $p=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(r.next(d))}catch(f){a(f)}}function c(d){try{l(r.throw(d))}catch(f){a(f)}}function l(d){d.done?i(d.value):s(d.value).then(o,c)}l((r=r.apply(n,e||[])).next())})};const Zc=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>qe(()=>Promise.resolve().then(()=>Wr),void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},Np=()=>$p(void 0,void 0,void 0,function*(){return typeof Response>"u"?(yield qe(()=>Promise.resolve().then(()=>Wr),void 0)).Response:Response});var Yt=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(r.next(d))}catch(f){a(f)}}function c(d){try{l(r.throw(d))}catch(f){a(f)}}function l(d){d.done?i(d.value):s(d.value).then(o,c)}l((r=r.apply(n,e||[])).next())})};const zs=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),Dp=(n,e)=>Yt(void 0,void 0,void 0,function*(){const t=yield Np();n instanceof t?n.json().then(r=>{e(new jp(zs(r),n.status||500))}).catch(r=>{e(new po(zs(r),r))}):e(new po(zs(n),n))}),Lp=(n,e,t,r)=>{const s={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json"},e==null?void 0:e.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};function ws(n,e,t,r,s,i){return Yt(this,void 0,void 0,function*(){return new Promise((a,o)=>{n(t,Lp(e,r,s,i)).then(c=>{if(!c.ok)throw c;return r!=null&&r.noResolveJson?c:c.json()}).then(c=>a(c)).catch(c=>Dp(c,o))})})}function gi(n,e,t,r){return Yt(this,void 0,void 0,function*(){return ws(n,"GET",e,t,r)})}function tt(n,e,t,r,s){return Yt(this,void 0,void 0,function*(){return ws(n,"POST",e,r,s,t)})}function Up(n,e,t,r,s){return Yt(this,void 0,void 0,function*(){return ws(n,"PUT",e,r,s,t)})}function Mc(n,e,t,r,s){return Yt(this,void 0,void 0,function*(){return ws(n,"DELETE",e,r,s,t)})}var ye=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(r.next(d))}catch(f){a(f)}}function c(d){try{l(r.throw(d))}catch(f){a(f)}}function l(d){d.done?i(d.value):s(d.value).then(o,c)}l((r=r.apply(n,e||[])).next())})};const Zp={limit:100,offset:0,sortBy:{column:"name",order:"asc"}},mo={cacheControl:"3600",contentType:"text/plain;charset=UTF-8",upsert:!1};class Mp{constructor(e,t={},r,s){this.url=e,this.headers=t,this.bucketId=r,this.fetch=Zc(s)}uploadOrUpdate(e,t,r,s){return ye(this,void 0,void 0,function*(){try{let i;const a=Object.assign(Object.assign({},mo),s),o=Object.assign(Object.assign({},this.headers),e==="POST"&&{"x-upsert":String(a.upsert)});typeof Blob<"u"&&r instanceof Blob?(i=new FormData,i.append("cacheControl",a.cacheControl),i.append("",r)):typeof FormData<"u"&&r instanceof FormData?(i=r,i.append("cacheControl",a.cacheControl)):(i=r,o["cache-control"]=`max-age=${a.cacheControl}`,o["content-type"]=a.contentType);const c=this._removeEmptyFolders(t),l=this._getFinalPath(c),d=yield this.fetch(`${this.url}/object/${l}`,Object.assign({method:e,body:i,headers:o},a!=null&&a.duplex?{duplex:a.duplex}:{})),f=yield d.json();return d.ok?{data:{path:c,id:f.Id,fullPath:f.Key},error:null}:{data:null,error:f}}catch(i){if(se(i))return{data:null,error:i};throw i}})}upload(e,t,r){return ye(this,void 0,void 0,function*(){return this.uploadOrUpdate("POST",e,t,r)})}uploadToSignedUrl(e,t,r,s){return ye(this,void 0,void 0,function*(){const i=this._removeEmptyFolders(e),a=this._getFinalPath(i),o=new URL(this.url+`/object/upload/sign/${a}`);o.searchParams.set("token",t);try{let c;const l=Object.assign({upsert:mo.upsert},s),d=Object.assign(Object.assign({},this.headers),{"x-upsert":String(l.upsert)});typeof Blob<"u"&&r instanceof Blob?(c=new FormData,c.append("cacheControl",l.cacheControl),c.append("",r)):typeof FormData<"u"&&r instanceof FormData?(c=r,c.append("cacheControl",l.cacheControl)):(c=r,d["cache-control"]=`max-age=${l.cacheControl}`,d["content-type"]=l.contentType);const f=yield this.fetch(o.toString(),{method:"PUT",body:c,headers:d}),m=yield f.json();return f.ok?{data:{path:i,fullPath:m.Key},error:null}:{data:null,error:m}}catch(c){if(se(c))return{data:null,error:c};throw c}})}createSignedUploadUrl(e){return ye(this,void 0,void 0,function*(){try{let t=this._getFinalPath(e);const r=yield tt(this.fetch,`${this.url}/object/upload/sign/${t}`,{},{headers:this.headers}),s=new URL(this.url+r.url),i=s.searchParams.get("token");if(!i)throw new na("No token returned by API");return{data:{signedUrl:s.toString(),path:e,token:i},error:null}}catch(t){if(se(t))return{data:null,error:t};throw t}})}update(e,t,r){return ye(this,void 0,void 0,function*(){return this.uploadOrUpdate("PUT",e,t,r)})}move(e,t){return ye(this,void 0,void 0,function*(){try{return{data:yield tt(this.fetch,`${this.url}/object/move`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers}),error:null}}catch(r){if(se(r))return{data:null,error:r};throw r}})}copy(e,t){return ye(this,void 0,void 0,function*(){try{return{data:{path:(yield tt(this.fetch,`${this.url}/object/copy`,{bucketId:this.bucketId,sourceKey:e,destinationKey:t},{headers:this.headers})).Key},error:null}}catch(r){if(se(r))return{data:null,error:r};throw r}})}createSignedUrl(e,t,r){return ye(this,void 0,void 0,function*(){try{let s=this._getFinalPath(e),i=yield tt(this.fetch,`${this.url}/object/sign/${s}`,Object.assign({expiresIn:t},r!=null&&r.transform?{transform:r.transform}:{}),{headers:this.headers});const a=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return i={signedUrl:encodeURI(`${this.url}${i.signedURL}${a}`)},{data:i,error:null}}catch(s){if(se(s))return{data:null,error:s};throw s}})}createSignedUrls(e,t,r){return ye(this,void 0,void 0,function*(){try{const s=yield tt(this.fetch,`${this.url}/object/sign/${this.bucketId}`,{expiresIn:t,paths:e},{headers:this.headers}),i=r!=null&&r.download?`&download=${r.download===!0?"":r.download}`:"";return{data:s.map(a=>Object.assign(Object.assign({},a),{signedUrl:a.signedURL?encodeURI(`${this.url}${a.signedURL}${i}`):null})),error:null}}catch(s){if(se(s))return{data:null,error:s};throw s}})}download(e,t){return ye(this,void 0,void 0,function*(){const s=typeof(t==null?void 0:t.transform)<"u"?"render/image/authenticated":"object",i=this.transformOptsToQueryString((t==null?void 0:t.transform)||{}),a=i?`?${i}`:"";try{const o=this._getFinalPath(e);return{data:yield(yield gi(this.fetch,`${this.url}/${s}/${o}${a}`,{headers:this.headers,noResolveJson:!0})).blob(),error:null}}catch(o){if(se(o))return{data:null,error:o};throw o}})}getPublicUrl(e,t){const r=this._getFinalPath(e),s=[],i=t!=null&&t.download?`download=${t.download===!0?"":t.download}`:"";i!==""&&s.push(i);const o=typeof(t==null?void 0:t.transform)<"u"?"render/image":"object",c=this.transformOptsToQueryString((t==null?void 0:t.transform)||{});c!==""&&s.push(c);let l=s.join("&");return l!==""&&(l=`?${l}`),{data:{publicUrl:encodeURI(`${this.url}/${o}/public/${r}${l}`)}}}remove(e){return ye(this,void 0,void 0,function*(){try{return{data:yield Mc(this.fetch,`${this.url}/object/${this.bucketId}`,{prefixes:e},{headers:this.headers}),error:null}}catch(t){if(se(t))return{data:null,error:t};throw t}})}list(e,t,r){return ye(this,void 0,void 0,function*(){try{const s=Object.assign(Object.assign(Object.assign({},Zp),t),{prefix:e||""});return{data:yield tt(this.fetch,`${this.url}/object/list/${this.bucketId}`,s,{headers:this.headers},r),error:null}}catch(s){if(se(s))return{data:null,error:s};throw s}})}_getFinalPath(e){return`${this.bucketId}/${e}`}_removeEmptyFolders(e){return e.replace(/^\/|\/$/g,"").replace(/\/+/g,"/")}transformOptsToQueryString(e){const t=[];return e.width&&t.push(`width=${e.width}`),e.height&&t.push(`height=${e.height}`),e.resize&&t.push(`resize=${e.resize}`),e.format&&t.push(`format=${e.format}`),e.quality&&t.push(`quality=${e.quality}`),t.join("&")}}const Fp="2.5.5",Bp={"X-Client-Info":`storage-js/${Fp}`};var Ct=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(r.next(d))}catch(f){a(f)}}function c(d){try{l(r.throw(d))}catch(f){a(f)}}function l(d){d.done?i(d.value):s(d.value).then(o,c)}l((r=r.apply(n,e||[])).next())})};class Vp{constructor(e,t={},r){this.url=e,this.headers=Object.assign(Object.assign({},Bp),t),this.fetch=Zc(r)}listBuckets(){return Ct(this,void 0,void 0,function*(){try{return{data:yield gi(this.fetch,`${this.url}/bucket`,{headers:this.headers}),error:null}}catch(e){if(se(e))return{data:null,error:e};throw e}})}getBucket(e){return Ct(this,void 0,void 0,function*(){try{return{data:yield gi(this.fetch,`${this.url}/bucket/${e}`,{headers:this.headers}),error:null}}catch(t){if(se(t))return{data:null,error:t};throw t}})}createBucket(e,t={public:!1}){return Ct(this,void 0,void 0,function*(){try{return{data:yield tt(this.fetch,`${this.url}/bucket`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(se(r))return{data:null,error:r};throw r}})}updateBucket(e,t){return Ct(this,void 0,void 0,function*(){try{return{data:yield Up(this.fetch,`${this.url}/bucket/${e}`,{id:e,name:e,public:t.public,file_size_limit:t.fileSizeLimit,allowed_mime_types:t.allowedMimeTypes},{headers:this.headers}),error:null}}catch(r){if(se(r))return{data:null,error:r};throw r}})}emptyBucket(e){return Ct(this,void 0,void 0,function*(){try{return{data:yield tt(this.fetch,`${this.url}/bucket/${e}/empty`,{},{headers:this.headers}),error:null}}catch(t){if(se(t))return{data:null,error:t};throw t}})}deleteBucket(e){return Ct(this,void 0,void 0,function*(){try{return{data:yield Mc(this.fetch,`${this.url}/bucket/${e}`,{},{headers:this.headers}),error:null}}catch(t){if(se(t))return{data:null,error:t};throw t}})}}class zp extends Vp{constructor(e,t={},r){super(e,t,r)}from(e){return new Mp(this.url,this.headers,e,this.fetch)}}const qp="2.39.2";let Cr="";typeof Deno<"u"?Cr="deno":typeof document<"u"?Cr="web":typeof navigator<"u"&&navigator.product==="ReactNative"?Cr="react-native":Cr="node";const Kp={"X-Client-Info":`supabase-js-${Cr}/${qp}`};var Hp=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(r.next(d))}catch(f){a(f)}}function c(d){try{l(r.throw(d))}catch(f){a(f)}}function l(d){d.done?i(d.value):s(d.value).then(o,c)}l((r=r.apply(n,e||[])).next())})};const Jp=n=>{let e;return n?e=n:typeof fetch>"u"?e=ea:e=fetch,(...t)=>e(...t)},Gp=()=>typeof Headers>"u"?Nc:Headers,Wp=(n,e,t)=>{const r=Jp(t),s=Gp();return(i,a)=>Hp(void 0,void 0,void 0,function*(){var o;const c=(o=yield e())!==null&&o!==void 0?o:n;let l=new s(a==null?void 0:a.headers);return l.has("apikey")||l.set("apikey",n),l.has("Authorization")||l.set("Authorization",`Bearer ${c}`),r(i,Object.assign(Object.assign({},a),{headers:l}))})};function Yp(n){return n.replace(/\/$/,"")}function Xp(n,e){const{db:t,auth:r,realtime:s,global:i}=n,{db:a,auth:o,realtime:c,global:l}=e;return{db:Object.assign(Object.assign({},a),t),auth:Object.assign(Object.assign({},o),r),realtime:Object.assign(Object.assign({},c),s),global:Object.assign(Object.assign({},l),i)}}function Qp(n){return Math.round(Date.now()/1e3)+n}function em(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(n){const e=Math.random()*16|0;return(n=="x"?e:e&3|8).toString(16)})}const Ae=()=>typeof document<"u",pt={tested:!1,writable:!1},Nr=()=>{if(!Ae())return!1;try{if(typeof globalThis.localStorage!="object")return!1}catch{return!1}if(pt.tested)return pt.writable;const n=`lswt-${Math.random()}${Math.random()}`;try{globalThis.localStorage.setItem(n,n),globalThis.localStorage.removeItem(n),pt.tested=!0,pt.writable=!0}catch{pt.tested=!0,pt.writable=!1}return pt.writable};function qs(n){const e={},t=new URL(n);if(t.hash&&t.hash[0]==="#")try{new URLSearchParams(t.hash.substring(1)).forEach((s,i)=>{e[i]=s})}catch{}return t.searchParams.forEach((r,s)=>{e[s]=r}),e}const Fc=n=>{let e;return n?e=n:typeof fetch>"u"?e=(...t)=>qe(()=>Promise.resolve().then(()=>Wr),void 0).then(({default:r})=>r(...t)):e=fetch,(...t)=>e(...t)},tm=n=>typeof n=="object"&&n!==null&&"status"in n&&"ok"in n&&"json"in n&&typeof n.json=="function",mt=async(n,e,t)=>{await n.setItem(e,JSON.stringify(t))},cn=async(n,e)=>{const t=await n.getItem(e);if(!t)return null;try{return JSON.parse(t)}catch{return t}},Ks=async(n,e)=>{await n.removeItem(e)};function rm(n){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";let t="",r,s,i,a,o,c,l,d=0;for(n=n.replace("-","+").replace("_","/");d<n.length;)a=e.indexOf(n.charAt(d++)),o=e.indexOf(n.charAt(d++)),c=e.indexOf(n.charAt(d++)),l=e.indexOf(n.charAt(d++)),r=a<<2|o>>4,s=(o&15)<<4|c>>2,i=(c&3)<<6|l,t=t+String.fromCharCode(r),c!=64&&s!=0&&(t=t+String.fromCharCode(s)),l!=64&&i!=0&&(t=t+String.fromCharCode(i));return t}class Ts{constructor(){this.promise=new Ts.promiseConstructor((e,t)=>{this.resolve=e,this.reject=t})}}Ts.promiseConstructor=Promise;function go(n){const e=/^([a-z0-9_-]{4})*($|[a-z0-9_-]{3}=?$|[a-z0-9_-]{2}(==)?$)$/i,t=n.split(".");if(t.length!==3)throw new Error("JWT is not valid: not a JWT structure");if(!e.test(t[1]))throw new Error("JWT is not valid: payload is not in base64url format");const r=t[1];return JSON.parse(rm(r))}async function nm(n){return await new Promise(e=>{setTimeout(()=>e(null),n)})}function sm(n,e){return new Promise((r,s)=>{(async()=>{for(let i=0;i<1/0;i++)try{const a=await n(i);if(!e(i,null,a)){r(a);return}}catch(a){if(!e(i,a)){s(a);return}}})()})}function im(n){return("0"+n.toString(16)).substr(-2)}function St(){const e=new Uint32Array(56);if(typeof crypto>"u"){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=t.length;let s="";for(let i=0;i<56;i++)s+=t.charAt(Math.floor(Math.random()*r));return s}return crypto.getRandomValues(e),Array.from(e,im).join("")}async function am(n){const t=new TextEncoder().encode(n),r=await crypto.subtle.digest("SHA-256",t),s=new Uint8Array(r);return Array.from(s).map(i=>String.fromCharCode(i)).join("")}function om(n){return btoa(n).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async function xt(n){if(!(typeof crypto<"u"&&typeof crypto.subtle<"u"&&typeof TextEncoder<"u"))return console.warn("WebCrypto API is not supported. Code challenge method will default to use plain instead of sha256."),n;const t=await am(n);return om(t)}class sa extends Error{constructor(e,t){super(e),this.__isAuthError=!0,this.name="AuthError",this.status=t}}function L(n){return typeof n=="object"&&n!==null&&"__isAuthError"in n}class cm extends sa{constructor(e,t){super(e,t),this.name="AuthApiError",this.status=t}toJSON(){return{name:this.name,message:this.message,status:this.status}}}function um(n){return L(n)&&n.name==="AuthApiError"}class Bc extends sa{constructor(e,t){super(e),this.name="AuthUnknownError",this.originalError=t}}class Et extends sa{constructor(e,t,r){super(e),this.name=t,this.status=r}toJSON(){return{name:this.name,message:this.message,status:this.status}}}class Rt extends Et{constructor(){super("Auth session missing!","AuthSessionMissingError",400)}}class Hs extends Et{constructor(){super("Auth session or user missing","AuthInvalidTokenResponseError",500)}}class un extends Et{constructor(e){super(e,"AuthInvalidCredentialsError",400)}}class ln extends Et{constructor(e,t=null){super(e,"AuthImplicitGrantRedirectError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class yo extends Et{constructor(e,t=null){super(e,"AuthPKCEGrantCodeExchangeError",500),this.details=null,this.details=t}toJSON(){return{name:this.name,message:this.message,status:this.status,details:this.details}}}class yi extends Et{constructor(e,t){super(e,"AuthRetryableFetchError",t)}}function Js(n){return L(n)&&n.name==="AuthRetryableFetchError"}class lm extends Et{constructor(e,t,r){super(e,"AuthWeakPasswordError",t),this.reasons=r}}var dm=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t};const Lt=n=>n.msg||n.message||n.error_description||n.error||JSON.stringify(n),hm=[502,503,504];async function _o(n){if(!tm(n))throw new yi(Lt(n),0);if(hm.includes(n.status))throw new yi(Lt(n),n.status);let e;try{e=await n.json()}catch(t){throw new Bc(Lt(t),t)}throw typeof e=="object"&&e&&typeof e.weak_password=="object"&&e.weak_password&&Array.isArray(e.weak_password.reasons)&&e.weak_password.reasons.length&&e.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)?new lm(Lt(e),n.status,e.weak_password.reasons):new cm(Lt(e),n.status||500)}const fm=(n,e,t,r)=>{const s={method:n,headers:(e==null?void 0:e.headers)||{}};return n==="GET"?s:(s.headers=Object.assign({"Content-Type":"application/json;charset=UTF-8"},e==null?void 0:e.headers),s.body=JSON.stringify(r),Object.assign(Object.assign({},s),t))};async function M(n,e,t,r){var s;const i=Object.assign({},r==null?void 0:r.headers);r!=null&&r.jwt&&(i.Authorization=`Bearer ${r.jwt}`);const a=(s=r==null?void 0:r.query)!==null&&s!==void 0?s:{};r!=null&&r.redirectTo&&(a.redirect_to=r.redirectTo);const o=Object.keys(a).length?"?"+new URLSearchParams(a).toString():"",c=await pm(n,e,t+o,{headers:i,noResolveJson:r==null?void 0:r.noResolveJson},{},r==null?void 0:r.body);return r!=null&&r.xform?r==null?void 0:r.xform(c):{data:Object.assign({},c),error:null}}async function pm(n,e,t,r,s,i){const a=fm(e,r,s,i);let o;try{o=await n(t,a)}catch(c){throw console.error(c),new yi(Lt(c),0)}if(o.ok||await _o(o),r!=null&&r.noResolveJson)return o;try{return await o.json()}catch(c){await _o(c)}}function gt(n){var e;let t=null;_m(n)&&(t=Object.assign({},n),n.expires_at||(t.expires_at=Qp(n.expires_in)));const r=(e=n.user)!==null&&e!==void 0?e:n;return{data:{session:t,user:r},error:null}}function bo(n){const e=gt(n);return!e.error&&n.weak_password&&typeof n.weak_password=="object"&&Array.isArray(n.weak_password.reasons)&&n.weak_password.reasons.length&&n.weak_password.message&&typeof n.weak_password.message=="string"&&n.weak_password.reasons.reduce((t,r)=>t&&typeof r=="string",!0)&&(e.data.weak_password=n.weak_password),e}function rt(n){var e;return{data:{user:(e=n.user)!==null&&e!==void 0?e:n},error:null}}function mm(n){return{data:n,error:null}}function gm(n){const{action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i}=n,a=dm(n,["action_link","email_otp","hashed_token","redirect_to","verification_type"]),o={action_link:e,email_otp:t,hashed_token:r,redirect_to:s,verification_type:i},c=Object.assign({},a);return{data:{properties:o,user:c},error:null}}function ym(n){return n}function _m(n){return n.access_token&&n.refresh_token&&n.expires_in}var bm=function(n,e){var t={};for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&e.indexOf(r)<0&&(t[r]=n[r]);if(n!=null&&typeof Object.getOwnPropertySymbols=="function")for(var s=0,r=Object.getOwnPropertySymbols(n);s<r.length;s++)e.indexOf(r[s])<0&&Object.prototype.propertyIsEnumerable.call(n,r[s])&&(t[r[s]]=n[r[s]]);return t};class vm{constructor({url:e="",headers:t={},fetch:r}){this.url=e,this.headers=t,this.fetch=Fc(r),this.mfa={listFactors:this._listFactors.bind(this),deleteFactor:this._deleteFactor.bind(this)}}async signOut(e,t="global"){try{return await M(this.fetch,"POST",`${this.url}/logout?scope=${t}`,{headers:this.headers,jwt:e,noResolveJson:!0}),{data:null,error:null}}catch(r){if(L(r))return{data:null,error:r};throw r}}async inviteUserByEmail(e,t={}){try{return await M(this.fetch,"POST",`${this.url}/invite`,{body:{email:e,data:t.data},headers:this.headers,redirectTo:t.redirectTo,xform:rt})}catch(r){if(L(r))return{data:{user:null},error:r};throw r}}async generateLink(e){try{const{options:t}=e,r=bm(e,["options"]),s=Object.assign(Object.assign({},r),t);return"newEmail"in r&&(s.new_email=r==null?void 0:r.newEmail,delete s.newEmail),await M(this.fetch,"POST",`${this.url}/admin/generate_link`,{body:s,headers:this.headers,xform:gm,redirectTo:t==null?void 0:t.redirectTo})}catch(t){if(L(t))return{data:{properties:null,user:null},error:t};throw t}}async createUser(e){try{return await M(this.fetch,"POST",`${this.url}/admin/users`,{body:e,headers:this.headers,xform:rt})}catch(t){if(L(t))return{data:{user:null},error:t};throw t}}async listUsers(e){var t,r,s,i,a,o,c;try{const l={nextPage:null,lastPage:0,total:0},d=await M(this.fetch,"GET",`${this.url}/admin/users`,{headers:this.headers,noResolveJson:!0,query:{page:(r=(t=e==null?void 0:e.page)===null||t===void 0?void 0:t.toString())!==null&&r!==void 0?r:"",per_page:(i=(s=e==null?void 0:e.perPage)===null||s===void 0?void 0:s.toString())!==null&&i!==void 0?i:""},xform:ym});if(d.error)throw d.error;const f=await d.json(),m=(a=d.headers.get("x-total-count"))!==null&&a!==void 0?a:0,b=(c=(o=d.headers.get("link"))===null||o===void 0?void 0:o.split(","))!==null&&c!==void 0?c:[];return b.length>0&&(b.forEach(v=>{const T=parseInt(v.split(";")[0].split("=")[1].substring(0,1)),w=JSON.parse(v.split(";")[1].split("=")[1]);l[`${w}Page`]=T}),l.total=parseInt(m)),{data:Object.assign(Object.assign({},f),l),error:null}}catch(l){if(L(l))return{data:{users:[]},error:l};throw l}}async getUserById(e){try{return await M(this.fetch,"GET",`${this.url}/admin/users/${e}`,{headers:this.headers,xform:rt})}catch(t){if(L(t))return{data:{user:null},error:t};throw t}}async updateUserById(e,t){try{return await M(this.fetch,"PUT",`${this.url}/admin/users/${e}`,{body:t,headers:this.headers,xform:rt})}catch(r){if(L(r))return{data:{user:null},error:r};throw r}}async deleteUser(e,t=!1){try{return await M(this.fetch,"DELETE",`${this.url}/admin/users/${e}`,{headers:this.headers,body:{should_soft_delete:t},xform:rt})}catch(r){if(L(r))return{data:{user:null},error:r};throw r}}async _listFactors(e){try{const{data:t,error:r}=await M(this.fetch,"GET",`${this.url}/admin/users/${e.userId}/factors`,{headers:this.headers,xform:s=>({data:{factors:s},error:null})});return{data:t,error:r}}catch(t){if(L(t))return{data:null,error:t};throw t}}async _deleteFactor(e){try{return{data:await M(this.fetch,"DELETE",`${this.url}/admin/users/${e.userId}/factors/${e.id}`,{headers:this.headers}),error:null}}catch(t){if(L(t))return{data:null,error:t};throw t}}}const Vc="2.62.0",wm="http://localhost:9999",Tm="supabase.auth.token",Em={"X-Client-Info":`gotrue-js/${Vc}`},vo=10,Om={getItem:n=>Nr()?globalThis.localStorage.getItem(n):null,setItem:(n,e)=>{Nr()&&globalThis.localStorage.setItem(n,e)},removeItem:n=>{Nr()&&globalThis.localStorage.removeItem(n)}};function wo(n={}){return{getItem:e=>n[e]||null,setItem:(e,t)=>{n[e]=t},removeItem:e=>{delete n[e]}}}function Pm(){if(typeof globalThis!="object")try{Object.defineProperty(Object.prototype,"__magic__",{get:function(){return this},configurable:!0}),__magic__.globalThis=__magic__,delete Object.prototype.__magic__}catch{typeof self<"u"&&(self.globalThis=self)}}const jt={debug:!!(globalThis&&Nr()&&globalThis.localStorage&&globalThis.localStorage.getItem("supabase.gotrue-js.locks.debug")==="true")};class zc extends Error{constructor(e){super(e),this.isAcquireTimeout=!0}}class Am extends zc{}async function Im(n,e,t){jt.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquire lock",n,e);const r=new globalThis.AbortController;return e>0&&setTimeout(()=>{r.abort(),jt.debug&&console.log("@supabase/gotrue-js: navigatorLock acquire timed out",n)},e),await globalThis.navigator.locks.request(n,e===0?{mode:"exclusive",ifAvailable:!0}:{mode:"exclusive",signal:r.signal},async s=>{if(s){jt.debug&&console.log("@supabase/gotrue-js: navigatorLock: acquired",n,s.name);try{return await t()}finally{jt.debug&&console.log("@supabase/gotrue-js: navigatorLock: released",n,s.name)}}else{if(e===0)throw jt.debug&&console.log("@supabase/gotrue-js: navigatorLock: not immediately available",n),new Am(`Acquiring an exclusive Navigator LockManager lock "${n}" immediately failed`);if(jt.debug)try{const i=await globalThis.navigator.locks.query();console.log("@supabase/gotrue-js: Navigator LockManager state",JSON.stringify(i,null,"  "))}catch(i){console.warn("@supabase/gotrue-js: Error when querying Navigator LockManager state",i)}return console.warn("@supabase/gotrue-js: Navigator LockManager returned a null lock when using #request without ifAvailable set to true, it appears this browser is not following the LockManager spec https://developer.mozilla.org/en-US/docs/Web/API/LockManager/request"),await t()}})}Pm();const km={url:wm,storageKey:Tm,autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,headers:Em,flowType:"implicit",debug:!1},Er=30*1e3,To=3;async function Eo(n,e,t){return await t()}class zr{constructor(e){var t,r;this.memoryStorage=null,this.stateChangeEmitters=new Map,this.autoRefreshTicker=null,this.visibilityChangedCallback=null,this.refreshingDeferred=null,this.initializePromise=null,this.detectSessionInUrl=!0,this.lockAcquired=!1,this.pendingInLock=[],this.broadcastChannel=null,this.logger=console.log,this.instanceID=zr.nextInstanceID,zr.nextInstanceID+=1,this.instanceID>0&&Ae()&&console.warn("Multiple GoTrueClient instances detected in the same browser context. It is not an error, but this should be avoided as it may produce undefined behavior when used concurrently under the same storage key.");const s=Object.assign(Object.assign({},km),e);if(this.logDebugMessages=!!s.debug,typeof s.debug=="function"&&(this.logger=s.debug),this.persistSession=s.persistSession,this.storageKey=s.storageKey,this.autoRefreshToken=s.autoRefreshToken,this.admin=new vm({url:s.url,headers:s.headers,fetch:s.fetch}),this.url=s.url,this.headers=s.headers,this.fetch=Fc(s.fetch),this.lock=s.lock||Eo,this.detectSessionInUrl=s.detectSessionInUrl,this.flowType=s.flowType,s.lock?this.lock=s.lock:Ae()&&(!((t=globalThis==null?void 0:globalThis.navigator)===null||t===void 0)&&t.locks)?this.lock=Im:this.lock=Eo,this.mfa={verify:this._verify.bind(this),enroll:this._enroll.bind(this),unenroll:this._unenroll.bind(this),challenge:this._challenge.bind(this),listFactors:this._listFactors.bind(this),challengeAndVerify:this._challengeAndVerify.bind(this),getAuthenticatorAssuranceLevel:this._getAuthenticatorAssuranceLevel.bind(this)},this.persistSession?s.storage?this.storage=s.storage:Nr()?this.storage=Om:(this.memoryStorage={},this.storage=wo(this.memoryStorage)):(this.memoryStorage={},this.storage=wo(this.memoryStorage)),Ae()&&globalThis.BroadcastChannel&&this.persistSession&&this.storageKey){try{this.broadcastChannel=new globalThis.BroadcastChannel(this.storageKey)}catch(i){console.error("Failed to create a new BroadcastChannel, multi-tab state changes will not be available",i)}(r=this.broadcastChannel)===null||r===void 0||r.addEventListener("message",async i=>{this._debug("received broadcast notification from other tab or client",i),await this._notifyAllSubscribers(i.data.event,i.data.session,!1)})}this.initialize()}_debug(...e){return this.logDebugMessages&&this.logger(`GoTrueClient@${this.instanceID} (${Vc}) ${new Date().toISOString()}`,...e),this}async initialize(){return this.initializePromise?await this.initializePromise:(this.initializePromise=(async()=>await this._acquireLock(-1,async()=>await this._initialize()))(),await this.initializePromise)}async _initialize(){try{const e=Ae()?await this._isPKCEFlow():!1;if(this._debug("#_initialize()","begin","is PKCE flow",e),e||this.detectSessionInUrl&&this._isImplicitGrantFlow()){const{data:t,error:r}=await this._getSessionFromURL(e);if(r)return this._debug("#_initialize()","error detecting session from URL",r),(r==null?void 0:r.message)==="Identity is already linked"||(r==null?void 0:r.message)==="Identity is already linked to another user"?{error:r}:(await this._removeSession(),{error:r});const{session:s,redirectType:i}=t;return this._debug("#_initialize()","detected session in URL",s,"redirect type",i),await this._saveSession(s),setTimeout(async()=>{i==="recovery"?await this._notifyAllSubscribers("PASSWORD_RECOVERY",s):await this._notifyAllSubscribers("SIGNED_IN",s)},0),{error:null}}return await this._recoverAndRefresh(),{error:null}}catch(e){return L(e)?{error:e}:{error:new Bc("Unexpected error during initialization",e)}}finally{await this._handleVisibilityChange(),this._debug("#_initialize()","end")}}async signUp(e){var t,r,s;try{await this._removeSession();let i;if("email"in e){const{email:d,password:f,options:m}=e;let b=null,v=null;if(this.flowType==="pkce"){const T=St();await mt(this.storage,`${this.storageKey}-code-verifier`,T),b=await xt(T),v=T===b?"plain":"s256"}i=await M(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,redirectTo:m==null?void 0:m.emailRedirectTo,body:{email:d,password:f,data:(t=m==null?void 0:m.data)!==null&&t!==void 0?t:{},gotrue_meta_security:{captcha_token:m==null?void 0:m.captchaToken},code_challenge:b,code_challenge_method:v},xform:gt})}else if("phone"in e){const{phone:d,password:f,options:m}=e;i=await M(this.fetch,"POST",`${this.url}/signup`,{headers:this.headers,body:{phone:d,password:f,data:(r=m==null?void 0:m.data)!==null&&r!==void 0?r:{},channel:(s=m==null?void 0:m.channel)!==null&&s!==void 0?s:"sms",gotrue_meta_security:{captcha_token:m==null?void 0:m.captchaToken}},xform:gt})}else throw new un("You must provide either an email or phone number and a password");const{data:a,error:o}=i;if(o||!a)return{data:{user:null,session:null},error:o};const c=a.session,l=a.user;return a.session&&(await this._saveSession(a.session),await this._notifyAllSubscribers("SIGNED_IN",c)),{data:{user:l,session:c},error:null}}catch(i){if(L(i))return{data:{user:null,session:null},error:i};throw i}}async signInWithPassword(e){try{await this._removeSession();let t;if("email"in e){const{email:i,password:a,options:o}=e;t=await M(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{email:i,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:bo})}else if("phone"in e){const{phone:i,password:a,options:o}=e;t=await M(this.fetch,"POST",`${this.url}/token?grant_type=password`,{headers:this.headers,body:{phone:i,password:a,gotrue_meta_security:{captcha_token:o==null?void 0:o.captchaToken}},xform:bo})}else throw new un("You must provide either an email or phone number and a password");const{data:r,error:s}=t;return s?{data:{user:null,session:null},error:s}:!r||!r.session||!r.user?{data:{user:null,session:null},error:new Hs}:(r.session&&(await this._saveSession(r.session),await this._notifyAllSubscribers("SIGNED_IN",r.session)),{data:Object.assign({user:r.user,session:r.session},r.weak_password?{weakPassword:r.weak_password}:null),error:s})}catch(t){if(L(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOAuth(e){var t,r,s,i;return await this._removeSession(),await this._handleProviderSignIn(e.provider,{redirectTo:(t=e.options)===null||t===void 0?void 0:t.redirectTo,scopes:(r=e.options)===null||r===void 0?void 0:r.scopes,queryParams:(s=e.options)===null||s===void 0?void 0:s.queryParams,skipBrowserRedirect:(i=e.options)===null||i===void 0?void 0:i.skipBrowserRedirect})}async exchangeCodeForSession(e){return await this.initializePromise,this._acquireLock(-1,async()=>this._exchangeCodeForSession(e))}async _exchangeCodeForSession(e){const t=await cn(this.storage,`${this.storageKey}-code-verifier`),[r,s]=(t??"").split("/"),{data:i,error:a}=await M(this.fetch,"POST",`${this.url}/token?grant_type=pkce`,{headers:this.headers,body:{auth_code:e,code_verifier:r},xform:gt});return await Ks(this.storage,`${this.storageKey}-code-verifier`),a?{data:{user:null,session:null,redirectType:null},error:a}:!i||!i.session||!i.user?{data:{user:null,session:null,redirectType:null},error:new Hs}:(i.session&&(await this._saveSession(i.session),await this._notifyAllSubscribers("SIGNED_IN",i.session)),{data:Object.assign(Object.assign({},i),{redirectType:s??null}),error:a})}async signInWithIdToken(e){await this._removeSession();try{const{options:t,provider:r,token:s,access_token:i,nonce:a}=e,o=await M(this.fetch,"POST",`${this.url}/token?grant_type=id_token`,{headers:this.headers,body:{provider:r,id_token:s,access_token:i,nonce:a,gotrue_meta_security:{captcha_token:t==null?void 0:t.captchaToken}},xform:gt}),{data:c,error:l}=o;return l?{data:{user:null,session:null},error:l}:!c||!c.session||!c.user?{data:{user:null,session:null},error:new Hs}:(c.session&&(await this._saveSession(c.session),await this._notifyAllSubscribers("SIGNED_IN",c.session)),{data:c,error:l})}catch(t){if(L(t))return{data:{user:null,session:null},error:t};throw t}}async signInWithOtp(e){var t,r,s,i,a;try{if(await this._removeSession(),"email"in e){const{email:o,options:c}=e;let l=null,d=null;if(this.flowType==="pkce"){const m=St();await mt(this.storage,`${this.storageKey}-code-verifier`,m),l=await xt(m),d=m===l?"plain":"s256"}const{error:f}=await M(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{email:o,data:(t=c==null?void 0:c.data)!==null&&t!==void 0?t:{},create_user:(r=c==null?void 0:c.shouldCreateUser)!==null&&r!==void 0?r:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},code_challenge:l,code_challenge_method:d},redirectTo:c==null?void 0:c.emailRedirectTo});return{data:{user:null,session:null},error:f}}if("phone"in e){const{phone:o,options:c}=e,{data:l,error:d}=await M(this.fetch,"POST",`${this.url}/otp`,{headers:this.headers,body:{phone:o,data:(s=c==null?void 0:c.data)!==null&&s!==void 0?s:{},create_user:(i=c==null?void 0:c.shouldCreateUser)!==null&&i!==void 0?i:!0,gotrue_meta_security:{captcha_token:c==null?void 0:c.captchaToken},channel:(a=c==null?void 0:c.channel)!==null&&a!==void 0?a:"sms"}});return{data:{user:null,session:null,messageId:l==null?void 0:l.message_id},error:d}}throw new un("You must provide either an email or phone number.")}catch(o){if(L(o))return{data:{user:null,session:null},error:o};throw o}}async verifyOtp(e){var t,r;try{e.type!=="email_change"&&e.type!=="phone_change"&&await this._removeSession();let s,i;"options"in e&&(s=(t=e.options)===null||t===void 0?void 0:t.redirectTo,i=(r=e.options)===null||r===void 0?void 0:r.captchaToken);const{data:a,error:o}=await M(this.fetch,"POST",`${this.url}/verify`,{headers:this.headers,body:Object.assign(Object.assign({},e),{gotrue_meta_security:{captcha_token:i}}),redirectTo:s,xform:gt});if(o)throw o;if(!a)throw new Error("An error occurred on token verification.");const c=a.session,l=a.user;return c!=null&&c.access_token&&(await this._saveSession(c),await this._notifyAllSubscribers("SIGNED_IN",c)),{data:{user:l,session:c},error:null}}catch(s){if(L(s))return{data:{user:null,session:null},error:s};throw s}}async signInWithSSO(e){var t,r,s;try{await this._removeSession();let i=null,a=null;if(this.flowType==="pkce"){const o=St();await mt(this.storage,`${this.storageKey}-code-verifier`,o),i=await xt(o),a=o===i?"plain":"s256"}return await M(this.fetch,"POST",`${this.url}/sso`,{body:Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({},"providerId"in e?{provider_id:e.providerId}:null),"domain"in e?{domain:e.domain}:null),{redirect_to:(r=(t=e.options)===null||t===void 0?void 0:t.redirectTo)!==null&&r!==void 0?r:void 0}),!((s=e==null?void 0:e.options)===null||s===void 0)&&s.captchaToken?{gotrue_meta_security:{captcha_token:e.options.captchaToken}}:null),{skip_http_redirect:!0,code_challenge:i,code_challenge_method:a}),headers:this.headers,xform:mm})}catch(i){if(L(i))return{data:null,error:i};throw i}}async reauthenticate(){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._reauthenticate())}async _reauthenticate(){try{return await this._useSession(async e=>{const{data:{session:t},error:r}=e;if(r)throw r;if(!t)throw new Rt;const{error:s}=await M(this.fetch,"GET",`${this.url}/reauthenticate`,{headers:this.headers,jwt:t.access_token});return{data:{user:null,session:null},error:s}})}catch(e){if(L(e))return{data:{user:null,session:null},error:e};throw e}}async resend(e){try{e.type!="email_change"&&e.type!="phone_change"&&await this._removeSession();const t=`${this.url}/resend`;if("email"in e){const{email:r,type:s,options:i}=e,{error:a}=await M(this.fetch,"POST",t,{headers:this.headers,body:{email:r,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}},redirectTo:i==null?void 0:i.emailRedirectTo});return{data:{user:null,session:null},error:a}}else if("phone"in e){const{phone:r,type:s,options:i}=e,{data:a,error:o}=await M(this.fetch,"POST",t,{headers:this.headers,body:{phone:r,type:s,gotrue_meta_security:{captcha_token:i==null?void 0:i.captchaToken}}});return{data:{user:null,session:null,messageId:a==null?void 0:a.message_id},error:o}}throw new un("You must provide either an email or phone number and a type")}catch(t){if(L(t))return{data:{user:null,session:null},error:t};throw t}}async getSession(){return await this.initializePromise,this._acquireLock(-1,async()=>this._useSession(async e=>e))}async _acquireLock(e,t){this._debug("#_acquireLock","begin",e);try{if(this.lockAcquired){const r=this.pendingInLock.length?this.pendingInLock[this.pendingInLock.length-1]:Promise.resolve(),s=(async()=>(await r,await t()))();return this.pendingInLock.push((async()=>{try{await s}catch{}})()),s}return await this.lock(`lock:${this.storageKey}`,e,async()=>{this._debug("#_acquireLock","lock acquired for storage key",this.storageKey);try{this.lockAcquired=!0;const r=t();for(this.pendingInLock.push((async()=>{try{await r}catch{}})()),await r;this.pendingInLock.length;){const s=[...this.pendingInLock];await Promise.all(s),this.pendingInLock.splice(0,s.length)}return await r}finally{this._debug("#_acquireLock","lock released for storage key",this.storageKey),this.lockAcquired=!1}})}finally{this._debug("#_acquireLock","end")}}async _useSession(e){this._debug("#_useSession","begin");try{const t=await this.__loadSession();return await e(t)}finally{this._debug("#_useSession","end")}}async __loadSession(){this._debug("#__loadSession()","begin"),this.lockAcquired||this._debug("#__loadSession()","used outside of an acquired lock!",new Error().stack);try{let e=null;const t=await cn(this.storage,this.storageKey);if(this._debug("#getSession()","session from storage",t),t!==null&&(this._isValidSession(t)?e=t:(this._debug("#getSession()","session from storage is not valid"),await this._removeSession())),!e)return{data:{session:null},error:null};const r=e.expires_at?e.expires_at<=Date.now()/1e3:!1;if(this._debug("#__loadSession()",`session has${r?"":" not"} expired`,"expires_at",e.expires_at),!r)return{data:{session:e},error:null};const{session:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{session:null},error:i}:{data:{session:s},error:null}}finally{this._debug("#__loadSession()","end")}}async getUser(e){return e?await this._getUser(e):(await this.initializePromise,this._acquireLock(-1,async()=>await this._getUser()))}async _getUser(e){try{return e?await M(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:e,xform:rt}):await this._useSession(async t=>{var r,s;const{data:i,error:a}=t;if(a)throw a;return await M(this.fetch,"GET",`${this.url}/user`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0,xform:rt})})}catch(t){if(L(t))return{data:{user:null},error:t};throw t}}async updateUser(e,t={}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._updateUser(e,t))}async _updateUser(e,t={}){try{return await this._useSession(async r=>{const{data:s,error:i}=r;if(i)throw i;if(!s.session)throw new Rt;const a=s.session;let o=null,c=null;if(this.flowType==="pkce"&&e.email!=null){const f=St();await mt(this.storage,`${this.storageKey}-code-verifier`,f),o=await xt(f),c=f===o?"plain":"s256"}const{data:l,error:d}=await M(this.fetch,"PUT",`${this.url}/user`,{headers:this.headers,redirectTo:t==null?void 0:t.emailRedirectTo,body:Object.assign(Object.assign({},e),{code_challenge:o,code_challenge_method:c}),jwt:a.access_token,xform:rt});if(d)throw d;return a.user=l.user,await this._saveSession(a),await this._notifyAllSubscribers("USER_UPDATED",a),{data:{user:a.user},error:null}})}catch(r){if(L(r))return{data:{user:null},error:r};throw r}}_decodeJWT(e){return go(e)}async setSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._setSession(e))}async _setSession(e){try{if(!e.access_token||!e.refresh_token)throw new Rt;const t=Date.now()/1e3;let r=t,s=!0,i=null;const a=go(e.access_token);if(a.exp&&(r=a.exp,s=r<=t),s){const{session:o,error:c}=await this._callRefreshToken(e.refresh_token);if(c)return{data:{user:null,session:null},error:c};if(!o)return{data:{user:null,session:null},error:null};i=o}else{const{data:o,error:c}=await this._getUser(e.access_token);if(c)throw c;i={access_token:e.access_token,refresh_token:e.refresh_token,user:o.user,token_type:"bearer",expires_in:r-t,expires_at:r},await this._saveSession(i),await this._notifyAllSubscribers("SIGNED_IN",i)}return{data:{user:i.user,session:i},error:null}}catch(t){if(L(t))return{data:{session:null,user:null},error:t};throw t}}async refreshSession(e){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._refreshSession(e))}async _refreshSession(e){try{return await this._useSession(async t=>{var r;if(!e){const{data:a,error:o}=t;if(o)throw o;e=(r=a.session)!==null&&r!==void 0?r:void 0}if(!(e!=null&&e.refresh_token))throw new Rt;const{session:s,error:i}=await this._callRefreshToken(e.refresh_token);return i?{data:{user:null,session:null},error:i}:s?{data:{user:s.user,session:s},error:null}:{data:{user:null,session:null},error:null}})}catch(t){if(L(t))return{data:{user:null,session:null},error:t};throw t}}async _getSessionFromURL(e){try{if(!Ae())throw new ln("No browser detected.");if(this.flowType==="implicit"&&!this._isImplicitGrantFlow())throw new ln("Not a valid implicit grant flow url.");if(this.flowType=="pkce"&&!e)throw new yo("Not a valid PKCE flow url.");const t=qs(window.location.href);if(e){if(!t.code)throw new yo("No code detected.");const{data:k,error:I}=await this._exchangeCodeForSession(t.code);if(I)throw I;const Z=new URL(window.location.href);return Z.searchParams.delete("code"),window.history.replaceState(window.history.state,"",Z.toString()),{data:{session:k.session,redirectType:null},error:null}}if(t.error||t.error_description||t.error_code)throw new ln(t.error_description||"Error in URL with unspecified error_description",{error:t.error||"unspecified_error",code:t.error_code||"unspecified_code"});const{provider_token:r,provider_refresh_token:s,access_token:i,refresh_token:a,expires_in:o,expires_at:c,token_type:l}=t;if(!i||!o||!a||!l)throw new ln("No session defined in URL");const d=Math.round(Date.now()/1e3),f=parseInt(o);let m=d+f;c&&(m=parseInt(c));const b=m-d;b*1e3<=Er&&console.warn(`@supabase/gotrue-js: Session as retrieved from URL expires in ${b}s, should have been closer to ${f}s`);const v=m-f;d-v>=120?console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued over 120s ago, URL could be stale",v,m,d):d-v<0&&console.warn("@supabase/gotrue-js: Session as retrieved from URL was issued in the future? Check the device clok for skew",v,m,d);const{data:T,error:w}=await this._getUser(i);if(w)throw w;const P={provider_token:r,provider_refresh_token:s,access_token:i,expires_in:f,expires_at:m,refresh_token:a,token_type:l,user:T.user};return window.location.hash="",this._debug("#_getSessionFromURL()","clearing window.location.hash"),{data:{session:P,redirectType:t.type},error:null}}catch(t){if(L(t))return{data:{session:null,redirectType:null},error:t};throw t}}_isImplicitGrantFlow(){const e=qs(window.location.href);return!!(Ae()&&(e.access_token||e.error_description))}async _isPKCEFlow(){const e=qs(window.location.href),t=await cn(this.storage,`${this.storageKey}-code-verifier`);return!!(e.code&&t)}async signOut(e={scope:"global"}){return await this.initializePromise,await this._acquireLock(-1,async()=>await this._signOut(e))}async _signOut({scope:e}={scope:"global"}){return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return{error:i};const a=(r=s.session)===null||r===void 0?void 0:r.access_token;if(a){const{error:o}=await this.admin.signOut(a,e);if(o&&!(um(o)&&(o.status===404||o.status===401)))return{error:o}}return e!=="others"&&(await this._removeSession(),await Ks(this.storage,`${this.storageKey}-code-verifier`),await this._notifyAllSubscribers("SIGNED_OUT",null)),{error:null}})}onAuthStateChange(e){const t=em(),r={id:t,callback:e,unsubscribe:()=>{this._debug("#unsubscribe()","state change callback with id removed",t),this.stateChangeEmitters.delete(t)}};return this._debug("#onAuthStateChange()","registered callback with id",t),this.stateChangeEmitters.set(t,r),(async()=>(await this.initializePromise,await this._acquireLock(-1,async()=>{this._emitInitialSession(t)})))(),{data:{subscription:r}}}async _emitInitialSession(e){return await this._useSession(async t=>{var r,s;try{const{data:{session:i},error:a}=t;if(a)throw a;await((r=this.stateChangeEmitters.get(e))===null||r===void 0?void 0:r.callback("INITIAL_SESSION",i)),this._debug("INITIAL_SESSION","callback id",e,"session",i)}catch(i){await((s=this.stateChangeEmitters.get(e))===null||s===void 0?void 0:s.callback("INITIAL_SESSION",null)),this._debug("INITIAL_SESSION","callback id",e,"error",i),console.error(i)}})}async resetPasswordForEmail(e,t={}){let r=null,s=null;if(this.flowType==="pkce"){const i=St();await mt(this.storage,`${this.storageKey}-code-verifier`,`${i}/PASSWORD_RECOVERY`),r=await xt(i),s=i===r?"plain":"s256"}try{return await M(this.fetch,"POST",`${this.url}/recover`,{body:{email:e,code_challenge:r,code_challenge_method:s,gotrue_meta_security:{captcha_token:t.captchaToken}},headers:this.headers,redirectTo:t.redirectTo})}catch(i){if(L(i))return{data:null,error:i};throw i}}async getUserIdentities(){var e;try{const{data:t,error:r}=await this.getUser();if(r)throw r;return{data:{identities:(e=t.user.identities)!==null&&e!==void 0?e:[]},error:null}}catch(t){if(L(t))return{data:null,error:t};throw t}}async linkIdentity(e){var t;try{const{data:r,error:s}=await this._useSession(async i=>{var a,o,c,l,d;const{data:f,error:m}=i;if(m)throw m;const b=await this._getUrlForProvider(`${this.url}/user/identities/authorize`,e.provider,{redirectTo:(a=e.options)===null||a===void 0?void 0:a.redirectTo,scopes:(o=e.options)===null||o===void 0?void 0:o.scopes,queryParams:(c=e.options)===null||c===void 0?void 0:c.queryParams,skipBrowserRedirect:!0});return await M(this.fetch,"GET",b,{headers:this.headers,jwt:(d=(l=f.session)===null||l===void 0?void 0:l.access_token)!==null&&d!==void 0?d:void 0})});if(s)throw s;return Ae()&&!(!((t=e.options)===null||t===void 0)&&t.skipBrowserRedirect)&&window.location.assign(r==null?void 0:r.url),{data:{provider:e.provider,url:r==null?void 0:r.url},error:null}}catch(r){if(L(r))return{data:{provider:e.provider,url:null},error:r};throw r}}async unlinkIdentity(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:a}=t;if(a)throw a;return await M(this.fetch,"DELETE",`${this.url}/user/identities/${e.identity_id}`,{headers:this.headers,jwt:(s=(r=i.session)===null||r===void 0?void 0:r.access_token)!==null&&s!==void 0?s:void 0})})}catch(t){if(L(t))return{data:null,error:t};throw t}}async _refreshAccessToken(e){const t=`#_refreshAccessToken(${e.substring(0,5)}...)`;this._debug(t,"begin");try{const r=Date.now();return await sm(async s=>(await nm(s*200),this._debug(t,"refreshing attempt",s),await M(this.fetch,"POST",`${this.url}/token?grant_type=refresh_token`,{body:{refresh_token:e},headers:this.headers,xform:gt})),(s,i,a)=>a&&a.error&&Js(a.error)&&Date.now()+(s+1)*200-r<Er)}catch(r){if(this._debug(t,"error",r),L(r))return{data:{session:null,user:null},error:r};throw r}finally{this._debug(t,"end")}}_isValidSession(e){return typeof e=="object"&&e!==null&&"access_token"in e&&"refresh_token"in e&&"expires_at"in e}async _handleProviderSignIn(e,t){const r=await this._getUrlForProvider(`${this.url}/authorize`,e,{redirectTo:t.redirectTo,scopes:t.scopes,queryParams:t.queryParams});return this._debug("#_handleProviderSignIn()","provider",e,"options",t,"url",r),Ae()&&!t.skipBrowserRedirect&&window.location.assign(r),{data:{provider:e,url:r},error:null}}async _recoverAndRefresh(){var e;const t="#_recoverAndRefresh()";this._debug(t,"begin");try{const r=await cn(this.storage,this.storageKey);if(this._debug(t,"session from storage",r),!this._isValidSession(r)){this._debug(t,"session is not valid"),r!==null&&await this._removeSession();return}const s=Math.round(Date.now()/1e3),i=((e=r.expires_at)!==null&&e!==void 0?e:1/0)<s+vo;if(this._debug(t,`session has${i?"":" not"} expired with margin of ${vo}s`),i){if(this.autoRefreshToken&&r.refresh_token){const{error:a}=await this._callRefreshToken(r.refresh_token);a&&(console.error(a),Js(a)||(this._debug(t,"refresh failed with a non-retryable error, removing the session",a),await this._removeSession()))}}else await this._notifyAllSubscribers("SIGNED_IN",r)}catch(r){this._debug(t,"error",r),console.error(r);return}finally{this._debug(t,"end")}}async _callRefreshToken(e){var t,r;if(!e)throw new Rt;if(this.refreshingDeferred)return this.refreshingDeferred.promise;const s=`#_callRefreshToken(${e.substring(0,5)}...)`;this._debug(s,"begin");try{this.refreshingDeferred=new Ts;const{data:i,error:a}=await this._refreshAccessToken(e);if(a)throw a;if(!i.session)throw new Rt;await this._saveSession(i.session),await this._notifyAllSubscribers("TOKEN_REFRESHED",i.session);const o={session:i.session,error:null};return this.refreshingDeferred.resolve(o),o}catch(i){if(this._debug(s,"error",i),L(i)){const a={session:null,error:i};return Js(i)||(await this._removeSession(),await this._notifyAllSubscribers("SIGNED_OUT",null)),(t=this.refreshingDeferred)===null||t===void 0||t.resolve(a),a}throw(r=this.refreshingDeferred)===null||r===void 0||r.reject(i),i}finally{this.refreshingDeferred=null,this._debug(s,"end")}}async _notifyAllSubscribers(e,t,r=!0){const s=`#_notifyAllSubscribers(${e})`;this._debug(s,"begin",t,`broadcast = ${r}`);try{this.broadcastChannel&&r&&this.broadcastChannel.postMessage({event:e,session:t});const i=[],a=Array.from(this.stateChangeEmitters.values()).map(async o=>{try{await o.callback(e,t)}catch(c){i.push(c)}});if(await Promise.all(a),i.length>0){for(let o=0;o<i.length;o+=1)console.error(i[o]);throw i[0]}}finally{this._debug(s,"end")}}async _saveSession(e){this._debug("#_saveSession()",e),await mt(this.storage,this.storageKey,e)}async _removeSession(){this._debug("#_removeSession()"),await Ks(this.storage,this.storageKey)}_removeVisibilityChangedCallback(){this._debug("#_removeVisibilityChangedCallback()");const e=this.visibilityChangedCallback;this.visibilityChangedCallback=null;try{e&&Ae()&&(window!=null&&window.removeEventListener)&&window.removeEventListener("visibilitychange",e)}catch(t){console.error("removing visibilitychange callback failed",t)}}async _startAutoRefresh(){await this._stopAutoRefresh(),this._debug("#_startAutoRefresh()");const e=setInterval(()=>this._autoRefreshTokenTick(),Er);this.autoRefreshTicker=e,e&&typeof e=="object"&&typeof e.unref=="function"?e.unref():typeof Deno<"u"&&typeof Deno.unrefTimer=="function"&&Deno.unrefTimer(e),setTimeout(async()=>{await this.initializePromise,await this._autoRefreshTokenTick()},0)}async _stopAutoRefresh(){this._debug("#_stopAutoRefresh()");const e=this.autoRefreshTicker;this.autoRefreshTicker=null,e&&clearInterval(e)}async startAutoRefresh(){this._removeVisibilityChangedCallback(),await this._startAutoRefresh()}async stopAutoRefresh(){this._removeVisibilityChangedCallback(),await this._stopAutoRefresh()}async _autoRefreshTokenTick(){this._debug("#_autoRefreshTokenTick()","begin");try{await this._acquireLock(0,async()=>{try{const e=Date.now();try{return await this._useSession(async t=>{const{data:{session:r}}=t;if(!r||!r.refresh_token||!r.expires_at){this._debug("#_autoRefreshTokenTick()","no session");return}const s=Math.floor((r.expires_at*1e3-e)/Er);this._debug("#_autoRefreshTokenTick()",`access token expires in ${s} ticks, a tick lasts ${Er}ms, refresh threshold is ${To} ticks`),s<=To&&await this._callRefreshToken(r.refresh_token)})}catch(t){console.error("Auto refresh tick failed with error. This is likely a transient error.",t)}}finally{this._debug("#_autoRefreshTokenTick()","end")}})}catch(e){if(e.isAcquireTimeout||e instanceof zc)this._debug("auto refresh token tick lock not available");else throw e}}async _handleVisibilityChange(){if(this._debug("#_handleVisibilityChange()"),!Ae()||!(window!=null&&window.addEventListener))return this.autoRefreshToken&&this.startAutoRefresh(),!1;try{this.visibilityChangedCallback=async()=>await this._onVisibilityChanged(!1),window==null||window.addEventListener("visibilitychange",this.visibilityChangedCallback),await this._onVisibilityChanged(!0)}catch(e){console.error("_handleVisibilityChange",e)}}async _onVisibilityChanged(e){const t=`#_onVisibilityChanged(${e})`;this._debug(t,"visibilityState",document.visibilityState),document.visibilityState==="visible"?(this.autoRefreshToken&&this._startAutoRefresh(),e||(await this.initializePromise,await this._acquireLock(-1,async()=>{if(document.visibilityState!=="visible"){this._debug(t,"acquired the lock to recover the session, but the browser visibilityState is no longer visible, aborting");return}await this._recoverAndRefresh()}))):document.visibilityState==="hidden"&&this.autoRefreshToken&&this._stopAutoRefresh()}async _getUrlForProvider(e,t,r){const s=[`provider=${encodeURIComponent(t)}`];if(r!=null&&r.redirectTo&&s.push(`redirect_to=${encodeURIComponent(r.redirectTo)}`),r!=null&&r.scopes&&s.push(`scopes=${encodeURIComponent(r.scopes)}`),this.flowType==="pkce"){const i=St();await mt(this.storage,`${this.storageKey}-code-verifier`,i);const a=await xt(i),o=i===a?"plain":"s256";this._debug("PKCE","code verifier",`${i.substring(0,5)}...`,"code challenge",a,"method",o);const c=new URLSearchParams({code_challenge:`${encodeURIComponent(a)}`,code_challenge_method:`${encodeURIComponent(o)}`});s.push(c.toString())}if(r!=null&&r.queryParams){const i=new URLSearchParams(r.queryParams);s.push(i.toString())}return r!=null&&r.skipBrowserRedirect&&s.push(`skip_http_redirect=${r.skipBrowserRedirect}`),`${e}?${s.join("&")}`}async _unenroll(e){try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?{data:null,error:i}:await M(this.fetch,"DELETE",`${this.url}/factors/${e.factorId}`,{headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(L(t))return{data:null,error:t};throw t}}async _enroll(e){try{return await this._useSession(async t=>{var r,s;const{data:i,error:a}=t;if(a)return{data:null,error:a};const{data:o,error:c}=await M(this.fetch,"POST",`${this.url}/factors`,{body:{friendly_name:e.friendlyName,factor_type:e.factorType,issuer:e.issuer},headers:this.headers,jwt:(r=i==null?void 0:i.session)===null||r===void 0?void 0:r.access_token});return c?{data:null,error:c}:(!((s=o==null?void 0:o.totp)===null||s===void 0)&&s.qr_code&&(o.totp.qr_code=`data:image/svg+xml;utf-8,${o.totp.qr_code}`),{data:o,error:null})})}catch(t){if(L(t))return{data:null,error:t};throw t}}async _verify(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;if(i)return{data:null,error:i};const{data:a,error:o}=await M(this.fetch,"POST",`${this.url}/factors/${e.factorId}/verify`,{body:{code:e.code,challenge_id:e.challengeId},headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token});return o?{data:null,error:o}:(await this._saveSession(Object.assign({expires_at:Math.round(Date.now()/1e3)+a.expires_in},a)),await this._notifyAllSubscribers("MFA_CHALLENGE_VERIFIED",a),{data:a,error:o})})}catch(t){if(L(t))return{data:null,error:t};throw t}})}async _challenge(e){return this._acquireLock(-1,async()=>{try{return await this._useSession(async t=>{var r;const{data:s,error:i}=t;return i?{data:null,error:i}:await M(this.fetch,"POST",`${this.url}/factors/${e.factorId}/challenge`,{headers:this.headers,jwt:(r=s==null?void 0:s.session)===null||r===void 0?void 0:r.access_token})})}catch(t){if(L(t))return{data:null,error:t};throw t}})}async _challengeAndVerify(e){const{data:t,error:r}=await this._challenge({factorId:e.factorId});return r?{data:null,error:r}:await this._verify({factorId:e.factorId,challengeId:t.id,code:e.code})}async _listFactors(){const{data:{user:e},error:t}=await this.getUser();if(t)return{data:null,error:t};const r=(e==null?void 0:e.factors)||[],s=r.filter(i=>i.factor_type==="totp"&&i.status==="verified");return{data:{all:r,totp:s},error:null}}async _getAuthenticatorAssuranceLevel(){return this._acquireLock(-1,async()=>await this._useSession(async e=>{var t,r;const{data:{session:s},error:i}=e;if(i)return{data:null,error:i};if(!s)return{data:{currentLevel:null,nextLevel:null,currentAuthenticationMethods:[]},error:null};const a=this._decodeJWT(s.access_token);let o=null;a.aal&&(o=a.aal);let c=o;((r=(t=s.user.factors)===null||t===void 0?void 0:t.filter(f=>f.status==="verified"))!==null&&r!==void 0?r:[]).length>0&&(c="aal2");const d=a.amr||[];return{data:{currentLevel:o,nextLevel:c,currentAuthenticationMethods:d},error:null}}))}}zr.nextInstanceID=0;class Cm extends zr{constructor(e){super(e)}}var Sm=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(a){a(i)})}return new(t||(t=Promise))(function(i,a){function o(d){try{l(r.next(d))}catch(f){a(f)}}function c(d){try{l(r.throw(d))}catch(f){a(f)}}function l(d){d.done?i(d.value):s(d.value).then(o,c)}l((r=r.apply(n,e||[])).next())})};const xm={headers:Kp},Rm={schema:"public"},jm={autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"implicit"},$m={};class Nm{constructor(e,t,r){var s,i,a,o,c,l,d,f;if(this.supabaseUrl=e,this.supabaseKey=t,this.from=w=>this.rest.from(w),this.schema=w=>this.rest.schema(w),this.rpc=(w,P={},k)=>this.rest.rpc(w,P,k),!e)throw new Error("supabaseUrl is required.");if(!t)throw new Error("supabaseKey is required.");const m=Yp(e);this.realtimeUrl=`${m}/realtime/v1`.replace(/^http/i,"ws"),this.authUrl=`${m}/auth/v1`,this.storageUrl=`${m}/storage/v1`,this.functionsUrl=`${m}/functions/v1`;const b=`sb-${new URL(this.authUrl).hostname.split(".")[0]}-auth-token`,v={db:Rm,realtime:$m,auth:Object.assign(Object.assign({},jm),{storageKey:b}),global:xm},T=Xp(r??{},v);this.storageKey=(i=(s=T.auth)===null||s===void 0?void 0:s.storageKey)!==null&&i!==void 0?i:"",this.headers=(o=(a=T.global)===null||a===void 0?void 0:a.headers)!==null&&o!==void 0?o:{},this.auth=this._initSupabaseAuthClient((c=T.auth)!==null&&c!==void 0?c:{},this.headers,(l=T.global)===null||l===void 0?void 0:l.fetch),this.fetch=Wp(t,this._getAccessToken.bind(this),(d=T.global)===null||d===void 0?void 0:d.fetch),this.realtime=this._initRealtimeClient(Object.assign({headers:this.headers},T.realtime)),this.rest=new ta(`${m}/rest/v1`,{headers:this.headers,schema:(f=T.db)===null||f===void 0?void 0:f.schema,fetch:this.fetch}),this._listenForAuthEvents()}get functions(){return new cp(this.functionsUrl,{headers:this.headers,customFetch:this.fetch})}get storage(){return new zp(this.storageUrl,this.headers,this.fetch)}channel(e,t={config:{}}){return this.realtime.channel(e,t)}getChannels(){return this.realtime.getChannels()}removeChannel(e){return this.realtime.removeChannel(e)}removeAllChannels(){return this.realtime.removeAllChannels()}_getAccessToken(){var e,t;return Sm(this,void 0,void 0,function*(){const{data:r}=yield this.auth.getSession();return(t=(e=r.session)===null||e===void 0?void 0:e.access_token)!==null&&t!==void 0?t:null})}_initSupabaseAuthClient({autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,storageKey:i,flowType:a,debug:o},c,l){const d={Authorization:`Bearer ${this.supabaseKey}`,apikey:`${this.supabaseKey}`};return new Cm({url:this.authUrl,headers:Object.assign(Object.assign({},d),c),storageKey:i,autoRefreshToken:e,persistSession:t,detectSessionInUrl:r,storage:s,flowType:a,debug:o,fetch:l})}_initRealtimeClient(e){return new xp(this.realtimeUrl,Object.assign(Object.assign({},e),{params:Object.assign({apikey:this.supabaseKey},e==null?void 0:e.params)}))}_listenForAuthEvents(){return this.auth.onAuthStateChange((t,r)=>{this._handleTokenChanged(t,"CLIENT",r==null?void 0:r.access_token)})}_handleTokenChanged(e,t,r){(e==="TOKEN_REFRESHED"||e==="SIGNED_IN")&&this.changedAccessToken!==r?(this.realtime.setAuth(r??null),this.changedAccessToken=r):e==="SIGNED_OUT"&&(this.realtime.setAuth(this.supabaseKey),t=="STORAGE"&&this.auth.signOut(),this.changedAccessToken=void 0)}}const Dm=(n,e,t)=>new Nm(n,e,t),Lm=new Uf,Um="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5Zm15cGh1dW1yd2hldXVucGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MDQzMTE2OTEsImV4cCI6MjAxOTg4NzY5MX0.ezqcQq6a2YsFqQmyDMAqPbH13N1G7KuDxZCzh1cpnWA",Zm="https://wyfmyphuumrwheuunpeb.supabase.co",Mm=Dm(Zm,Um),Fm=new Xi(Lm,{client:Mm,tableName:"documents",queryName:"match_documents"}),Bm=Fm.asRetriever();function Vm(n){let e="";for(let t in n)e+=n[t].pageContent;return e}document.addEventListener("submit",n=>{n.preventDefault(),Xm()});const qc=new Nf,zm="Given a question, convert it to a standalone question. Question: {question} Standalone Question:",qm=it.fromTemplate(zm),Km="Given the following question: {question} Answer the question using the following documents as context: {context}. Please be friendly and only answer the question from the context provided, and never make up answers. If you do not know the answer, advise the user to email help@scrimba.com. Always speak as if chatting to a friend.",Hm=it.fromTemplate(Km),Jm=qm.pipe(qc).pipe(new $c),Gm=st.from([n=>n.standalone_question,Bm,Vm]),Wm=Hm.pipe(qc).pipe(new $c),Ym=st.from([{standalone_question:Jm,original_input:new Hf},{context:Gm,question:({original_input:n})=>n.question},Wm]);async function Xm(){const n=document.getElementById("user-input"),e=document.getElementById("chatbot-conversation-container"),t=n.value;n.value="";const r=document.createElement("div");r.classList.add("speech","speech-human"),e.appendChild(r),r.textContent=t,e.scrollTop=e.scrollHeight;const s=await Ym.invoke({question:t}),i=document.createElement("div");i.classList.add("speech","speech-ai"),e.appendChild(i),i.textContent=s,e.scrollTop=e.scrollHeight}export{Ff as B,pd as C,it as P,Bf as a,Kf as c,_i as g,jc as r};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
